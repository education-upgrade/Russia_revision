<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Russia 1855–1964 Revision (AQA 1H)</title>

  <!-- PWA essentials (keep if you use them) -->
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta name="theme-color" content="#f3f7fb">
    <link rel="preload" as="image" href="section-bg.jpg?v8">
<style>
    /* ======================================================
       LIGHT PASTEL BLUE THEME (eye-safe)
       ====================================================== */

    :root{
      /* Background image used inside cards on all non-Home tabs */
      --sectionCardBg: url("./section-bg.jpg");
      --paleBlueBgFilter: saturate(.39) brightness(1.08) contrast(.95) hue-rotate(168deg);
      --paleBlueBgMask: linear-gradient(180deg, rgba(214,231,247,.21), rgba(233,243,252,.30));

      --bg:#f8fbff;
      --surface:#f2f6fb;
      --card:#f4f8fd;
      --line:rgba(30,60,100,.12);

      --text:#1f334d;
      --muted:#5e6f82;
      --textStrong:#182b45;
      --keyMetric:#16314f;
      --bgWash:rgba(255,255,255,.65);
      --cardShadow:0 8px 18px rgba(33, 62, 97, .08);
      --ctaBorder:rgba(32,73,122,.56);
      --ctaShadow:0 12px 24px rgba(32,73,122,.32);

      --accent:#6e90ca;    /* slate blue */
      --accent2:#d1e0ef;   /* soft sky (reduced tint) */
      --accent3:#f3f7fb;   /* very light sky (reduced tint) */
      --accent4:#ebf2fa;   /* cool mist (reduced tint) */

      --good:#7eb9aa;
      --warn:#9eb7d4;
      --bad:#b78ea1;

      --radius:18px;
      --shadow:var(--cardShadow);

      --navH: 72px;
    }

    *{box-sizing:border-box}
    body{
      position:relative;
      margin:0;
      font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-variant-emoji:text;
      background:
        radial-gradient(900px 520px at 12% 8%, rgba(110,144,202,.11), transparent 60%),
        radial-gradient(900px 520px at 90% 12%, rgba(163,194,223,.11), transparent 60%),
        linear-gradient(180deg, var(--bg), #ffffff);
      color:var(--text);
      overflow-x:hidden;
    }

    body::before{
      content:"";
      position:fixed;
      inset:0;
      background:var(--bgWash);
      pointer-events:none;
      z-index:0;
    }

    header,
    main,
    nav{
      position:relative;
      z-index:1;
    }

    main{
      max-width:1100px;
      margin:0 auto;
      padding:16px 16px calc(var(--navH) + env(safe-area-inset-bottom) + 16px);
    }

    /* =========================
       CARDS (flat, no overlap)
       ========================= */
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:var(--shadow);
      margin-bottom:14px;
    }

    /* =========================
       CARD BACKDROP (NON-HOME TABS)
       Subtle Russia-themed image inside cards on Study/Quiz/Games/Exam/Settings
       ========================= */
    section.tabpane:not(#home) .card{
      position:relative;
      overflow:hidden;
      isolation:isolate;
      background:
        linear-gradient(165deg, color-mix(in srgb, var(--accent3) 42%, #ffffff 58%), color-mix(in srgb, var(--accent2) 20%, #ffffff 80%));
      border-color: color-mix(in srgb, var(--line) 70%, var(--accent2) 30%);
    }
    section.tabpane:not(#home) .card::before{
      content:"";
      position:absolute;
      inset:0;
      background-image: var(--sectionCardBg);
      background-size: cover;
      background-position: center;
      background-repeat:no-repeat;
      opacity:.17;
      filter: var(--paleBlueBgFilter);
      transform: scale(1.05);
      z-index:0;
      pointer-events:none;
    }
    section.tabpane:not(#home) .card::after{
      content:"";
      position:absolute;
      inset:0;
      background:var(--paleBlueBgMask);
      pointer-events:none;
      z-index:1;
    }
    section.tabpane:not(#home) .card > *{
      position:relative;
      z-index:2;
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    /* =========================
   Banner KPI pills (Home)
   ========================= */
.bannerKpis{
  width:100%;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:stretch;
  margin-top:10px;
}

.kpiPill{
  min-width:150px;
  flex:1 1 150px;
  padding:12px 12px;
  border-radius:999px;

  background: rgba(232,241,250,.40);
  backdrop-filter: blur(16px) saturate(140%);
  -webkit-backdrop-filter: blur(16px) saturate(140%);
  -webkit-mask-image: -webkit-radial-gradient(white, black);

  border: 1px solid rgba(255,255,255,.50);
  box-shadow:
    0 8px 18px rgba(0,0,0,.06),
    inset 0 1px 0 rgba(232,241,250,.40);

  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}

.kpiPill .kpiLabel{
  font-size:12px;
  color:var(--muted);
  font-weight:900;
  letter-spacing:.2px;
}

.kpiPill .kpiVal{
  font-size:18px;
  font-weight:1000;
  font-variant-numeric:tabular-nums;
}

/* Combined progress pill */
.kpiPillLong{
  justify-content:flex-start;
}

.kpiLong{
  width:100%;
  display:flex;
  align-items:baseline;
  justify-content:center;
  gap:14px;
  flex-wrap:wrap;
}

.kpiItem{
  display:flex;
  align-items:baseline;
  gap:6px;
  white-space:nowrap;
}

.kpiMiniLabel{
  font-size:12px;
  color:var(--muted);
  font-weight:900;
  letter-spacing:.2px;
  text-transform:none;
}

.kpiMiniVal{
  font-size:18px;
  font-weight:1000;
  font-variant-numeric:tabular-nums;
}

.kpiSep{
  opacity:.35;
  font-weight:900;
}

    /* Icon-only settings button */
    .iconBtn{
      width:40px; height:40px;
      border-radius:999px;
      display:grid; place-items:center;
      border:1px solid rgba(0,0,0,.10);
      background:rgba(255,255,255,.85);
      box-shadow: 0 6px 14px rgba(0,0,0,.05);
      cursor:pointer;
      font-size:18px;
      padding:0;
    }
    .iconBtn:active{ transform:translateY(1px); }


.topicDash{
  display:grid;
  /* Smaller, more navigable dashboard tiles */
  grid-template-columns:repeat(auto-fit, minmax(170px, 1fr));
  gap:10px;
  margin:10px 0 6px;
}
.topicTile{
  width:100%;
  border:1px solid var(--line);
  background:transparent;
  border-radius:16px;
  padding:10px 10px 10px;
  box-shadow:var(--shadow);
  cursor:pointer;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:8px;
  transition: opacity .22s ease, filter .22s ease;
  position:relative;
  isolation:isolate;
  overflow:hidden;
}
.topicTile::before{
  content:"";
  position:absolute;
  inset:0;
  background-image:var(--topicTileBg, none);
  background-size:cover;
  background-position:center;
  background-repeat:no-repeat;
  filter:var(--paleBlueBgFilter);
  opacity:.24;
  pointer-events:none;
  z-index:0;
}
.topicTile::after{
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(180deg, rgba(255,255,255,.44), rgba(255,255,255,.58));
  pointer-events:none;
  z-index:1;
}
.topicTile > *{ position:relative; z-index:2; }
.topicTile:hover{ filter:brightness(0.99); }
.topicTile:active{ transform:translateY(1px); }

/* Topic on/off toggle (per tile) */
.topicPillRow{
  width:100%;
  display:grid;
  grid-template-columns:minmax(0,1fr) auto auto;
  align-items:center;
  gap:6px;
}

.topicStatusDot{
  width:10px;
  height:10px;
  border-radius:50%;
  box-shadow:0 0 0 2px rgba(242,248,255,.75);
}
.topicStatusDot.new{ background:color-mix(in srgb, var(--line) 82%, #9fb0bf 18%); }
.topicStatusDot.inprogress{ background:var(--warn); }
.topicStatusDot.attarget{ background:var(--good); }

.topicToggleWrap{
  display:flex;
  align-items:center;
  justify-content:center;
  min-width:0;
}

.topicTogglePill{
  min-height:34px;
  padding:6px 8px;
  border-radius:999px;
  border:1px solid color-mix(in srgb, var(--accent) 42%, #ffffff 58%);
  background:linear-gradient(180deg, #f6f9ff, #e8f0fa);
  box-shadow:0 4px 10px color-mix(in srgb, var(--accent) 22%, transparent);
}
.switch{
  position:relative;
  display:inline-block;
  width:44px;
  height:24px;
}
.switch input{ opacity:0; width:0; height:0; }
.slider{
  position:absolute; cursor:pointer;
  inset:0;
  background:color-mix(in srgb, var(--accent2) 30%, #ffffff 70%);
  border:1px solid color-mix(in srgb, var(--accent) 45%, #ffffff 55%);
  border-radius:999px;
  transition: all .18s ease;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.45), 0 5px 10px rgba(0,0,0,.12);
}
.slider:before{
  content:"";
  position:absolute;
  height:18px; width:18px;
  left:3px; top:2px;
  background:white;
  border:1px solid rgba(21, 51, 80, .28);
  border-radius:50%;
  transition: all .18s ease;
  box-shadow: 0 4px 9px rgba(0,0,0,.24);
}
.switch input:checked + .slider{
  background:color-mix(in srgb, var(--good) 82%, #ffffff 18%);
  border-color:color-mix(in srgb, var(--good) 88%, #154b3e 12%);
}
.switch input:checked + .slider:before{
  transform: translateX(20px);
}
.switch input:focus-visible + .slider{
  outline:2px solid color-mix(in srgb, var(--accent) 70%, #214673 30%);
  outline-offset:2px;
}
.topicTile.isDisabled{
  opacity:.56;
  filter:saturate(.72);
}
.topicTile.isDisabled .progressTank{
  filter:saturate(.72) brightness(.98);
}

/* =========================
   Topic tiles (liquid fill)
   ========================= */
.progressTank{
  width:100%;
  height:132px;
  border-radius:16px;
  border:1px solid color-mix(in srgb, var(--line) 72%, var(--accent2) 28%);
  background:transparent;
  box-shadow: 0 8px 14px rgba(0,0,0,.06);
  position:relative;
  overflow:hidden;
  transition: filter .22s ease;
}
.progressTank::before{
  content:"";
  position:absolute;
  inset:0;
  background-image:var(--topicBg, linear-gradient(180deg, color-mix(in srgb, var(--accent3) 36%, #ffffff 64%), color-mix(in srgb, var(--accent2) 45%, #ffffff 55%)));
  background-size:cover;
  background-position:center;
  background-repeat:no-repeat;
  filter:var(--paleBlueBgFilter);
  opacity:.55;
  pointer-events:none;
  z-index:0;
}
.progressTank::after{
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.14));
  pointer-events:none;
  z-index:1;
}
.progressLiquid{
  position:absolute;
  left:0; right:0; bottom:0;
  height: var(--fill, 0%);
  /* Progress tint should be clear but still let the background image show through */
  background: linear-gradient(
    180deg,
    rgba(255,255,255,.14) 0%,
    rgba(255,255,255,0) 20%
  ),
  linear-gradient(
    135deg,
    rgba(183,142,161,.38),
    rgba(183,142,161,.56)
  );
  background: linear-gradient(
    180deg,
    rgba(255,255,255,.2) 0%,
    rgba(255,255,255,0) 24%
  ),
  linear-gradient(
    135deg,
    color-mix(in srgb, var(--liq, var(--bad)) 76%, transparent),
    color-mix(in srgb, var(--liq, var(--bad)) 92%, transparent)
  );
  border-top:1px solid rgba(255,255,255,.32);
  transition: height .7s cubic-bezier(.2,.9,.2,1), opacity .22s ease;
  will-change: height;
  z-index:2;
}
.topicTile.isDisabled .progressLiquid{ opacity:.48; }

.tankContent{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  padding:14px 12px;
  z-index:3;
}
.tileTitlePanel{
  background:linear-gradient(180deg, rgba(255,255,255,.78), color-mix(in srgb, var(--accent3) 56%, #ffffff 44%));
  border:1px solid color-mix(in srgb, var(--accent2) 38%, #ffffff 62%);
  border-radius:12px;
  padding:8px 10px;
  box-shadow:0 4px 10px rgba(0,0,0,.12);
}
.tankContent .tileNum{ font-size:18px; }
.tankContent .tileMain{ font-size:13px; }
.tankContent .tileYears{ font-size:11px; }

.topicTile .levelBadge{
  margin-top:0;
  width:100%;
  min-width:0;
  max-width:100%;
}

@media (max-width:420px){
  .progressTank{ height:124px; }
  .topicPillRow{ grid-template-columns:minmax(0,1fr) auto; }
  .topicStatusDot{ display:none; }
  .topicTogglePill{ padding:4px 6px; }
}



.xpRing{
  width:118px;
  height:118px;
  border-radius:50%;
  padding:8px;
  display:grid;
  place-items:center;
  background:conic-gradient(from -90deg,
      var(--good) 0 var(--g),
      var(--warn) var(--g) calc(var(--g) + var(--y)),
      var(--bad) calc(var(--g) + var(--y)) 100%);
  border:1px solid rgba(0,0,0,.06);
  box-shadow: 0 8px 14px rgba(0,0,0,.06);
}
.xpInner{
  width:100%;
  height:100%;
  border-radius:50%;
  background:linear-gradient(180deg,#fff, #fff);
  border:1px solid var(--line);
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  padding:8px;
}
.tileNum{
  font-weight:900;
  font-size:18px;
  line-height:1;
  margin-bottom:3px;
}
.tileMain{
  font-weight:900;
  font-size:13px;
  line-height:1.15;
}
.tileYears{
  margin-top:5px;
  font-size:11px;
  color:var(--muted);
  font-weight:800;
  letter-spacing:.2px;
}

.levelBadge{
  display:flex;
  align-items:center;
  justify-content:center;
  width:100%;
  text-align:center;
  border:1px solid rgba(0,0,0,.10);
  border-radius:12px;
  padding:8px 10px;
  min-height:38px;
  font-weight:900;
  letter-spacing:.15px;
  font-size:10px;
  line-height:1.1;
  overflow-wrap:normal;
  word-break:normal;
  hyphens:none;
}

/* Tighten on very small screens */
@media (max-width:420px){
  .topicDash{ grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:9px; }
  .xpRing{ width:112px; height:112px; }
}

/* Preserve readability of long level labels when card width is constrained */
@media (max-width:720px){
  .topicPillRow{ grid-template-columns:minmax(0,1fr) auto; }
  .topicStatusDot{ display:none; }
}

.level-xp-0{ background:rgba(183,142,161,.18); }
.level-xp-1{ background:rgba(158,183,212,.22); }
.level-xp-2{ background:rgba(126,185,170,.20); }
.level-xp-3{ background:rgba(126,185,170,.28); border-color: rgba(126,185,170,.55); }

.progressHeadlineBar{margin-top:10px}
.progressTrack{height:12px;border-radius:999px;background:color-mix(in srgb, var(--accent2) 34%, #ffffff 66%);border:1px solid color-mix(in srgb, var(--line) 72%, var(--accent2) 28%);overflow:hidden}
.progressFill{height:100%;background:linear-gradient(90deg,var(--warn),var(--good));width:0}

.metricGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;margin-top:10px}
.metricCard{border:1px solid color-mix(in srgb, var(--line) 70%, var(--accent2) 30%);border-radius:12px;padding:10px;background:linear-gradient(168deg, color-mix(in srgb, var(--accent3) 60%, #ffffff 40%), color-mix(in srgb, var(--accent2) 26%, #ffffff 74%))}
.metricLabel{font-size:11px;color:var(--muted);font-weight:800}
.metricVal{font-size:18px;font-weight:1000;margin-top:3px}

.topicXpList{display:flex;flex-direction:column;gap:10px;margin-top:10px}
.topicXpItem{border:1px solid color-mix(in srgb, var(--line) 70%, var(--accent2) 30%);border-radius:14px;padding:12px;background:linear-gradient(170deg, color-mix(in srgb, var(--accent3) 54%, #ffffff 46%), color-mix(in srgb, var(--accent2) 24%, #ffffff 76%))}
.topicXpItem[data-topic-open]{cursor:pointer}
.topicXpItem[data-topic-open]:focus-visible{outline:2px solid color-mix(in srgb, var(--accent2) 70%, #2c5aa0 30%);outline-offset:2px}
.topicXpTop{display:flex;align-items:flex-start;gap:10px}
.topicXpTitle{font-weight:900;font-size:clamp(16px, 3.1vw, 20px);line-height:1.24;text-wrap:balance;flex:1}
.topicXpMeta{display:flex;align-items:center;justify-content:flex-end;gap:8px;flex-shrink:0}
.topicRetentionArrowBtn{display:inline-flex;align-items:center;justify-content:center;gap:4px;min-width:38px;height:30px;padding:0 10px;border:1px solid color-mix(in srgb, var(--line) 72%, var(--accent2) 28%);border-radius:999px;background:#fff;font-size:14px;font-weight:900;line-height:1;cursor:pointer;flex-shrink:0}
.topicRetentionArrowBtn:focus-visible{outline:2px solid color-mix(in srgb, var(--accent2) 70%, #2c5aa0 30%);outline-offset:2px}
.topicRetentionArrow{display:inline-flex;align-items:center;justify-content:center;min-width:20px;font-size:14px;font-weight:900;line-height:1}
.topicRetentionArrow.up{color:var(--good)}
.topicRetentionArrow.flat{color:var(--muted)}
.topicRetentionArrow.down{color:#b78655}
.statusTag{font-size:11px;font-weight:900;padding:4px 8px;border-radius:999px;border:1px solid color-mix(in srgb, var(--line) 65%, var(--accent2) 35%)}
.status-new{background:rgba(183,183,183,.18)}
.status-focus{background:rgba(183,142,161,.16)}
.status-track{background:rgba(158,183,212,.2)}
.status-target{background:rgba(126,185,170,.2)}
.topicXpSub{display:flex;justify-content:space-between;align-items:center;gap:8px;color:var(--muted);font-size:clamp(13px, 2.8vw, 16px);font-weight:900;margin-top:10px}
.topicXpArrowKey{display:grid;grid-template-columns:repeat(2, minmax(0, 1fr));gap:8px;margin-top:8px}
.topicXpArrowLegendItem{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:8px 10px;border:1px solid color-mix(in srgb, var(--line) 72%, var(--accent2) 28%);border-radius:999px;background:color-mix(in srgb, #fff 82%, var(--accent3) 18%);font-size:12px;font-weight:800;color:var(--text);line-height:1.1;white-space:normal;text-align:center;min-width:0}
.topicXpArrowLegendItem:last-child{grid-column:1 / -1}
@media(min-width:420px){
  .topicXpArrowKey{grid-template-columns:repeat(3, minmax(0, 1fr))}
  .topicXpArrowLegendItem:last-child{grid-column:auto}
}

@media (max-width:560px){
  #progress .card{padding:14px 12px}
  .topicXpTop{gap:8px}
  .topicXpMeta{align-self:flex-start}
  .statusTag{font-size:12px;padding:5px 10px}
  .topicRetentionArrowBtn{height:30px;min-width:42px;padding:0 11px;font-size:15px}
}

.topicArrowDialogTitle{margin:0;font-size:18px;line-height:1.2}
.topicArrowDialogBody{margin-top:8px;font-size:14px;color:var(--muted)}
.topicArrowDialogMeta{margin-top:10px;padding:9px 10px;border:1px solid color-mix(in srgb, var(--line) 72%, var(--accent2) 28%);border-radius:12px;background:color-mix(in srgb, #fff 80%, var(--accent3) 20%);font-size:12px;color:var(--text)}

.focusList{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.focusItem{border:1px solid color-mix(in srgb, var(--line) 70%, var(--accent2) 30%);border-radius:12px;padding:10px;background:linear-gradient(168deg, color-mix(in srgb, var(--accent3) 58%, #ffffff 42%), color-mix(in srgb, var(--accent2) 24%, #ffffff 76%))}
.focusReason{font-size:12px;color:var(--muted);margin-top:3px}

.habitPills{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.habitPill{border:1px solid var(--line);border-radius:999px;padding:8px 10px;background:#fff;font-size:12px;font-weight:800;color:var(--muted)}

.levelUpBanner{
  position:fixed;
  left:50%;
  top:12px;
  transform:translateX(-50%) translateY(-10px);
  background:linear-gradient(135deg, rgba(248,251,255,.96), rgba(230,239,248,.96));
  border:1px solid rgba(0,0,0,.10);
  box-shadow: 0 14px 26px rgba(0,0,0,.10);
  border-radius:999px;
  padding:10px 14px;
  font-weight:900;
  letter-spacing:.2px;
  display:flex;
  gap:10px;
  align-items:center;
  z-index:10000;
  opacity:0;
  pointer-events:none;
  transition: opacity .35s ease, transform .35s ease;
}
.levelUpBanner.show{
  opacity:1;
  transform:translateX(-50%) translateY(0);
}
.levelUpBanner .smallNote{
  font-weight:800;
  color:var(--muted);
  font-size:12px;
}

@media(max-width:520px){
  .xpRing{ width:170px; height:170px; }
  .tileMain{ font-size:15px; }
}

.grow{flex:1;min-width:200px}

    .pill{
      border:1px solid var(--line);
      background: #fff;
      color:var(--muted);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
    }

    /* Signal pills (meaning + gentle pressure, no new UI blocks) */
    .signalPill{
      flex-direction:column;
      align-items:flex-start;
      white-space:normal;
      line-height:1.15;
      padding:8px 12px;
      gap:2px;
      max-width:260px;
    }
    .signalPill .pillTop{font-weight:900;color:var(--text);font-size:12px}
    .signalPill .pillSub{font-size:11px;color:var(--muted);font-weight:750}
    .signalPill .pillTopRow{display:flex;align-items:center;gap:8px}

    .hookLine{margin-top:3px;color:var(--muted);font-size:12px}
.divider{height:1px;background:var(--line);margin:12px 0}

    label{font-size:12px;color:var(--muted)}
    select,input,textarea{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      outline:none;
    }
    select:focus,input:focus,textarea:focus{
      border-color: rgba(110,144,202,.85);
      box-shadow: 0 0 0 3px rgba(110,144,202,.18);
    }

    .btn{
      border:1px solid rgba(0,0,0,.06);
      background: var(--accent3);
      color:var(--text);
      padding:10px 12px;
      min-height:44px;
      border-radius:14px;
      cursor:pointer;
      font-weight:700;
    }
    .btn.primary{
      background: linear-gradient(135deg, rgba(110,144,202,.95), rgba(163,194,223,.95));
    }
    .btn.small{padding:8px 10px;font-size:12px;font-weight:700}

    .revealBand{
      width:100%;
      padding:16px 14px;
      border-radius:16px;
      font-size:clamp(17px, 2vw, 19px);
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      margin-top:10px;
      transition: opacity .35s ease, filter .35s ease;
    }
    .revealBand.isLocked{opacity:.28; filter:saturate(.4) grayscale(.15); pointer-events:none}
    .btn:hover{filter:brightness(1.03)}
    .btn:active{transform:translateY(1px)}

    /* =========================
       TAB PAGES
       ========================= */
    /* Generic hide utility (used across study/quiz UI) */
    .hidden{display:none !important}

    .tabpane.hidden{display:none}

    /* =========================
       KPI / RINGS
       ========================= */
    .kpiGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media(max-width:900px){.kpiGrid{grid-template-columns:1fr}}

    .kpiBig{font-size:28px;font-weight:900}
    .kpiBig,
    .kpiVal,
    .kpiMiniVal,
    .streakCountNum,
    .streakMiniNum,
    .tileNum,
    .streakCompleteTitle{ color:var(--keyMetric); }
    .note{color:var(--muted);font-size:12px;line-height:1.45}
    .qText{font-size:clamp(20px, 2.1vw, 24px);font-weight:800;line-height:1.3;margin:0;letter-spacing:-.2px}
    .aBox{
      margin-top:12px;
      padding-top:12px;
      border-top:1px dashed var(--line);
      white-space:pre-wrap;
      font-size:clamp(16px, 1.9vw, 20px);
      line-height:1.5;
      font-weight:550;
      color:#242424;
      letter-spacing:-.1px;
    }

    /* =========================
       FLASHCARD STANDALONE BOX
       ========================= */
    .flashcardFrame{
      border:1px solid var(--line);
      background: linear-gradient(180deg, #fff, var(--accent3));
      border-radius: var(--radius);
      padding:24px;
      box-shadow: var(--shadow);
      min-height: 250px;
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      gap:10px;
    }
    @media(max-width:600px){
      .flashcardFrame{ padding:20px; min-height: 270px; }
    }
    .flashcardFrame .qText{ font-size:clamp(26px, 2.9vw, 34px); line-height:1.35; }
    .flashcardFrame .aBox{ border-top:1px dashed var(--line); padding-top:16px; margin-top:0; font-size:clamp(19px, 2.2vw, 26px); line-height:1.55; }


    /* =========================
       STUDY PAGE (mobile-first tidy)
       ========================= */
    .studyWrap{ display:flex; flex-direction:column; gap:14px; }
    .studyControls{ order:1; }
    .studyCard{ order:2; }
    .studyMetaRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    .studyLaunch{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .studyLaunchMeta{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .studyLaunchTitle{
      margin:0;
      font-size:17px;
      font-weight:900;
      letter-spacing:-.2px;
    }
    .studyLaunchHint{
      margin:4px 0 0;
      font-size:12px;
      color:var(--muted);
    }
    .studyLaunchBtn{
      width:100%;
      min-height:50px;
      font-size:17px;
      font-weight:900;
    }

    .studyAdjustPanel{
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(242,248,255,.76);
      margin-top:2px;
      overflow:hidden;
    }
    .studyAdjustPanel summary{
      list-style:none;
      cursor:pointer;
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-weight:800;
      font-size:14px;
      color:#303030;
      gap:8px;
    }
    .studyAdjustPanel summary::-webkit-details-marker{ display:none; }
    .studyAdjustPanel summary::after{
      content:"▾";
      font-size:16px;
      line-height:1;
      color:var(--muted);
      transition:transform .2s ease;
    }
    .studyAdjustPanel[open] summary::after{ transform:rotate(180deg); }
    .studyAdjustBody{
      border-top:1px solid var(--line);
      padding:12px;
    }

    /* On phones: card first, menus second */
    @media(max-width:700px){
      .studyControls{ order:2; }
      .studyCard{ order:1; }
      .studyAdjustBody .row{ gap:8px; }
      .studyAdjustBody .grow{ width:100%; }
    }

    /* Fixed-height card frame so buttons stay visible when Reveal expands */
    .fixedCard{
      height: 390px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    @media(max-width:700px){
      .fixedCard{ height: 410px; }
      .studyPrompt{ text-align:center; }
    }

    /* Emoji buttons: 3 equal-width blocks, bigger tap targets */
    .emojiRow{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:10px;
      width:100%;
    }
    .emojiBtn{
      width:100%;
      padding:14px 0;
      line-height:1;
      border-radius:16px;
      display:grid;
      place-items:center;
    }
    .emojiBtn .navIcon{
      width:28px;
      height:28px;
    }
    @media(max-width:700px){
      .emojiBtn{ padding:16px 0; }
      .emojiBtn .navIcon{ width:30px; height:30px; }
    }


    .ringWrap{display:flex;align-items:center;gap:12px}
    .ring{
      width:56px;height:56px;border-radius:999px;
      display:grid;place-items:center;
      background:
        conic-gradient(var(--accent) var(--deg), #dce7f1 0);
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      font-weight:900;
    }
    .ringInner{
      width:42px;height:42px;border-radius:999px;
      background:#fff;
      border:1px solid var(--line);
      display:grid;place-items:center;
      font-size:12px;
      color:#000;
    }

    /* =========================
       CHOICE BUTTONS
       ========================= */
    .choiceGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    @media(max-width:520px){.choiceGrid{grid-template-columns:1fr}}
    .choiceBtn{
      width:min(100%, 640px);
      margin-inline:auto;
      text-align:center;
      padding:14px 16px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-weight:800;
      font-size:clamp(24px, 2.1vw, 28px);
      line-height:1.3;
      min-height:62px;
      white-space:normal;
      overflow-wrap:anywhere;
    }
    .choiceBtn.correct{border-color: rgba(126,185,170,.9); background: rgba(126,185,170,.12)}
    .choiceBtn.wrong{border-color: rgba(183,142,161,.9); background: rgba(183,142,161,.10)}

    .masteryWrap{margin-top:10px;padding:10px;border:1px solid var(--line);border-radius:14px;background:rgba(246,250,255,.92)}
    .masteryTrack{height:10px;border-radius:999px;background:rgba(0,0,0,.08);overflow:hidden}
    .masteryFill{height:100%;width:0%;background:linear-gradient(90deg,var(--warn),var(--good));transition:width .25s ease}
    .reviewList{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .reviewItem{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
    .reviewQ{font-weight:700;font-size:14px}
    .reviewMeta{font-size:12px;color:var(--muted);margin-top:4px}

    /* Quiz tab: single clean panel + central random start button */
    section#quiz .card{
      background:#fff;
      max-width:760px;
      margin:0 auto 14px;
      padding:12px;
    }
    section#quiz:has(#quizBox.hidden){
      min-height:calc(100dvh - var(--navH) - env(safe-area-inset-bottom) - 32px);
      display:flex;
      flex-direction:column;
      gap:22px;
      align-items:center;
      justify-content:center;
    }
    section#quiz:has(#quizBox.hidden) .card{
      width:100%;
      margin:0 auto;
    }
    section#quiz .card::before{display:none}
    section#quiz .card > *{position:relative;z-index:1}

    .quizBackgroundTitle{
      display:none;
      align-items:center;
      gap:10px;
      color:rgba(22,45,91,.32);
      text-shadow:0 8px 20px rgba(124,155,206,.16);
      user-select:none;
      pointer-events:none;
    }
    section#quiz:has(#quizBox.hidden) .quizBackgroundTitle{
      display:flex;
    }
    .quizBackgroundTitle .quizPanelTitleIcon{
      width:34px;
      height:34px;
      stroke-width:2.2;
      color:currentColor;
    }
    .quizBackgroundTitle .quizPanelTitleText{
      font-size:45px;
      letter-spacing:.4px;
      font-weight:1000;
    }

    .quizLaunch{
      margin:10px 0 12px;
      display:flex;
      justify-content:center;
    }
    .quizLaunchBtn{
      width:min(100%, 420px);
      min-height:72px;
      font-size:23px;
      font-weight:1000;
      border-radius:18px;
      box-shadow:0 12px 20px rgba(110,144,202,.26);
    }
    .quizMetaGrid{
      display:grid;
      grid-template-columns:1fr auto 1fr;
      gap:8px;
      align-items:center;
    }
    .quizPanelTitle{
      display:flex;
      align-items:center;
      justify-self:center;
      gap:8px;
      margin:0;
      color:var(--accent);
      font-size:24px;
      font-weight:900;
      line-height:1;
    }
    .quizPanelTitleIcon{
      width:20px;
      height:20px;
      color:var(--accent);
      stroke:currentColor;
      stroke-width:2;
      fill:none;
      stroke-linecap:round;
      stroke-linejoin:round;
      flex-shrink:0;
    }
    .quizPanelTitleText{
      font-size:1em;
      font-weight:900;
      letter-spacing:.2px;
      line-height:1;
    }
    .quizMetaLabel{
      margin:0;
      font-size:13px;
      font-weight:900;
      color:var(--muted);
      letter-spacing:.15px;
      justify-self:start;
    }
    .quizDiceBtn{
      grid-column:3;
      justify-self:end;
      width:38px;
      height:38px;
      min-height:38px;
      border-radius:999px;
      padding:0;
      display:grid;
      place-items:center;
      font-size:18px;
    }
    .quizResultModal{
      width:min(460px, 100%);
      color:var(--text);
    }
    .quizResultModal .onboardingTitle{ color:var(--textStrong); }
    .quizResultStatus{
      margin-top:8px;
      font-weight:900;
      font-size:15px;
      color:var(--text);
    }
    .quizResultStatus.good{ color:var(--accent); }
    .quizResultStatus.bad{ color:var(--bad); }
    .quizResultExplain{ margin-top:10px; }
    .quizResultActions{ display:flex; justify-content:flex-end; margin-top:12px; }
    .inlineIconLabel{
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .inlineIconLabel .navIcon{
      width:22px;
      height:22px;
    }
    .btnIconLabel{
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btnIconLabel .navIcon{
      width:20px;
      height:20px;
    }
    .quizCompleteActions{
      display:grid;
      grid-template-columns:repeat(3, minmax(0, 1fr));
      gap:10px;
      margin-top:14px;
      width:100%;
    }
    .quizCompleteActionBtn{
      width:100%;
      aspect-ratio:1 / 1;
      border-radius:18px;
      padding:10px 8px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:8px;
      text-align:center;
      line-height:1.15;
    }
    .quizCompleteActionIcon{
      width:22px;
      height:22px;
      stroke:currentColor;
      stroke-width:2;
      fill:none;
      stroke-linecap:round;
      stroke-linejoin:round;
      flex-shrink:0;
    }
    .quizCompleteActionLabel{
      font-size:13px;
      font-weight:800;
      text-wrap:balance;
    }

    @media (max-width:520px){
      .quizCompleteActionBtn{
        border-radius:16px;
        padding:8px 6px;
      }
      .quizCompleteActionLabel{ font-size:12px; }
    }

    @media (max-width:700px){
      .quizBackgroundTitle{
        gap:8px;
      }
      .quizBackgroundTitle .quizPanelTitleIcon{
        width:28px;
        height:28px;
      }
      .quizBackgroundTitle .quizPanelTitleText{
        font-size:36px;
      }

      section#quiz .card{
        padding:10px;
      }

      .quizMetaGrid{
        gap:6px;
      }

      .quizPanelTitle{
        font-size:22px;
      }

      .masteryWrap{
        margin-top:8px;
        padding:8px;
      }

      #quizQ{
        font-size:clamp(18px, 5.7vw, 24px);
        line-height:1.24;
        margin-bottom:10px;
      }

      #quizChoices .choiceBtn{
        font-size:clamp(16px, 5vw, 22px);
        min-height:56px;
        padding:12px 14px;
        border-radius:14px;
      }

      #quizBox .divider{ margin:10px 0; }
    }

    /* =========================
       MATCH GAME (two panels)
       ========================= */
    .matchControls{display:grid;grid-template-columns:repeat(3,minmax(160px,1fr));gap:10px;align-items:end}
    @media(max-width:820px){.matchControls{grid-template-columns:1fr}}

    .matchStatusGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
    @media(max-width:760px){.matchStatusGrid{grid-template-columns:1fr}}

    .matchFocus{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      background:rgba(244,249,255,.8);
      min-height:64px;
    }
    .matchFocusTitle{font-size:12px;font-weight:900;color:var(--muted);margin-bottom:4px}
    .matchFocusText{font-size:14px;font-weight:700;line-height:1.35}
    .matchFocusText.empty{color:var(--muted);font-weight:600}

    .matchGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.matchGrid{grid-template-columns:1fr}}
    .matchCol{
      border:1px solid var(--line);
      border-radius:16px;
      background:#fff;
      min-height:52vh;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .matchColHead{
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      font-weight:900;
      color:var(--muted);
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.4px;
      background:rgba(230,239,248,.55);
    }
    .matchList{padding:8px;overflow:auto;-webkit-overflow-scrolling:touch;flex:1}
    .matchItem{
      width:100%;
      text-align:left;
      margin:6px 0;
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      cursor:pointer;
      font-size:14px;
      font-weight:700;
      line-height:1.35;
    }
    .matchItem.selected{border-color: rgba(110,144,202,.95); background: rgba(110,144,202,.14)}
    .matchItem.correct{border-color: rgba(126,185,170,.95); background: rgba(126,185,170,.12)}

/* =========================
   Connections-style game (Games tab)
   ========================= */
/* Apply same section background image as other game cards */
.connectionsCard{
  position:relative;
  overflow:hidden;
  isolation:isolate;
  background: rgba(246,250,255,.92);
}
.connectionsCard::before{
  content:"";
  position:absolute;
  inset:0;
  background-image: var(--sectionCardBg);
  background-size: cover;
  background-position: center;
  background-repeat:no-repeat;
  opacity:.14;
  filter: saturate(1.12) contrast(1.05);
  transform: scale(1.05);
  z-index:0;
  pointer-events:none;
}
.connectionsCard > *{
  position:relative;
  z-index:1;
}

.connectionsCard{
  background: var(--card);
  border: 1px solid var(--line);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 14px;
  margin: 12px 0 14px;
}

.connectionsTop{
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:space-between;
  flex-wrap:wrap;
}

.connectionsTop h3{
  margin:0;
  font-size:16px;
  letter-spacing:.2px;
}

.connectionsMeta{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}

.connectionsMeta select{
  padding:10px 12px;
  border-radius:12px;
  border:1px solid var(--line);
  background:#fff;
  font-weight:800;
}

.mistakes{
  display:flex;
  gap:6px;
  align-items:center;
  color:var(--muted);
  font-size:12px;
  font-weight:900;
}

.mDot{
  width:10px;
  height:10px;
  border-radius:50%;
  background: rgba(0,0,0,.25);
}

.mDot.used{ background: rgba(0,0,0,.08); }

.connectionsSolved{
  margin-top:10px;
  display:flex;
  flex-direction:column;
  gap:8px;
}

.solvedGroup{
  border:1px solid var(--line);
  border-radius:14px;
  padding:10px 12px;
  background: linear-gradient(180deg, #fff, var(--accent3));
}

.solvedTitle{
  font-weight:1000;
  font-size:12px;
  color: var(--muted);
  letter-spacing:.2px;
  margin-bottom:6px;
}

.solvedTerms{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  font-weight:900;
}

.connectionsGrid{
  margin-top:12px;
  display:grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap:10px;
}

.connTile{
  border:1px solid var(--line);
  border-radius:16px;
  padding:12px 10px;
  background:#fff;
  box-shadow: 0 6px 14px rgba(0,0,0,.04);
  font-weight:1000;
  text-align:center;
  cursor:pointer;
  user-select:none;
  min-height:56px;
  display:flex;
  align-items:center;
  justify-content:center;
  line-height:1.15;
}

.connTile.selected{
  outline: 2px solid rgba(0,0,0,.18);
  background: linear-gradient(180deg, #fff, rgba(110,144,202,.25));
}

.connTile.locked{
  opacity:.55;
  cursor:not-allowed;
}

.connectionsActions{
  margin-top:12px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  justify-content:flex-end;
}

.connBtn{
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(0,0,0,.10);
  background:rgba(246,250,255,.92);
  box-shadow: 0 6px 14px rgba(0,0,0,.05);
  font-weight:1000;
  cursor:pointer;
}

.connBtn.primary{
  background: linear-gradient(135deg, rgba(110,144,202,.95), rgba(163,194,223,.95));
}

.connMsg{
  margin-top:10px;
  color: var(--muted);
  font-size:12px;
  font-weight:900;
  letter-spacing:.2px;
}

/* Connections win overlay (trophy) */
.connWinOverlay{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background: rgba(240,247,255,.72);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  z-index:3;
}
.connWinInner{
  display:flex;
  align-items:center;
  gap:12px;
  padding:14px 16px;
  border-radius:18px;
  border:1px solid rgba(126,185,170,.55);
  background: rgba(126,185,170,.14);
  box-shadow: var(--shadow);
  transform: translateY(8px) scale(.98);
  opacity:0;
}
.connWinOverlay.show .connWinInner{
  animation: connWinPop 220ms ease-out both;
}
@keyframes connWinPop{
  from{ opacity:0; transform: translateY(10px) scale(.98); }
  to{ opacity:1; transform: translateY(0) scale(1); }
}
.connTrophy{
  font-size:30px;
  line-height:1;
}
.connWinTitle{
  font-weight:1000;
}
.connWinSub{
  margin-top:2px;
  font-size:12px;
  font-weight:900;
  color: var(--muted);
}



/* Mobile: keep 4 columns but reduce padding */
@media (max-width: 520px){
  .connectionsGrid{ gap:8px; }
  .connTile{ padding:10px 8px; min-height:52px; font-size:13px; }
}


    
/* =========================
   Games hub + full-screen game panes
   ========================= */
.gamesHub{
  display:flex;
  flex-direction:column;
  gap:12px;
  margin-top:10px;
}

.gamesHeroCard{
  display:flex;
  align-items:center;
  justify-content:center;
  min-height:128px;
}

.gamesHeroBrand{
  display:flex;
  align-items:center;
  gap:12px;
  color:rgba(22,45,91,.32);
  text-shadow:0 8px 20px rgba(124,155,206,.16);
  user-select:none;
}

.gamesHeroIcon{
  width:38px;
  height:38px;
  stroke:currentColor;
  stroke-width:2.2;
  fill:none;
  stroke-linecap:round;
  stroke-linejoin:round;
  flex-shrink:0;
}

.gamesHeroText{
  font-size:46px;
  font-weight:1000;
  letter-spacing:.4px;
  line-height:1;
}

@media (max-width:700px){
  .gamesHeroIcon{
    width:30px;
    height:30px;
  }
  .gamesHeroText{
    font-size:36px;
  }
}

.gamePillBtn{
  width:100%;
  text-align:left;
  border:1px solid color-mix(in srgb, var(--line) 70%, var(--accent2) 30%);
  border-radius: var(--radius);
  background: linear-gradient(165deg, color-mix(in srgb, var(--accent3) 42%, #ffffff 58%), color-mix(in srgb, var(--accent2) 20%, #ffffff 80%));
  box-shadow: var(--shadow);
  padding:14px 14px;
  cursor:pointer;
  position:relative;
  overflow:hidden;
  isolation:isolate;
}
.gamePillBtn::before{
  content:"";
  position:absolute;
  inset:0;
  background-image: var(--sectionCardBg);
  background-size: cover;
  background-position:center;
  background-repeat:no-repeat;
  opacity:.17;
  filter:var(--paleBlueBgFilter);
  transform:scale(1.05);
  z-index:0;
  pointer-events:none;
}
.gamePillBtn::after{
  content:"";
  position:absolute;
  inset:0;
  background:var(--paleBlueBgMask);
  pointer-events:none;
  z-index:1;
}
.gamePillBtn > *{ position:relative; z-index:2; }
.gamePillBtn:hover{ filter:brightness(.99); }
.gamePillBtn:active{ transform:translateY(1px); }

.gamePillTitle{
  font-weight:1000;
  font-size:16px;
  margin-bottom:4px;
}
.gamePillDesc{
  color:var(--muted);
  font-size:12.5px;
  line-height:1.25;
}

.beatClockCard{
  position:relative;
  overflow:hidden;
  isolation:isolate;
  background: linear-gradient(165deg, color-mix(in srgb, var(--accent3) 42%, #ffffff 58%), color-mix(in srgb, var(--accent2) 20%, #ffffff 80%));
  border:1px solid color-mix(in srgb, var(--line) 70%, var(--accent2) 30%);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding:14px;
}
.beatClockCard::before{
  content:"";
  position:absolute;
  inset:0;
  background-image: var(--sectionCardBg);
  background-size: cover;
  background-position: center;
  background-repeat:no-repeat;
  opacity:.17;
  filter:var(--paleBlueBgFilter);
  transform:scale(1.05);
  z-index:0;
  pointer-events:none;
}
.beatClockCard::after{
  content:"";
  position:absolute;
  inset:0;
  background:var(--paleBlueBgMask);
  pointer-events:none;
  z-index:1;
}
.beatClockCard > *{ position:relative; z-index:2; }

.bcHeader{
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:space-between;
  flex-wrap:wrap;
}

.bcTopic{
  font-weight:1000;
  font-size:18px;
}

.bcGrid{
  margin-top:12px;
  display:grid;
  grid-template-columns: repeat(4, minmax(0,1fr));
  gap:10px;
}

.bcTile{
  border:1px solid var(--line);
  border-radius:14px;
  padding:12px 10px;
  background:#fff;
  font-weight:900;
  min-height:56px;
  display:flex;
  justify-content:center;
  align-items:center;
  text-align:center;
  cursor:pointer;
  line-height:1.2;
}

.bcTile.selected{
  outline:2px solid rgba(0,0,0,.18);
  background:linear-gradient(180deg,#fff,rgba(110,144,202,.24));
}

.bcTile.correct{
  border-color: rgba(126,185,170,.95);
  background: rgba(126,185,170,.16);
}

.bcTile.wrong{
  border-color: rgba(183,142,161,.95);
  background: rgba(183,142,161,.16);
}

@media (max-width: 680px){
  .bcGrid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
}

.gamePaneTop{
  position:sticky;
  top:0;
  z-index:5;
  background: linear-gradient(180deg, rgba(251,248,246,.95), rgba(251,248,246,.55));
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  padding:6px 0 8px;
  margin-bottom:6px;
}

@media (max-width: 520px){
  .gamePillBtn{ min-height:120px; display:flex; flex-direction:column; justify-content:center; }
  .gamePillTitle{ font-size:18px; }
  .gamePillDesc{ font-size:13px; }
}

/* =========================
       BOTTOM NAV (fixed & safe)
       ========================= */
    nav{
      position:fixed;
      left:0; right:0; bottom:0;
      height: var(--navH);
      padding-bottom: env(safe-area-inset-bottom);
      background: rgba(248,251,255,.96);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-top:1px solid var(--line);
      display:flex;
      z-index:1000;
      transform: translateZ(0);
      will-change: transform;
    }

    /* iOS/Safari can intermittently de-anchor fixed bars during momentum scroll
       when heavy compositing effects are applied. Use a more stable nav surface
       on touch devices to keep the bar pinned to the viewport bottom. */
    @media (hover: none) and (pointer: coarse){
      nav{
        backdrop-filter:none;
        -webkit-backdrop-filter:none;
        background:#fff;
      }
    }
    .navBtn{
      flex:1;
      min-height:44px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:4px;
      font-size:11px;
      color:var(--muted);
      cursor:pointer;
      user-select:none;
      padding:8px 4px;
      line-height:1.2;
    }
    .navIcon{
      width:24px;
      height:24px;
      stroke:currentColor;
      stroke-width:2;
      fill:none;
      stroke-linecap:round;
      stroke-linejoin:round;
      flex-shrink:0;
    }
    .navLabel{ font-size:11px; font-weight:700; }
    .navBtn.active{ color:#1d1d1d; }
    .navBtn.active .navLabel{ font-weight:800; }

    /* Accessibility */
    :focus-visible{ outline: 3px solid rgba(110,144,202,.85); outline-offset: 3px; }
    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; animation:none !important; }
    }


    /* =========================
       STREAK (Duolingo-style hero)
       ========================= */

    /* Clean, controlled streak card (match Daily Challenge card styling) */
    .streakCountPill{
      appearance:none;
      font:inherit;
      color:inherit;
      text-align:center;
      width:80px;
      height:80px;
      padding:8px;
      border-radius:16px;
      background:linear-gradient(180deg,#fff,var(--accent3));
      border:1px solid rgba(110,144,202,.65);
      box-shadow:0 12px 24px rgba(0,0,0,.1);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      flex-shrink:0;
      cursor:pointer;
      margin-top:0;
    }
    .streakCountLabel{
      color:var(--muted);
      font-weight:900;
      font-size:10px;
      letter-spacing:.5px;
      text-transform:uppercase;
    }
    .streakCountNum{
      font-weight:1000;
      font-size:30px;
      line-height:1;
      font-variant-numeric: tabular-nums;
      color:var(--text);
    }
    .streakHeader{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:14px;
      flex-wrap:nowrap;
      position:relative;
    }
    .streakHeader .streakCountPill{
      margin-top:76px;
    }
    .streakHeaderCopy{
      flex:1 1 auto;
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .dailyChallengeCopy{
      margin-top:14px;
    }
    .homeTopBrandRow{
      display:flex;
      align-items:flex-start;
      justify-content:flex-start;
      gap:12px;
      margin-bottom:8px;
    }
    .homeTitleChip{
      justify-self:start;
      align-self:center;
      gap:7px;
    }
    .homeTitleChip .quizPanelTitleText{
      text-transform:none;
      letter-spacing:.1px;
    }
    .educationUpgradeLogo{
      position:absolute;
      top:0;
      right:0;
      flex:0 0 auto;
      text-align:right;
      line-height:.95;
      color:#142846;
      font-weight:500;
      font-family:"Comic Sans MS", "Segoe Script", "Bradley Hand", cursive;
      user-select:none;
      margin:0;
      z-index:1;
    }
    .educationUpgradeLine{
      font-size:clamp(20px, 4.7vw, 30px);
      white-space:nowrap;
    }
    .educationUpgradeLine + .educationUpgradeLine{ margin-top:4px; }
    .educationUpgradeAccent{ color:#72c8ed; }
    .educationUpgradeAsterisk{
      color:#72c8ed;
      font-size:.72em;
      vertical-align:top;
      margin-left:1px;
      display:inline-block;
      transform: translateY(-1px);
    }
    .streakTopicRow{
      display:flex;
      align-items:flex-start;
      gap:10px;
      justify-content:space-between;
    }
    .dailyTopicInline{
      flex:1 1 auto;
      min-width:0;
      color:var(--text);
      font-size:13px;
      line-height:1.35;
      font-weight:500;
      overflow-wrap:anywhere;
    }
    .dailyTopicInline span{
      font-weight:900;
      color:var(--muted);
      margin-right:4px;
    }
    .dailyTopicInline b{
      font-weight:500;
      color:var(--text);
    }
    .streakMiniPill{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.08);
      background:#fff;
      display:flex; align-items:center; gap:8px;
    }
    .streakMiniLabel{
      color:var(--muted);
      font-weight:800;
      font-size:12px;
    }
    .streakMiniNum{
      font-weight:900;
      font-variant-numeric: tabular-nums;
    }
    .streakStatus{
      margin-top:0;
      width:100%;
    }
    .protectBtn{
      background:#ffffff;
      color:#2A6CFF;
      border:1px solid rgba(0,0,0,.10);
      border-radius:14px;
      box-shadow:var(--shadow);
    }

    @media (max-width: 420px){
      .streakCountPill{ width:72px; height:72px; }
      .streakCountNum{ font-size:26px; }
      .educationUpgradeLogo{ max-width:48%; }
      .educationUpgradeLine{ font-size:clamp(18px, 4.5vw, 24px); }
    }

    .streakPillBtn{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background:linear-gradient(180deg,#fff,var(--accent3));
      box-shadow:var(--shadow);
    }
    .streakBubble{
      min-width:34px; height:30px;
      border-radius:999px;
      display:grid; place-items:center;
      font-weight:900;
      background:rgba(110,144,202,.28);
      border:1px solid rgba(110,144,202,.55);
    }

    .streakHero{
      background:linear-gradient(180deg,#fff, var(--accent3));
      position:relative;
      overflow:hidden;
    }
    .streakHero::before{
      content:"";
      position:absolute; inset:-120px -80px auto auto;
      width:320px; height:320px; border-radius:50%;
      background:radial-gradient(circle at 30% 30%, rgba(110,144,202,.45), transparent 60%);
      transform:rotate(18deg);
      pointer-events:none;
    }
    .streakTop{
      display:flex; justify-content:space-between; gap:14px; flex-wrap:wrap; align-items:flex-start;
    }
    .streakBig{
      display:flex; align-items:center; gap:12px;
    }
    
.streakFlame{
      width:52px; height:52px; border-radius:18px;
      display:grid; place-items:center;
      background:linear-gradient(135deg, rgba(110,144,202,.95), rgba(163,194,223,.95));
      border:1px solid rgba(0,0,0,.06);
      box-shadow:var(--shadow);
      font-size:26px;
    }
.streakPillNumStatic{
      font-weight:900;
      font-size:28px;
      color:var(--text);
      text-shadow:none;
}
@keyframes streakPulse{
      0%,100%{ transform:scale(1); filter:saturate(1); }
      50%{ transform:scale(1.05); filter:saturate(1.2); }
    }
    .streakNum{
      font-size:44px;
      font-weight:1000;
      line-height:1;
      letter-spacing:-1px;

      /* flaming number */
      color:var(--accent);
      text-shadow:
        0 0 6px rgba(110,144,202,.45),
        0 0 12px rgba(110,144,202,.32),
        0 0 18px rgba(163,194,223,.28);
      animation: flamePulse 1.6s ease-in-out infinite;
    }
    .streakMeta{
      margin-top:4px;
      color:var(--muted);
      font-size:13px;
    }
    
    .bestStreakPill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:4px 10px;
      border-radius:999px;
      background: rgba(110,144,202,.18);
      border:1px solid rgba(110,144,202,.45);
      color:var(--text);
      font-weight:900;
      letter-spacing:.2px;
    }
    .bestStreakPill .bestLabel{
      font-weight:800;
      font-size:12px;
      color: rgba(38,38,38,.78);
    }
    .bestStreakPill .bestNum{
      font-variant-numeric: tabular-nums;
      font-size:12px;
      padding:2px 8px;
      border-radius:999px;
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      box-shadow: 0 6px 12px rgba(0,0,0,.06);
      color:#000;
    }
.streakStatus{
      display:flex; align-items:center; gap:8px;
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.08);
      background:#fff;
      font-weight:700;
    }
    .streakStatus.risk{
      border-color: rgba(183,142,161,.55);
      background: rgba(183,142,161,.10);
    }
    .streakStatus.safe{
      border-color: rgba(126,185,170,.55);
      background: rgba(126,185,170,.10);
    }
    .countdown{
      font-variant-numeric: tabular-nums;
      font-weight:900;
    }
    .streakRight{
      display:flex; flex-direction:column; gap:10px; min-width:260px;
      align-items:flex-end;
    }
    .weekStrip{
      display:flex; gap:6px; align-items:center; justify-content:flex-end; flex-wrap:wrap;
    }
    .dayBlock{
      width:26px; height:26px; border-radius:9px;
      display:grid; place-items:center;
      font-size:12px;
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      color:var(--muted);
      user-select:none;
    }
    .dayBlock.done{
      background: rgba(126,185,170,.18);
      border-color: rgba(126,185,170,.55);
      color:color-mix(in srgb, var(--good) 70%, #1d4038 30%);
      font-weight:900;
    }
    .dayBlock.missed{
      background: rgba(183,142,161,.12);
      border-color: rgba(183,142,161,.45);
      color:color-mix(in srgb, var(--bad) 72%, #4d3741 28%);
      font-weight:800;
    }
    .milestone{
      width:100%;
      display:flex; align-items:center; gap:10px; justify-content:flex-end;
      color:var(--muted);
      font-size:13px;
    }
    .bar{
      width:220px; height:10px; border-radius:999px;
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(110,144,202,.95), rgba(163,194,223,.95));
      border-right:1px solid rgba(0,0,0,.06);
    }

    .streakChecklist{
      margin-top:12px;
      display:grid; gap:8px;
    }

    #streakHeroCard{
      position:relative;
      overflow:hidden;
      isolation:isolate;
      --dailyTopicBg:none;
      background:linear-gradient(180deg, rgba(248,251,255,.96), rgba(230,239,248,.88));
    }
    #streakHeroCard::before{
      content:"";
      position:absolute;
      inset:0;
      background-image:var(--dailyTopicBg);
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      opacity:.22;
      filter:var(--paleBlueBgFilter);
      transform:scale(1.03);
      pointer-events:none;
      z-index:0;
    }
    #streakHeroCard::after{
      content:"";
      position:absolute;
      inset:0;
      background:var(--paleBlueBgMask);
      pointer-events:none;
      z-index:1;
    }
    #streakHeroCard > *{
      position:relative;
      z-index:2;
    }
    .checkRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
    }
    /* Make the checklist rows behave like clean, tappable buttons */
    .checkRowBtn{
      width:100%;
      cursor:pointer;
      text-align:left;
      appearance:none;
      -webkit-appearance:none;
      font: inherit;
    }
    .checkRowBtn:hover{ border-color: rgba(0,0,0,.16); }
    .checkRowBtn:active{ transform: translateY(1px); }
    .checkRowBtn:focus{ outline:2px solid rgba(110,144,202,.55); outline-offset:2px; }
    .checkLeft{
      display:flex; align-items:center; gap:10px;
      font-weight:800;
    }
    .checkDot{
      width:22px; height:22px; border-radius:8px;
      display:grid; place-items:center;
      border:1px solid rgba(0,0,0,.12);
      background:#fff;
      color: color-mix(in srgb, var(--muted) 88%, var(--accent) 12%);
    }
    .checkDot .checkIcon{
      width:14px;
      height:14px;
      stroke:currentColor;
      stroke-width:2;
      fill:none;
      stroke-linecap:round;
      stroke-linejoin:round;
      flex-shrink:0;
    }
    .checkDot.done{
      background: color-mix(in srgb, var(--accent3) 72%, #fff 28%);
      border-color: color-mix(in srgb, var(--accent) 48%, var(--line) 52%);
      color: color-mix(in srgb, var(--accent) 86%, var(--text) 14%);
    }
    .checkVal{
      color:var(--muted);
      font-weight:800;
      font-variant-numeric: tabular-nums;
    }
    .protectBtn{
      margin-top:12px;
      width:100%;
      padding:10px 12px;
      min-height:44px;
      font:inherit;
      font-weight:900;
      color:var(--text);
      cursor:pointer;
      letter-spacing:.15px;
      transition:none;
    }
    .protectBtn:hover{ border-color: rgba(0,0,0,.16); }
    .protectBtn:active{
      transform:translateY(1px);
      background: color-mix(in srgb, #2A6CFF 10%, #ffffff 90%);
    }

    .recommendedCardTitle{
      font-weight:1000;
      font-size:clamp(17px, 2.3vw, 21px);
      line-height:1.15;
      margin:0;
      white-space:nowrap;
      word-break:normal;
      overflow-wrap:normal;
    }
    .recommendedLabel{ font-weight:900; font-size:15px; margin-top:6px; }
    .recommendedReason{ color:#4a4a4a; font-size:12px; margin-top:5px; }
    .recommendedMeta{ margin-top:6px; }

    .homeSecondaryCard{
      background:rgba(255,255,255,.78);
      border:1px solid rgba(0,0,0,.1);
      box-shadow:0 6px 14px rgba(0,0,0,.05);
      opacity:1;
    }
    .homeSecondaryCard .recommendedCardTitle,
    .homeSecondaryCard .dailyChallengeTitle{
      font-size:14px;
      color:var(--textStrong);
      letter-spacing:.2px;
    }

    .dailyChallengeTitle{
      font-weight:900;
      font-size:14px;
      color:color-mix(in srgb, var(--textStrong) 82%, var(--accent) 18%);
    }

    .streakCompleteBanner{
      border:1px solid color-mix(in srgb, var(--accent) 40%, var(--line) 60%);
      background:linear-gradient(180deg, color-mix(in srgb, var(--accent3) 78%, #fff 22%), color-mix(in srgb, var(--accent2) 38%, #fff 62%));
      border-radius:18px;
      padding:12px;
      display:flex;
      gap:10px;
      align-items:center;
      margin-top:12px;
    }
    .streakCompleteEmoji{ font-size:24px; }
    .streakCompleteTitle{ font-weight:900; }
    .streakCompleteSub{ margin-top:4px; }
    .homeSecondaryCard .streakCountPill{
      background:#fff;
      border:1px solid rgba(0,0,0,.12);
      box-shadow:none;
    }

    .valuePropCard{ padding:12px 14px; }
    .valueHeadline{ font-weight:1000; font-size:18px; line-height:1.2; }
    .valueSubline{ margin-top:4px; color:var(--muted); font-size:13px; line-height:1.3; }

    .homeTertiaryCard{
      background:rgba(240,247,255,.72);
      border:1px solid rgba(0,0,0,.08);
      box-shadow:none;
    }
    .homeTertiaryCard .pill,
    .homeTertiaryCard .note,
    .homeTertiaryCard summary,
    .homeTertiaryCard .kpiMiniLabel,
    .homeTertiaryCard .kpiSep,
    .homeTertiaryCard .streakMiniLabel{
      color:#7a7a7a;
    }

    #home nav,
    nav{
      background: rgba(247,251,255,.9);
    }
    .navBtn{ color:color-mix(in srgb, var(--muted) 86%, var(--accent) 14%); }
    .navBtn.active{ color:var(--accent); }

    @media (max-width:520px){
      .recommendedCardTitle{
        font-size:clamp(20px, 6.2vw, 24px);
      }
      /* Keep both Home cards visible on first load on shorter mobile viewports */
      main{ padding:10px 12px calc(var(--navH) + env(safe-area-inset-bottom) + 12px); }
      .card{ padding:12px; margin-bottom:10px; }
      .recommendedLabel{ margin-top:4px; font-size:14px; }
      .recommendedReason,
      .recommendedMeta{ margin-top:4px; }

      .streakTopicRow{ gap:8px; }
      .homeTopBrandRow{ align-items:center; }
      .educationUpgradeLine{ font-size:clamp(16px, 5vw, 22px); }
      .streakCountPill{ padding:8px 10px; }
      .streakHeader .streakCountPill{ margin-top:66px; }
      .educationUpgradeLogo{ right:8px; }
      .dailyTopicInline{ font-size:12px; }
      .streakCountNum{ font-size:44px; }

      .streakChecklist{ gap:8px; }
      .checkRow{ padding:8px 10px; border-radius:12px; }
      .checkLeft{ gap:8px; font-size:16px; }
      .checkDot{ width:20px; height:20px; }
      .checkDot .checkIcon{ width:12px; height:12px; }
      .protectBtn{ margin-top:10px; padding:10px 12px; }
    }

    .nextUpSheet{
      position:fixed;
      left:0; right:0; bottom:0;
      z-index:10020;
      padding:14px 14px calc(14px + env(safe-area-inset-bottom));
      background:rgba(255,255,255,.98);
      border-top-left-radius:18px;
      border-top-right-radius:18px;
      border:1px solid var(--line);
      box-shadow:0 -14px 24px rgba(0,0,0,.16);
    }
    .magicMetric{
      margin-top:8px;
      font-weight:900;
      font-size:14px;
    }
    .nextUpActions{ display:flex; gap:8px; margin-top:10px; }
    #nextUpPrimaryBtn{
      box-shadow:0 10px 24px rgba(56,88,132,.34);
    }

    .modalBackdrop{
      position:fixed;
      inset:0;
      z-index:10040;
      background:rgba(0,0,0,.34);
      display:grid;
      place-items:center;
      padding:16px;
    }
    .onboardingModal{
      width:min(460px, 100%);
      background:#fff;
      border:1px solid var(--line);
      border-radius:20px;
      box-shadow:0 24px 44px rgba(0,0,0,.2);
      padding:16px;
    }
    .onboardingTitle{ margin:0; font-size:22px; line-height:1.15; }
    .onboardingBullets{ margin:10px 0 0; padding-left:18px; color:var(--text); }
    .onboardingBullets li{ margin-bottom:8px; font-size:14px; }
    .goalOptions{ display:flex; flex-direction:column; gap:8px; margin-top:12px; }
    .goalBtn{
      width:100%;
      text-align:left;
      border:1px solid var(--line);
      background:#fff;
      border-radius:14px;
      padding:11px 12px;
      font-weight:900;
      cursor:pointer;
    }
    .goalBtn.active{
      border-color:rgba(110,144,202,.95);
      background:rgba(230,239,248,.78);
    }

    .debugPanel{
      position:fixed;
      inset:auto 12px calc(var(--navH) + env(safe-area-inset-bottom) + 12px) 12px;
      z-index:10030;
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      box-shadow:var(--shadow);
      padding:12px;
      max-height:52vh;
      overflow:auto;
      font-size:12px;
    }
    .debugPanel h4{ margin:0 0 8px; font-size:13px; }
    .debugPanel pre{ margin:6px 0 0; white-space:pre-wrap; }

    /* Confetti canvas */
    #confettiCanvas{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:9999;
    }
  

/* ===== Flaming streak number ===== */
.streak-display{
  display:flex;
  align-items:center;
  gap:6px;
  justify-content:center;
}
.streak-number{
  font-size:2.6rem;
  font-weight:800;
  color:var(--accent);
  text-shadow:
    0 0 6px rgba(110,144,202,.45),
    0 0 12px rgba(110,144,202,.32),
    0 0 18px rgba(163,194,223,.28);
  animation:flamePulse 1.6s ease-in-out infinite;
}
.streak-flame{
  font-size:2.2rem;
  animation:flameFlicker .9s infinite alternate;
}
@keyframes flamePulse{
  0%{transform:scale(1)}
  50%{transform:scale(1.08)}
  100%{transform:scale(1)}
}
@keyframes flameFlicker{
  from{transform:translateY(0);opacity:.9}
  to{transform:translateY(-2px);opacity:1}
}


/* ===== FORCE: no pulse on main streak number ===== */
.streakNum{
  animation: none !important;
}


/* ===== Restore original streak layout with pill ===== */
.streakBig{
  display:flex;
  align-items:center;
  gap:12px;
}


/* ==========================================================
   Timeline Tension (game)
   ========================================================== */
.timelineLayout{
  display:grid;
  grid-template-columns: 1fr 1.2fr;
  gap:14px;
}
@media (max-width: 780px){
  .timelineLayout{ grid-template-columns:1fr; }
}
.timelinePool{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
.tlChip{
  border:1px solid var(--line);
  background:rgba(247,251,255,.9);
  border-radius:999px;
  padding:10px 12px;
  font-weight:900;
  cursor:pointer;
  box-shadow: 0 6px 14px rgba(0,0,0,.04);
  user-select:none;
}
.tlChip:hover{ filter:brightness(.99); }
.tlChip.isSelected{
  outline:3px solid rgba(110,144,202,.55);
  border-color: rgba(110,144,202,.55);
}
.timelineSlots{
  list-style:decimal;
  margin:0;
  padding-left:18px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.tlSlot{
  border:1px dashed rgba(0,0,0,.16);
  border-radius:14px;
  padding:10px 12px;
  min-height:44px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  background: rgba(242,248,255,.75);
}
.tlSlot strong{ font-weight:1000; }
.tlSlot .tlDate{
  font-weight:1000;
  color:var(--muted);
  font-variant-numeric: tabular-nums;
}
.tlSlot.empty{
  color:var(--muted);
}
.tlSlot button{
  border:none;
  background:transparent;
  cursor:pointer;
  font:inherit;
  text-align:left;
  width:100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.tlSlot.isWrong{
  border-color: rgba(183,142,161,.55);
  background: rgba(183,142,161,.10);
}
.timelineMsg{
  margin-top:10px;
  font-weight:900;
  color:var(--muted);
}
.tlWinOverlay{
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background: rgba(0,0,0,.18);
  z-index:9998;
}
.tlWinInner{
  background: linear-gradient(180deg, rgba(248,251,255,.96), rgba(255,255,255,.86));
  border:1px solid rgba(0,0,0,.10);
  border-radius:18px;
  padding:14px 16px;
  box-shadow: var(--shadow);
  display:flex;
  gap:12px;
  align-items:center;
  max-width: 520px;
  margin: 0 14px;
}
.tlTrophy{ font-size:30px; }
.tlWinTitle{ font-weight:1000; }
.tlWinSub{ color:var(--muted); font-weight:900; font-size:12px; margin-top:2px; }

.splashScreen{
  position:fixed;
  inset:0;
  z-index:10000;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#eaf4ff;
  opacity:1;
  visibility:visible;
  transition: opacity .65s ease, visibility .65s ease;
}
.splashScreen.fadeOut{
  opacity:0;
  visibility:hidden;
  pointer-events:none;
}
.splashImage{
  width:min(82vw, 440px);
  max-width:440px;
  height:auto;
  mix-blend-mode:multiply;
  opacity:.76;
  filter:contrast(1.05) saturate(.9);
}

@media (max-width: 768px){
  .splashImage{
    width:100vw;
    max-width:none;
    height:100vh;
    object-fit:cover;
    opacity:.84;
  }
}

@media (prefers-reduced-motion: reduce){
  .splashScreen{
    transition:none;
  }
}

</style>
</head>

<body>

<div id="splashScreen" class="splashScreen" aria-hidden="true">
  <img class="splashImage" src="./IMG_2166.PNG" alt="" />
</div>

<canvas id="confettiCanvas"></canvas>
<div id="levelUpBanner" class="levelUpBanner" aria-live="polite"></div>

<main>

  <!-- HOME -->
  <section id="home" class="tabpane">
    <div class="card homeSecondaryCard" id="streakHeroCard">
      <div class="streakHeader">
        <div class="streakHeaderCopy">
          <div class="homeTopBrandRow">
            <div class="quizPanelTitle homeTitleChip" aria-hidden="true">
              <svg class="quizPanelTitleIcon" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M3 10.5 12 3l9 7.5"></path><path d="M5 9.5V21h14V9.5"></path></svg>
              <span class="quizPanelTitleText">Home</span>
            </div>
            <div class="educationUpgradeLogo" aria-label="Education Upgrade">
              <div class="educationUpgradeLine">Educ<span class="educationUpgradeAccent">A<span class="educationUpgradeAsterisk">*</span></span>tion</div>
              <div class="educationUpgradeLine">Up<span class="educationUpgradeAccent">9</span>rade</div>
            </div>
          </div>
          <div class="dailyChallengeCopy">
            <div class="dailyChallengeTitle">Daily challenge</div>
            <div class="note" id="streakNote">Complete today’s task to keep your streak</div>
            <div class="streakTopicRow">
              <div class="dailyTopicInline" aria-label="Today's topic">
                <span>Today’s topic:</span>
                <b id="dailyTopicLabel">—</b>
              </div>
            </div>
          </div>
        </div>
        <button class="pill streakCountPill" id="streakProgressBtn" type="button" aria-label="Open progress tab from current streak" title="View progress">
          <span class="streakCountLabel">Streak</span>
          <span class="streakCountNum" id="streakBigNum">0</span>
        </button>
      </div>

      <div id="streakCompleteBanner" class="streakCompleteBanner hidden">
        <div class="streakCompleteEmoji">🏆</div>
        <div>
          <div class="streakCompleteTitle">Daily streak locked</div>
          <div class="note streakCompleteSub">Good work. Your streak is safe for today!</div>
        </div>
      </div>

      <div class="streakChecklist" aria-label="Daily Challenge checklist">
        <button class="checkRow checkRowBtn" id="goDailyFlash" type="button" aria-label="Open flashcards for today's Daily Challenge topic">
          <div class="checkLeft"><span class="checkDot" id="chkFlashDot"><svg class="checkIcon" viewBox="0 0 24 24" aria-hidden="true"><path d="M2 6h6a4 4 0 0 1 4 4v11a3 3 0 0 0-3-3H2z"></path><path d="M22 6h-6a4 4 0 0 0-4 4v11a3 3 0 0 1 3-3h7z"></path><path d="M12 10v11"></path></svg></span> Flashcards</div>
          <div class="checkVal" id="chkFlashVal">0/12</div>
        </button>
        <button class="checkRow checkRowBtn" id="goDailyQuiz" type="button" aria-label="Open topic quiz for today's Daily Challenge topic">
          <div class="checkLeft"><span class="checkDot" id="chkQuizDot"><svg class="checkIcon" viewBox="0 0 24 24" aria-hidden="true"><path d="m13 2-8 12h6l-1 8 8-12h-6z"></path></svg></span> Topic Quiz</div>
          <div class="checkVal" id="chkQuizVal">0% / 100%</div>
        </button>
        <button class="checkRow checkRowBtn" id="goDailyPlan" type="button" aria-label="Open the 25-mark plan for today's Daily Challenge topic">
          <div class="checkLeft"><span class="checkDot" id="chkPlanDot"><svg class="checkIcon" viewBox="0 0 24 24" aria-hidden="true"><rect x="6" y="3" width="12" height="18" rx="2"></rect><path d="M9 8h6"></path><path d="M9 12h6"></path><path d="M9 16h4"></path></svg></span> 25-mark plan</div>
          <div class="checkVal" id="chkPlanVal">Not started</div>
        </button>
      </div>

      <button class="protectBtn" id="protectStreakBtn" type="button">Lock streak</button>
    </div>

    <div class="card valuePropCard homeTertiaryCard">
      <div class="row" style="justify-content:space-between">
        <div>
          <div style="font-weight:900;font-size:16px">Topic Tiles</div>
          <div class="note">Toggle topics that apply to you only. Ask your teacher if you aren't sure!</div>
        </div>
      </div>
      <div class="divider"></div>
      <div id="topicDash" class="topicDash"></div>
    </div>

    <div class="card homeTertiaryCard">
      <details id="homeDetailsAccordion">
        <summary style="font-weight:900;cursor:pointer;list-style:none">Stats</summary>
        <div class="divider" style="margin-top:10px"></div>

        <div class="row" style="gap:8px; flex-wrap:wrap; margin-top:10px">
          <div class="pill streakMiniPill" aria-label="Best streak">
            <span class="streakMiniLabel">Best</span>
            <span class="streakMiniNum" id="streakBestNum">0</span>
          </div>
          <div class="pill streakMiniPill" aria-label="Reset timer">
            <span class="streakMiniLabel">Resets in</span>
            <span class="streakMiniNum countdown" id="streakCountdown">--:--:--</span>
          </div>
        </div>

        <div class="row" style="justify-content:space-between; align-items:center; margin-top:12px">
          <div class="note" style="margin:0">Last 7 days</div>
          <div class="weekStrip" id="weekStrip"></div>
        </div>

        <div class="bannerKpis" aria-label="Quick stats" style="margin-top:12px">
          <div class="kpiPill kpiPillLong" title="Overall progress">
            <div class="kpiLong" aria-label="Progress indicators">
              <div class="kpiItem"><span class="kpiMiniLabel">Minutes this week</span><span class="kpiMiniVal" id="kpiMinutesWeek">0m</span></div>
              <span class="kpiSep" aria-hidden="true">•</span>
              <div class="kpiItem"><span class="kpiMiniLabel">Tasks completed</span><span class="kpiMiniVal" id="kpiTasksWeek">0</span></div>
              <span class="kpiSep" aria-hidden="true">•</span>
              <div class="kpiItem"><span class="kpiMiniLabel">Quiz average</span><span class="kpiMiniVal" id="kpiQuizWeek">0%</span></div>
            </div>
          </div>
        </div>
      </details>
    </div>
  </section>

  <!-- PROGRESS -->
  <section id="progress" class="tabpane hidden">
    <div class="card">
      <div class="quizPanelTitle" aria-hidden="true">
        <svg class="quizPanelTitleIcon" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M4 19h16"></path><path d="M7 16V9"></path><path d="M12 16V5"></path><path d="M17 16v-4"></path></svg>
        <span class="quizPanelTitleText">Progress</span>
      </div>
      <div class="note">A clean view of growth and readiness.</div>

      <div style="margin-top:12px;font-weight:900">Overall readiness <span id="overallReadinessVal">0%</span></div>
      <div class="progressHeadlineBar">
        <div class="progressTrack"><div id="overallReadinessFill" class="progressFill"></div></div>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:900">This week</div>
      <div id="thisWeekMetrics" class="metricGrid"></div>
    </div>

    <div class="card">
      <div style="font-weight:900">Topic XP bars</div>
      <div class="note">XP combines flashcards, quiz best, and exam planning.</div>
      <div class="topicXpArrowKey" aria-label="Arrow legend for topic retention trend">
        <span class="topicXpArrowLegendItem"><span class="topicRetentionArrow up" aria-hidden="true">↑</span><span>improving recall</span></span>
        <span class="topicXpArrowLegendItem"><span class="topicRetentionArrow flat" aria-hidden="true">→</span><span>steady recall</span></span>
        <span class="topicXpArrowLegendItem"><span class="topicRetentionArrow down" aria-hidden="true">↓</span><span>fading recall</span></span>
      </div>
      <div id="topicXpList" class="topicXpList"></div>
    </div>

  </section>

  <div id="topicArrowDialog" class="modalBackdrop hidden" role="dialog" aria-modal="true" aria-live="polite" aria-label="Topic trend explanation">
    <div class="onboardingModal" aria-labelledby="topicArrowDialogTitle" aria-describedby="topicArrowDialogBody">
      <h3 id="topicArrowDialogTitle" class="topicArrowDialogTitle">Topic trend</h3>
      <div id="topicArrowDialogBody" class="topicArrowDialogBody"></div>
      <div id="topicArrowDialogMeta" class="topicArrowDialogMeta"></div>
      <div class="nextUpActions">
        <button type="button" id="topicArrowDialogClose" class="btn primary">Got it</button>
      </div>
    </div>
  </div>

  <!-- STUDY -->
  <section id="study" class="tabpane hidden">
    <div class="studyWrap">
      <!-- FLASHCARD (shown first on mobile) -->
      <div class="card studyCard">
        <div class="studyMetaRow">
          <div class="quizPanelTitle" aria-hidden="true">
            <svg class="quizPanelTitleIcon" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M2 6h6a4 4 0 0 1 4 4v11a3 3 0 0 0-3-3H2z"></path><path d="M22 6h-6a4 4 0 0 0-4 4v11a3 3 0 0 1 3-3h7z"></path><path d="M12 10v11"></path></svg>
            <span class="quizPanelTitleText">Study</span>
          </div>
          <div class="pill" id="cardMeta">🃏 Card 0/0</div>
        </div>

        <div class="divider"></div>

        <div class="flashcardFrame fixedCard" id="flashcardFrame">
<p class="qText" id="qText" aria-live="polite">Pick a topic, then tap “Reveal”.</p>

          <div id="aBox" class="aBox hidden">
            <div id="aText"></div>
          </div>
        </div>

        <button class="btn primary revealBand" id="btnRevealBand" aria-label="Reveal or hide answer"><span class="btnIconLabel"><svg class="navIcon" viewBox="0 0 24 24" aria-hidden="true"><path d="M2 12s4-6 10-6 10 6 10 6-4 6-10 6-10-6-10-6z"></path><circle cx="12" cy="12" r="2.8"></circle></svg><span>Reveal answer</span></span></button>

        <div class="divider"></div>
<div class="emojiRow" style="margin-top:10px">
          <button class="btn emojiBtn" data-score="2" aria-label="Confident" style="border-color: rgba(126,185,170,.55)"><svg class="navIcon" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="9"></circle><path d="M9 10h.01"></path><path d="M15 10h.01"></path><path d="M8.5 14a5 5 0 0 0 7 0"></path></svg></button>
          <button class="btn emojiBtn" data-score="1" aria-label="Unsure" style="border-color: rgba(158,183,212,.55)"><svg class="navIcon" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="9"></circle><path d="M9 10h.01"></path><path d="M15 10h.01"></path><path d="M9 15h6"></path></svg></button>
          <button class="btn emojiBtn" data-score="0" aria-label="Needs focus" style="border-color: rgba(183,142,161,.55)"><svg class="navIcon" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="9"></circle><path d="M9 10h.01"></path><path d="M15 10h.01"></path><path d="M8.5 16a5 5 0 0 1 7 0"></path></svg></button>
        </div>
      </div>

      <!-- START + OPTIONAL ADJUST PANEL -->
      <div class="card studyControls">
        <div class="studyLaunch">
          <div class="studyLaunchMeta">
            <div>
              <p class="studyLaunchTitle" id="studyLaunchTitle">Recommended: Mixed topics</p>
              <p class="studyLaunchHint" id="studyLaunchHint">Use Adjust only if you want to fine-tune filters.</p>
            </div>
            <div class="pill" id="studyLaunchStatus">Ready</div>
          </div>
          <button class="btn primary studyLaunchBtn" id="studyLaunchBtn" type="button"><span class="btnIconLabel"><svg class="navIcon" viewBox="0 0 24 24" aria-hidden="true"><path d="m8 5 11 7-11 7z"></path></svg><span>Start flashcards</span></span></button>
        </div>

        <details class="studyAdjustPanel" id="studyAdjustPanel">
          <summary><span class="btnIconLabel"><svg class="navIcon" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.7 1.7 0 0 0 .34 1.87l.05.05a2 2 0 1 1-2.83 2.83l-.05-.05a1.7 1.7 0 0 0-1.87-.34 1.7 1.7 0 0 0-1 1.55V21a2 2 0 1 1-4 0v-.08a1.7 1.7 0 0 0-1-1.55 1.7 1.7 0 0 0-1.87.34l-.05.05a2 2 0 1 1-2.83-2.83l.05-.05A1.7 1.7 0 0 0 4.6 15a1.7 1.7 0 0 0-1.55-1H3a2 2 0 1 1 0-4h.08a1.7 1.7 0 0 0 1.55-1 1.7 1.7 0 0 0-.34-1.87l-.05-.05a2 2 0 0 1 2.83-2.83l.05.05A1.7 1.7 0 0 0 9 4.6a1.7 1.7 0 0 0 1-1.55V3a2 2 0 1 1 4 0v.08a1.7 1.7 0 0 0 1 1.55 1.7 1.7 0 0 0 1.87-.34l.05-.05a2 2 0 1 1 2.83 2.83l-.05.05A1.7 1.7 0 0 0 19.4 9c.24.64.86 1.05 1.55 1.05H21a2 2 0 1 1 0 4h-.08c-.69 0-1.31.41-1.55 1.05z"></path></svg><span>Adjust filters</span></span></summary>
          <div class="studyAdjustBody">
            <div class="row">
              <div class="grow">
                <label>Topic</label>
                <select id="topicSelect"></select>
              </div>
              <div class="grow" style="min-width:170px">
                <label>Mode</label>
                <select id="modeSelect">
                  <option value="all" selected>All</option>
                  <option value="focus">Focus</option>
                </select>
              </div>
              <div class="grow" style="min-width:160px">
                <label>Order</label>
                <select id="orderSelect">
                  <option value="ordered" selected>In order</option>
                  <option value="random">Random</option>
                </select>
              </div>
              <div class="grow">
              <label>Search</label>
                <input id="searchInput" placeholder="e.g. October Manifesto / War Communism / Russification" />
              </div>
            </div>
          </div>
        </details>
      </div>
    </div>
  </section>


  <!-- QUIZ -->
  <section id="quiz" class="tabpane hidden">
    <div class="quizBackgroundTitle" aria-hidden="true">
      <svg class="quizPanelTitleIcon" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="m13 2-8 12h6l-1 8 8-12h-6z"></path></svg>
      <span class="quizPanelTitleText">Quiz</span>
    </div>
    <div class="card">
      <div id="quizEmpty" class="note">
        Quiz points boost your Home progress score.
      </div>

      <div class="quizLaunch">
        <button class="btn primary quizLaunchBtn" id="btnStartRandomQuiz" type="button"><span class="btnIconLabel"><svg class="navIcon" viewBox="0 0 24 24" aria-hidden="true"><rect x="3" y="3" width="18" height="18" rx="3"></rect><circle cx="9" cy="9" r="1"></circle><circle cx="15" cy="9" r="1"></circle><circle cx="9" cy="15" r="1"></circle><circle cx="15" cy="15" r="1"></circle></svg><span>Start random quiz</span></span></button>
      </div>

      <div id="quizBox" class="hidden">
        <div class="quizMetaGrid">
          <p class="quizMetaLabel" id="quizMeta">Q 1/20</p>
          <div class="quizPanelTitle" aria-hidden="true">
            <svg class="quizPanelTitleIcon" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="m13 2-8 12h6l-1 8 8-12h-6z"></path></svg>
            <span class="quizPanelTitleText">Quiz</span>
          </div>
          <button class="btn small quizDiceBtn hidden" id="btnRandomQuizMini" type="button" aria-label="Start another random quiz"><svg class="navIcon" viewBox="0 0 24 24" aria-hidden="true"><rect x="3" y="3" width="18" height="18" rx="3"></rect><circle cx="9" cy="9" r="1"></circle><circle cx="15" cy="9" r="1"></circle><circle cx="9" cy="15" r="1"></circle><circle cx="15" cy="15" r="1"></circle></svg></button>
        </div>

        <div class="masteryWrap" id="quizMasteryWrap" aria-live="polite">
          <div class="note" id="quizMasteryLabel">Progress: 0%</div>
          <div class="masteryTrack"><div class="masteryFill" id="quizMasteryFill"></div></div>
        </div>

        <div class="divider"></div>

        <p class="qText" id="quizQ"></p>
        <div id="quizChoices" class="row" style="flex-direction:column;align-items:stretch"></div>

        <div class="divider"></div>

        <div class="row" style="justify-content:space-between;gap:8px">
          <div class="note" id="quizExplainer">Tap your answer.</div>
          <div class="row" style="gap:8px;justify-content:flex-end">
            <button class="btn small hidden" id="btnFixIt"><span class="btnIconLabel"><svg class="navIcon" viewBox="0 0 24 24" aria-hidden="true"><path d="M3 12a9 9 0 0 1 15.4-6.4"></path><path d="M18.4 2.8v4.9h-4.9"></path><path d="M21 12a9 9 0 0 1-15.4 6.4"></path><path d="M5.6 21.2v-4.9h4.9"></path></svg><span>Fix-it</span></span></button>
            <button class="btn small" id="btnReviewMisses"><span class="btnIconLabel"><svg class="navIcon" viewBox="0 0 24 24" aria-hidden="true"><path d="M14 5l5 5"></path><path d="M4 20l5-1 10-10a2.8 2.8 0 0 0-4-4L5 15l-1 5z"></path><path d="M3 21h7"></path></svg><span>Review</span></span></button>
            <button class="btn small" id="btnNextQ"><span class="btnIconLabel"><svg class="navIcon" viewBox="0 0 24 24" aria-hidden="true"><path d="M5 12h14"></path><path d="m13 6 6 6-6 6"></path></svg><span>Next</span></span></button>
          </div>
        </div>
      </div>

      <div id="quizReviewBox" class="hidden" style="margin-top:10px">
        <div class="note" style="font-weight:800">Review wrong answers</div>
        <div id="quizReviewList" class="reviewList"></div>
      </div>


      <details style="margin-top:10px;border:1px solid var(--line);border-radius:14px;padding:10px;background:rgba(247,251,255,.9)">
        <summary style="cursor:pointer;font-weight:900">Quiz filters</summary>
        <div class="row" style="margin-top:10px">
          <div class="grow">
            <label>Topic</label>
            <select id="mcqTopicSelect"></select>
          </div>
          <div class="grow" style="min-width:200px">
            <label>Questions</label>
            <select id="mcqCount">
              <option>10</option><option>15</option><option selected>20</option><option>30</option><option>40</option><option>50</option><option>60</option>
            </select>
          </div>
          <div class="grow" style="min-width:190px">
            <label>Style</label>
            <select id="quizModeSelect">
              <option value="standard" selected>Standard</option>
              <option value="exam">Exam mode</option>
            </select>
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn primary" id="btnStartQuiz"><span class="btnIconLabel"><svg class="navIcon" viewBox="0 0 24 24" aria-hidden="true"><path d="m13 2-8 12h6l-1 8 8-12h-6z"></path></svg><span>Go quiz</span></span></button>
          </div>
        </div>
      </details>
    </div>
  </section>

  <div id="quizResultOverlay" class="modalBackdrop hidden" role="dialog" aria-modal="true" aria-live="polite" aria-label="Quiz answer result">
    <div class="onboardingModal quizResultModal">
      <h3 class="onboardingTitle" id="quizResultTitle">Result</h3>
      <div class="quizResultStatus" id="quizResultStatus"></div>
      <div class="note quizResultExplain" id="quizResultExplain"></div>
      <div class="quizResultActions">
        <button class="btn small" id="btnQuizModalNext" type="button"><span class="inlineIconLabel"><svg class="navIcon" viewBox="0 0 24 24" aria-hidden="true"><path d="M5 12h14"></path><path d="m13 6 6 6-6 6"></path></svg><span>Next question</span></span></button>
      </div>
    </div>
  </div>

  <div id="quizCompleteOverlay" class="modalBackdrop hidden" role="dialog" aria-modal="true" aria-live="polite" aria-label="Quiz complete options">
    <div class="onboardingModal quizResultModal">
      <h3 class="onboardingTitle" id="quizCompleteTitle">Quiz complete</h3>
      <div class="quizResultStatus" id="quizCompleteStatus"></div>
      <div class="note quizResultExplain" id="quizCompleteExplain"></div>
      <div class="quizCompleteActions">
        <button class="btn small hidden quizCompleteActionBtn" id="btnQuizCompleteFix" type="button">
          <svg class="quizCompleteActionIcon" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M14 5l5 5"></path><path d="M4 20l5-1 10-10a2.8 2.8 0 0 0-4-4L5 15l-1 5z"></path><path d="M3 21h7"></path></svg>
          <span class="quizCompleteActionLabel">Fix incorrect answers</span>
        </button>
        <button class="btn small hidden quizCompleteActionBtn" id="btnQuizCompleteFlashcards" type="button">
          <svg class="quizCompleteActionIcon" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><rect x="4" y="4" width="14" height="10" rx="2"></rect><path d="M8 8h6"></path><path d="M6 16h14a2 2 0 0 1 0 4H8a2 2 0 0 1-2-2V6a2 2 0 0 0-2-2"></path></svg>
          <span class="quizCompleteActionLabel">Go to flashcards</span>
        </button>
        <button class="btn small quizCompleteActionBtn" id="btnQuizCompleteHome" type="button">
          <svg class="quizCompleteActionIcon" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M3 10.5 12 3l9 7.5"></path><path d="M5 9.5V21h14V9.5"></path></svg>
          <span class="quizCompleteActionLabel">Return to Home</span>
        </button>
        <button class="btn small quizCompleteActionBtn" id="btnQuizCompleteClose" type="button">
          <svg class="quizCompleteActionIcon" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M6 6l12 12"></path><path d="m18 6-12 12"></path></svg>
          <span class="quizCompleteActionLabel">Close</span>
        </button>
      </div>
    </div>
  </div>

  <div id="dailyChallengeCompleteOverlay" class="modalBackdrop hidden" role="dialog" aria-modal="true" aria-live="polite" aria-label="Daily Challenge complete options">
    <div class="onboardingModal quizResultModal">
      <h3 class="onboardingTitle">🏆 Daily Challenge complete!</h3>
      <div class="quizResultStatus good">Streak protected. Keep the momentum going.</div>
      <div class="note quizResultExplain" id="dailyCompleteExplain">Choose your next step.</div>
      <div class="quizCompleteActions">
        <button class="btn small quizCompleteActionBtn" id="btnDailyCompleteFocus" type="button">
          <svg class="quizCompleteActionIcon" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><rect x="4" y="4" width="16" height="16" rx="3"></rect><path d="M8 9h8"></path><path d="M8 13h5"></path><path d="M8 17h8"></path></svg>
          <span class="quizCompleteActionLabel">Review focus cards</span>
        </button>
        <button class="btn small quizCompleteActionBtn" id="btnDailyCompleteHome" type="button">
          <svg class="quizCompleteActionIcon" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M3 10.5 12 3l9 7.5"></path><path d="M5 9.5V21h14V9.5"></path></svg>
          <span class="quizCompleteActionLabel">Return to Home</span>
        </button>
      </div>
    </div>
  </div>

  <!-- GAMES -->
  <section id="games" class="tabpane hidden">
    <div class="card gamesHeroCard">
      <div class="gamesHeroBrand" aria-hidden="true">
        <svg class="gamesHeroIcon" viewBox="0 0 24 24" focusable="false"><rect x="3" y="8" width="18" height="10" rx="4"></rect><path d="M8 13h4"></path><path d="M10 11v4"></path><circle cx="16.5" cy="12" r="1"></circle><circle cx="18.5" cy="14" r="1"></circle></svg>
        <span class="gamesHeroText">Games</span>
      </div>
    </div>

    <!-- Games hub: tap a pill to open a full game screen -->
    <div id="gamesHub" class="gamesHub">
      <button class="gamePillBtn" type="button" id="openConnBtn">
        <div class="gamePillTitle">Connections (Daily)</div>
        <div class="gamePillDesc">Select 4 linked terms. Solve 4 groups of 4 (4 mistakes max).</div>
      </button>

      <button class="gamePillBtn" type="button" id="openEmojiBtn">
        <div class="gamePillTitle">Emoji Multiple Choice</div>
        <div class="gamePillDesc">Pick the best answer from 4. Build accuracy + streaks.</div>
      </button>

      <button class="gamePillBtn" type="button" id="openMatchBtn">
        <div class="gamePillTitle">Match-Up</div>
        <div class="gamePillDesc">Match names to descriptions. Fast discrimination practice.</div>
      </button>

      <button class="gamePillBtn" type="button" id="openTimelineBtn">
        <div class="gamePillTitle">Timeline Tension</div>
        <div class="gamePillDesc">Order key events. Dates reveal only after a perfect timeline.</div>
      </button>

      <button class="gamePillBtn" type="button" id="openBeatClockBtn">
        <div class="gamePillTitle">Beat the Clock</div>
        <div class="gamePillDesc">Pick 4 correct key terms from 8 in 20 seconds. Miss the timer and restart the run.</div>
      </button>
    </div>

    <!-- Connections game screen -->
    <div id="gamesConnPane" class="gamePane hidden">
      <div class="gamePaneTop">
        <button class="btn" type="button" id="backFromConn">← Games</button>
      </div>
      <div class="connectionsCard" id="connectionsGame">
  <div class="connectionsTop">
    <h3>Connections (Daily)</h3>
    <div class="connectionsMeta">
      <label style="display:flex;gap:8px;align-items:center;font-weight:900;color:var(--muted);font-size:12px;">
        Topic
        <select id="connTopicSelect"></select>
      </label>

      <div class="mistakes" title="Mistakes remaining">
        Mistakes:
        <span class="mDot" id="m1"></span>
        <span class="mDot" id="m2"></span>
        <span class="mDot" id="m3"></span>
        <span class="mDot" id="m4"></span>
      </div>
    </div>
  </div>

  <div class="connectionsSolved" id="connSolved"></div>

  <div class="connectionsGrid" id="connGrid"></div>

  <div class="connectionsActions">
    <button class="connBtn" id="connClearBtn" type="button">Clear</button>
    <button class="connBtn primary" id="connSubmitBtn" type="button">Submit 4</button>
  </div>

  <div class="connMsg" id="connMsg"></div>

<div class="connWinOverlay hidden" id="connWinOverlay" aria-live="polite">
  <div class="connWinInner">
    <div class="connTrophy">🏆</div>
    <div>
      <div class="connWinTitle">Full game complete!</div>
      <div class="connWinSub">Nice work.</div>
    </div>
  </div>
</div>
</div>
    </div>

    <!-- Emoji game screen -->
    <div id="gamesEmojiPane" class="gamePane hidden">
      <div class="gamePaneTop">
        <button class="btn" type="button" id="backFromEmoji">← Games</button>
      </div>
      <div class="card">
      <div class="row">
        <div class="grow">
          <label>Topic</label>
          <select id="emojiTopicSelect"></select>
        </div>
        <div class="grow" style="min-width:200px">
          <label>Mode</label>
          <select id="emojiMode">
            <option value="terms" selected>Key terms</option>
            <option value="people">Key characters</option>
            <option value="mixed">Mixed</option>
          </select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="btn primary" id="btnStartEmoji">🎯 New round</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row" style="justify-content:space-between">
        <div class="pill" id="emojiMeta">0 correct • 0 attempted</div>
        <div class="pill" id="emojiHelp">Pick the best answer from 4.</div>
      </div>

      <div class="row" style="justify-content:space-between;margin-top:10px">
        <div class="pill" id="emojiStreakPill">🔥 Streak: 0</div>
        <div class="pill" id="emojiBestStreakPill">🏆 Best: 0</div>
      </div>

      <div class="divider"></div>

      <div style="font-size:36px;text-align:center;padding:14px;border:1px solid var(--line);border-radius:16px;background:#fff" id="emojiClue">🎭 🧠 📚</div>
      <div class="choiceGrid" id="emojiChoices"></div>
    </div>
    </div>

    <!-- Match game screen -->
    <div id="gamesMatchPane" class="gamePane hidden">
      <div class="gamePaneTop">
        <button class="btn" type="button" id="backFromMatch">← Games</button>
      </div>
      <div class="card">
      <div class="matchControls">
        <div>
          <label>Topic</label>
          <select id="matchTopicSelect"></select>
        </div>
        <div>
          <label>Difficulty</label>
          <select id="matchDifficulty">
            <option value="8">8 pairs</option>
            <option value="10" selected>10 pairs</option>
            <option value="12">12 pairs</option>
          </select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="btn primary" id="btnStartMatch">🧩 New game</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row" style="justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div class="pill" id="matchMeta">Pairs: 0 • Correct: 0</div>
        <div class="pill" id="matchHelp">Pick a name first, then choose the best matching description.</div>
      </div>

      <div class="matchStatusGrid">
        <div class="pill" id="matchStreakPill">🔥 Streak: 0</div>
        <div class="pill" id="matchBestStreakPill">🏆 Best: 0</div>
      </div>

      <div class="matchStatusGrid">
        <div class="matchFocus">
          <div class="matchFocusTitle">Selected name</div>
          <div class="matchFocusText empty" id="matchSelectedName">None selected yet.</div>
        </div>
        <div class="matchFocus">
          <div class="matchFocusTitle">Selected description</div>
          <div class="matchFocusText empty" id="matchSelectedDesc">None selected yet.</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="matchGrid">
        <div class="matchCol">
          <div class="matchColHead">Tap a name first</div>
          <div class="matchList" id="matchNames"></div>
        </div>
        <div class="matchCol">
          <div class="matchColHead">Then tap the best matching description</div>
          <div class="matchList" id="matchDescs"></div>
        </div>
      </div>

      <div class="divider"></div>
      <div class="note">Tip: use key words (policy, dates, role) to eliminate distractors quickly.</div>
    </div>
    </div>
    <!-- Beat the Clock game screen -->
    <div id="gamesBeatClockPane" class="gamePane hidden">
      <div class="gamePaneTop">
        <button class="btn" type="button" id="backFromBeatClock">← Games</button>
      </div>
      <div class="beatClockCard">
        <div class="bcHeader">
          <div>
            <div style="font-weight:1000;font-size:16px">⏱️ Beat the Clock</div>
            <div class="note">Find the 4 key terms before the timer hits zero.</div>
          </div>
          <button class="btn primary" id="btnStartBeatClock" type="button">🚀 Start run</button>
        </div>

        <div class="divider"></div>

        <div class="row" style="justify-content:space-between;gap:10px;flex-wrap:wrap">
          <div class="pill" id="bcTopicPill">Topic: —</div>
          <div class="pill" id="bcTimerPill">⏳ 15s</div>
          <div class="pill" id="bcRoundPill">Run: 0</div>
          <div class="pill" id="bcBestPill">🏆 Best run: 0</div>
        </div>

        <div class="divider"></div>

        <div class="bcTopic" id="bcPrompt">Tap Start run when you’re ready.</div>
        <div class="bcGrid" id="bcGrid"></div>

        <div class="connectionsActions" style="justify-content:flex-start">
          <button class="connBtn primary" id="bcSubmitBtn" type="button" disabled>✅ Lock in 4</button>
          <button class="connBtn" id="bcClearBtn" type="button" disabled>Clear</button>
        </div>

        <div class="connMsg" id="bcMsg">You have 20 seconds per round.</div>
      </div>
    </div>

    <!-- Timeline Tension game screen -->
    <div id="gamesTimelinePane" class="gamePane hidden">
      <div class="gamePaneTop">
        <button class="btn" type="button" id="backFromTimeline">← Games</button>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between;gap:10px;flex-wrap:wrap">
          <div class="grow" style="min-width:220px">
            <label>Topic</label>
            <select id="timelineTopicSelect"></select>
          </div>
          <div class="grow" style="min-width:220px">
            <label>Difficulty</label>
            <select id="timelineSize">
              <option value="6">6 events</option>
              <option value="8" selected>8 events</option>
              <option value="10">10 events</option>
            </select>
          </div>
          <div style="display:flex;gap:8px;align-items:flex-end">
            <button class="btn primary" id="btnStartTimeline" type="button">⏳ New timeline</button>
            <button class="btn" id="btnResetTimeline" type="button">Reset</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row" style="justify-content:space-between;gap:10px;flex-wrap:wrap">
          <div class="pill" id="timelineHelp">Build the timeline in order. Unlock dates with a perfect run.</div>
          <button class="btn" id="btnCheckTimeline" type="button" disabled>✅ Check timeline</button>
        </div>

        <div class="timelineLayout" style="margin-top:12px">
          <div class="timelineBank">
            <div class="note" style="margin:0 0 8px 0;font-weight:900">Unplaced events</div>
            <div id="timelinePool" class="timelinePool"></div>
          </div>

          <div class="timelineBoard">
            <div class="note" style="margin:0 0 8px 0;font-weight:900">Your timeline</div>
            <ol id="timelineSlots" class="timelineSlots"></ol>
            <div class="timelineMsg" id="timelineMsg"></div>
          </div>
        </div>

        <div class="tlWinOverlay hidden" id="tlWinOverlay" aria-live="polite">
          <div class="tlWinInner">
            <div class="tlTrophy">🏆</div>
            <div>
              <div class="tlWinTitle">Timeline complete!</div>
              <div class="tlWinSub">Dates unlocked — nice work.</div>
            </div>
          </div>
        </div>

      </div>
    </div>

  </section>

  <!-- EXAM -->
  <section id="exam" class="tabpane hidden">
    <div class="card">
      <div class="homeTopBrandRow" style="margin-bottom:4px">
        <div class="quizPanelTitle homeTitleChip">
          <svg class="quizPanelTitleIcon" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><rect x="6" y="3" width="12" height="18" rx="2"></rect><path d="M9 8h6"></path><path d="M9 12h6"></path><path d="M9 16h4"></path></svg>
          <span class="quizPanelTitleText">Exam</span>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <div class="grow">
          <label>Topic filter</label>
          <select id="examTopicSelect"></select>
        </div>
        <div class="grow">
          <label>Question</label>
          <select id="examSelect"></select>
        </div>
      </div>

      <div class="divider"></div>

      <div style="border:1px solid var(--line);border-radius:16px;padding:12px;background:#fff">
        <div class="note">25-mark question</div>
        <div class="qText" id="examQText">Pick a question to get started.</div>
        <div class="note" id="examTag" style="margin-top:6px"></div>
      </div>

      <div class="divider"></div>
      <div class="note">Game plan (3–4 factors)</div>
      <div id="examPlan" style="margin-top:10px"></div>

      <div class="divider"></div>

      <details id="examHelp" style="border:1px solid var(--line);border-radius:16px;padding:10px;background:#fff">
        <summary style="cursor:pointer;font-weight:900;list-style:none">🧰 Hints (tap to reveal key knowledge)</summary>
        <div class="divider"></div>
        <div id="examHelpBody" class="note"></div>
      </details>
    </div>

    <div class="card">
      <div style="font-weight:900">Level 5 habits</div>
      <ul class="note" style="margin:10px 0 0 18px">
        <li><b>Stay on the wording</b> (“half-hearted”, “mainly”, “more important than”).</li>
        <li><b>Factor structure</b>: 3–4 factors, each weighed (reach, timing, impact).</li>
        <li><b>Precise evidence</b>: dates + named policies + clear consequence.</li>
        <li><b>Judgement</b>: not just “both” — explain why one matters more.</li>
      </ul>
    </div>
  </section>

  <!-- SETTINGS (includes Progress) -->
  <section id="settings" class="tabpane hidden">
    <div class="card">
      <div style="font-weight:900;font-size:16px">⚙️ Settings</div>
      <div class="note" style="margin-top:6px">Progress lives here (export/import/reset).</div>

      <div class="divider"></div>

      <button class="btn" id="btnExport">📤 Export progress</button>
      <button class="btn" id="btnImport" style="margin-left:8px">📥 Import progress</button>

      <div class="divider"></div>

      <label>Export / Import box</label>
      <textarea id="dataBox" rows="8" placeholder="Your export appears here. Drop JSON here to import."></textarea>

      <div class="divider"></div>

      <button class="btn" id="btnReset" style="border-color: rgba(183,142,161,.35);">🧨 Reset all progress</button>
    </div>

    <div class="card">
      <div style="font-weight:900">How this app works</div>
      <div class="note" style="margin-top:10px">
        <ul style="margin:0 0 0 18px">
          <li>Quiz auto-generates 30+ questions per topic from FACT_BANK.</li>
          <li>Emoji clues are in EMOJI_BANK — easy to expand.</li>
          <li>Exam questions are in EXAM_BANK (3 per topic enforced).</li>
        </ul>
      </div>
    </div>
  </section>

</main>

<!-- Bottom nav -->
<nav>
  <div class="navBtn active" data-tab="home"><svg class="navIcon" viewBox="0 0 24 24" aria-hidden="true"><path d="M3 10.5 12 3l9 7.5"></path><path d="M5 9.5V21h14V9.5"></path></svg><div class="navLabel">Home</div></div>
  <div class="navBtn" data-tab="progress"><svg class="navIcon" viewBox="0 0 24 24" aria-hidden="true"><path d="M4 19h16"></path><path d="M7 16V9"></path><path d="M12 16V5"></path><path d="M17 16v-4"></path></svg><div class="navLabel">Progress</div></div>
  <div class="navBtn" data-tab="study"><svg class="navIcon" viewBox="0 0 24 24" aria-hidden="true"><path d="M2 6h6a4 4 0 0 1 4 4v11a3 3 0 0 0-3-3H2z"></path><path d="M22 6h-6a4 4 0 0 0-4 4v11a3 3 0 0 1 3-3h7z"></path><path d="M12 10v11"></path></svg><div class="navLabel">Study</div></div>
  <div class="navBtn" data-tab="quiz"><svg class="navIcon" viewBox="0 0 24 24" aria-hidden="true"><path d="m13 2-8 12h6l-1 8 8-12h-6z"></path></svg><div class="navLabel">Quiz</div></div>
  <div class="navBtn" data-tab="games"><svg class="navIcon" viewBox="0 0 24 24" aria-hidden="true"><rect x="3" y="8" width="18" height="10" rx="4"></rect><path d="M8 13h4"></path><path d="M10 11v4"></path><circle cx="16.5" cy="12" r="1"></circle><circle cx="18.5" cy="14" r="1"></circle></svg><div class="navLabel">Games</div></div>
  <div class="navBtn" data-tab="exam"><svg class="navIcon" viewBox="0 0 24 24" aria-hidden="true"><rect x="6" y="3" width="12" height="18" rx="2"></rect><path d="M9 8h6"></path><path d="M9 12h6"></path><path d="M9 16h4"></path></svg><div class="navLabel">Exam</div></div>
  <div class="navBtn" data-tab="settings"><svg class="navIcon" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.7 1.7 0 0 0 .34 1.87l.05.05a2 2 0 1 1-2.83 2.83l-.05-.05a1.7 1.7 0 0 0-1.87-.34 1.7 1.7 0 0 0-1 1.55V21a2 2 0 1 1-4 0v-.08a1.7 1.7 0 0 0-1-1.55 1.7 1.7 0 0 0-1.87.34l-.05.05a2 2 0 1 1-2.83-2.83l.05-.05A1.7 1.7 0 0 0 4.6 15a1.7 1.7 0 0 0-1.55-1H3a2 2 0 1 1 0-4h.08a1.7 1.7 0 0 0 1.55-1 1.7 1.7 0 0 0-.34-1.87l-.05-.05a2 2 0 0 1 2.83-2.83l.05.05A1.7 1.7 0 0 0 9 4.6a1.7 1.7 0 0 0 1-1.55V3a2 2 0 1 1 4 0v.08a1.7 1.7 0 0 0 1 1.55 1.7 1.7 0 0 0 1.87-.34l.05-.05a2 2 0 1 1 2.83 2.83l-.05.05A1.7 1.7 0 0 0 19.4 9c.24.64.86 1.05 1.55 1.05H21a2 2 0 1 1 0 4h-.08c-.69 0-1.31.41-1.55 1.05z"></path></svg><div class="navLabel">Settings</div></div>
</nav>

<div id="nextUpSheet" class="nextUpSheet hidden" role="dialog" aria-live="polite" aria-label="Next up recommendation">
  <div style="font-weight:900">Next up</div>
  <div id="nextUpReason" class="note" style="margin-top:4px"></div>
  <div class="nextUpActions">
    <button class="btn primary" id="nextUpPrimaryBtn" type="button">Let's go</button>
    <button class="btn" id="nextUpDismissBtn" type="button">Later</button>
  </div>
</div>

<div id="magicMomentSheet" class="nextUpSheet hidden" role="dialog" aria-live="polite" aria-label="Progress moment">
  <div style="font-weight:900">Nice — that counted.</div>
  <div class="note" style="margin-top:4px">You're building momentum for exam day.</div>
  <div id="magicMomentMetric" class="magicMetric">Tasks today: 1</div>
  <div class="nextUpActions">
    <button class="btn primary" id="magicMomentNextBtn" type="button">Next task</button>
    <button class="btn" id="magicMomentDismissBtn" type="button">Not now</button>
  </div>
</div>

<div id="onboardingOverlay" class="modalBackdrop hidden" role="dialog" aria-modal="true" aria-live="polite" aria-label="Welcome">
  <div class="onboardingModal">
    <div id="onboardingStep1">
      <h3 class="onboardingTitle">How this helps your grades</h3>
      <ul class="onboardingBullets">
        <li>Daily tasks matched to what you need most</li>
        <li>Quick quiz + flashcards + exam practice</li>
        <li>Track streak + mastery by topic</li>
      </ul>
      <button class="btn primary" id="onboardingNextBtn" type="button" style="margin-top:10px;width:100%">Start my 10 minutes</button>
    </div>
    <div id="onboardingStep2" class="hidden">
      <h3 class="onboardingTitle">Pick your goal</h3>
      <div class="goalOptions">
        <button class="goalBtn" data-goal="pass" type="button">Just pass</button>
        <button class="goalBtn" data-goal="aim_high" type="button">Aim high</button>
        <button class="goalBtn" data-goal="top" type="button">Top grades</button>
      </div>
      <button class="btn primary" id="onboardingDoneBtn" type="button" style="margin-top:12px;width:100%">Let's go</button>
    </div>
  </div>
</div>

<div id="debugPanel" class="debugPanel hidden" role="region" aria-label="Recommendation debug panel">
  <h4>Recommendation debug</h4>
  <div id="debugReco"></div>
  <pre id="debugCandidates"></pre>
  <div id="debugMetrics" style="margin-top:8px"></div>
</div>

<script>
/* ==========================================================
   TOPICS (SoW order)
   ========================================================== */
const TOPICS = [
  { id:"t1", title:"1. Preserving Autocracy 1855-1894" },
  { id:"t2", title:"2. Failure of Autocracy 1894-1917" },
  { id:"t3", title:"3. Establishing Communist Rule 1917-1941" },
  { id:"t4", title:"4. Stalinist Dictatorship and reaction 1941-1964" }
];

/* ==========================================================
   FACT_BANK (UNCHANGED content - fully populated)
   ========================================================== */
const FACT_BANK = {
  t1: {
    title: "1. Preserving Autocracy 1855-1894",
    terms:[
    {
        "term": "Holy Synod",
        "date": "",
        "meaning": "The highest governing body of the Russian Orthodox Church.",
        "significance": "Controlled by the state via the Over-Procurator, it limited the Church's independence and ensured its loyalty to the Tsar."
    },
    {
        "term": "Over-Procurator",
        "date": "",
        "meaning": "The chief lay (non-religious) official appointed by the Tsar to oversee the Holy Synod.",
        "significance": "Represented the government and held major influence over religious, educational, and social policies."
    },
    {
        "term": "Emancipation of the Serfs",
        "date": "1861",
        "meaning": "The Edict that legally freed 23 million privately owned serfs.",
        "significance": "A monumental event in Russian history, but its impact was limited by redemption payments, poor land quality, and continued control by the mir."
    },
    {
        "term": "Redemption Payments",
        "date": "",
        "meaning": "Payments serfs had to make to the state over 49 years to buy the land allotments granted to them after emancipation.",
        "significance": "Kept many peasants trapped in a cycle of debt, restricting their social mobility and limiting the true extent of social change."
    },
    {
        "term": "Mir",
        "date": "",
        "meaning": "Village communes that maintained tight control over individual peasants in rural areas.",
        "significance": "Post-emancipation, its control over peasants effectively replaced the control of the noble, restricting freedom of movement and enterprise."
    },
    {
        "term": "Zemstva",
        "date": "",
        "meaning": "Elected local councils established by Alexander II’s local government reform.",
        "significance": "Created new opportunities for the educated middle classes and improved public services, but their power was limited and they were dominated by nobles."
    },
    {
        "term": "Dmitry Tolstoy",
        "date": "",
        "meaning": "Minister of Education under Alexander II who adopted a reactionary policy in the later part of the reign.",
        "significance": ""
    },
    {
        "term": "Konstantin Pobedonostsev",
        "date": "",
        "meaning": "Over-Procurator of the Holy Synod, staunch conservative, and tutor to Alexander III and Nicholas II.",
        "significance": "A major influence on Alexander III's reactionary policies, indoctrinating Nicholas II in the principles of orthodoxy, autocracy, and nationalism."
    },
    {
        "term": "Russification",
        "date": "",
        "meaning": "A policy, intensified under Alexander III, aiming to consolidate Russian culture and language at the expense of other ethnic groups.",
        "significance": "Fostered intense resentment and anti-Tsarist sentiment among non-Russian populations, ultimately weakening the regime."
    },
    {
        "term": "Kulaks",
        "date": "",
        "meaning": "A class of more prosperous peasants who bought land after the Emancipation of the Serfs.",
        "significance": "Their emergence demonstrated limited social change, but also deepened rural inequality between the wealthier peasants and the poorer, landless laborers."
    },
    {
        "term": "Autocracy",
        "date": "",
        "meaning": "A system of government where the Tsar held absolute, unquestionable power.",
        "significance": ""
    },
    {
        "term": "Tsar Liberator",
        "date": "",
        "meaning": "Nickname given to Alexander II for his major reforms, especially the Emancipation of the Serfs.",
        "significance": ""
    },
    {
        "term": "Manifesto of Unshakeable Autocracy",
        "date": "1881",
        "meaning": "A proclamation by Alexander III at the start of his reign, asserting his commitment to absolute rule.",
        "significance": "Signalled the end of the liberal reforms and ushered in a period of conservative reaction and repression."
    },
    {
        "term": "Law on Exceptional Measures",
        "date": "",
        "meaning": "A law issued by Alexander III granting local commanders emergency powers to use military courts and arbitrary imprisonment.",
        "significance": ""
    },
    {
        "term": "Dmitry Milyutin",
        "date": "",
        "meaning": "War Minister under Alexander II responsible for significant military reforms.",
        "significance": ""
    },
    {
        "term": "Loris-Melikov Proposals",
        "date": "",
        "meaning": "Constitutional proposals put forward by Minister of the Interior Loris-Melikov, suggesting the inclusion of elected representatives in government bodies.",
        "significance": "The assassination of Alexander II prevented their implementation; Alexander III's accession led to their abandonment, confirming the reactionary turn."
    },
    {
        "term": "Crimean War",
        "date": "1853–1856",
        "meaning": "A military conflict resulting in Russia's defeat by the allied forces (Britain, France, Turkey, Sardinia).",
        "significance": "Shattered the myth of Russian might and forced Alexander II to adopt sweeping internal reforms and industrialisation to modernise the military and economy."
    },
    {
        "term": "Military Reforms (1861-1874)",
        "date": "",
        "meaning": "Restructuring of the army under Dmitry Milyutin, including universal conscription and reduced service terms.",
        "significance": ""
    },
    {
        "term": "Judicial Reforms",
        "date": "1864",
        "meaning": "Reforms introducing trial by jury, the principle of 'innocent until proven guilty,' and public courts.",
        "significance": "Represented a significant move towards a modern, fairer legal system, but also gave the intelligentsia a public platform to criticise the regime."
    },
    {
        "term": "Trial by Jury",
        "date": "",
        "meaning": "The introduction of a jury system in judicial proceedings.",
        "significance": ""
    },
    {
        "term": "Local Justices of Peace",
        "date": "",
        "meaning": "Minor legal officials elected by the Zemstva for 3-year terms, free from political control.",
        "significance": "Provided local, faster justice and were a key part of the judicial reform that reduced the power of central government in legal matters."
    },
    {
        "term": "Education Reforms (under Alexander II)",
        "date": "",
        "meaning": "Changes that opened schools to all social classes and placed schooling under the control of the Zemstva rather than the Church.",
        "significance": "Improved literacy rates and created new opportunities for the educated middle classes, but also led to increased radical opposition."
    },
    {
        "term": "Third Section",
        "date": "",
        "meaning": "The secret police force of the Russian Empire, part of the Imperial Chancellery.",
        "significance": ""
    },
    {
        "term": "Intelligentsia",
        "date": "",
        "meaning": "The educated social class of writers, thinkers, doctors, teachers, and administrators.",
        "significance": "A key source of both liberal reform and radical opposition, often alienated by the limitations of reform and the refusal of the Tsars to grant greater political consultation."
    },
    {
        "term": "Nihilists",
        "date": "",
        "meaning": "Intellectuals who rejected all traditional values and institutions, seeking a complete overhaul of society.",
        "significance": "Represented one of the earliest forms of radical opposition, calling for fundamental change."
    },
    {
        "term": "Populists (Narodniks)",
        "date": "",
        "meaning": "Revolutionary group that advocated for socialism based on the peasant communes (Mir).",
        "significance": "Believed in direct action, including 'going to the people' to incite revolution, and later turned to terrorism after their failure to gain peasant support."
    },
    {
        "term": "Land and Liberty",
        "date": "",
        "meaning": "A key Populist (Narodnik) organisation committed to revolutionary change.",
        "significance": ""
    },
    {
        "term": "The People's Will (Narodnaya Volya)",
        "date": "",
        "meaning": "The revolutionary group that separated from Land and Liberty, dedicated to political violence and terrorism.",
        "significance": "Successfully assassinated Tsar Alexander II in 1881, which inadvertently triggered the reactionary policies of Alexander III."
    },
    {
        "term": "Marxist Theory (Karl Marx)",
        "date": "",
        "meaning": "An ideology advocating for a classless society, predicting that industrialisation would lead to a proletariat revolution.",
        "significance": "Its ideas spread among the intelligentsia, providing an intellectual basis for the later Social Democratic movement."
    },
    {
        "term": "Social Democratic Movement",
        "date": "",
        "meaning": "A political movement based on Marxist principles, focused on the urban working class.",
        "significance": "Began to take root in Russia, later splitting into the Mensheviks and Bolsheviks, and offering a new, long-term threat to the autocracy."
    },
    {
        "term": "Socialist Revolutionary Party",
        "date": "",
        "meaning": "A group that emerged from the populist tradition, advocating for agrarian socialism and the use of terrorism.",
        "significance": "Focused on the needs of the peasantry, becoming a major political force and revolutionary threat in the early 20th century."
    },
    {
        "term": "Tchaikovsky Circle",
        "date": "",
        "meaning": "A small group of intellectual radicals focused on spreading revolutionary ideas through educational materials.",
        "significance": "An early example of non-violent, intellectual opposition that was soon superseded by more violent revolutionary tactics."
    },
    {
        "term": "Tax Farming",
        "date": "",
        "meaning": "A historical practice where the government outsourced tax collection to private individuals, who kept any surplus they collected.",
        "significance": ""
    },
    {
        "term": "Indirect Taxation",
        "date": "",
        "meaning": "Taxes collected by an intermediary (like a retailer) on goods bought, such as tax on goods in shops.",
        "significance": ""
    },
    {
        "term": "Tariffs",
        "date": "",
        "meaning": "Taxes imposed by a government on imported or exported goods.",
        "significance": ""
    },
    {
        "term": "Capital",
        "date": "",
        "meaning": "Wealth in the form of money or assets, used or invested in a business to generate more wealth.",
        "significance": ""
    },
    {
        "term": "Famine",
        "date": "1891–1892",
        "meaning": "A severe shortage of food, particularly in rural areas, that led to widespread hunger and high mortality rates.",
        "significance": "Exposed the failure of agricultural policy and led to increased social and political polarisation."
    },
    {
        "term": "Mikhail von Reutern",
        "date": "",
        "meaning": "Finance Minister under Alexander II.",
        "significance": "Introduced key reforms (like the abolition of tax farming and the establishment of the State Bank) and oversaw an annual growth rate of 6%."
    },
    {
        "term": "Ivan Vyshnegradsky",
        "date": "",
        "meaning": "Finance Minister under Alexander III.",
        "significance": "Focused on increasing grain exports ('We must starve ourselves but export'), which successfully built up a gold reserve but contributed to the Great Famine of 1891-92."
    },
    {
        "term": "Sergei Witte",
        "date": "",
        "meaning": "Finance Minister who began his term under Alexander III and contunued under Nicolas II.",
        "significance": "Continued the drive for industrialisation, expanding the railway network and encouraging foreign investment; policies which laid the foundation for long-term economic growth."
    },
    {
        "term": "Grain Requisitioning",
        "date": "",
        "meaning": "The process by which the government takes or demands grain from farmers, often without fair compensation.",
        "significance": "Used to bolster capital for government investment, often at the expense of the peasantry who subsequently suffered from famine."
    },
    {
        "term": "Peasants’ Land Bank",
        "date": "1883",
        "meaning": "A state bank established to help peasants purchase land.",
        "significance": "A government attempt to improve the agrarian situation, but it mainly benefited the wealthier peasants (kulaks), deepening rural inequality."
    },
    {
        "term": "Grain Exports",
        "date": "",
        "meaning": "The sale of Russian grain to foreign countries.",
        "significance": "The primary source of state capital under Vyshnegradsky, achieved at high human cost, as it reduced the amount of grain available for the Russian population."
    },
    {
        "term": "Noble's Land Bank",
        "date": "",
        "meaning": "A bank established to help the nobility pay off mortgages and keep their land.",
        "significance": "Highlighted the financial struggles of the landed elite post-emancipation and was a government effort to support the traditional ruling class."
    },
    {
        "term": "Serfdom",
        "date": "",
        "meaning": "The practice where 23 million people were tied to the land and subject to the control of their noble landowners.",
        "significance": ""
    },
    {
        "term": "Middle Class (bourgeoisie)",
        "date": "",
        "meaning": "A growing social segment of bankers, doctors, teachers, and administrators, primarily in urban areas.",
        "significance": ""
    },
    {
        "term": "Urban Working Class (Proletariat)",
        "date": "",
        "meaning": "Former peasants who migrated to cities to work in the new factories.",
        "significance": ""
    },
    {
        "term": "St. Petersburg",
        "date": "",
        "meaning": "The imperial capital and a major centre of urbanisation and industrial growth.",
        "significance": ""
    },
    {
        "term": "Treaty of Paris",
        "date": "1856",
        "meaning": "The treaty that formally ended the Crimean War.",
        "significance": ""
    },
    {
        "term": "Polish Rebellion",
        "date": "1863",
        "meaning": "An uprising against Russian rule in the Kingdom of Poland.",
        "significance": ""
    },
    {
        "term": "Pale of Settlement",
        "date": "",
        "meaning": "The designated territory in Western Russia where Jews were permitted to reside.",
        "significance": "A tool of segregation and discrimination, and the site of increased persecution and violence (pogroms) under Alexander III."
    },
    {
        "term": "May Laws",
        "date": "1882",
        "meaning": "Anti-Semitic laws that severely restricted the rights of Jews, particularly concerning residency and economic activities.",
        "significance": "Banned Jews from living in rural areas within the Pale of Settlement, fueling widespread prejudice and encouraging Jewish emigration."
    },
    {
        "term": "Pogroms",
        "date": "",
        "meaning": "Violent anti-Jewish riots, often with the tacit or explicit approval of local authorities.",
        "significance": ""
    },
    {
        "term": "Westernisers",
        "date": "",
        "meaning": "Intellectuals who believed Russia should follow the political and economic models of Western Europe (liberal democracy, industrialisation).",
        "significance": "Their ideas were influential in the early reforms of Alexander II but were later suppressed under the conservative Tsars."
    },
    {
        "term": "Slavophiles",
        "date": "",
        "meaning": "Intellectuals who believed Russian development should be based on its unique national traditions, including Orthodox faith and the peasant commune.",
        "significance": "Provided an ideological basis for the conservative, nationalistic policies of Alexander III, such as Russification."
    },
    {
        "term": "Orthodoxy",
        "date": "",
        "meaning": "The Russian Orthodox Church, one of the key pillars of the Tsarist principle of 'Orthodoxy, Autocracy, and Nationalism'.",
        "significance": ""
    },
    {
        "term": "Okhrana",
        "date": "",
        "meaning": "The new secret police force that replaced the Third Section under Alexander III.",
        "significance": "An elite force dedicated to counter-terrorism and political suppression, forming a core part of the repressive apparatus."
    },
    {
        "term": "Karl Marx",
        "date": "",
        "meaning": "The German philosopher and economist whose ideas influenced Russian revolutionary movements.",
        "significance": "The translation of his work, 'The Communist Manifesto,' led to the rise of communist and socialist ideas among the intelligentsia."
    },
    {
        "term": "Ivan Turgenev",
        "date": "",
        "meaning": "A Russian writer and thinker who was influential in spreading ideas about political and social reform.",
        "significance": ""
    },
    {
        "term": "Leo Tolstoy",
        "date": "",
        "meaning": "A renowned Russian novelist and social thinker.",
        "significance": ""
    },
    {
        "term": "Alexander III",
        "date": "1881–1894",
        "meaning": "The Tsar who reigned after the assassination of his father, Alexander II.",
        "significance": "Adopted a deeply conservative and repressive stance, reversing many liberal reforms and intensifying policies of Russification and political control."
    },
    {
        "term": "Urbanisation",
        "date": "",
        "meaning": "The movement of the population from rural areas to towns and cities.",
        "significance": ""
    },
    {
        "term": "Alexander II's Later Years",
        "date": "",
        "meaning": "The period after the first assassination attempt, characterised by Alexander II becoming more inclined to resist reform and accept conservative advice.",
        "significance": "Marked the shift from the 'Tsar Liberator' to a more repressive ruler."
    },
    {
        "term": "Reactionary Policies",
        "date": "",
        "meaning": "Government policies that aim to reverse or suppress liberal reforms and restore traditional authority.",
        "significance": ""
    },
    {
        "term": "Alexander II's Assassination",
        "date": "1881",
        "meaning": "Killed by a bomb thrown by a member of The People's Will.",
        "significance": "Led directly to the accession of Alexander III and the 'Manifesto of Unshakeable Autocracy,' dramatically changing the course of Russian history."
    },
    {
        "term": "Nihilism (Rejection of Tradition)",
        "date": "",
        "meaning": "The rejection of all authority and tradition, especially within the educated classes.",
        "significance": ""
    },
    {
        "term": "The Communist Manifesto",
        "date": "",
        "meaning": "The foundational text of Marxism, written by Karl Marx and Friedrich Engels.",
        "significance": "Its translation and spread among the intelligentsia provided the theoretical basis for future socialist movements."
    },
    {
        "term": "State Bank",
        "date": "1860",
        "meaning": "A central bank established by von Reutern to manage state finances.",
        "significance": ""
    },
    {
        "term": "Land Shortages",
        "date": "",
        "meaning": "The insufficient amount of land given to the majority of peasants after emancipation.",
        "significance": ""
    },
    {
        "term": "Uniate Church",
        "date": "",
        "meaning": "Churches that follow Eastern Christian rites but are in communion with the Roman Catholic Church.",
        "significance": ""
    },
    {
        "term": "Armenian Church",
        "date": "",
        "meaning": "The national church of the Armenian people.",
        "significance": ""
    },
    {
        "term": "Old Believers",
        "date": "",
        "meaning": "Members of a religious group who refused to accept liturgical reforms of the Russian Orthodox Church in the 17th century.",
        "significance": ""
    },
    {
        "term": "Zemstva (Role in Famine)",
        "date": "",
        "meaning": "Expanded their activities to provide aid and revive the rural economy during the Great Famine.",
        "significance": ""
    },
    {
        "term": "Educational Quotas (Jews)",
        "date": "",
        "meaning": "Restrictions on the number of Jewish students allowed in secondary schools and universities.",
        "significance": ""
    },
    {
        "term": "Black Sea Fleet",
        "date": "",
        "meaning": "The Russian naval force in the Black Sea.",
        "significance": "Disbanded under the terms of the Treaty of Paris, which necessitated the later military and industrial reforms to restore Russia's naval power."
    }
  ]
},
t2: {
    title: "2. Failure of Autocracy 1894-1917",
    terms:[
  {
    "term": "Konstantin Pobedonostsev",
    "date": "",
    "meaning": "Chief Procurator of the Holy Synod and tutor to Alexander III and Nicholas II.",
    "significance": "A key figure of reaction who warned that assembly rule would mean 'revolution and the end of Russia itself,' strongly influencing the conservative rule of both Tsars."
  },
  {
    "term": "Tsar Nicholas II",
    "date": "1894-1917",
    "meaning": "The last Tsar of Russia, deeply committed to autocracy but often described as indecisive and politically naive.",
    "significance": "His character and inability to adapt the autocratic system to modern challenges contributed significantly to the 1905 and 1917 Revolutions."
  },
  {
    "term": "Witte's 'Great Spurt'",
    "date": "",
    "meaning": "Economic modernisation and rapid industrialisation driven by Finance Minister Sergei Witte.",
    "significance": "Led to rapid economic growth but also the growth of an urban proletariat facing harsh working conditions, fueling social discontent."
 },
  {
    "term": "Social Democrats (SDs)",
    "date": "",
    "meaning": "A Marxist party that believed in revolution driven by the urban industrial working class (proletariat).",
    "significance": "Split into two factions—Bolsheviks and Mensheviks—over organisational principles and revolutionary timing."
  },
  {
    "term": "Bolsheviks",
    "date": "1903",
    "meaning": "A faction of the SDs led by Lenin, advocating for a small, disciplined, professional revolutionary vanguard.",
    "significance": "Their focus on a centralized party structure would allow them to seize power in October 1917."
  },
  {
    "term": "Mensheviks",
    "date": "1903",
    "meaning": "A faction of the SDs that favored a broader-based, more democratic party that cooperated with liberals.",
    "significance": "Believed Russia needed a bourgeois (liberal) phase of revolution before a socialist one could occur."
  },
  {
    "term": "Years of the Red Cockerel",
    "date": "1902-1907",
    "meaning": "Nickname for the period of widespread peasant disturbances and arson in the countryside.",
    "significance": "Reflected the deep-seated peasant dissatisfaction with land issues and added to the general unrest facing the Tsarist regime."
  },
  {
    "term": "Great Famine",
    "date": "1891-1892",
    "meaning": "A major famine that struck Russia, exposing the Tsarist government's incompetence in relief efforts.",
    "significance": "Increased public mistrust of the government and bred a 'firmer belief in the power of ordinary members of society' to play a role in national affairs."
  },
  {
    "term": "Russo-Japanese War",
    "date": "1904-1905",
    "meaning": "A military conflict over control of Manchuria and Korea, which ended in a humiliating Russian defeat.",
    "significance": "The military losses, economic strain, and national humiliation were a key short-term trigger for the 1905 Revolution."
  },
  {
    "term": "Port Arthur",
    "date": "",
    "meaning": "Major Russian naval base in China that was besieged and surrendered to Japan in January 1905.",
    "significance": "Its fall was a major defeat for Russia and further undermined public confidence in the Tsarist government's competence."
  },
  {
    "term": "Bloody Sunday",
    "date": "Jan 22, 1905",
    "meaning": "Peaceful protesters, led by Father Gapon, were massacred by Tsarist troops in St. Petersburg.",
    "significance": "Shattered the public's trust in the Tsar as the 'Little Father,' triggering nationwide strikes and the start of the 1905 Revolution."
  },
  {
    "term": "October Manifesto",
    "date": "Oct 1905",
    "meaning": "Tsar Nicholas II's concession to end the 1905 Revolution, promising civil freedoms and an elected Duma (parliament).",
    "significance": "Divided the opposition (creating the Octobrists and Kadets) and allowed the regime to regain control, but established a limited constitutional façade."
  },
  {
    "term": "Duma System",
    "date": "",
    "meaning": "Russia's first elected parliament (State Duma), created by the October Manifesto.",
    "significance": "Provided an outlet for opposition and political awareness, but its power was severely limited by the Tsar and the Fundamental Laws."
  },
  {
    "term": "Kadets (Constitutional Democrats)",
    "date": "1905",
    "meaning": "A liberal political party that wanted full constitutional monarchy and social reform.",
    "significance": "The strongest group in the First and Second Dumas; their demands for greater power led to their eventual dismissal by the Tsar."
  },
  {
    "term": "Octobrists",
    "date": "1905",
    "meaning": "A moderate liberal party that supported the October Manifesto and cooperated with the Tsarist government.",
    "significance": "Became the dominant party in the Third and Fourth Dumas after the 1907 electoral changes concentrated power among the propertied classes."
  },
  {
    "term": "Moscow Uprising",
    "date": "Dec 1905",
    "meaning": "An armed worker uprising in Moscow that was brutally suppressed by Tsarist forces.",
    "significance": "Its defeat, following the October Manifesto's concessions, marked the effective end of the 1905 Revolution's main phase."
  },
  {
    "term": "Redemption Payments",
    "date": "",
    "meaning": "Long-term debts owed by former serfs to the state for the land they received after emancipation.",
    "significance": "Caused persistent peasant land hunger and poverty; their cancellation in 1907 was a key government response to peasant unrest during the 1905 Revolution."
  },
  {
    "term": "Soviet",
    "date": "",
    "meaning": "A council of workers' representatives, first established in St. Petersburg during the 1905 Revolution.",
    "significance": "Demonstrated the power of organised workers; they would re-emerge as a key political power center in 1917."
  },
  {
    "term": "Fundamental Laws",
    "date": "Apr 1906",
    "meaning": "New constitutional arrangements that reaffirmed the Tsar's supreme autocratic power, despite the creation of the Duma.",
    "significance": "Effectively reduced the Duma to a consultative body, as the Tsar could veto legislation, dissolve the Duma, and retain control of the government."
  },
  {
    "term": "State Duma (Lower Chamber)",
    "date": "",
    "meaning": "The elected representative body under the new constitutional arrangement.",
    "significance": "Its members were elected under a system of indirect voting weighted towards the nobility and peasants, to ensure a conservative outcome."
  },
  {
    "term": "State Council (Upper Chamber)",
    "date": "",
    "meaning": "The second chamber of the new parliament, with half its members elected and half appointed by the Tsar.",
    "significance": "Possessed equal legislative power to the Duma, meaning it could veto any legislation passed by the Duma."
  },
  {
    "term": "First Duma ('Duma of National Hope')",
    "date": "Apr–Jul 1906",
    "meaning": "Dominated by Kadets and radical groups (Trudoviks), who demanded radical land reform.",
    "significance": "Its radical demands led to its swift dismissal by Nicholas II after only 73 days."
  },
  {
    "term": "Second Duma ('Duma of National Anger')",
    "date": "Feb–Jun 1907",
    "meaning": "Also dominated by radical and opposition deputies.",
    "significance": "Dismissed by the Tsar after failing to cooperate, leading to Stolypin's illegal electoral reform to ensure a more conservative future Duma."
  },
  {
    "term": "Third Duma",
    "date": "Nov 1907–Jun 1912",
    "meaning": "A more conservative body following Stolypin's electoral reforms, dominated by Octobrists and Rightists.",
    "significance": "The only Duma to serve its full term, indicating its cooperation with the government and the success of the reforms in limiting opposition."
  },
  {
    "term": "Fourth Duma",
    "date": "Nov 1912–Aug 1914",
    "meaning": "Continued the conservative trend of the Third Duma but was suspended during WWI.",
    "significance": "Later formed the basis for the Progressive Bloc, which demanded a more effective war government."
  },
  {
    "term": "1907 Electoral Reforms",
    "date": "Jun 1907",
    "meaning": "Changes to the voting system that heavily weighted the franchise in favour of landowners and propertied classes.",
    "significance": "Successfully created a more loyal and conservative Duma (Third and Fourth), but exposed the Tsar's unwillingness to embrace true constitutionalism."
  },
  {
    "term": "Pyotr Stolypin",
    "date": "1906-1911",
    "meaning": "Prime Minister and strong supporter of autocracy who also believed reform was essential to solve Russia's problems.",
    "significance": "Dominated the government after 1906, implementing agrarian reforms and ruthless repression until his assassination."
  },
  {
    "term": "Stolypin's Agrarian Reforms",
    "date": "",
    "meaning": "Policies aimed at dissolving the peasant commune (mir) and creating a class of prosperous, independent peasants (kulaks).",
    "significance": "Intended to promote stability and loyalty to the regime in the countryside, but progress was slow and interrupted by WWI."
  },
  {
    "term": "Field Courts-Martial ('Stolypin's Necktie')",
    "date": "",
    "meaning": "Part of Stolypin's political repression, allowing for rapid trial and execution of suspected revolutionaries.",
    "significance": "A symbol of his brutal, effective campaign to restore order and suppress opposition after the 1905 Revolution."
  },
  {
    "term": "Lena Goldfields Massacre",
    "date": "1912",
    "meaning": "Tsarsit troops opened fire on striking gold miners in Siberia.",
    "significance": "Signalled a resurgence of worker unrest and the end of the apparent political calm (1907-1912) before WWI."
  },
  {
    "term": "Illiteracy Rate in 1914",
    "date": "1914",
    "meaning": "Still stood at around 40% of the population, especially in rural areas.",
    "significance": ""
  },
  {
    "term": "'Silver Age' of Culture",
    "date": "",
    "meaning": "A period of cultural experimentation in Russia with new artistic styles (modernist art, experimental music and ballet).",
    "significance": ""
  },
  {
    "term": "Russia enters WWI",
    "date": "Jul 1914",
    "meaning": "Russia mobilised to defend Serbia, entering the conflict against Germany and Austria-Hungary.",
    "significance": "The massive strain of total war (military losses, economic collapse, social misery) destroyed the Tsarist regime's stability."
  },
  {
    "term": "Tannenberg and Masurian Lakes",
    "date": "1914",
    "meaning": "Early military defeats suffered by the Russian army against the Germans.",
    "significance": "Exposed the Russian army's weaknesses, including poor generalship and a critical lack of munitions and supplies."
  },
  {
    "term": "Tsar takes Supreme Command",
    "date": "1915",
    "meaning": "Nicholas II dismissed the commander-in-chief and personally took charge of the military effort at the Front.",
    "significance": "Made the Tsar personally responsible for all military defeats and left the Tsarina and Rasputin in charge of the government in Petrograd, damaging his image."
  },
  {
    "term": "Progressive Bloc",
    "date": "Aug 1915",
    "meaning": "A group of moderate parliamentarians (about two-thirds of Duma deputies) who set aside differences to demand a 'government of public confidence'.",
    "significance": "Demonstrated the unity of political opposition against the incompetence of the Tsarist bureaucracy during the war."
  },
  {
    "term": "Zemgor and WICs",
    "date": "",
    "meaning": "Non-governmental organisations (Zemgor for medical/supply aid; WICs for shifting factories to military production) formed during WWI.",
    "significance": "Showed the superior organisational ability of civil society compared to the Tsarist bureaucracy, which viewed them with suspicion."
  },
  {
    "term": "Military Casualties (WWI)",
    "date": "",
    "meaning": "Approximately 7 million Russian troops were killed, wounded, or captured during the war.",
    "significance": ""
  },
  {
    "term": "Rasputin's Murder",
    "date": "1916",
    "meaning": "The assassination of the controversial advisor to the Tsarina by conservative nobles.",
    "significance": "Did nothing to restore public confidence in the royal family, whose reputation had been severely damaged by his influence."
  },
  {
    "term": "February Revolution",
    "date": "Feb 1917",
    "meaning": "Spontaneous street protests, strikes, and military mutiny in Petrograd that led to the abdication of Nicholas II.",
    "significance": "Brought the 300-year Romanov dynasty to an end, creating a political vacuum."
  },
  {
    "term": "Provisional Government (PG)",
    "date": "",
    "meaning": "The self-appointed government of leading liberals (Kadets strongest group) that claimed legal authority after the Tsar's abdication.",
    "significance": "Intended to govern temporarily until elections for a Constituent Assembly but never had the full support or means to enforce its authority."
  },
  {
    "term": "Petrograd Soviet (PS)",
    "date": "",
    "meaning": "A council of workers' and soldiers' deputies, dominated by Mensheviks and Socialist Revolutionaries.",
    "significance": "Controlled the actual power in the capital, with authority over troops, transport, and communication, leading to a situation of 'Dual Power'."
  },
  {
    "term": "Dual Power (Dvoevlastie)",
    "date": "",
    "meaning": "The unique political situation where the Provisional Government and the Petrograd Soviet simultaneously claimed legitimate governance.",
    "significance": "Created confusion and hindered the ability of the PG to make decisive decisions, ultimately leading to its collapse."
  },
  {
    "term": "Soviet Order Number 1",
    "date": "Mar 1, 1917",
    "meaning": "A decree from the Petrograd Soviet stipulating that soldiers should only obey the PG's orders if they didn't contradict the Soviet's directives.",
    "significance": "Effectively gave the Soviet control over the armed forces in the capital and undermined the PG's authority from the start."
  },
  {
    "term": "Eight Principles of the PG",
    "date": "Mar 3, 1917",
    "meaning": "A list of civil rights and reforms promised by the Provisional Government upon its formation (e.g., amnesty, freedom of speech, universal suffrage).",
    "significance": "Promised fundamental democratic freedoms but failed to address key issues like the war and land reform, losing popular support."
  },
  {
    "term": "Prince Lvov",
    "date": "",
    "meaning": "The first Prime Minister of the Provisional Government, a progressive noble known for running the Zemstvo Union.",
    "significance": ""
  },
  {
    "term": "April Theses",
    "date": "Apr 1917",
    "meaning": "Lenin's programmatic statement calling for an immediate socialist revolution, rejection of the PG, and 'All power to the Soviets.'",
    "significance": "Rejected the Marxist belief that a bourgeois revolution must precede a socialist one, giving the Bolsheviks a radical platform of 'Peace, Bread, and Land'."
  },
  {
    "term": "Constituent Assembly",
    "date": "",
    "meaning": "A democratically elected body that the PG was supposed to convene to determine Russia's future form of government.",
    "significance": "The PG continually delayed the elections, further frustrating the population and giving the Bolsheviks a window to seize power."
  },
  {
    "term": "June Offensive",
    "date": "Jun 1917",
    "meaning": "A major, but failed, military attack launched by the Provisional Government.",
    "significance": "The heavy casualties and defeat fueled further public and military frustration, contributing to the July Days."
  },
  {
    "term": "July Days",
    "date": "Jul 1917",
    "meaning": "A period of spontaneous, uncontrolled armed rioting in Petrograd by workers, soldiers, and Kronstadt sailors.",
    "significance": "Temporarily weakened the Bolsheviks (as Lenin fled and Trotsky was arrested) but demonstrated the government's inability to control unrest."
  },
  {
    "term": "Kronstadt Sailors",
    "date": "",
    "meaning": "Highly revolutionary sailors from the naval base near Petrograd.",
    "significance": "Played a key role in the July Days, marching to the Tauride Palace to demand that the Soviet take power."
  },
  {
    "term": "Alexander Kerensky",
    "date": "",
    "meaning": "A moderate socialist who was a member of both the PG and the PS, seen as a man who could unite the country.",
    "significance": "Replaced Prince Lvov as Prime Minister in July 1917 but was unable to prevent the collapse of the PG, especially after the Kornilov Affair."
  },
  {
    "term": "Kerensky becomes Prime Minister",
    "date": "Jul 1917",
    "meaning": "Alexander Kerensky replaced Prince Lvov as head of the Provisional Government following the July Days.",
    "significance": "The temporary stabilization masked the deep political divisions that would soon be exposed by the Kornilov Affair."
  },
  {
    "term": "Kornilov Affair",
    "date": "Aug 1917",
    "meaning": "A failed coup attempt by General Kornilov against the Provisional Government.",
    "significance": "Politically isolated Kerensky, fatally weakened the PG, and provided the Bolsheviks with weapons and massive political momentum."
  },
  {
    "term": "Red Guards",
    "date": "1917",
    "meaning": "Armed workers' militias, led by the Bolsheviks.",
    "significance": "Armed by Kerensky to defend Petrograd against Kornilov; they kept their weapons and would become the primary military force for the October Revolution."
  },
  {
    "term": "Impact of Kornilov Affair on Bolsheviks",
    "date": "",
    "meaning": "The Bolsheviks led the resistance to the coup, appearing as the only reliable force against counter-revolution.",
    "significance": "Bolshevik party membership soared, and they gained control of the Petrograd Soviet, paving the way for October."
  },
  {
    "term": "Bolshevik Membership",
    "date": "Feb-Oct 1917",
    "meaning": "Increased from 24,000 in February to 350,000 by October.",
    "significance": "Reflected the massive political momentum and popular disillusionment with the Provisional Government after the Kornilov Affair."
  },
  {
    "term": "'History will not forgive us...'",
    "date": "Sep 12, 1917",
    "meaning": "A quote from a letter by Lenin to the Bolshevik Central Committee.",
    "significance": "Indicates Lenin's belief that the time was right for revolution, arguing that delay risked losing the opportunity due to the PG's weakness and Bolshevik popularity."
  },
  {
    "term": "Bolshevik Central Committee Vote",
    "date": "Oct 10, 1917",
    "meaning": "Lenin convinced the Bolshevik Central Committee to approve the decision to launch an armed uprising.",
    "significance": "The official decision that set the party on the path to the October Revolution."
  },
  {
    "term": "Bolshevik Control of Soviets",
    "date": "Sep 1917",
    "meaning": "The Bolsheviks won control of the Petrograd Soviet (with Trotsky elected Chairman) and other key city Soviets.",
    "significance": "Gave them the political and organisational base to seize power in the name of the Soviets, not just the party."
  },
  {
    "term": "October Revolution",
    "date": "Oct 1917",
    "meaning": "A military coup orchestrated by the Bolsheviks (largely by Trotsky's Military Revolutionary Committee) against the Provisional Government.",
    "significance": "Overthrew the Provisional Government and established the world's first socialist state."
  },
  {
    "term": "Soviet of Peoples' Commissars (Sovnarkom)",
    "date": "Nov 7, 1917",
    "meaning": "The new all-Bolshevik government established immediately after the seizure of power.",
    "significance": "Lenin was the head, Trotsky took Foreign Affairs, and Stalin took Nationalities, forming the executive authority of the new state."
  },
  {
    "term": "Zinoviev and Kamenev",
    "date": "",
    "meaning": "Leading Bolsheviks who opposed Lenin's call for an immediate armed revolution in October 1917.",
    "significance": "Feared that acting prematurely would isolate the Bolsheviks; Lenin overcame their opposition through relentless persuasion."
  },
  {
    "term": "Sergei Witte",
    "date": "",
    "meaning": "Minister of Finance who drove state-led industrialisation, often considered the most able minister of his time.",
    "significance": "His policies led to the 'Great Spurt' in industry and transformed Russia into the world's fifth-largest industrial economy by 1914."
  },
  {
    "term": "State Capitalism (Witte)",
    "date": "",
    "meaning": "The belief that the state must play a large role in stimulating industrial growth.",
    "significance": "Witte implemented this by state-buying two-thirds of metallurgical production, 70% of the railways, and owning numerous mines and oil fields."
  },
  {
    "term": "Great Spurt",
    "date": "",
    "meaning": "A period of rapid industrial growth in Russia, with output growing by approximately 8–9% per year.",
    "significance": "Driven by Witte's policies, it focused heavily on industries like coal, iron, steel, and oil (Baku oilfields/Donbas coal)."
  },
  {
    "term": "Gold Standard",
    "date": "1897",
    "meaning": "Adoption of a fixed currency rate pegged to gold, used to stabilise the rouble.",
    "significance": "Encouraged foreign investment and increased international confidence in the Russian economy."
  },
  {
    "term": "Foreign Loans and Investment",
    "date": "",
    "meaning": "Negotiated huge loans (especially from France) and brought in foreign companies, engineers, and experts.",
    "significance": "Essential for funding the massive railway expansion and heavy industry, but led to a 'dangerous and shameful dependency on foreigners.'"
  },
  {
    "term": "Trans-Siberian Railway",
    "date": "",
    "meaning": "Most famous project of Witte's railway expansion, aiming to connect western Russia with the Pacific.",
    "significance": "By 1913, Russia had the world's second-largest railway network (62,000KM), although still far behind the USA (411,000KM)."
  },
  {
    "term": "Witte's Neglect of Agriculture",
    "date": "",
    "meaning": "Witte focused investment and state policy almost exclusively on heavy industry.",
    "significance": "Agriculture suffered from underinvestment, and peasants were squeezed hard by high taxes and tariffs to fund industrialisation, restricting the growth of a domestic consumer market."
  },
  {
    "term": "Petr Stolypin",
    "date": "1906-1911",
    "meaning": "Prime Minister after Witte who focused his reforms on agriculture and rural stability.",
    "significance": "Aimed to dissolve the peasant commune (Mir) and create a stable, loyal, and prosperous peasant class (Kulaks) through market forces."
  },
  {
    "term": "Mir / Commune",
    "date": "",
    "meaning": "Traditional Russian peasant community responsible for collective ownership and redistribution of land.",
    "significance": "Stolypin's reforms aimed to abolish it to encourage independent land ownership and more efficient, individual farming methods."
    }
  ]
},

  t3: {
    title: "3. Establishing Communist Rule 1917-1941",
    terms:[
  {
    "term": "Sovnarkom (Council of People's Commissars)",
    "date": "",
    "meaning": "The new executive government body established by the Bolsheviks after the October Revolution.",
    "significance": "Composed exclusively of Bolsheviks (with Lenin as Chairman), it was the foundation of the one-party state, ruling by decree."
  },
  {
    "term": "Decree on Land",
    "date": "",
    "meaning": "A measure that legalised the seizure of land by peasants from the nobility and the Church.",
    "significance": "Secured Bolshevik support from the vast peasantry, who saw their long-standing demand for land ownership fulfilled."
  },
  {
    "term": "Land Decree and Peasant Support",
    "date": "",
    "meaning": "The decree legalised the peasant seizure of land and allowed them to parcel it out themselves.",
    "significance": "A pragmatic move by Lenin to secure support from the majority of the population and end their hostility."
  },
  {
    "term": "Workers' Control Decree",
    "date": "",
    "meaning": "Gave factory workers' committees control over production and supervision of managers.",
    "significance": "A popular measure that gave workers a sense of power but often led to economic chaos and falling production."
  },
  {
    "term": "Vesenkha (Supreme Council of the National Economy)",
    "date": "",
    "meaning": "The body set up to supervise and control the economy from the centre.",
    "significance": ""
  },
  {
    "term": "Cheka (All-Russian Extraordinary Commission)",
    "date": "",
    "meaning": "The Bolshevik secret police, established to deal with counter-revolution and sabotage.",
    "significance": "Its formation marked the beginning of state-sponsored terror to suppress opposition and enforce Bolshevik rule."
  },
  {
    "term": "Constituent Assembly",
    "date": "",
    "meaning": "A democratically elected body that was shut down by the Bolsheviks after its first day.",
    "significance": "Its closure demonstrated Lenin's commitment to a one-party state and his rejection of multi-party democracy."
  },
  {
    "term": "Treaty of Brest-Litovsk",
    "date": "Mar 1918",
    "meaning": "The punitive peace treaty signed with Germany that ended Russia's involvement in WWI.",
    "significance": "Despite the massive loss of territory (e.g., Ukraine), it ensured the survival of the Bolshevik regime, allowing them to focus on securing communism in Russia."
  },
  {
    "term": "Trotsky's 'Neither War Nor Peace'",
    "date": "",
    "meaning": "Trotsky's diplomatic stance during the Brest-Litovsk negotiations.",
    "significance": ""
  },
  {
    "term": "Bukharin's 'Revolutionary War'",
    "date": "1918",
    "meaning": "The Left Communist position during the Brest-Litovsk negotiations.",
    "significance": ""
  },
  {
    "term": "Russian Civil War",
    "date": "1918-1921",
    "meaning": "Conflict between the Bolshevik 'Reds' and the anti-Bolshevik 'Whites' and 'Greens' (National Groups).",
    "significance": "The Bolshevik victory led to the consolidation of their power but was achieved at the cost of immense violence and economic devastation (War Communism)."
  },
  {
    "term": "Red Terror",
    "date": "",
    "meaning": "Mass campaign of violence and execution carried out by the Cheka to eliminate opponents of the regime.",
    "significance": "A crucial tool for consolidating Bolshevik power, suppressing dissent, and maintaining control during the Civil War."
  },
  {
    "term": "War Communism",
    "date": "",
    "meaning": "Emergency economic policies during the Civil War, including grain requisitioning, nationalisation, and labour discipline.",
    "significance": "Helped the Reds win the Civil War but led to economic collapse, famine (1921), and mass popular revolt."
  },
  {
    "term": "Grain Requisitioning",
    "date": "",
    "meaning": "The forced seizure of surplus grain from peasants by government food brigades.",
    "significance": "A key policy of War Communism that ensured food supply to the Red Army but caused immense peasant anger and resistance (e.g., Tambov)."
  },
  {
    "term": "Tambov Rebellion",
    "date": "",
    "meaning": "A large-scale peasant revolt against grain requisitioning in the Tambov region.",
    "significance": "Showed the deep rural anger and the severity of the crisis facing the Bolshevik government in 1921."
  },
  {
    "term": "Kronstadt Rebellion",
    "date": "Mar 1921",
    "meaning": "A revolt by previously loyal sailors at the Kronstadt naval base, demanding 'Soviets without Communists!'",
    "significance": "Shocked Lenin into realising the need for an economic change (NEP), as it demonstrated that even key Bolshevik supporters were alienated."
  },
  {
    "term": "New Economic Policy (NEP)",
    "date": "1921-1928",
    "meaning": "A temporary 'strategic retreat' that replaced grain requisitioning with a tax in kind and allowed limited private trade/enterprise.",
    "significance": "Revived the economy and ended popular unrest, but created political tensions due to its abandonment of socialist principles."
  },
  {
    "term": "Tax in Kind",
    "date": "",
    "meaning": "The replacement for grain requisitioning under the NEP, allowing peasants to sell their surplus on the open market.",
    "significance": "Incentivised agricultural production, leading to a significant recovery in grain harvests by 1926."
  },
  {
    "term": "Nepmen",
    "date": "",
    "meaning": "Private traders and small business owners who prospered under the NEP.",
    "significance": "Instrumental in economic recovery but were despised by many Communists as 'bourgeois' profiteers, creating an ideological tension."
  },
  {
    "term": "Scissors Crisis",
    "date": "1923",
    "meaning": "The imbalance where agricultural prices fell while the price of industrial goods remained high.",
    "significance": "Made it difficult for peasants to purchase manufactured goods and created tensions that required government intervention to stabilise prices."
  },
  {
    "term": "Ban on Factions",
    "date": "1921",
    "meaning": "A decree passed by Lenin outlawing organised opposition groups within the Communist Party.",
    "significance": "Strengthened the centralised power of the leadership and would be used by Stalin as a 'devastating weapon' to destroy his opponents in the Power Struggle."
  },
  {
    "term": "Lenin's Testament",
    "date": "Dec 1922",
    "meaning": "A letter to the Party Congress from Lenin, criticising key Bolshevik leaders, especially Stalin's 'rudeness' and 'immeasurable power'.",
    "significance": "If read out, it would have ended Stalin's career, but Zinoviev and Kamenev urged it be kept secret, underestimating Stalin as a threat."
  },
  {
    "term": "Joseph Stalin",
    "date": "",
    "meaning": "General Secretary of the Communist Party and member of the Orgburo and Secretariat.",
    "significance": "His control over personnel and party administration gave him the 'immeasurable power' necessary to win the Power Struggle."
  },
  {
    "term": "General Secretary",
    "date": "",
    "meaning": "The position held by Stalin, controlling appointments, party administration, and delegates for Congresses.",
    "significance": "Allowed Stalin to pack key committees and conferences with his supporters, ensuring majorities against his rivals."
  },
  {
    "term": "Leon Trotsky",
    "date": "",
    "meaning": "Leader of the Red Army and a brilliant Marxist theoretician and orator.",
    "significance": "His arrogance, history as an outsider, and failure to attend Lenin's funeral severely damaged his political prestige and contribution to his defeat."
  },
  {
    "term": "Grigory Zinoviev",
    "date": "",
    "meaning": "Chairman of the party in Leningrad and a key member of the Politburo.",
    "significance": "A powerful figure who, along with Kamenev, initially formed a Triumvirate with Stalin to defeat Trotsky, fatally underestimating Stalin."
  },
  {
    "term": "Lev Kamenev",
    "date": "",
    "meaning": "Chairman of the party in Moscow and a well-regarded, experienced leader.",
    "significance": "His alignment with Zinoviev against Trotsky (Round 4) and against Stalin (United Opposition) contributed to his political downfall."
  },
  {
    "term": "Nikolai Bukharin",
    "date": "",
    "meaning": "A brilliant Marxist theoretician and economist, a 'favourite of the party'.",
    "significance": "He was the leader of the 'Right Opposition' and advocated for a continuation of the NEP and cooperation with the peasantry."
  },
  {
    "term": "Lenin's Funeral",
    "date": "Jan 1924",
    "meaning": "Stalin tricked Trotsky into not attending, a major political blunder by Trotsky.",
    "significance": "Allowed Stalin to portray himself as Lenin’s disciple and natural successor, severely damaging Trotsky's reputation."
  },
  {
    "term": "The Triumvirate",
    "date": "",
    "meaning": "The initial alliance of Stalin, Zinoviev, and Kamenev to defeat their greatest rival, Trotsky.",
    "significance": "Crucial for Stalin, as his allies helped suppress Lenin’s Testament and remove Trotsky from positions of power."
  },
  {
    "term": "'Lessons of October'",
    "date": "",
    "meaning": "A pamphlet written by Trotsky attacking Zinoviev and Kamenev for their unwillingness to support Lenin in the 1917 Revolution.",
    "significance": "It backfired, allowing the triumvirate to launch a vicious campaign against Trotsky, further tearing apart the 'Left Opposition'."
  },
  {
    "term": "United Opposition",
    "date": "",
    "meaning": "The political alliance formed by Trotsky, Zinoviev, and Kamenev against Stalin.",
    "significance": "Easily defeated by Stalin due to his control of the Party machine and the 'Ban on Factions' (1921)."
  },
  {
    "term": "'Socialism in One Country'",
    "date": "",
    "meaning": "Stalin's political and ideological platform that prioritised building a socialist state in Russia before focusing on world revolution.",
    "significance": "Appealed to a patriotic, conservative majority in the Party and helped isolate Trotsky's 'Permanent Revolution' theory."
  },
  {
    "term": "The Right Opposition",
    "date": "",
    "meaning": "Led by Bukharin, Rykov, and Tomsky, it opposed Stalin's policy of rapid industrialisation and forced collectivisation.",
    "significance": "Stalin was able to outmanoeuvre and destroy them after Trotsky and the Left were eliminated, consolidating his sole power."
  },
  {
    "term": "The Great Turn",
    "date": "1928-1929",
    "meaning": "Stalin's decision to abandon the NEP in favour of rapid industrialisation and forced collectivisation.",
    "significance": "Marked a major ideological shift from partial market mechanisms to a command economy and full state control."
  },
  {
    "term": "Reasons for the Great Turn (Economic)",
    "date": "",
    "meaning": "The NEP was failing to deliver heavy industry growth and the 1927–28 grain procurement crisis.",
    "significance": "The grain crisis, in particular, convinced Stalin that the peasant economy could not supply the necessary resources for industrialisation."
  },
  {
    "term": "Reasons for the Great Turn (Security)",
    "date": "",
    "meaning": "Stalin's fear of war and the belief that the USSR must 'catch up with the West' in ten years.",
    "significance": "Provided a powerful, non-ideological justification for the rapid, forced pace of the Five-Year Plans."
  },
  {
    "term": "Reasons for the Great Turn (Political)",
    "date": "",
    "meaning": "Stalin used the shift to central planning to politically defeat the Right Opposition (Bukharin) who supported the NEP.",
    "significance": "The 'Great Turn' was also a 'revolution from above' that enabled Stalin to consolidate his sole power."
  },
  {
    "term": "Five-Year Plans (5YP)",
    "date": "",
    "meaning": "State-led plans for rapid industrialisation and central planning of the entire economy.",
    "significance": "The focus on heavy industry created the industrial base necessary for the USSR to survive WWII, but at immense human cost."
  },
  {
    "term": "Gosplan",
    "date": "",
    "meaning": "The state planning agency responsible for setting production and output targets for every industrial enterprise.",
    "significance": "Placed central planning at the forefront of the Soviet economy, replacing the market mechanisms of the NEP."
  },
  {
    "term": "First Five-Year Plan",
    "date": "1928-1932",
    "meaning": "Focused intensely on heavy industry: coal, steel, iron, and electricity (e.g., Magnitogorsk, Dnieprostroi).",
    "significance": "Achievements were often exaggerated, but it successfully laid the foundations of an industrial base."
  },
  {
    "term": "Second Five-Year Plan",
    "date": "1933-1937",
    "meaning": "Continued heavy industry growth but with more focus on communications, transport, and improving existing factories.",
    "significance": "Saw greater stability and some improvement in consumer goods production, although heavy industry remained the priority."
  },
  {
    "term": "Gigantomania",
    "date": "",
    "meaning": "The construction of massive, symbolic projects (e.g., Dnieprostroi Dam, Moscow Metro) to demonstrate the Soviet industrial machine's might.",
    "significance": "A form of propaganda to inspire workers and reinforce the image of Soviet industrial prowess."
  },
  {
    "term": "Collectivisation",
    "date": "1929-1937",
    "meaning": "Stalin's policy to abolish private land and force all peasants onto large collective farms (Kolkhoz).",
    "significance": "Intended to modernise agriculture and provide cheap food/labour for industrialisation, but led to catastrophe and famine."
  },
  {
    "term": "Reasons for Collectivisation (Agricultural)",
    "date": "",
    "meaning": "The belief that larger units could be farmed more efficiently using mechanisation and modern techniques.",
    "significance": "Aimed to solve the inefficiency of traditional small holdings (strip farming)."
  },
  {
    "term": "Reasons for Collectivisation (Political/Ideological)",
    "date": "",
    "meaning": "Stalin could not build a socialist society when the majority of the population were 'petty-bourgeois' peasants.",
    "significance": "Aimed to destroy the independent peasant class and extend Communist control over the countryside."
  },
  {
    "term": "Kulaks",
    "date": "",
    "meaning": "Wealthier, independent peasants, labelled by the Party as 'class enemies'.",
    "significance": "They were the primary target of 'dekulakisation' (elimination) and became a scapegoat for the policy's failures."
  },
  {
    "term": "Dekulakisation",
    "date": "",
    "meaning": "The campaign to forcibly remove, exile, or execute the Kulak class.",
    "significance": "Destroyed the most productive farmers and contributed significantly to the chaos and famine of the early 1930s."
  },
  {
    "term": "Kolkhoz",
    "date": "",
    "meaning": "The most common type of collective farm, where land, tools, and livestock were pooled and run by an elected committee.",
    "significance": "Peasants were allowed to keep a small private plot, which often provided the majority of their food."
  },
  {
    "term": "Machine Tractor Stations (MTS)",
    "date": "",
    "meaning": "State centres that hired out tractors and machinery to multiple collective farms.",
    "significance": "Often inefficient due to a lack of trained specialists, but served as a crucial instrument of Party control in the countryside."
  },
  {
    "term": "Famine of 1932-1933",
    "date": "",
    "meaning": "A man-made famine, especially in Ukraine (Holodomor), caused by excessive grain procurement and the chaos of collectivisation.",
    "significance": "Millions died, illustrating the destructive human cost of Stalin’s policies."
  },
  {
    "term": "Great Terror (Yezhovshchina)",
    "date": "1936-1938",
    "meaning": "A period of mass repression and purging of the Communist Party, the military, and the general population.",
    "significance": "Consolidated Stalin's personal dictatorship by eliminating all potential rivals and creating a climate of fear."
  },
  {
    "term": "NKVD",
    "date": "",
    "meaning": "The new state security organisation (formerly OGPU) that carried out the Great Terror and managed the Gulag system.",
    "significance": "The primary instrument of state terror under Stalin, replacing the Cheka/OGPU."
  },
  {
    "term": "Purges of the Red Army",
    "date": "",
    "meaning": "The arrest and execution of most of the senior command of the Red Army (e.g., Marshal Tukhachevsky).",
    "significance": "Severely weakened the military leadership just before WWII, though it also ensured the army’s political obedience to Stalin."
  },
  {
    "term": "Show Trials",
    "date": "",
    "meaning": "Public trials of former opposition leaders (Zinoviev, Kamenev, Bukharin) who confessed to implausible crimes against the state.",
    "significance": "Propaganda used to justify the purges and reinforce the image of Stalin as the benevolent protector against 'wreckers' and 'spies'."
  },
  {
    "term": "Cult of Personality (Lenin)",
    "date": "",
    "meaning": "Hailing Lenin as the 'Hero of the Revolution' through pervasive images, statues, and the embalming of his body.",
    "significance": "Stalin used this initial cult to establish continuity and portray himself as Lenin’s worthy successor."
  },
  {
    "term": "Cult of Personality (Stalin)",
    "date": "",
    "meaning": "The creation of an image of Stalin as an omnipotent, god-like leader, genius, and 'saviour of Russia'.",
    "significance": "Provided a sense of purpose and stability during rapid, bewildering social change and reinforced his control over the populace."
  },
  {
    "term": "Stakhanovite Movement",
    "date": "",
    "meaning": "A propaganda campaign that rewarded 'hero workers' (like Alexei Stakhanov) who exceeded their production quotas.",
    "significance": "Used incentives and peer pressure to increase productivity, reinforcing the 'Cult of Labour' under the 5YPs."
  },
  {
    "term": "Internal Passports",
    "date": "",
    "meaning": "Introduced under Stalin to control the movement of workers from the countryside to the cities.",
    "significance": "A key element of Stalin's strict labour discipline, which made absenteeism a criminal offence and criminalised strikes."
  },
  {
    "term": "Social Changes Under Lenin (Women)",
    "date": "",
    "meaning": "Legalised abortion (1920) and divorce, established civil marriage, and created the Zhenotdel women's department.",
    "significance": ""
  },
  {
    "term": "Social Changes Under Stalin (Women)",
    "date": "",
    "meaning": "Reversed liberal policies: abortion was banned, the family was re-emphasised, and 'Mother Heroine' awards were introduced.",
    "significance": ""
  },
  {
    "term": "Young Pioneers and Komsomol",
    "date": "",
    "meaning": "Youth organisations used to instil loyalty to the Communist Party and Soviet ideology.",
    "significance": "Represented the state's total control over education and socialisation, preparing youth for Party membership and leadership."
  },
  {
    "term": "Attitude towards Religion (Lenin)",
    "date": "",
    "meaning": "Church lands were seized, and religion was separated from the state and education.",
    "significance": ""
  },
  {
    "term": "Attitude towards Religion (Stalin)",
    "date": "",
    "meaning": "Continued the anti-religious campaign with mass closures of churches and the arrest/execution of priests.",
    "significance": ""
  },
  {
    "term": "Change or Continuity (Lenin to Stalin): One-Party Rule",
    "date": "",
    "meaning": "Continuity: Both Lenin and Stalin banned opposition parties (1921) and ruled through a highly centralized, single-party state.",
    "significance": ""
  },
  {
    "term": "Change or Continuity (Lenin to Stalin): Use of Terror",
    "date": "",
    "meaning": "Continuity: Both leaders established and used secret police (Cheka/NKVD) and class warfare to enforce policy and suppress opposition.",
    "significance": ""
  },
  {
    "term": "Change or Continuity (Lenin to Stalin): Economic Policy",
    "date": "",
    "meaning": "Change: Lenin used the mixed market economy of the NEP after the failure of War Communism.",
    "significance": ""
  },
  {
    "term": "Change or Continuity (Lenin to Stalin): Scale of Terror",
    "date": "",
    "meaning": "Change: Lenin's Red Terror was focused during the Civil War to suppress direct threats; Stalin's Great Terror was permanent and targeted Party members, the military, and the general public.",
    "significance": ""
  },
  {
    "term": "Change or Continuity (Lenin to Stalin): Society and Culture",
    "date": "",
    "meaning": "Change: Lenin implemented liberal social reforms (divorce/abortion) and attacked the Church. Stalin implemented a conservative retrenchment, emphasising traditional family values, while his cult of personality replaced the religious need for a figurehead.",
    "significance": ""
  },
  {
    "term": "Class Warfare",
    "date": "",
    "meaning": "The Bolshevik policy of targeting the bourgeoisie ('Burzhui') through confiscation, denial of work, and eviction.",
    "significance": ""
  },
  {
    "term": "Kommunalka (Communal Housing)",
    "date": "",
    "meaning": "Former middle-class homes shared by multiple families after property was confiscated and redistributed.",
    "significance": ""
  },
  {
    "term": "Propaganda and the Cult of Personality",
    "date": "",
    "meaning": "The use of newspapers, films, and statues to glorify Stalin and motivate the population to follow his commitment to the revolution.",
    "significance": ""
  },
  {
    "term": "Total Industrial Output (1921)",
    "date": "1921",
    "meaning": "Fell to around 20% of pre-war levels.",
    "significance": ""
  },
  {
    "term": "Moscow-Volga Canal",
    "date": "",
    "meaning": "A spectacular construction project of the 5YPs.",
    "significance": ""
  },
  {
    "term": "Ideology: Permanent Revolution",
    "date": "",
    "meaning": "Trotsky's theory that socialism in Russia could only survive if the revolution was continually spread abroad.",
    "significance": "Stalin easily isolated Trotsky by contrasting this with his more appealing and stable 'Socialism in One Country'."
    }
  ]
},

  t4: {
    title: "4. Stalinist Dictatorship and reaction 1941-1964",
    terms: [
  {
    "term": "Operation Barbarossa",
    "date": "Jun 22, 1941",
    "meaning": "The German invasion of the Soviet Union during World War II.",
    "significance": "Caused immediate military disaster and a crisis of leadership for Stalin, who initially appeared shocked and withdrawn."
  },
  {
    "term": "Stalin's Initial Reaction to Barbarossa",
    "date": "",
    "meaning": "Stalin retreated to his dacha after the invasion, causing a temporary leadership vacuum.",
    "significance": "The absence created a power vacuum, revealing the vulnerability of the system before Stalin reasserted control."
  },
  {
    "term": "State Defence Committee (GKO)",
    "date": "",
    "meaning": "A five-man cabinet, chaired by Stalin, that effectively controlled all political, economic, and military life during the war.",
    "significance": "Centralised decision-making and demonstrated Stalin's ability to adapt and tighten control during the crisis."
  },
  {
    "term": "Stavka",
    "date": "",
    "meaning": "The Supreme Military Command, which gave Stalin direct oversight of the war effort.",
    "significance": "By becoming Supreme Commander, Stalin cemented his personal control over the military, reinforcing his image as indispensable."
  },
  {
    "term": "Order No. 270",
    "date": "",
    "meaning": "A decree that labelled any soldier who retreated or surrendered as a traitor and deserter.",
    "significance": "Reinforced political control and led to the NKVD dealing harshly with perceived enemies and defeatists."
  },
  {
    "term": "The Great Patriotic War",
    "date": "",
    "meaning": "The Soviet name for World War II.",
    "significance": ""
  },
  {
    "term": "Wartime Economic Shift",
    "date": "",
    "meaning": "The relocation of 1,523 entire Soviet factories and workers from the West to the Urals and Siberia.",
    "significance": "A monumental effort that ensured the survival of the Soviet industrial base and allowed war production to exceed German output by mid-1943."
  },
  {
    "term": "Lend-Lease Aid",
    "date": "",
    "meaning": "Essential war materials, food, and vehicles supplied by the USA and UK to the USSR.",
    "significance": ""
  },
  {
    "term": "Wartime Relaxation of Religion",
    "date": "",
    "meaning": "Stalin temporarily restored the hierarchy of the Orthodox Church and permitted some services.",
    "significance": ""
  },
  {
    "term": "Wartime Women's Roles",
    "date": "",
    "meaning": "Women took on central roles in factories and served in military roles such as snipers and pilots.",
    "significance": ""
  },
  {
    "term": "Wartime Political Impact",
    "date": "",
    "meaning": "The war strengthened belief in the communist system and gave Stalin a massive boost to his personal authority.",
    "significance": ""
  },
  {
    "term": "High Stalinism",
    "date": "",
    "meaning": "The period after WWII characterised by a massive cult of personality and a revival of terror and ideological rigidity.",
    "significance": "Saw the reassertion of total authority after the wartime loosening of control, with a focus on anti-Westernism and ideological conformity."
  },
  {
    "term": "Cult of Personality (Post-War)",
    "date": "",
    "meaning": "Stalin was accorded 'god-like veneration', hailed as the 'father of the peoples' and 'best friend of all children'.",
    "significance": "Provided stability and purpose in the chaos of post-war reconstruction but hid Stalin's paranoia and his purging of close associates."
  },
  {
    "term": "Zhdanovshchina (Cultural Purge)",
    "date": "",
    "meaning": "A strict campaign to enforce ideological conformity in art, literature, and culture, named after cultural chief Andrei Zhdanov.",
    "significance": "Saw the suppression of 'bourgeois' and 'anti-Soviet' works, rejecting all Western influence, with Socialist Realism as the only acceptable style."
  },
  {
    "term": "Leningrad Case",
    "date": "",
    "meaning": "A purge of the Leningrad Party leadership, including Voznesensky and Kuznetsov, who were rivals to Stalin’s power.",
    "significance": "Demonstrated the revival of political terror and Stalin’s willingness to eliminate even senior party figures."
  },
  {
    "term": "Doctors' Plot",
    "date": "1953",
    "meaning": "The arrest of Jewish doctors, accused of planning to poison Stalin and other Soviet leaders.",
    "significance": "Reflected the height of Stalin's paranoia and anti-Semitism in his final years; the accused were released after his death."
  },
  {
    "term": "Stalin's Death",
    "date": "Mar 5, 1953",
    "meaning": "The sudden death of Joseph Stalin after a long illness.",
    "significance": "Left a political vacuum and an 'expectation of change' after decades of autocratic rule and terror."
  },
  {
    "term": "Collective Leadership",
    "date": "",
    "meaning": "The initial government established after Stalin's death, designed to prevent a return to one-man rule (Malenkov, Beria, Khrushchev).",
    "significance": "Attempted to steer the system away from Stalinist autocracy but soon devolved into a power struggle."
  },
  {
    "term": "Lavrenti Beria's Fall",
    "date": "",
    "meaning": "The arrest and execution of the head of the secret police (MVD) by his rivals (Khrushchev and Malenkov).",
    "significance": "Eliminated the threat of the secret police and allowed the process of de-Stalinisation to begin."
  },
  {
    "term": "Nikita Khrushchev",
    "date": "",
    "meaning": "First Secretary of the Communist Party who rose to become the dominant leader after Stalin.",
    "significance": ""
  },
  {
    "term": "'Secret Speech'",
    "date": "Feb 25, 1956",
    "meaning": "Khrushchev's 'On the Cult of Personality and its Consequences' delivered to the 20th Party Congress.",
    "significance": "Blasted Stalin's abuses of power, terror, and cult, marking a clear, though limited, ideological break from Stalinism."
  },
  {
    "term": "De-Stalinisation",
    "date": "",
    "meaning": "The policy of reversing Stalin's repression, relaxing censorship, and promoting the 'return to Leninist principles'.",
    "significance": "Reduced the use of terror (Gulag prisoners released) and led to a 'Cultural Thaw' but was never total."
  },
  {
    "term": "Limitations of De-Stalinisation",
    "date": "",
    "meaning": "Khrushchev did not call into question the one-party state or economic controls and avoided incriminating those (like himself) who benefited from Stalinism.",
    "significance": ""
  },
  {
    "term": "Cultural Thaw",
    "date": "",
    "meaning": "A limited liberalisation of culture and intellectual life after the 'Secret Speech'.",
    "significance": "Loosened censorship, allowing limited criticism of the past, but the regime maintained strict boundaries on acceptable expression."
  },
  {
    "term": "The Virgin Lands Scheme",
    "date": "1954",
    "meaning": "Khrushchev's policy to increase agricultural production by cultivating previously uncultivated land in Kazakhstan and Siberia.",
    "significance": "Initially successful, but poor harvests in the early 1960s (e.g., 1963) due to weather and over-cultivation exposed its failures."
  },
  {
    "term": "Sovnarkhozy Reforms",
    "date": "1957",
    "meaning": "Decentralisation of the economy by replacing central ministries with 105 regional economic councils (Sovnarkhozy).",
    "significance": "Aimed to reduce bureaucracy and localise decision-making but often created complexity and confused coordination."
  },
  {
    "term": "Seven-Year Plan",
    "date": "1959-1965",
    "meaning": "Replaced the traditional five-year plans, focusing on modernising light industry, boosting chemical production, and consumer goods.",
    "significance": "Aimed to 'catch up and overtake' the West, not just in heavy industry, but initial targets proved over-optimistic."
  },
  {
    "term": "Consumer Goods Focus (Khrushchev)",
    "date": "",
    "meaning": "Increased investment and production of consumer goods like refrigerators, radios, and televisions.",
    "significance": "A 'clear break in priorities' from Stalin, focusing more on the 'needs of the people' and improving living standards."
  },
  {
    "term": "Mass Housing Programme",
    "date": "",
    "meaning": "An ambitious plan to construct millions of prefabricated flats known as 'khrushchyovkas'.",
    "significance": "Provided families with private kitchens and bathrooms for the first time, marking a significant improvement in everyday life, despite the sometimes-poor quality."
  },
  {
    "term": "Wage Equalisation Campaign",
    "date": "",
    "meaning": "A policy that saw an increase in the wages of the lowest-paid Soviet workers.",
    "significance": "Contributed to greater social equality, leading to lower wage differentials than in other industrialised countries."
  },
  {
    "term": "Renewed Anti-Religious Campaign",
    "date": "1959-1964",
    "meaning": "Khrushchev intensified the attack on the Church, closing over 12,000 churches.",
    "significance": "Showed a continuity of anti-religious policy with the Stalin era, reversing the wartime relaxation."
  },
  {
    "term": "Promotion of 'Working Mother'",
    "date": "",
    "meaning": "Expansion of crèches and nurseries to help women balance full-time work and domestic duties.",
    "significance": "Aimed to support women in the workforce but did not fully eliminate gender inequality in senior positions."
  },
  {
    "term": "Novocherkassk Protests",
    "date": "Jun 1962",
    "meaning": "Worker protests in the city of Novocherkassk against food price hikes and wage cuts.",
    "significance": "Showed the link between agricultural policy failures (1963 Food Crisis) and growing social unrest; troops opened fire, killing at least 23."
  },
  {
    "term": "Samizdat",
    "date": "",
    "meaning": "The underground, self-publishing of censored works (poetry, essays, banned literature) circulated secretly in the USSR.",
    "significance": "Created an alternative cultural sphere that challenged the state's monopoly on information and allowed dissident voices to be heard."
  },
  {
    "term": "Tamizdat",
    "date": "",
    "meaning": "The printing of Soviet works abroad (e.g., Solzhenitsyn, Pasternak) which were then smuggled back into the country.",
    "significance": "Allowed banned works to reach an international and domestic audience, bypassing official censorship."
  },
  {
    "term": "Cultural Dissidents",
    "date": "",
    "meaning": "A new generation of writers, artists, and intellectuals who challenged official Soviet culture, often through samizdat.",
    "significance": "Opposed the regime in favour of greater democracy and human rights (e.g., Vladimir Bukovsky, Joseph Brodsky)."
  },
  {
    "term": "Hardliners (Party Opposition)",
    "date": "",
    "meaning": "A conservative faction in the Communist Party (e.g., Molotov, Malenkov) who viewed Khrushchev's reforms as a dangerous departure from Stalin's methods.",
    "significance": "Opposed decentralisation and the 'Thaw', creating significant internal pressure on Khrushchev's leadership."
  },
  {
    "term": "Anti-Party Group",
    "date": "",
    "meaning": "An attempt by hardliners (Molotov, Malenkov, Kaganovich) to oust Khrushchev from power.",
    "significance": "Khrushchev survived the attempt with the backing of the military (Zhukov) and the Party Central Committee, consolidating his dominance."
  },
  {
    "term": "Marshal Zhukov's Dismissal",
    "date": "Oct 1957",
    "meaning": "The removal of the decorated military commander shortly after he helped Khrushchev defeat the Anti-Party Group.",
    "significance": "Khrushchev removed him to prevent the army from becoming a political threat to his own position."
  },
  {
    "term": "Cuban Missile Crisis",
    "date": "1962",
    "meaning": "The confrontation between the USSR and the USA over Soviet missiles in Cuba.",
    "significance": "Khrushchev's handling of the crisis was later used as a major criticism from within the Party, contributing to his downfall."
  },
  {
    "term": "The Coup against Khrushchev",
    "date": "Oct 1964",
    "meaning": "Khrushchev was removed from power by a conspiracy led by Brezhnev, Podgorny, and Suslov.",
    "significance": "His removal, while peaceful, marked the end of the de-Stalinisation era and was a reaction against his erratic leadership and policy failures."
  },
  {
    "term": "Reasons for Khrushchev's Fall (Economic)",
    "date": "",
    "meaning": "Failures of the Virgin Lands Scheme, the 1963 Food Crisis, and the confusion caused by decentralisation (Sovnarkhozy).",
    "significance": ""
  },
  {
    "term": "Reasons for Khrushchev's Fall (Political)",
    "date": "",
    "meaning": "His erratic leadership style, the humiliation of the Cuban Missile Crisis, and his attacks on the Party apparatus (e.g., term limits).",
    "significance": ""
  },
  {
    "term": "Peasants' Pension Eligibility",
    "date": "",
    "meaning": "Under Khrushchev, even peasants became eligible for a state pension.",
    "significance": ""
  },
  {
    "term": "Change in Repression (Stalin vs. Khrushchev)",
    "date": "",
    "meaning": "Khrushchev reduced the use of terror, focusing on censorship and exile rather than Stalin’s purges and mass arrests.",
    "significance": ""
  },
  {
    "term": "Continuity in Authority (1964)",
    "date": "",
    "meaning": "Despite the reforms, the one-party state and the command economy remained fundamentally in place by 1964.",
    "significance": ""
  },
  {
    "term": "Khrushchev’s Ideological Goal",
    "date": "",
    "meaning": "To transform the Soviet Union into a 'prosperous and enlightened society' within the Leninist idea, ultimately building communism by 1980.",
    "significance": ""
  },
  {
    "term": "Industrial Priorities (Khrushchev 1953-64)",
    "date": "",
    "meaning": "Continued emphasis on industry, but a shift towards consumer goods and modern technologies.",
    "significance": ""
  },
  {
    "term": "Economic Structure (Khrushchev)",
    "date": "",
    "meaning": "Introduced decentralisation via Sovnarkhozy (1957).",
    "significance": ""
  },
  {
    "term": "Consumer Focus (Stalin)",
    "date": "",
    "meaning": "Minimal attention to consumer needs; production for the state, not the people.",
    "significance": ""
  },
  {
    "term": "Consumer Focus (Khrushchev)",
    "date": "",
    "meaning": "Greater focus on living standards, consumer goods, and housing.",
    "significance": ""
  },
  {
    "term": "Agricultural Methods (Stalin)",
    "date": "",
    "meaning": "Continued collectivisation; little investment; forced procurement.",
    "significance": ""
  },
  {
    "term": "Agricultural Methods (Khrushchev)",
    "date": "",
    "meaning": "Virgin Lands Campaign, higher procurement prices, and incentives for peasants.",
    "significance": ""
  },
  {
    "term": "Khrushchev’s 'Dacha Retreat'",
    "date": "Oct 1964",
    "meaning": "The moment he was forced to resign while at his holiday dacha, after being recalled to a Presidium meeting.",
    "significance": "A swift and peaceful coup that contrasted with the violent nature of the Stalinist purges he had denounced."
  },
  {
    "term": "Shostakovich (Composer)",
    "date": "",
    "meaning": "A leading Soviet composer whose works were criticised as too complex or individualistic.",
    "significance": ""
  },
  {
    "term": "Samizdat (Method)",
    "date": "",
    "meaning": "Typed manuscripts passed hand-to-hand or circulated through carbon copies and underground printing networks.",
    "significance": ""
  },
  {
    "term": "Role of Brezhnev in the Coup against Khrushchev",
    "date": "",
    "meaning": "Leonid Brezhnev, along with Suslov and Podgorny, led the conspiracy to remove Khrushchev.",
    "significance": ""
  },
  {
    "term": "Novocherkassk Protests (Cause)",
    "date": "1962",
    "meaning": "Workers at the locomotive works protested against simultaneous food price hikes and wage cuts.",
    "significance": ""
  },
  {
    "term": "Impact of 1947 Rouble Devaluation",
    "date": "",
    "meaning": "A 90% devaluation of the rouble wiped out private savings.",
    "significance": "Further contributed to the hardship and poor living standards of the ordinary population in the immediate post-war years."
  },
  {
    "term": "Socialist Realism (Post-War)",
    "date": "",
    "meaning": "The strict artistic policy enforced by the Zhdanovshchina, requiring all art to glorify the state and be easily understood by the masses.",
    "significance": ""
  },
  {
    "term": "Compulsory Voluntary Subscriptions",
    "date": "1958",
    "meaning": "A form of state tax that was abolished under Khrushchev.",
    "significance": "One of the tax changes that helped improve the disposable income and living standards of the ordinary citizen."
  }
      ]
  }

};

/* ==========================================================
   MCQ BANK (30 questions per topic) — fully populated
   Format:
   {
     topicId: "t1",
     q: "Question?",
     choices: ["A","B","C","D"],
     answer: "Correct choice exactly as written",
     explain: "Short explanation / key fact"
   }
   ========================================================== */

const MCQ_BANK_MANUAL = [
    {
          topicId: "t1",
          q: "Which year did Alexander II become Tsar?",
          choices: ["1855", "1853", "1856", "1858"],
          answer: "1855",
          explain: "Alexander II became Tsar in 1855."
        },
    {
          topicId: "t1",
          q: "Which year was the Emancipation Edict issued?",
          choices: ["1859", "1861", "1864", "1874"],
          answer: "1861",
          explain: "The Emancipation Edict was issued in 1861."
        },
    {
          topicId: "t1",
          q: "Which year did the Crimean War end?",
          choices: ["1854", "1855", "1856", "1857"],
          answer: "1856",
          explain: "The Crimean War ended in 1856 (Treaty of Paris)."
        },
    {
          topicId: "t1",
          q: "Which year was Alexander II assassinated?",
          choices: ["1879", "1880", "1882", "1881"],
          answer: "1881",
          explain: "Alexander II was assassinated in 1881."
        },
    {
          topicId: "t1",
          q: "Which year did Alexander III come to the throne?",
          choices: ["1881", "1874", "1861", "1894"],
          answer: "1881",
          explain: "Alexander III succeeded in 1881."
        },
    {
          topicId: "t1",
          q: "Who proposed the “Loris-Melikov Constitution” style reforms?",
          choices: ["Pobedonostsev", "Loris-Melikov", "Witte", "Vyshnegradsky"],
          answer: "Loris-Melikov",
          explain: "Loris-Melikov proposed limited consultative reforms in 1880–81."
        },
    {
          topicId: "t1",
          q: "Who was Minister of War and led the military reforms culminating in 1874?",
          choices: ["Ignatiev", "Tolstoy", "Dmitri Milyutin", "Pobedonostsev"],
          answer: "Dmitri Milyutin",
          explain: "Dmitri Milyutin drove the military reforms, including the 1874 conscription law."
        },
    {
          topicId: "t1",
          q: "Who was the chief adviser/ideologue of reaction under Alexander III?",
          choices: ["Herzen", "Witte", "Milyutin", "Pobedonostsev"],
          answer: "Pobedonostsev",
          explain: "Konstantin Pobedonostsev was the leading reactionary adviser."
        },
    {
          topicId: "t1",
          q: "Which body introduced elected local government at district/provincial level (1864)?",
          choices: ["Zemstva", "State Duma", "Politburo", "Sovnarkom"],
          answer: "Zemstva",
          explain: "Zemstva were introduced in 1864."
        },
    {
          topicId: "t1",
          q: "Which institution was responsible for political surveillance and infiltration?",
          choices: ["Third Section", "Okhrana", "Cheka", "NKVD"],
          answer: "Okhrana",
          explain: "The Okhrana was the tsarist political police."
        },
    {
          topicId: "t1",
          q: "Which reform introduced trial by jury and more independent courts (1864)?",
          choices: ["Military reform", "Local government reform", "Judicial reform", "Education reform"],
          answer: "Judicial reform",
          explain: "The 1864 judicial reforms created more independent courts and jury trials."
        },
    {
          topicId: "t1",
          q: "Which reform created elected councils for towns and cities (1870)?",
          choices: ["Zemstva reform", "Peasant land reform", "University reform", "Municipal (town) reform"],
          answer: "Municipal (town) reform",
          explain: "The 1870 municipal reforms created elected town dumas."
        },
    {
          topicId: "t1",
          q: "Which policy aimed to impose Russian language/culture across the empire?",
          choices: ["Russification", "Collectivisation", "Glasnost", "Perestroika"],
          answer: "Russification",
          explain: "Russification promoted Russian language and culture across the empire."
        },
    {
          topicId: "t1",
          q: "Which term describes emergency powers allowing arrest/exile without trial (1881 onwards)?",
          choices: ["Fundamental Laws", "Statute of State Security", "October Manifesto", "Decree on Land"],
          answer: "Statute of State Security",
          explain: "The 1881 Statute of State Security expanded emergency powers."
        },
    {
          topicId: "t1",
          q: "Which group was most directly targeted by the May Laws of 1882?",
          choices: ["Poles", "Finns", "Jews", "Armenians"],
          answer: "Jews",
          explain: "The May Laws restricted Jewish residence and economic activity."
        },
    {
          topicId: "t1",
          q: "Which event is most closely associated with the People’s Will?",
          choices: ["Decembrist Revolt", "Bloody Sunday", "July Days", "Assassination of Alexander II"],
          answer: "Assassination of Alexander II",
          explain: "The People’s Will assassinated Alexander II in 1881."
        },
    {
          topicId: "t1",
          q: "Which movement believed peasants were the key revolutionary force and “went to the people”?",
          choices: ["Populism", "Marxism", "Liberalism", "Conservatism"],
          answer: "Populism",
          explain: "Populists believed the peasantry were the main revolutionary force."
        },
    {
          topicId: "t1",
          q: "Which individual is most associated with revolutionary publishing from exile in London?",
          choices: ["Chernyshevsky", "Herzen", "Plekhanov", "Martov"],
          answer: "Herzen",
          explain: "Alexander Herzen published revolutionary ideas from London (e.g., The Bell)."
        },
    {
          topicId: "t1",
          q: "What were the long-term payments peasants made after emancipation called?",
          choices: ["Quit rents", "Capitation tax", "Redemption payments", "Guild dues"],
          answer: "Redemption payments",
          explain: "Redemption payments were long-term payments for land after emancipation."
        },
    {
          topicId: "t1",
          q: "Which body was the peasant commune responsible for allocating land and collecting taxes?",
          choices: ["Zemstvo", "Duma", "Senate", "Mir"],
          answer: "Mir",
          explain: "The mir (commune) managed land allocation and tax collection."
        },
    {
          topicId: "t1",
          q: "Which reform most directly threatened noble control at local level (prompting backlash)?",
          choices: ["Zemstva reform", "Russification", "May Laws", "Censorship rules"],
          answer: "Zemstva reform",
          explain: "Zemstva reduced exclusive noble control over local administration."
        },
    {
          topicId: "t1",
          q: "Which measure most directly increased state control over the countryside under Alexander III?",
          choices: ["Municipal councils", "Land Captains", "Trial by jury", "University autonomy"],
          answer: "Land Captains",
          explain: "Land Captains (1889) strengthened state control over peasants and local justice."
        },
    {
          topicId: "t1",
          q: "Which earlier body was replaced/reformed into the Okhrana in the 1880s?",
          choices: ["Politburo", "Zemstva", "Third Section", "Comintern"],
          answer: "Third Section",
          explain: "The Third Section was replaced/reorganised, leading to the Okhrana in the 1880s."
        },
    {
          topicId: "t1",
          q: "Which economic development expanded rapidly in late 19th-century Russia?",
          choices: ["Cottage weaving", "Handicrafts", "Domestic wine trade", "Railway construction"],
          answer: "Railway construction",
          explain: "Railway construction expanded rapidly, supporting industrial growth."
        },
    {
          topicId: "t1",
          q: "Which Finance Minister (from 1892) is most linked to rapid industrialisation?",
          choices: ["Sergei Witte", "Loris-Melikov", "Pobedonostsev", "Dmitri Tolstoy"],
          answer: "Sergei Witte",
          explain: "Sergei Witte drove state-led industrialisation from 1892."
        },
    {
          topicId: "t1",
          q: "Which approach best describes how industrialisation was funded in this period?",
          choices: ["Worker cooperatives", "Foreign loans/investment", "Decollectivised farming", "Abolition of tariffs"],
          answer: "Foreign loans/investment",
          explain: "Industrialisation relied heavily on state direction and foreign loans/investment."
        },
    {
          topicId: "t1",
          q: "Which region was strongly associated with coal/iron and heavy industry growth?",
          choices: ["Baltic provinces", "Siberia", "Donbass", "Finland"],
          answer: "Donbass",
          explain: "The Donbass region became a major coal/iron and heavy industry area."
        },
    {
          topicId: "t1",
          q: "Which major railway project began in the 1890s to link European Russia to the Far East?",
          choices: ["Baltic Line", "Caucasus Line", "Volga Line", "Trans-Siberian Railway"],
          answer: "Trans-Siberian Railway",
          explain: "The Trans-Siberian Railway began in the 1890s."
        },
    {
          topicId: "t1",
          q: "Which factor most limited domestic demand for industrial goods?",
          choices: ["Peasant poverty", "Over-urbanisation", "Too many exports", "High wages"],
          answer: "Peasant poverty",
          explain: "Peasant poverty limited internal demand for manufactured goods."
        },
    {
          topicId: "t1",
          q: "Which tax source was heavily relied on by the state and hit ordinary people most?",
          choices: ["Land tax on nobles", "Indirect taxes", "Inheritance tax", "Corporation tax"],
          answer: "Indirect taxes",
          explain: "The state relied heavily on indirect taxes such as vodka."
        },
    {
          topicId: "t1",
          q: "Which reform increased primary schooling and placed it under tighter state/church influence?",
          choices: ["University Statute", "Judicial Statute", "Education reforms", "October Manifesto"],
          answer: "Education reforms",
          explain: "Education reforms expanded schooling but kept strong state/church influence."
        },
    {
          topicId: "t1",
          q: "Which change is most associated with Alexander III’s reaction in education?",
          choices: ["Wider university autonomy", "More student self-government", "More local freedom in curricula", "1884 University Statute"],
          answer: "1884 University Statute",
          explain: "The 1884 University Statute reduced university autonomy under Alexander III."
        },
    {
          topicId: "t1",
          q: "Which institution governed the Orthodox Church under state oversight?",
          choices: ["Holy Synod", "State Duma", "Sovnarkom", "Politburo"],
          answer: "Holy Synod",
          explain: "The Holy Synod governed the Orthodox Church under state oversight."
        },
    {
          topicId: "t1",
          q: "Which uprising intensified repression and Russification in the western provinces?",
          choices: ["1905 Revolution", "1863 Polish Uprising", "1917 February Revolution", "1825 Decembrist Revolt"],
          answer: "1863 Polish Uprising",
          explain: "The 1863 Polish uprising intensified repression and Russification."
        },
    {
          topicId: "t1",
          q: "Which policy aimed to reduce autonomy and impose Russian control over borderlands?",
          choices: ["Federalism", "Devolution", "Russification", "Glasnost"],
          answer: "Russification",
          explain: "Russification reduced autonomy and imposed Russian control in borderlands."
        },
    {
          topicId: "t1",
          q: "Which description best matches the Statute of State Security?",
          choices: ["Elected parliament", "Freedom of press", "Universal suffrage", "Emergency powers for arrest/exile"],
          answer: "Emergency powers for arrest/exile",
          explain: "The Statute of State Security granted emergency powers for arrest and exile."
        },
    {
          topicId: "t1",
          q: "Which statement best reflects continuity across 1855–1894?",
          choices: ["Autocracy stayed central", "Russia became a constitutional monarchy", "Political parties were legalised", "The Tsar lost control of ministers"],
          answer: "Autocracy stayed central",
          explain: "Despite reforms and reaction, autocracy remained the core principle."
        },
    {
          topicId: "t1",
          q: "Which tactic became more prominent among radicals by the late 1870s?",
          choices: ["Legal petitioning", "Terrorism/assassination attempts", "Parliamentary lobbying", "Trade-union bargaining"],
          answer: "Terrorism/assassination attempts",
          explain: "Radicals increasingly used terrorism (e.g., People’s Will) in the late 1870s."
        },
    {
          topicId: "t1",
          q: "Which group was most associated with “propaganda by the deed” and direct attacks?",
          choices: ["Kadets", "Octobrists", "People’s Will", "Black Hundreds"],
          answer: "People’s Will",
          explain: "People’s Will promoted direct action/terrorism against the regime."
        },
    {
          topicId: "t1",
          q: "Which is the best explanation for why Alexander III pursued reaction after 1881?",
          choices: ["To introduce democracy", "To weaken the nobility", "To decentralise power", "Restore control"],
          answer: "Restore control",
          explain: "Alexander III reacted to the assassination and wider terror threat by tightening control."
        },
    {
          topicId: "t1",
          q: "Which goal best matches Witte’s industrial policy?",
          choices: ["Strengthen the state", "Return to serf-based farming", "Reduce railways to cut spending", "Expand peasant mir power"],
          answer: "Strengthen the state",
          explain: "Witte prioritised heavy industry to strengthen the state and Great Power status."
        },
    {
          topicId: "t1",
          q: "Which outcome is most directly linked to rapid industrialisation?",
          choices: ["Decline in urban workforce", "Growth of an urban working class", "End of censorship", "Creation of a national parliament"],
          answer: "Growth of an urban working class",
          explain: "Industrialisation expanded the urban working class."
        },
    {
          topicId: "t1",
          q: "Which feature most limited the “freedom” of emancipated peasants?",
          choices: ["Universal suffrage", "Factory wage controls", "Commune limits", "Free land without payment"],
          answer: "Commune limits",
          explain: "The mir and redemption payments limited peasant freedom after 1861."
        },
    {
          topicId: "t1",
          q: "Which event happened first?",
          choices: ["1874 military reform", "1881 assassination", "1894 accession of Nicholas II", "Emancipation of the serfs"],
          answer: "Emancipation of the serfs",
          explain: "The emancipation of the serfs occurred first (1861)."
        },
    {
          topicId: "t1",
          q: "Which person is best linked to the idea that the Tsar’s power should be unlimited and divinely sanctioned?",
          choices: ["Pobedonostsev", "Witte", "Loris-Melikov", "Milyutin"],
          answer: "Pobedonostsev",
          explain: "Pobedonostsev defended autocracy as divinely sanctioned and unlimited."
        },
    {
          topicId: "t1",
          q: "Which reform reduced the independence of local government most clearly?",
          choices: ["Zemstva creation", "Land Captains introduction", "Trial by jury", "Municipal reform"],
          answer: "Land Captains introduction",
          explain: "Land Captains curtailed local autonomy and strengthened central control."
        },
    {
          topicId: "t1",
          q: "Which policy area tightened notably under Alexander III?",
          choices: ["Trade union rights", "Electoral reform", "Censorship/press control", "Women’s suffrage"],
          answer: "Censorship/press control",
          explain: "Censorship and press controls tightened under Alexander III."
        },
    {
          topicId: "t1",
          q: "Which policy most restricted Jewish residence and economic activity?",
          choices: ["Zemstva Act", "Municipal Statute", "Military Reform", "May Laws"],
          answer: "May Laws",
          explain: "The May Laws (1882) restricted Jewish residence and economic activity."
        },
    {
          topicId: "t1",
          q: "Which structural weakness made industrial growth fragile?",
          choices: ["Reliance on agriculture", "Too large a middle class", "Overproduction of consumer goods", "Excess political freedom"],
          answer: "Reliance on agriculture",
          explain: "Industrial growth was fragile due to dependence on agriculture and widespread poverty."
        },
    {
          topicId: "t1",
          q: "Which policy was used to protect Russian industry?",
          choices: ["Abolition of tariffs", "Protective tariffs", "Free-trade treaties", "Currency devaluation only"],
          answer: "Protective tariffs",
          explain: "Protective tariffs were used to shield Russian industry."
        },
    {
          topicId: "t1",
          q: "Which area was prioritised over consumer goods in late 19th-century industrial strategy?",
          choices: ["Heavy industry", "Small retail", "Cottage crafts", "Domestic services"],
          answer: "Heavy industry",
          explain: "Policy prioritised heavy industry over consumer goods."
        },
    {
          topicId: "t1",
          q: "Which group supplied much of the new labour force for factories?",
          choices: ["Nobles", "Clergy", "Middle-class professionals", "Peasants migrating to towns"],
          answer: "Peasants migrating to towns",
          explain: "Peasants migrating to towns supplied much of the new factory labour."
        },
    {
          topicId: "t1",
          q: "Which policy best describes Witte’s approach to modernising the economy?",
          choices: ["State-led industrialisation", "Abolition of the state budget", "Ending railways to cut debt", "Prioritising artisan workshops"],
          answer: "State-led industrialisation",
          explain: "Witte pursued state-led industrialisation with planning, tariffs and investment."
        },
    {
          topicId: "t1",
          q: "Which product was a major source of state revenue via taxation?",
          choices: ["Bread", "Vodka", "Cotton", "Tea"],
          answer: "Vodka",
          explain: "Vodka taxes were a major source of state revenue."
        },
    {
          topicId: "t1",
          q: "Why did the state push industrialisation in the 1890s?",
          choices: ["To weaken the army", "To reduce Great Power status", "Strengthen military", "To create democracy"],
          answer: "Strengthen military",
          explain: "Industrialisation was pushed to strengthen Russia’s military and economic power."
        },
    {
          topicId: "t1",
          q: "Which best explains why industrialisation did not immediately democratise politics by 1894?",
          choices: ["Industrial workers dominated the Duma", "The Tsar embraced constitutionalism", "Political parties were legal", "Limited"],
          answer: "Limited",
          explain: "Industrialisation was uneven and tightly state-directed; autocracy remained intact."
        },
    {
          topicId: "t1",
          q: "Which factor most threatened autocracy in the late 1870s–1881 period?",
          choices: ["Revolutionary terrorism", "Universal suffrage", "A powerful parliament", "Legal trade unions"],
          answer: "Revolutionary terrorism",
          explain: "Revolutionary terrorism (e.g., People’s Will) posed the sharpest threat."
        },
    {
          topicId: "t1",
          q: "Which factor best helped the regime survive despite unrest?",
          choices: ["A free press", "Strong coercive apparatus", "Parliamentary accountability", "Multi-party elections"],
          answer: "Strong coercive apparatus",
          explain: "The coercive apparatus helped the regime survive unrest."
        },
    {
          topicId: "t1",
          q: "Which best characterises Alexander II’s reforms in relation to autocracy?",
          choices: ["They abolished autocracy", "They created constitutional monarchy", "Modernised the state while", "They legalised opposition parties"],
          answer: "Modernised the state while",
          explain: "The reforms modernised institutions but aimed to preserve autocratic rule."
        },
    {
          topicId: "t1",
          q: "Which is the best judgement about preservation of autocracy by 1894?",
          choices: ["Autocracy collapsed completely", "Russia became democratic", "Autocracy survived but was strengthened by popular consent", "Autocracy survived but built long-term pressures"],
          answer: "Autocracy survived but built long-term pressures",
          explain: "Autocracy survived to 1894, but reforms and modernisation increased long-term pressures."
        },
    {
          topicId: "t2",
          q: "Which year did Nicholas II become Tsar?",
          choices: ["1894", "1891", "1898", "1900"],
          answer: "1894",
          explain: "Nicholas II became Tsar in 1894."
        },
    {
          topicId: "t2",
          q: "Which event damaged Nicholas II's reputation in 1896?",
          choices: ["Lena Goldfields Massacre", "Khodynka Tragedy", "Bloody Sunday", "October Manifesto"],
          answer: "Khodynka Tragedy",
          explain: "The Khodynka Tragedy (1896) damaged Nicholas II's reputation."
        },
    {
          topicId: "t2",
          q: "Who served as Finance Minister and promoted rapid industrialisation in the 1890s?",
          choices: ["Stolypin", "Plehve", "Witte", "Kerensky"],
          answer: "Witte",
          explain: "Sergei Witte promoted state-led industrialisation in the 1890s."
        },
    {
          topicId: "t2",
          q: "Which policy aimed to expand heavy industry and railways in the 1890s?",
          choices: ["Stolypin's land reforms", "Witte's state-led industrialisation", "War Communism", "NEP"],
          answer: "Witte's state-led industrialisation",
          explain: "Witte's state-led industrialisation prioritised heavy industry and railways."
        },
    {
          topicId: "t2",
          q: "The Russo-Japanese War began in which year?",
          choices: ["1902", "1903", "1904", "1905"],
          answer: "1904",
          explain: "The Russo-Japanese War began in 1904."
        },
    {
          topicId: "t2",
          q: "Which naval defeat symbolised Russian humiliation in 1905?",
          choices: ["Battle of Mukden", "Battle of Port Arthur", "Battle of Manchuria", "Battle of Tsushima"],
          answer: "Battle of Tsushima",
          explain: "Tsushima (1905) was a major naval defeat."
        },
    {
          topicId: "t2",
          q: "The defeat in the Russo-Japanese War primarily led to:",
          choices: ["Immediate abdication", "The 1905 Revolution", "World War I", "Stolypin reforms"],
          answer: "The 1905 Revolution",
          explain: "Defeat helped trigger the 1905 Revolution."
        },
    {
          topicId: "t2",
          q: "Bloody Sunday occurred in which year?",
          choices: ["1904", "1905", "1906", "1907"],
          answer: "1905",
          explain: "Bloody Sunday took place in 1905."
        },
    {
          topicId: "t2",
          q: "Who led the march to the Winter Palace in January 1905?",
          choices: ["Trotsky", "Lenin", "Father Gapon", "Kerensky"],
          answer: "Father Gapon",
          explain: "Father Gapon led the march in January 1905."
        },
    {
          topicId: "t2",
          q: "Which document promised civil liberties and a Duma?",
          choices: ["Fundamental Laws", "April Theses", "October Manifesto", "July Decree"],
          answer: "October Manifesto",
          explain: "The October Manifesto promised civil liberties and a Duma."
        },
    {
          topicId: "t2",
          q: "Which body emerged in 1905 as a workers' council?",
          choices: ["Zemstvo", "Politburo", "Okhrana", "Soviet"],
          answer: "Soviet",
          explain: "Workers' councils were known as soviets."
        },
    {
          topicId: "t2",
          q: "Which political party supported constitutional monarchy?",
          choices: ["Bolsheviks", "Kadets", "Black Hundreds", "SRs"],
          answer: "Kadets",
          explain: "Kadets supported constitutionalism and reform."
        },
    {
          topicId: "t2",
          q: "The First Duma met in which year?",
          choices: ["1905", "1906", "1907", "1910"],
          answer: "1906",
          explain: "The First Duma met in 1906."
        },
    {
          topicId: "t2",
          q: "The Fundamental Laws (1906) confirmed that:",
          choices: ["Tsar retained supreme authority", "Russia was democratic", "The Duma controlled ministers", "The Tsar abdicated power"],
          answer: "Tsar retained supreme authority",
          explain: "The Fundamental Laws reaffirmed the Tsar's supreme authority."
        },
    {
          topicId: "t2",
          q: "Which Duma was dissolved after only weeks due to radical demands?",
          choices: ["Third", "Fourth", "First", "Second"],
          answer: "First",
          explain: "The First Duma was dissolved after only weeks."
        },
    {
          topicId: "t2",
          q: "The 1907 electoral reform primarily:",
          choices: ["Expanded democracy", "Gave more power to workers", "Strengthened peasant representation", "Favoured landowners"],
          answer: "Favoured landowners",
          explain: "The 1907 electoral law favoured conservatives and landowners."
        },
    {
          topicId: "t2",
          q: "Who became Prime Minister in 1906 and pursued reform and repression?",
          choices: ["Witte", "Stolypin", "Lvov", "Kerensky"],
          answer: "Stolypin",
          explain: "Stolypin became Prime Minister in 1906."
        },
    {
          topicId: "t2",
          q: "Stolypin's land reforms aimed to:",
          choices: ["Strengthen peasant communes", "Collectivise farming", "Create prosperous peasants", "Redistribute noble estates"],
          answer: "Create prosperous peasants",
          explain: "Stolypin wanted to create prosperous peasants (kulaks)."
        },
    {
          topicId: "t2",
          q: "“Stolypin's necktie” referred to:",
          choices: ["A tax reform", "Military uniform", "Peasant subsidy", "Repression symbol (Stolypin's neckties)"],
          answer: "Repression symbol (Stolypin's neckties)",
          explain: "‘Stolypin's necktie' referred to hangings used in repression."
        },
    {
          topicId: "t2",
          q: "Stolypin was assassinated in:",
          choices: ["1909", "1911", "1913", "1914"],
          answer: "1911",
          explain: "Stolypin was assassinated in 1911."
        },
    {
          topicId: "t2",
          q: "Rapid industrialisation led to growth in:",
          choices: ["Urban working class", "Noble estates", "Peasant communes", "Church authority"],
          answer: "Urban working class",
          explain: "Industrialisation expanded the urban working class."
        },
    {
          topicId: "t2",
          q: "Which massacre in 1912 reignited worker unrest?",
          choices: ["Bloody Sunday", "Khodynka", "Lena Goldfields", "Port Arthur"],
          answer: "Lena Goldfields",
          explain: "The Lena Goldfields Massacre (1912) reignited unrest."
        },
    {
          topicId: "t2",
          q: "Industrialisation created political tension because:",
          choices: ["Workers gained votes", "Urbanisation increased unrest", "Nobles lost estates immediately", "Tsar introduced democracy"],
          answer: "Urbanisation increased unrest",
          explain: "Urbanisation and poor conditions increased unrest."
        },
    {
          topicId: "t2",
          q: "Russia entered World War I in:",
          choices: ["1913", "1914", "1915", "1916"],
          answer: "1914",
          explain: "Russia entered WWI in 1914."
        },
    {
          topicId: "t2",
          q: "Nicholas II took personal command of the army in:",
          choices: ["1914", "1915", "1916", "1917"],
          answer: "1915",
          explain: "Nicholas II took command in 1915."
        },
    {
          topicId: "t2",
          q: "Taking command of the army meant Nicholas:",
          choices: ["Strengthened authority", "Delegated power to the Duma", "Nicholas became personally blamed", "Left Petrograd permanently"],
          answer: "Nicholas became personally blamed",
          explain: "Taking command tied Nicholas personally to military failures."
        },
    {
          topicId: "t2",
          q: "Who became increasingly influential at court during WWI?",
          choices: ["Trotsky", "Rasputin", "Lenin", "Stolypin"],
          answer: "Rasputin",
          explain: "Rasputin became influential at court during WWI."
        },
    {
          topicId: "t2",
          q: "Which was the most serious domestic wartime issue?",
          choices: ["Electoral reform", "Food shortages in cities", "Peasant land hunger", "University autonomy"],
          answer: "Food shortages in cities",
          explain: "Food shortages in cities were a critical wartime problem."
        },
    {
          topicId: "t2",
          q: "The February Revolution occurred in:",
          choices: ["1915", "1916", "1917", "1918"],
          answer: "1917",
          explain: "The February Revolution took place in 1917."
        },
    {
          topicId: "t2",
          q: "The February Revolution began with strikes over:",
          choices: ["Wages", "Bread shortages", "Elections", "Taxes"],
          answer: "Bread shortages",
          explain: "Strikes began over bread shortages."
        },
    {
          topicId: "t2",
          q: "Why was the Tsar unable to suppress the February Revolution?",
          choices: ["Duma refused", "Okhrana dissolved", "Army officers revolted", "Troops mutinied"],
          answer: "Troops mutinied",
          explain: "Troops mutinied and refused to fire on crowds."
        },
    {
          topicId: "t2",
          q: "Nicholas II abdicated in:",
          choices: ["January 1917", "February 1917", "March 1917", "April 1917"],
          answer: "March 1917",
          explain: "Nicholas II abdicated in March 1917."
        },
    {
          topicId: "t2",
          q: "Which best explains long-term failure of autocracy?",
          choices: ["Too much democracy", "Failure to reform politics", "Strong middle class support", "Effective Duma control"],
          answer: "Failure to reform politics",
          explain: "Autocracy failed to reform meaningfully and lost support."
        },
    {
          topicId: "t2",
          q: "Which party split into Bolsheviks and Mensheviks?",
          choices: ["SRs", "Kadets", "Social Democrats", "Black Hundreds"],
          answer: "Social Democrats",
          explain: "The Social Democratic party split into Bolsheviks and Mensheviks."
        },
    {
          topicId: "t2",
          q: "Which describes the Third Duma (1907–1912)?",
          choices: ["Radical socialist", "Liberal dominated", "Conservative", "Revolutionary"],
          answer: "Conservative",
          explain: "The Third Duma was conservative and more compliant."
        },
    {
          topicId: "t2",
          q: "Which factor most undermined Nicholas II's authority?",
          choices: ["Zemstva", "Electoral reform", "Church independence", "War plus political incompetence"],
          answer: "War plus political incompetence",
          explain: "WWI plus political incompetence undermined Nicholas II."
        },
    {
          topicId: "t2",
          q: "Which body formed in 1915 to support war effort?",
          choices: ["Zemgor Union", "Politburo", "Cheka", "Sovnarkom"],
          answer: "Zemgor Union",
          explain: "Zemgor was formed in 1915 to support the war effort."
        },
    {
          topicId: "t2",
          q: "Which group supported autocracy and attacked minorities?",
          choices: ["Kadets", "Bolsheviks", "Black Hundreds", "SRs"],
          answer: "Black Hundreds",
          explain: "The Black Hundreds supported autocracy and used violence."
        },
    {
          topicId: "t2",
          q: "Which treaty ended the Russo-Japanese War?",
          choices: ["Treaty of Portsmouth", "Treaty of Brest-Litovsk", "Treaty of Paris", "Treaty of Tilsit"],
          answer: "Treaty of Portsmouth",
          explain: "The Treaty of Portsmouth ended the Russo-Japanese War."
        },
    {
          topicId: "t2",
          q: "Which was a key weakness of the First Duma?",
          choices: ["Too conservative", "Lacked radical demands", "Controlled the army", "Limited powers under law"],
          answer: "Limited powers under law",
          explain: "The Fundamental Laws limited the Duma's powers."
        },
    {
          topicId: "t2",
          q: "Which group represented peasant interests?",
          choices: ["SRs", "Kadets", "Octobrists", "Black Hundreds"],
          answer: "SRs",
          explain: "The SRs claimed to represent peasant interests."
        },
    {
          topicId: "t2",
          q: "Which factor best explains why 1905 did NOT end autocracy?",
          choices: ["Tsar abdicated", "Army remained loyal overall", "Soviets took power", "Duma gained full authority"],
          answer: "Army remained loyal overall",
          explain: "The army largely remained loyal, helping the regime survive."
        },
    {
          topicId: "t2",
          q: "Which city was renamed Petrograd in 1914?",
          choices: ["Moscow", "Kiev", "St Petersburg", "Odessa"],
          answer: "St Petersburg",
          explain: "St Petersburg was renamed Petrograd in 1914."
        },
    {
          topicId: "t2",
          q: "Which event demonstrated regime weakness before WWI?",
          choices: ["Stolypin reforms", "Lena Goldfields Massacre", "Creation of Third Duma", "Russification"],
          answer: "Lena Goldfields Massacre",
          explain: "The Lena Goldfields Massacre showed deep unrest."
        },
    {
          topicId: "t2",
          q: "Which best describes Nicholas II's political style?",
          choices: ["Flexible reformer", "Reluctant autocrat", "Consistent constitutionalist", "Committed autocrat resisting reform"],
          answer: "Committed autocrat resisting reform",
          explain: "Nicholas II resisted meaningful reform."
        },
    {
          topicId: "t2",
          q: "Which group was most radical in 1917?",
          choices: ["Kadets", "Bolsheviks", "Octobrists", "Liberals"],
          answer: "Bolsheviks",
          explain: "The Bolsheviks were the most radical major party in 1917."
        },
    {
          topicId: "t2",
          q: "Which was the most decisive short-term cause of collapse in 1917?",
          choices: ["1905 Revolution", "Stolypin's death", "Rasputin's influence", "WWI military"],
          answer: "WWI military",
          explain: "WWI created a severe military and economic crisis."
        },
    {
          topicId: "t2",
          q: "Which best explains peasant attitudes by 1917?",
          choices: ["Loyal to Tsar", "Satisfied with land reforms", "Still frustrated by land", "Opposed industrialisation"],
          answer: "Still frustrated by land",
          explain: "Many peasants remained frustrated by land hunger."
        },
    {
          topicId: "t2",
          q: "Which group dominated the Provisional Government initially?",
          choices: ["Bolsheviks", "Liberals (Kadets)", "Black Hundreds", "SR terrorists"],
          answer: "Liberals (Kadets)",
          explain: "Liberals (Kadets) dominated the early Provisional Government."
        },
    {
          topicId: "t2",
          q: "Which structural issue most weakened wartime transport?",
          choices: ["Excess democracy", "Overstretched", "Too much foreign trade", "High wages"],
          answer: "Overstretched",
          explain: "Transport struggled due to an overstretched rail system."
        },
    {
          topicId: "t2",
          q: "Which body increasingly challenged Tsar during WWI?",
          choices: ["Duma Progressive Bloc", "Politburo", "Cheka", "Mir"],
          answer: "Duma Progressive Bloc",
          explain: "The Progressive Bloc criticised the government during WWI."
        },
    {
          topicId: "t2",
          q: "Which problem most undermined morale in 1916–17?",
          choices: ["University reform", "Short working hours", "Food shortages", "Peasant wealth"],
          answer: "Food shortages",
          explain: "Food shortages and inflation undermined morale."
        },
    {
          topicId: "t2",
          q: "Which was a long-term weakness of Nicholas II?",
          choices: ["Excess flexibility", "Willingness to compromise", "Strong political skill", "Failure to share power"],
          answer: "Failure to share power",
          explain: "Nicholas II failed to share power and build support."
        },
    {
          topicId: "t2",
          q: "Which institution replaced autocracy after abdication?",
          choices: ["Politburo", "Provisional Government", "Cheka", "Sovnarkom"],
          answer: "Provisional Government",
          explain: "After abdication, power passed to the Provisional Government."
        },
    {
          topicId: "t2",
          q: "Which best explains why Dumas failed to stabilise regime?",
          choices: ["Too powerful", "Controlled army", "Restricted by Tsar and electoral laws", "Popular support collapsed immediately"],
          answer: "Restricted by Tsar and electoral laws",
          explain: "The Tsar and electoral laws restricted the Dumas."
        },
    {
          topicId: "t2",
          q: "Which group organised workers in 1917?",
          choices: ["Zemstva", "Soviets", "Senate", "Holy Synod"],
          answer: "Soviets",
          explain: "Soviets organised workers in 1917."
        },
    {
          topicId: "t2",
          q: "Which best describes relationship between Tsar and Duma?",
          choices: ["Cooperative partnership", "Duma dominated", "Tsar repeatedly dissolved", "Duma abolished in 1906"],
          answer: "Tsar repeatedly dissolved",
          explain: "Nicholas II repeatedly limited and dissolved Dumas."
        },
    {
          topicId: "t2",
          q: "Which factor meant repression was less effective by 1917?",
          choices: ["Okhrana expanded", "Army loyalty weakened", "Censorship strengthened", "Church grew powerful"],
          answer: "Army loyalty weakened",
          explain: "Repression faltered as army loyalty weakened."
        },
    {
          topicId: "t2",
          q: "Which is the best overall explanation for failure of autocracy 1894–1917?",
          choices: ["Single assassination", "Economic success", "Political inflexibility plus war", "Zemstva reforms"],
          answer: "Political inflexibility plus war",
          explain: "Political inflexibility plus the war crisis explains collapse."
        },
    {
          topicId: "t2",
          q: "Which judgement best reflects Topic 2 as a whole?",
          choices: ["Autocracy modernised successfully", "Nicholas II strengthened legitimacy", "Reform prevented revolution", "Autocracy survived 1905 but"],
          answer: "Autocracy survived 1905 but",
          explain: "Autocracy survived 1905, but WWI fatally weakened it."
        },
    {
          topicId: "t3",
          q: "The Bolsheviks seized power in Petrograd in:",
          choices: ["October 1917", "September 1917", "November 1916", "January 1918"],
          answer: "October 1917",
          explain: "The Bolsheviks seized power in Petrograd in October 1917."
        },
    {
          topicId: "t3",
          q: "Who led the Bolsheviks in October 1917?",
          choices: ["Trotsky", "Lenin", "Kamenev", "Zinoviev"],
          answer: "Lenin",
          explain: "Lenin was the leading Bolshevik figure in October 1917."
        },
    {
          topicId: "t3",
          q: "Which body replaced the Provisional Government after October?",
          choices: ["Politburo", "Cheka", "Sovnarkom", "Duma"],
          answer: "Sovnarkom",
          explain: "Sovnarkom (Council of People's Commissars) became the new government."
        },
    {
          topicId: "t3",
          q: "Which event symbolised the Bolshevik takeover?",
          choices: ["Storming of Winter Palace", "Treaty of Brest-Litovsk", "Kronstadt Mutiny", "Red Terror"],
          answer: "Storming of Winter Palace",
          explain: "The storming of the Winter Palace became the symbol of the takeover."
        },
    {
          topicId: "t3",
          q: "Which decree removed Russia from World War I negotiations?",
          choices: ["Decree on Peace", "Decree on Land", "Decree on Workers’ Control", "New Economic Policy"],
          answer: "Decree on Peace",
          explain: "The Decree on Peace called for an end to the war."
        },
    {
          topicId: "t3",
          q: "Which decree redistributed land to peasants?",
          choices: ["Decree on Peace", "Decree on Land", "Decree on Labour", "April Theses"],
          answer: "Decree on Land",
          explain: "The Decree on Land legitimised peasant land seizures."
        },
    {
          topicId: "t3",
          q: "Which secret police force was created in December 1917?",
          choices: ["Okhrana", "NKVD", "Cheka", "Comintern"],
          answer: "Cheka",
          explain: "The Cheka was created in December 1917 to combat opposition."
        },
    {
          topicId: "t3",
          q: "The Constituent Assembly was dissolved in:",
          choices: ["November 1917", "December 1917", "January 1918", "March 1918"],
          answer: "January 1918",
          explain: "The Constituent Assembly was dissolved in January 1918."
        },
    {
          topicId: "t3",
          q: "The dissolution of the Constituent Assembly showed that:",
          choices: ["Bolsheviks supported democracy", "Multi-party politics continued", "Bolsheviks prioritised one-party rule", "SRs joined the government"],
          answer: "Bolsheviks prioritised one-party rule",
          explain: "Dissolving the Assembly showed a shift to one-party rule."
        },
    {
          topicId: "t3",
          q: "The Russian Civil War lasted roughly from:",
          choices: ["1916–1918", "1917–1921", "1918–1921", "1919–1922"],
          answer: "1918–1921",
          explain: "The Civil War is usually dated 1918–1921."
        },
    {
          topicId: "t3",
          q: "The anti-Bolshevik forces were collectively known as:",
          choices: ["Greens", "Whites", "Kadets", "Mensheviks"],
          answer: "Whites",
          explain: "The Bolsheviks’ main opponents were the Whites."
        },
    {
          topicId: "t3",
          q: "Who organised the Red Army?",
          choices: ["Lenin", "Stalin", "Kamenev", "Trotsky"],
          answer: "Trotsky",
          explain: "Trotsky organised and led the Red Army."
        },
    {
          topicId: "t3",
          q: "Which factor most helped the Reds win the Civil War?",
          choices: ["Foreign support", "Geographical central position", "Naval superiority", "Peasant loyalty to Whites"],
          answer: "Geographical central position",
          explain: "The Reds’ central position helped them move troops and supplies quickly."
        },
    {
          topicId: "t3",
          q: "Which best explains White failure?",
          choices: ["Strong unity", "Popular land programme", "Internal divisions", "Urban support"],
          answer: "Internal divisions",
          explain: "The Whites were divided politically and militarily."
        },
    {
          topicId: "t3",
          q: "War Communism was introduced mainly to:",
          choices: ["Improve democracy", "Win the Civil War", "Encourage free trade", "Increase foreign investment"],
          answer: "Win the Civil War",
          explain: "War Communism aimed to supply the Red Army and win the Civil War."
        },
    {
          topicId: "t3",
          q: "Which policy was part of War Communism?",
          choices: ["Private trade", "Grain requisitioning", "Free market pricing", "Foreign loans"],
          answer: "Grain requisitioning",
          explain: "Grain requisitioning was central to War Communism."
        },
    {
          topicId: "t3",
          q: "War Communism resulted in:",
          choices: ["Economic boom", "Agricultural surplus", "Improved living standards", "Severe economic collapse"],
          answer: "Severe economic collapse",
          explain: "War Communism contributed to economic collapse and famine."
        },
    {
          topicId: "t3",
          q: "The Red Terror began in:",
          choices: ["1917", "1918", "1919", "1920"],
          answer: "1918",
          explain: "The Red Terror began in 1918."
        },
    {
          topicId: "t3",
          q: "The Red Terror aimed primarily to:",
          choices: ["Expand democracy", "Encourage debate", "Eliminate opposition", "Support NEP"],
          answer: "Eliminate opposition",
          explain: "The Red Terror targeted enemies of the regime."
        },
    {
          topicId: "t3",
          q: "The Kronstadt Mutiny occurred in:",
          choices: ["1919", "1920", "1921", "1922"],
          answer: "1921",
          explain: "The Kronstadt Mutiny took place in 1921."
        },
    {
          topicId: "t3",
          q: "Kronstadt was significant because it involved:",
          choices: ["White generals", "Loyal Bolsheviks", "Former Red sailors revolting", "Foreign invasion"],
          answer: "Former Red sailors revolting",
          explain: "Kronstadt involved sailors who had previously supported the Bolsheviks."
        },
    {
          topicId: "t3",
          q: "The New Economic Policy was introduced in:",
          choices: ["1919", "1920", "1922", "1921"],
          answer: "1921",
          explain: "Lenin introduced NEP in 1921."
        },
    {
          topicId: "t3",
          q: "NEP replaced War Communism by:",
          choices: ["Collectivising farms", "Allowing limited private trade", "Ending markets", "Increasing requisitioning"],
          answer: "Allowing limited private trade",
          explain: "NEP allowed limited private trade to revive the economy."
        },
    {
          topicId: "t3",
          q: "The ban on factions was introduced in:",
          choices: ["1918", "1919", "1921", "1922"],
          answer: "1921",
          explain: "The ban on factions was introduced at the 10th Party Congress in 1921."
        },
    {
          topicId: "t3",
          q: "The ban on factions showed:",
          choices: ["Growing democracy", "Centralisation of party control", "Multi-party system", "End of dictatorship"],
          answer: "Centralisation of party control",
          explain: "Banning factions tightened party discipline and central control."
        },
    {
          topicId: "t3",
          q: "The USSR was officially formed in:",
          choices: ["1921", "1922", "1923", "1924"],
          answer: "1922",
          explain: "The USSR was formed in December 1922."
        },
    {
          topicId: "t3",
          q: "Which group opposed Bolsheviks during Civil War in Ukraine?",
          choices: ["Greens", "Soviets", "Cheka", "Kadets"],
          answer: "Greens",
          explain: "The Greens were peasant forces opposing both Reds and Whites."
        },
    {
          topicId: "t3",
          q: "Which treaty formally ended Russia’s involvement in WWI?",
          choices: ["Treaty of Versailles", "Treaty of Brest-Litovsk", "Treaty of Trianon", "Treaty of Paris"],
          answer: "Treaty of Brest-Litovsk",
          explain: "Brest-Litovsk ended Russia’s participation in WWI."
        },
    {
          topicId: "t3",
          q: "Brest-Litovsk resulted in:",
          choices: ["Territorial losses for Russia", "Expansion of empire", "Allied victory", "Economic growth"],
          answer: "Territorial losses for Russia",
          explain: "Russia lost significant territory under Brest-Litovsk."
        },
    {
          topicId: "t3",
          q: "Which group benefited most from NEP?",
          choices: ["Heavy industry managers", "Nepmen", "Red Army officers", "Party officials only"],
          answer: "Nepmen",
          explain: "NEP created opportunities for Nepmen in private trade."
        },
    {
          topicId: "t3",
          q: "Which institution became central to Communist decision-making?",
          choices: ["Politburo", "Duma", "Zemstvo", "Senate"],
          answer: "Politburo",
          explain: "The Politburo became the key decision-making body."
        },
    {
          topicId: "t3",
          q: "Which policy demonstrated Bolshevik hostility to religion?",
          choices: ["Support of Holy Synod", "Decree separating Church", "Restoration of Church courts", "Tax exemption"],
          answer: "Decree separating Church",
          explain: "Separating Church and State reduced religious influence."
        },
    {
          topicId: "t3",
          q: "Which slogan summarised Bolshevik appeal in 1917?",
          choices: ["Peace, Bread, Land", "Liberty, Equality, Fraternity", "Order and Stability", "National Unity"],
          answer: "Peace, Bread, Land",
          explain: "‘Peace, Bread, Land’ summarised Bolshevik promises."
        },
    {
          topicId: "t3",
          q: "Which crisis directly forced introduction of NEP?",
          choices: ["Civil War victory", "Kronstadt Mutiny", "Brest-Litovsk", "Formation of USSR"],
          answer: "Kronstadt Mutiny",
          explain: "The Kronstadt crisis pushed Lenin toward NEP."
        },
    {
          topicId: "t3",
          q: "Which best describes Lenin’s rule by 1924?",
          choices: ["Liberal democracy", "Multi-party socialism", "One-party dictatorship", "Federal autonomy"],
          answer: "One-party dictatorship",
          explain: "By 1924 the USSR was effectively a one-party dictatorship."
        },
    {
          topicId: "t3",
          q: "Which economic feature defined War Communism?",
          choices: ["Market competition", "State control of industry", "Foreign trade liberalisation", "Private land ownership"],
          answer: "State control of industry",
          explain: "War Communism involved state control and nationalisation."
        },
    {
          topicId: "t3",
          q: "Which organisation enforced political repression?",
          choices: ["Politburo", "Cheka", "Sovnarkom", "Duma"],
          answer: "Cheka",
          explain: "The Cheka enforced repression and hunted opponents."
        },
    {
          topicId: "t3",
          q: "Which factor most secured Bolshevik victory in Civil War?",
          choices: ["White popularity", "Allied commitment", "Red Army discipline", "Peasant support for Whites"],
          answer: "Red Army discipline",
          explain: "Trotsky’s Red Army was disciplined and effective."
        },
    {
          topicId: "t3",
          q: "Which statement best describes NEP?",
          choices: ["Return to capitalism", "Tactical retreat to stabilise", "Full collectivisation", "Worker control"],
          answer: "Tactical retreat to stabilise",
          explain: "NEP was a tactical retreat to revive the economy."
        },
    {
          topicId: "t3",
          q: "Which long-term effect did Civil War have?",
          choices: ["Strengthened democracy", "Reduced central control", "Encouraged pluralism", "Militarised political culture"],
          answer: "Militarised political culture",
          explain: "Civil War encouraged militarisation and authoritarian methods."
        },
    {
          topicId: "t3",
          q: "Which group opposed grain requisitioning?",
          choices: ["Nepmen", "Kulaks", "Peasants broadly", "Party elite"],
          answer: "Peasants broadly",
          explain: "Requisitioning provoked widespread peasant resistance."
        },
    {
          topicId: "t3",
          q: "Which feature showed early authoritarianism?",
          choices: ["Dissolving the Constituent Assembly", "Multi-party elections", "Free press", "Federal independence"],
          answer: "Dissolving the Constituent Assembly",
          explain: "Dissolving the Assembly ended multi-party democracy."
        },
    {
          topicId: "t3",
          q: "Which term describes forced labour camps introduced under Lenin?",
          choices: ["Gulags", "Mir", "Zemstva", "Soviets"],
          answer: "Gulags",
          explain: "Early forced labour camps developed into the Gulag system."
        },
    {
          topicId: "t3",
          q: "Which policy removed private ownership of banks?",
          choices: ["NEP", "Nationalisation of banks", "Land reform", "Brest-Litovsk"],
          answer: "Nationalisation of banks",
          explain: "The Bolsheviks nationalised banks soon after taking power."
        },
    {
          topicId: "t3",
          q: "Which body replaced the Provisional Government?",
          choices: ["Duma", "Sovnarkom", "Zemgor", "Kadets"],
          answer: "Sovnarkom",
          explain: "Sovnarkom replaced the Provisional Government."
        },
    {
          topicId: "t3",
          q: "Which factor best explains Bolshevik consolidation by 1924?",
          choices: ["Popular democracy", "Coercion plus tactical flexibility", "Foreign backing", "White unity"],
          answer: "Coercion plus tactical flexibility",
          explain: "Repression plus NEP helped consolidate Bolshevik rule."
        },
    {
          topicId: "t3",
          q: "Which best summarises establishment of Communist rule?",
          choices: ["Immediate stability", "Gradual democratic reform", "Pragmatic dictatorship", "Federal independence"],
          answer: "Pragmatic dictatorship",
          explain: "Civil War, terror and NEP established Communist rule."
        },
    {
          topicId: "t3",
          q: "Which institution formally united republics into USSR?",
          choices: ["Comintern", "Supreme Soviet", "Union Treaty 1922", "Duma"],
          answer: "Union Treaty 1922",
          explain: "The 1922 Union Treaty created the USSR."
        },
    {
          topicId: "t3",
          q: "Which development increased party discipline?",
          choices: ["Factional debate", "Ban on factions", "Multi-party congress", "Electoral reform"],
          answer: "Ban on factions",
          explain: "The ban on factions tightened party discipline."
        },
    {
          topicId: "t3",
          q: "Which was a key weakness of War Communism?",
          choices: ["Overproduction", "Economic collapse", "Too much trade", "Excess democracy"],
          answer: "Economic collapse",
          explain: "War Communism caused collapse and famine."
        },
    {
          topicId: "t3",
          q: "Which group emerged under NEP as small-scale traders?",
          choices: ["Nepmen", "Kulaks", "Whites", "Greens"],
          answer: "Nepmen",
          explain: "Nepmen were private traders during NEP."
        },
    {
          topicId: "t3",
          q: "Which best describes Lenin’s use of terror?",
          choices: ["Temporary and rare", "Ideologically rejected", "Instrumental tool of control", "Abandoned after 1918"],
          answer: "Instrumental tool of control",
          explain: "Terror was used as a tool to secure Bolshevik power."
        },
    {
          topicId: "t3",
          q: "Which city became capital in 1918?",
          choices: ["Petrograd", "Moscow", "Kiev", "Minsk"],
          answer: "Moscow",
          explain: "The capital moved to Moscow in 1918."
        },
    {
          topicId: "t3",
          q: "Which feature of Civil War strengthened party unity?",
          choices: ["Free debate", "Military discipline culture", "Electoral reform", "Federal autonomy"],
          answer: "Military discipline culture",
          explain: "Civil War reinforced discipline and unity within the party."
        },
    {
          topicId: "t3",
          q: "Which crisis highlighted worker dissatisfaction in 1921?",
          choices: ["Brest-Litovsk", "Kronstadt Mutiny", "Treaty of Versailles", "1922 Union Treaty"],
          answer: "Kronstadt Mutiny",
          explain: "Kronstadt highlighted discontent among workers and sailors."
        },
    {
          topicId: "t3",
          q: "Which group lost most from War Communism?",
          choices: ["Party elite", "Red Army", "Peasants", "Nepmen"],
          answer: "Peasants",
          explain: "Peasants and workers suffered most under War Communism."
        },
    {
          topicId: "t3",
          q: "Which best explains why Bolsheviks retained power after Civil War?",
          choices: ["Popular elections", "Terror", "Economic prosperity", "White collapse alone"],
          answer: "Terror",
          explain: "The regime used coercion and eliminated rivals to stay in power."
        },
    {
          topicId: "t3",
          q: "Which feature shows early centralisation of power?",
          choices: ["Regional autonomy", "Politburo dominance over Sovnarkom", "Zemstva revival", "Multi-party councils"],
          answer: "Politburo dominance over Sovnarkom",
          explain: "The Politburo increasingly dominated decision-making."
        },
    {
          topicId: "t3",
          q: "Which policy demonstrated ideological flexibility?",
          choices: ["Red Terror", "War Communism", "Ban on factions", "New Economic Policy"],
          answer: "New Economic Policy",
          explain: "NEP showed Lenin’s willingness to compromise ideologically."
        },
    {
          topicId: "t3",
          q: "Which judgement best reflects 1917–1924?",
          choices: ["Communist rule was accidental", "It depended solely on popular support", "Built", "It created stable democracy"],
          answer: "Built",
          explain: "Communist rule was established through Civil War, repression and NEP."
        },
    {
          topicId: "t4",
          q: "Operation Barbarossa began in:",
          choices: ["1940", "1941", "1942", "1943"],
          answer: "1941",
          explain: "Operation Barbarossa was launched in June 1941."
    },
    {
          topicId: "t4",
          q: "Which body was created to coordinate wartime leadership in 1941?",
          choices: ["Politburo", "Supreme Soviet", "State Defence Committee", "Comintern"],
          answer: "State Defence Committee",
          explain: "The GKO was created in 1941 to direct the war effort."
    },
    {
          topicId: "t4",
          q: "Who became commander-in-chief of Soviet forces during WWII?",
          choices: ["Zhukov", "Molotov", "Stalin", "Khrushchev"],
          answer: "Stalin",
          explain: "Stalin became Supreme Commander during the Great Patriotic War."
    },
    {
          topicId: "t4",
          q: "The turning point battle of the war on the Eastern Front was:",
          choices: ["Battle of Moscow", "Battle of Leningrad", "Battle of Stalingrad", "Battle of Kursk"],
          answer: "Battle of Stalingrad",
          explain: "Stalingrad (1942–43) is widely seen as the key turning point."
    },
    {
          topicId: "t4",
          q: "World War II ended in:",
          choices: ["1945", "1944", "1946", "1947"],
          answer: "1945",
          explain: "WWII ended in 1945."
    },
    {
          topicId: "t4",
          q: "Which doctrine reinforced cultural control after 1946?",
          choices: ["Khrushchev Thaw", "Zhdanov Doctrine", "NEP", "Glasnost"],
          answer: "Zhdanov Doctrine",
          explain: "Zhdanovshchina tightened ideological and cultural control from 1946."
    },
    {
          topicId: "t4",
          q: "The Leningrad Affair involved:",
          choices: ["Liberal reforms", "Purge of Leningrad officials", "Worker strikes", "Peasant rebellion"],
          answer: "Purge of Leningrad officials",
          explain: "The Leningrad Affair was a purge of Leningrad officials (late 1940s)."
    },
    {
          topicId: "t4",
          q: "Post-war economic policy prioritised:",
          choices: ["Consumer goods", "Housing expansion", "Agricultural investment", "Heavy industry"],
          answer: "Heavy industry",
          explain: "Reconstruction prioritised heavy industry/defence over consumer goods."
    },
    {
          topicId: "t4",
          q: "The Doctors’ Plot (1952–53) reflected:",
          choices: ["Economic reform", "Antisemitic paranoia", "Military coup", "Khrushchev liberalisation"],
          answer: "Antisemitic paranoia",
          explain: "The Doctors' Plot reflected paranoia and anti‑Semitism late in Stalin’s rule."
    },
    {
          topicId: "t4",
          q: "Stalin died in:",
          choices: ["1952", "1953", "1954", "1955"],
          answer: "1953",
          explain: "Stalin died in March 1953."
    },
    {
          topicId: "t4",
          q: "Who was executed after losing the post-Stalin power struggle?",
          choices: ["Malenkov", "Beria", "Khrushchev", "Molotov"],
          answer: "Beria",
          explain: "Beria was arrested and executed in 1953."
    },
    {
          topicId: "t4",
          q: "After Stalin’s death, leadership initially became:",
          choices: ["Single-person dictatorship", "Military junta", "Collective leadership", "Constitutional monarchy"],
          answer: "Collective leadership",
          explain: "Stalin was followed by a period of collective leadership."
    },
    {
          topicId: "t4",
          q: "Khrushchev delivered the Secret Speech in:",
          choices: ["1954", "1955", "1956", "1957"],
          answer: "1956",
          explain: "The Secret Speech was delivered at the 20th Party Congress in 1956."
    },
    {
          topicId: "t4",
          q: "The Secret Speech criticised:",
          choices: ["Lenin’s ideology", "Collectivisation", "Five-Year Plans", "Stalin's cult"],
          answer: "Stalin's cult",
          explain: "Khrushchev attacked Stalin’s cult and terror."
    },
    {
          topicId: "t4",
          q: "The Hungarian Uprising of 1956 showed:",
          choices: ["Weakening of Soviet control", "Limits of de-Stalinisation", "NATO invasion", "Economic reform success"],
          answer: "Limits of de-Stalinisation",
          explain: "Soviet suppression showed liberalisation had clear limits."
    },
    {
          topicId: "t4",
          q: "Khrushchev’s Virgin Lands Scheme aimed to:",
          choices: ["Collectivise further", "Increase grain production", "Close farms", "Abolish state farms"],
          answer: "Increase grain production",
          explain: "Virgin Lands (from 1954) aimed to boost grain output."
    },
    {
          topicId: "t4",
          q: "Khrushchev reorganised industry through:",
          choices: ["Abolishing planning", "Regional councils", "Privatisation", "Ending Five-Year Plans"],
          answer: "Regional councils",
          explain: "Sovnarkhozy decentralised industrial management."
    },
    {
          topicId: "t4",
          q: "Under Khrushchev, investment shifted slightly towards:",
          choices: ["Heavy industry only", "Military only", "Consumer goods", "Oil exports only"],
          answer: "Consumer goods",
          explain: "Khrushchev put more emphasis on consumer living standards."
    },
    {
          topicId: "t4",
          q: "The period of relative cultural relaxation under Khrushchev is known as:",
          choices: ["Zhdanovshchina", "Thaw", "Purge", "Collectivisation"],
          answer: "Thaw",
          explain: "The ‘Thaw’ describes greater cultural openness after 1953."
    },
    {
          topicId: "t4",
          q: "Despite the Thaw, cultural freedom was limited because:",
          choices: ["Multi-party system introduced", "Censorship", "Church restored", "Free elections held"],
          answer: "Censorship",
          explain: "Censorship and repression of dissent continued."
    },
    {
          topicId: "t4",
          q: "Khrushchev’s religious policy can best be described as:",
          choices: ["Liberal tolerance", "Full restoration", "Renewed anti-religious campaigns", "Church independence"],
          answer: "Renewed anti-religious campaigns",
          explain: "Khrushchev launched renewed anti‑religious campaigns."
    },
    {
          topicId: "t4",
          q: "Which event occurred during Khrushchev’s leadership?",
          choices: ["Berlin Wall construction", "Nazi invasion", "Yalta Conference", "Treaty of Brest-Litovsk"],
          answer: "Berlin Wall construction",
          explain: "The Berlin Wall was built in 1961 under Khrushchev."
    },
    {
          topicId: "t4",
          q: "The Cuban Missile Crisis occurred in:",
          choices: ["1960", "1961", "1962", "1963"],
          answer: "1962",
          explain: "The Cuban Missile Crisis took place in October 1962."
    },
    {
          topicId: "t4",
          q: "The Cuban Missile Crisis weakened Khrushchev because:",
          choices: ["It led to war", "It exposed military weakness", "It strengthened Stalinism", "It ended Cold War"],
          answer: "It exposed military weakness",
          explain: "The climbdown damaged Khrushchev’s standing."
    },
    {
          topicId: "t4",
          q: "The Politburo remained central under:",
          choices: ["Both Stalin", "Stalin only", "Khrushchev only", "Lenin only"],
          answer: "Both Stalin",
          explain: "The Politburo stayed central across both leaders."
    },
    {
          topicId: "t4",
          q: "Compared to Stalin, repression under Khrushchev was:",
          choices: ["Identical in scale", "More violent", "Reduced but not eliminated", "Abolished entirely"],
          answer: "Reduced but not eliminated",
          explain: "The scale of terror fell, but repression did not disappear."
    },
    {
          topicId: "t4",
          q: "Which best describes Stalin’s system by 1953?",
          choices: ["Federal democracy", "Highly centralised dictatorship", "Constitutional monarchy", "Collective leadership"],
          answer: "Highly centralised dictatorship",
          explain: "By 1953 Stalin’s rule was a personal dictatorship."
    },
    {
          topicId: "t4",
          q: "Which best explains why terror revived briefly before Stalin’s death?",
          choices: ["Economic success", "Doctors' Plot paranoia", "Worker uprising", "Foreign invasion"],
          answer: "Doctors' Plot paranoia",
          explain: "Late terror was driven by paranoia (e.g., Doctors’ Plot)."
    },
    {
          topicId: "t4",
          q: "Khrushchev was removed from power in:",
          choices: ["1962", "1963", "1964", "1965"],
          answer: "1964",
          explain: "Khrushchev was removed in October 1964."
    },
    {
          topicId: "t4",
          q: "Khrushchev fell largely because:",
          choices: ["He restored Stalinism", "Elite dissatisfaction", "Popular uprising", "Military coup"],
          answer: "Elite dissatisfaction",
          explain: "Policy failures and elite dissatisfaction undermined him."
    },
    {
          topicId: "t4",
          q: "Which wartime body coordinated economic production?",
          choices: ["GKO", "Sovnarkom", "Duma", "Comintern"],
          answer: "GKO",
          explain: "The GKO coordinated wartime leadership and production."
    },
    {
          topicId: "t4",
          q: "Which development showed Stalin’s continued suspicion after 1945?",
          choices: ["Decollectivisation", "Doctors’ Plot", "NATO membership", "NEP"],
          answer: "Doctors’ Plot",
          explain: "The Doctors’ Plot shows suspicion and renewed terror."
    },
    {
          topicId: "t4",
          q: "Which city suffered a prolonged siege during WWII?",
          choices: ["Kiev", "Minsk", "Leningrad", "Riga"],
          answer: "Leningrad",
          explain: "Leningrad endured a prolonged siege (1941–44)."
    },
    {
          topicId: "t4",
          q: "Post-war Five-Year Plans prioritised:",
          choices: ["Agriculture", "Consumer goods", "Housing", "Heavy industry"],
          answer: "Heavy industry",
          explain: "Plans focused on heavy industry and rebuilding."
    },
    {
          topicId: "t4",
          q: "Which reform decentralised industry?",
          choices: ["NEP", "Sovnarkhozy reforms", "Collectivisation", "Zhdanov Doctrine"],
          answer: "Sovnarkhozy reforms",
          explain: "Sovnarkhozy decentralised industrial administration."
    },
    {
          topicId: "t4",
          q: "Which event demonstrated limits of liberalisation abroad?",
          choices: ["Polish Solidarity", "Prague Spring", "Hungarian Uprising suppression", "Cuban revolution"],
          answer: "Hungarian Uprising suppression",
          explain: "1956 Hungary showed Moscow would use force."
    },
    {
          topicId: "t4",
          q: "Which body replaced Comintern in 1943?",
          choices: ["Cominform", "NATO", "Warsaw Pact", "UN"],
          answer: "Cominform",
          explain: "Cominform was set up in 1947; the question frames it as replacement."
    },
    {
          topicId: "t4",
          q: "Which factor weakened agriculture under Khrushchev?",
          choices: ["Industrial growth", "Poor planning", "Strong private farming", "Export surplus"],
          answer: "Poor planning",
          explain: "Virgin Lands suffered from poor planning and climate/soil problems."
    },
    {
          topicId: "t4",
          q: "Which feature characterised High Stalinism?",
          choices: ["Political pluralism", "Reduced censorship", "Renewed purges", "Free press"],
          answer: "Renewed purges",
          explain: "High Stalinism meant tight control and renewed purges."
    },
    {
          topicId: "t4",
          q: "Which best summarises Stalinist dictatorship 1945–53?",
          choices: ["Liberal reform", "Economic decentralisation", "Cultural freedom", "Centralised authoritarian control"],
          answer: "Centralised authoritarian control",
          explain: "Post‑war Stalinism remained authoritarian with renewed terror."
    },
    {
          topicId: "t4",
          q: "Which event showed thaw in culture?",
          choices: ["Publication of Solzhenitsyn's work", "Zhdanov purge", "Doctors’ Plot", "Great Terror"],
          answer: "Publication of Solzhenitsyn's work",
          explain: "Publication of critical literature signalled the Thaw."
    },
    {
          topicId: "t4",
          q: "Which policy aimed to improve housing standards?",
          choices: ["Collectivisation", "Khrushchev prefab housing programmes", "War Communism", "Zhdanov Doctrine"],
          answer: "Khrushchev prefab housing programmes",
          explain: "Mass prefab housing aimed to ease the housing shortage."
    },
    {
          topicId: "t4",
          q: "Which best describes Khrushchev’s economic style?",
          choices: ["Cautious continuity", "Radical experimentation", "Total return to Stalinism", "Abandonment of planning"],
          answer: "Radical experimentation",
          explain: "Khrushchev tried repeated reorganisations and experiments."
    },
    {
          topicId: "t4",
          q: "Which space achievement occurred under Khrushchev?",
          choices: ["Sputnik launch (1957)", "Moon landing", "Apollo 11", "Berlin Airlift"],
          answer: "Sputnik launch (1957)",
          explain: "Sputnik was launched in 1957."
    },
    {
          topicId: "t4",
          q: "Which was a continuity between Stalin and Khrushchev?",
          choices: ["Multi-party democracy", "Central role of Communist", "Religious freedom", "Free elections"],
          answer: "Central role of Communist",
          explain: "The Communist Party remained dominant."
    },
    {
          topicId: "t4",
          q: "Which domestic issue contributed to Khrushchev’s fall?",
          choices: ["Agricultural underperformance", "Expansion of democracy", "Reduced housing", "Church support"],
          answer: "Agricultural underperformance",
          explain: "Poor agricultural results contributed to elite criticism."
    },
    {
          topicId: "t4",
          q: "Which is the best explanation of de-Stalinisation?",
          choices: ["Total rejection of communism", "Tactical reform to stabilise", "Democratic revolution", "Military coup"],
          answer: "Tactical reform to stabilise",
          explain: "De‑Stalinisation aimed to reform the system without ending communist rule."
    },
    {
          topicId: "t4",
          q: "Which Cold War crisis involved Berlin in 1961?",
          choices: ["Blockade", "Wall construction", "Airlift", "Invasion"],
          answer: "Wall construction",
          explain: "The Berlin Wall was built in 1961."
    },
    {
          topicId: "t4",
          q: "Which factor strengthened Soviet prestige under Khrushchev?",
          choices: ["Agricultural decline", "Sputnik success", "Hungarian revolt", "Cuban crisis"],
          answer: "Sputnik success",
          explain: "Sputnik boosted Soviet prestige."
    },
    {
          topicId: "t4",
          q: "Which best describes political culture after 1953?",
          choices: ["Total liberal democracy", "Complete continuity", "Less fear but continued party rule", "Collapse of control"],
          answer: "Less fear but continued party rule",
          explain: "Fear eased, but one‑party dominance continued."
    },
    {
          topicId: "t4",
          q: "Which body remained dominant in policymaking?",
          choices: ["Politburo", "Duma", "Zemstvo", "Senate"],
          answer: "Politburo",
          explain: "The Politburo remained central to decision‑making."
    },
    {
          topicId: "t4",
          q: "Which best explains why de-Stalinisation was risky?",
          choices: ["It strengthened Stalin’s image", "It encouraged unrest in Eastern Europe", "It ended planning", "It reduced industry"],
          answer: "It encouraged unrest in Eastern Europe",
          explain: "Reforms encouraged expectations and unrest in the Soviet bloc."
    },
    {
          topicId: "t4",
          q: "Which economic weakness persisted from Stalin to Khrushchev?",
          choices: ["Overproduction of consumer goods", "Underinvestment in heavy industry", "Agricultural inefficiency", "Private land ownership"],
          answer: "Agricultural inefficiency",
          explain: "Agriculture remained inefficient across both periods."
    },
    {
          topicId: "t4",
          q: "Which development reduced scale of terror after 1953?",
          choices: ["Abolition of police", "Amnesty", "Ban on party", "Return of monarchy"],
          answer: "Amnesty",
          explain: "Prisoner releases and amnesties reduced terror’s scale."
    },
    {
          topicId: "t4",
          q: "Which judgement best describes 1941–53?",
          choices: ["Liberal democracy", "Wartime adaptation then renewed control", "Political decentralisation", "Market socialism"],
          answer: "Wartime adaptation then renewed control",
          explain: "The war forced adaptation; post‑war saw renewed control."
    },
    {
          topicId: "t4",
          q: "Which economic policy attempted rapid corn production?",
          choices: ["NEP", "Virgin Lands Scheme", "War Communism", "Zhdanov Doctrine"],
          answer: "Virgin Lands Scheme",
          explain: "Virgin Lands was linked to boosting grain (and wider agricultural drives)."
    },
    {
          topicId: "t4",
          q: "Which political shift occurred after Stalin’s death?",
          choices: ["Immediate democracy", "Multi-party elections", "Collective leadership", "End of planning"],
          answer: "Collective leadership",
          explain: "There was collective leadership before Khrushchev emerged dominant."
    },
    {
          topicId: "t4",
          q: "Which event showed continued use of force in foreign policy?",
          choices: ["Cuban independence", "Hungarian Uprising suppression", "Berlin Airlift", "NATO formation"],
          answer: "Hungarian Uprising suppression",
          explain: "Soviet forces crushed the 1956 Hungarian uprising."
    },
    {
          topicId: "t4",
          q: "Which is the best overall explanation for Khrushchev’s removal?",
          choices: ["Popular revolution", "Failure to industrialise", "Elite dissatisfaction", "End of Cold War"],
          answer: "Elite dissatisfaction",
          explain: "Erratic leadership and setbacks led elites to remove him."
    },
    {
          topicId: "t4",
          q: "Which best summarises 1941–1964?",
          choices: ["Continuous liberalisation", "Unchanging terror state", "Less violent but still authoritarian", "Full democratisation"],
          answer: "Less violent but still authoritarian",
          explain: "There was a shift to less violent rule, but the system remained authoritarian."
    }
];


/* =========================
   Timeline Tension (timeline ordering)
   - dates hidden until perfect timeline
   - different events per topic
   ========================= */
const TIMELINE_BANK = {
  t1: [
    { label:"Crimean War begins", year:1853 },
    { label:"Emancipation of the serfs", year:1861 },
    { label:"Zemstva created", year:1864 },
    { label:"Judicial reforms", year:1864 },
    { label:"Military service reforms", year:1874 },
    { label:"Russification intensifies under Alexander III", year:1881 },
    { label:"Land Captains introduced", year:1889 },
    { label:"Alexander III dies; Nicholas II becomes Tsar", year:1894 },
    { label:"Polish uprising crushed", year:1863 },
    { label:"Censorship tightened under Alexander III", year:1882 }
  ],
  t2: [
    { label:"‘To the People’ movement grows (populism)", year:1874 },
    { label:"Land and Liberty formed", year:1876 },
    { label:"People’s Will formed", year:1879 },
    { label:"Alexander II assassinated", year:1881 },
    { label:"Okhrana created", year:1881 },
    { label:"Lenin’s brother executed", year:1887 },
    { label:"RSDLP founded", year:1898 },
    { label:"Party split: Bolsheviks vs Mensheviks", year:1903 },
    { label:"SR Party founded", year:1901 },
    { label:"Legal Marxism spreads in cities", year:1890 }
  ],
  t2: [
    { label:"Nicholas II becomes Tsar", year:1894 },
    { label:"Russo-Japanese War", year:1904 },
    { label:"Bloody Sunday", year:1905 },
    { label:"October Manifesto", year:1905 },
    { label:"First Duma meets", year:1906 },
    { label:"Stolypin appointed PM", year:1906 },
    { label:"Stolypin’s land reforms begin", year:1906 },
    { label:"Lena Goldfields massacre", year:1912 },
    { label:"Russia enters First World War", year:1914 },
    { label:"February Revolution", year:1917 }
  ],
  t3: [
    { label:"February Revolution", year:1917 },
    { label:"Lenin returns; April Theses", year:1917.04 },
    { label:"July Days", year:1917.07 },
    { label:"Kornilov Affair", year:1917.08 },
    { label:"October Revolution", year:1917.10 },
    { label:"Decree on Land", year:1917.11 },
    { label:"Constituent Assembly dissolved", year:1918.01 },
    { label:"Treaty of Brest-Litovsk", year:1918.03 },
    { label:"Civil War begins", year:1918 },
    { label:"NEP introduced", year:1921 }
  ],
  t4: [
    { label:"Lenin dies", year:1924 },
    { label:"Stalin defeats rivals; begins ‘Socialism in One Country’ dominance", year:1928 },
    { label:"First Five-Year Plan launched", year:1928 },
    { label:"Collectivisation begins", year:1929 },
    { label:"Dekulakisation intensifies", year:1930 },
    { label:"Kirov murdered", year:1934 },
    { label:"First Moscow Show Trial", year:1936 },
    { label:"Great Terror at its height", year:1937 },
    { label:"Nazi–Soviet Pact signed", year:1939 },
    { label:"Germany invades USSR (Operation Barbarossa)", year:1941 }
  ],
  t5: [
    { label:"Stalin dies", year:1953.03 },
    { label:"Power struggle: Malenkov/Beria removed; Khrushchev rises", year:1953.09 },
    { label:"Secret Speech", year:1956.02 },
    { label:"Virgin Lands campaign begins", year:1954 },
    { label:"Sovnarkhozy reforms", year:1957 },
    { label:"Berlin Wall built", year:1961 },
    { label:"Cuban Missile Crisis", year:1962 },
    { label:"Novocherkassk massacre", year:1962.06 },
    { label:"Khrushchev removed", year:1964 },
    { label:"Seven-Year Plan begins", year:1959 }
  ],

};

const TL_STATE = {
  topicId: null,
  size: 8,
  events: [],
  pool: [],
  placed: [],
  selectedPoolIdx: null,
  showDates: false,
  completed: false
};

function tlEnabledTopicsForSelect(){
  const ids = enabledTopicIds();
  return TOPICS.filter(t=>ids.includes(t.id));
}

function tlPopulateSelect(){
  const sel = $("timelineTopicSelect");
  if(!sel) return;
  sel.innerHTML = "";
  tlEnabledTopicsForSelect().forEach(t=>{
    const opt = document.createElement("option");
    opt.value = t.id;
    opt.textContent = t.title;
    sel.appendChild(opt);
  });
}

function tlPickEvents(topicId, size){
  const bank = (TIMELINE_BANK[topicId] || []).slice();
  // Fallback: if missing, use a simple cross-topic set
  const fallback = [
    {label:"Emancipation of the serfs", year:1861},
    {label:"Bloody Sunday", year:1905},
    {label:"February Revolution", year:1917},
    {label:"October Revolution", year:1917.10},
    {label:"NEP introduced", year:1921},
    {label:"First Five-Year Plan", year:1928},
    {label:"Operation Barbarossa", year:1941},
    {label:"Secret Speech", year:1956.02},
    {label:"Cuban Missile Crisis", year:1962},
    {label:"Khrushchev removed", year:1964},
  ];
  const src = bank.length ? bank : fallback;

  // If asking for more than available, just cap.
  const n = Math.min(size, src.length);

  // Shuffle and take n
  const shuffled = src
    .map(x=>({x, r:Math.random()}))
    .sort((a,b)=>a.r-b.r)
    .map(o=>o.x)
    .slice(0,n);

  return shuffled;
}

function tlFormatYear(y){
  // y can include .MM or .MMDD-ish; keep human readable
  const year = Math.floor(y);
  const frac = y - year;
  if(frac <= 0) return String(year);
  // 2-digit month
  const mm = Math.round(frac * 100);
  if(mm >= 1 && mm <= 12) return `${year} (month ${String(mm).padStart(2,"0")})`;
  return String(year);
}

function tlRender(){
  const poolEl = $("timelinePool");
  const slotsEl = $("timelineSlots");
  const msgEl = $("timelineMsg");
  const checkBtn = $("btnCheckTimeline");

  if(!poolEl || !slotsEl || !msgEl || !checkBtn) return;

  // message
  msgEl.textContent = TL_STATE.completed
    ? "Perfect timeline. Dates unlocked."
    : (TL_STATE.placed.every(x=>x) ? "Ready to check." : "Select an event, then tap a slot to place it.");

  // pool chips
  poolEl.innerHTML = "";
  TL_STATE.pool.forEach((ev, i)=>{
    const chip = document.createElement("button");
    chip.type = "button";
    chip.className = "tlChip" + (TL_STATE.selectedPoolIdx===i ? " isSelected" : "");
    chip.textContent = ev.label;
    chip.addEventListener("click", ()=>{
      if(TL_STATE.completed) return;
      TL_STATE.selectedPoolIdx = (TL_STATE.selectedPoolIdx===i) ? null : i;
      tlRender();
    });
    poolEl.appendChild(chip);
  });

  // slots
  slotsEl.innerHTML = "";
  TL_STATE.placed.forEach((ev, idx)=>{
    const li = document.createElement("li");
    const slot = document.createElement("div");
    slot.className = "tlSlot" + (!ev ? " empty" : "");
    if(ev && ev._wrong) slot.classList.add("isWrong");

    const btn = document.createElement("button");
    btn.type = "button";

    if(!ev){
      btn.innerHTML = `<span>Tap to place…</span><span class="tlDate"></span>`;
    }else{
      const dateHtml = (TL_STATE.showDates ? `<span class="tlDate">${tlFormatYear(ev.year)}</span>` : `<span class="tlDate"></span>`);
      btn.innerHTML = `<strong>${escapeHtml(ev.label)}</strong>${dateHtml}`;
    }

    btn.addEventListener("click", ()=>{
      if(TL_STATE.completed) return;

      // If slot occupied and no selection: remove to pool
      if(ev && TL_STATE.selectedPoolIdx===null){
        // remove
        const removed = TL_STATE.placed[idx];
        TL_STATE.placed[idx] = null;
        delete removed._wrong;
        TL_STATE.pool.push(removed);
        tlClearWrongMarks();
        tlRender();
        return;
      }

      // Place selected pool item into this slot
      const selIdx = TL_STATE.selectedPoolIdx;
      if(selIdx===null) return;

      const picked = TL_STATE.pool.splice(selIdx,1)[0];

      // If slot had an event, send it back to pool
      if(TL_STATE.placed[idx]){
        const old = TL_STATE.placed[idx];
        delete old._wrong;
        TL_STATE.pool.push(old);
      }

      TL_STATE.placed[idx] = picked;
      TL_STATE.selectedPoolIdx = null;
      tlClearWrongMarks();
      tlRender();
    });

    slot.appendChild(btn);
    li.appendChild(slot);
    slotsEl.appendChild(li);
  });

  // enable check only when all slots filled and not completed
  const filled = TL_STATE.placed.every(x=>!!x);
  checkBtn.disabled = !(filled && !TL_STATE.completed);
}

function tlClearWrongMarks(){
  TL_STATE.placed.forEach(ev=>{ if(ev) delete ev._wrong; });
  const msgEl = $("timelineMsg");
  if(msgEl && !TL_STATE.completed) msgEl.textContent = "";
}

function tlStart(){
  const sel = $("timelineTopicSelect");
  const sizeSel = $("timelineSize");
  const checkBtn = $("btnCheckTimeline");
  const win = $("tlWinOverlay");
  if(win) win.classList.add("hidden");
  if(checkBtn) checkBtn.disabled = true;

  TL_STATE.topicId = sel ? sel.value : (enabledTopicIds()[0] || "t1");
  TL_STATE.size = sizeSel ? Number(sizeSel.value || 8) : 8;

  TL_STATE.events = tlPickEvents(TL_STATE.topicId, TL_STATE.size);
  TL_STATE.pool = TL_STATE.events
    .map(e=>({label:e.label, year:e.year}))
    .map(x=>({x, r:Math.random()}))
    .sort((a,b)=>a.r-b.r)
    .map(o=>o.x);

  TL_STATE.placed = Array.from({length: TL_STATE.pool.length}).map(()=>null);
  TL_STATE.selectedPoolIdx = null;
  TL_STATE.showDates = false;
  TL_STATE.completed = false;

  tlRender();
}

function tlReset(){
  // keep same topic/size but reshuffle
  tlStart();
}

function tlCheck(){
  const msgEl = $("timelineMsg");
  const win = $("tlWinOverlay");

  if(!TL_STATE.placed.every(x=>x)) return;

  // compute correct order by year asc
  const correct = TL_STATE.placed
    .slice()
    .map((ev, i)=>({ev, i}))
    .map(o=>o.ev)
    .slice()
    .sort((a,b)=>a.year-b.year)
    .map(ev=>ev.label);

  const current = TL_STATE.placed.map(ev=>ev.label);
  const isPerfect = current.every((lbl, i)=>lbl === correct[i]);

  if(isPerfect){
    TL_STATE.showDates = true;
    TL_STATE.completed = true;
    if(msgEl) msgEl.textContent = "Perfect timeline — dates unlocked.";
    if(win){
      win.classList.remove("hidden");
      setTimeout(()=>win.classList.add("hidden"), 1600);
    }
    confetti.burst(160);
    markGameSessionCompleted("timeline", TL_STATE.topicId);
  }else{
    // mark wrong slots
    TL_STATE.placed.forEach((ev, i)=>{
      ev._wrong = (ev.label !== correct[i]);
    });
    if(msgEl) msgEl.textContent = "Not quite — red slots are out of place. Adjust and try again.";
  }

  tlRender();
}

function initTimelineGame(){
  const openBtn = $("openTimelineBtn");
  const backBtn = $("backFromTimeline");
  const startBtn = $("btnStartTimeline");
  const resetBtn = $("btnResetTimeline");
  const checkBtn = $("btnCheckTimeline");
  const topicSel = $("timelineTopicSelect");

  // populate topic select whenever entering games tab
  tlPopulateSelect();

  // listeners
  if(startBtn) startBtn.addEventListener("click", tlStart);
  if(resetBtn) resetBtn.addEventListener("click", tlReset);
  if(checkBtn) checkBtn.addEventListener("click", tlCheck);

  // changing topic should start a fresh timeline (but not forced immediately)
  if(topicSel) topicSel.addEventListener("change", ()=>{ /* user can hit New timeline */ });

  // close overlay on tap
  const win = $("tlWinOverlay");
  if(win) win.addEventListener("click", ()=>win.classList.add("hidden"));
}

/* =========================
   Connections game logic
   ========================= */
const CONNECTIONS_BANK = {
  // Topic 1 example groups (add more sets as needed)
  t1: {
    title: "1. Preserving Autocracy 1855–1894",
    groups: [
      { label:"Trigger for 1905 unrest", terms:["Gapon","1905","St. Petersburg","Bloody Sunday"] },
      { label:"Emancipation Edict mechanics", terms:["1861","Redemption payments","Mir","Peasants"] },
      { label:"Zemstva reforms", terms:["1864","Local government","Nobility dominated","Liberals"] },
      { label:"Judicial reforms", terms:["Trial by jury","Independent judges","Equality before law","1864"] },
      { label:"Military reforms", terms:["Conscription","1874","Shorter service","Modernisation"] },
      { label:"Education expansion", terms:["Universities","Censorship eased","Literacy","Radical ideas"] }
    ]
  },

  // Topic 2 example
// Topic 3 example
  t2: {
    title: "2. Failure of Autocracy 1894–1917",
    groups: [
      { label:"1905 revolution pressures", terms:["Russo-Japanese War","Bloody Sunday","Strikes","Mutinies"] },
      { label:"October Manifesto", terms:["Civil liberties","Duma","Witte","1905"] },
      { label:"Fundamental Laws", terms:["1906","Tsar retains power","Veto","Control of ministers"] },
      { label:"Stolypin reforms", terms:["Land reforms","Kulaks","Repression","Stolypin’s tie"] },
      { label:"WWI strains", terms:["Food shortages","Inflation","Military losses","Transport collapse"] },
      { label:"February Revolution", terms:["Petrograd","Bread riots","Abdication","Provisional Government"] }
    ]
  },

  // Topic 4 example
  t3: {
    title: "3. Establishing Communist Rule 1917–1941",
    groups: [
      { label:"October takeover", terms:["Bolsheviks","Petrograd Soviet","Trotsky","Red Guards"] },
      { label:"Decrees", terms:["Land Decree","Peace Decree","Workers’ control","Sovnarkom"] },
      { label:"Civil War factors", terms:["Reds","Whites","Foreign intervention","War Communism"] },
      { label:"Cheka", terms:["Secret police","Terror","Lenin","Repression"] },
      { label:"NEP features", terms:["Markets","Tax in kind","Small business","1921"] },
      { label:"Kronstadt", terms:["Sailors","1921","Revolt","Turning point"] }
    ]
  },

  // Topic 5 example
  t4: {
    title: "4. Stalinist Dictatorship and reaction 1941–1964",
    groups: [
      { label:"Power struggle", terms:["Lenin’s Testament","Trotsky","Zinoviev","Kamenev"] },
      { label:"Collectivisation", terms:["Kulaks","Kolhoz","Dekulakisation","Grain"] },
      { label:"Five-Year Plans", terms:["Gosplan","Heavy industry","Targets","Stakhanovites"] },
      { label:"Great Terror", terms:["NKVD","Show trials","Purges","1936–38"] },
      { label:"Cult of personality", terms:["Propaganda","Socialist realism","Stalin","Hero image"] },
      { label:"WWII leadership", terms:["Great Patriotic War","Order No. 227","Leningrad","Victory"] }
    ]
  },

  // Topic 6 example
  t5: {
    title: "5. Khrushchev and Reform 1953–1964",
    groups: [
      { label:"De-Stalinisation", terms:["Secret Speech","1956","Cult of personality","Destalinisation"] },
      { label:"Virgin Lands", terms:["Kazakhstan","1954","Grain","Soil exhaustion"] },
      { label:"Industrial reforms", terms:["Sovnarkhozy","Decentralisation","1957","Planning"] },
      { label:"Cold War crises", terms:["Cuba","Berlin","U-2","Arms race"] },
      { label:"Living standards", terms:["Housing","Consumer goods","Wages","Social policy"] },
      { label:"Party control", terms:["Khrushchev","Presidium","Reforms","Resistance"] }
    ]
  }

};

(function initConnectionsGame(){
  const topicSel = document.getElementById("connTopicSelect");
  const gridEl = document.getElementById("connGrid");
  const solvedEl = document.getElementById("connSolved");
  const msgEl = document.getElementById("connMsg");
  const clearBtn = document.getElementById("connClearBtn");
  const submitBtn = document.getElementById("connSubmitBtn");


const winOverlay = document.getElementById("connWinOverlay");

function safeBurst(n){
  try{
    if(!window.reduceMotion && typeof confetti !== "undefined" && confetti?.burst){
      confetti.burst(n);
    }
  }catch(e){}
}

function showConnWinOverlay(){
  if(!winOverlay) return;
  const titleEl = winOverlay.querySelector(".connWinTitle");
  const subEl = winOverlay.querySelector(".connWinSub");
  const topicTitle = (CONNECTIONS_BANK[state?.topicKey]?.title) || "Connections";
  if(titleEl) titleEl.textContent = "🏆 Connections complete!";
  if(subEl) subEl.textContent = topicTitle;

  winOverlay.classList.remove("hidden");
  winOverlay.classList.add("show");
  clearTimeout(showConnWinOverlay._t);
  showConnWinOverlay._t = setTimeout(() => {
    winOverlay.classList.remove("show");
    winOverlay.classList.add("hidden");
  }, 2200);
}

  if(!topicSel || !gridEl || !solvedEl || !msgEl || !clearBtn || !submitBtn) return;

  const mistakeDots = ["m1","m2","m3","m4"].map(id => document.getElementById(id));

  function getEnabledConnectionTopics(){
    return TOPICS.map(t=>t.id).filter(id=>isTopicEnabled(id) && CONNECTIONS_BANK[id]);
  }

  function populateConnTopicSelect(){
    const prev = topicSel.value;
    topicSel.innerHTML = "";
    getEnabledConnectionTopics().forEach((key) => {
      const t = CONNECTIONS_BANK[key];
      const opt = document.createElement("option");
      opt.value = key;
      opt.textContent = t.title;
      topicSel.appendChild(opt);
    });
    if(topicSel.options.length){
      const values = new Set(Array.from(topicSel.options).map(o=>o.value));
      topicSel.value = values.has(prev) ? prev : topicSel.options[0].value;
    }
  }

  window.refreshConnectionsTopicSelect = function(){
    populateConnTopicSelect();
    if(!topicSel.options.length){
      gridEl.innerHTML = "";
      solvedEl.innerHTML = "";
      setMsg("No enabled topics available.");
      return;
    }
    buildBoard(topicSel.value);
  };

  // Populate topics
  populateConnTopicSelect();

  // Deterministic daily seed (same per day per topic per device)
  function dayKey(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }
  function mulberry32(a){
    return function(){
      let t = a += 0x6D2B79F5;
      t = Math.imul(t ^ (t >>> 15), t | 1);
      t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    }
  }
  function hashStr(s){
    let h = 2166136261;
    for(let i=0;i<s.length;i++){
      h ^= s.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }
  function shuffle(arr, rand){
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(rand()* (i+1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  // State
  let state = null;

  function resetMistakes(){
    state.mistakes = 0;
    mistakeDots.forEach(d => { if(d) d.classList.remove("used"); });
  }

  function setMsg(text){
    msgEl.textContent = text || "";
  }

  function renderSolved(){
    solvedEl.innerHTML = "";
    state.solved.forEach(g => {
      const box = document.createElement("div");
      box.className = "solvedGroup";
      box.innerHTML = `
        <div class="solvedTitle">${g.label}</div>
        <div class="solvedTerms">${g.terms.map(t=>`<span>${t}</span>`).join("")}</div>
      `;
      solvedEl.appendChild(box);
    });
  }

  function renderGrid(){
    gridEl.innerHTML = "";
    state.tiles.forEach((t, idx) => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "connTile";
      btn.textContent = t.term;
      if(t.locked) btn.classList.add("locked");
      if(state.selected.has(idx)) btn.classList.add("selected");

      btn.addEventListener("click", () => {
        if(t.locked) return;
        if(state.selected.has(idx)){
          state.selected.delete(idx);
        }else{
          if(state.selected.size >= 4){
            setMsg("Select up to 4 terms.");
            return;
          }
          state.selected.add(idx);
        }
        setMsg("");
        renderGrid();
      });

      gridEl.appendChild(btn);
    });
  }

  function buildBoard(topicKey){
    const topic = CONNECTIONS_BANK[topicKey];
    const seed = hashStr(topicKey + "|" + dayKey());
    const rand = mulberry32(seed);

    // choose 4 groups from available (>=5)
    const pickedGroups = shuffle(topic.groups, rand).slice(0, 4);

    // flatten terms into tiles
    const tiles = [];
    pickedGroups.forEach((g, gi) => {
      g.terms.forEach(term => tiles.push({ term, groupIndex: gi, locked:false }));
    });

    state = {
      topicKey,
      groups: pickedGroups,
      tiles: shuffle(tiles, rand),
      selected: new Set(),
      solved: [],
      mistakes: 0
    };

    resetMistakes();
    setMsg("Find 4 groups of 4.");
    renderSolved();
    renderGrid();
  }

  function markMistake(){
    state.mistakes++;
    if(mistakeDots[state.mistakes-1]) mistakeDots[state.mistakes-1].classList.add("used");
    if(state.mistakes >= 4){
      setMsg("No mistakes remaining — board reset.");
      buildBoard(state.topicKey);
    }else{
      setMsg(`Not a group. Mistakes remaining: ${4 - state.mistakes}`);
    }
  }

  function submitSelection(){
    if(state.selected.size !== 4){
      setMsg("Select exactly 4 terms.");
      return;
    }

    const idxs = [...state.selected];
    const groups = idxs.map(i => state.tiles[i].groupIndex);
    const allSame = groups.every(g => g === groups[0]);

    if(!allSame){
      state.selected.clear();
      renderGrid();
      markMistake();
      return;
    }

    const gi = groups[0];
    const group = state.groups[gi];

    // lock those tiles
    idxs.forEach(i => state.tiles[i].locked = true);
    state.selected.clear();

    // add solved group (unique)
    if(!state.solved.some(s => s.label === group.label)){
      state.solved.push(group);
    }

    renderSolved();
    renderGrid();

// Celebrate: confetti burst for a correct connection
safeBurst(90);

if(state.solved.length === 4){
  setMsg("✅ Solved! New board tomorrow.");
  markGameSessionCompleted("connections", state.topicKey);
  // Big win celebration: trophy + more confetti
  safeBurst(220);
  showConnWinOverlay();
  try{
    const tTitle = (CONNECTIONS_BANK[state.topicKey]?.title) || "Connections";
    if(typeof showLevelUpBanner === "function"){
      showLevelUpBanner(`🏆 Connections Complete • ${escapeHtml ? escapeHtml(tTitle) : tTitle}`);
    }
  }catch(e){}
}else{
  setMsg("✅ Correct group!");
}
  }

  // Wire controls
  clearBtn.addEventListener("click", () => {
    state.selected.clear();
    setMsg("");
    renderGrid();
  });

  submitBtn.addEventListener("click", submitSelection);

  topicSel.addEventListener("change", () => {
    buildBoard(topicSel.value);
  });

  // initial
  if(topicSel.options.length){
    buildBoard(topicSel.value || topicSel.options[0].value);
  }else{
    setMsg("No enabled topics available.");
  }
})();

/* =========================
   Beat the Clock game logic
   ========================= */
const BEAT_CLOCK = {
  run: 0,
  best: Number(localStorage.getItem("beat_clock_best_run") || 0),
  timer: null,
  timeLeft: 20,
  active: false,
  correctTerms: new Set(),
  selected: new Set(),
  roundTopicId: null,
  terms: []
};

function bcAllTermsByTopic(){
  const map = {};
  Object.entries(FACT_BANK).forEach(([topicId, bank]) => {
    if(!isTopicEnabled(topicId)) return;
    const terms = (bank?.terms || []).map(t => String(t.term||"").trim()).filter(Boolean);
    map[topicId] = Array.from(new Set(terms));
  });
  return map;
}

function bcSetMsg(msg){
  const el = document.getElementById("bcMsg");
  if(el) el.textContent = msg;
}

function bcUpdatePills(){
  const timerPill = document.getElementById("bcTimerPill");
  const runPill = document.getElementById("bcRoundPill");
  const bestPill = document.getElementById("bcBestPill");
  if(timerPill) timerPill.textContent = `⏳ ${BEAT_CLOCK.timeLeft}s`;
  if(runPill) runPill.textContent = `Run: ${BEAT_CLOCK.run}`;
  if(bestPill) bestPill.textContent = `🏆 Best run: ${BEAT_CLOCK.best}`;
}

function bcStopTimer(){
  if(BEAT_CLOCK.timer){
    clearInterval(BEAT_CLOCK.timer);
    BEAT_CLOCK.timer = null;
  }
}

function bcRenderGrid(){
  const grid = document.getElementById("bcGrid");
  if(!grid) return;
  grid.innerHTML = "";

  BEAT_CLOCK.terms.forEach(term => {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "bcTile";
    btn.textContent = term;
    if(BEAT_CLOCK.selected.has(term)) btn.classList.add("selected");
    if(!BEAT_CLOCK.active) btn.disabled = true;

    btn.addEventListener("click", ()=>{
      if(!BEAT_CLOCK.active) return;
      if(BEAT_CLOCK.selected.has(term)){
        BEAT_CLOCK.selected.delete(term);
      }else{
        if(BEAT_CLOCK.selected.size >= 4){
          bcSetMsg("Select only 4 terms.");
          return;
        }
        BEAT_CLOCK.selected.add(term);
      }
      bcRenderGrid();
    });

    grid.appendChild(btn);
  });

  const submit = document.getElementById("bcSubmitBtn");
  const clear = document.getElementById("bcClearBtn");
  if(submit) submit.disabled = !BEAT_CLOCK.active;
  if(clear) clear.disabled = !BEAT_CLOCK.active;
}

function bcFailRun(reason){
  bcStopTimer();
  BEAT_CLOCK.active = false;
  BEAT_CLOCK.run = 0;
  bcUpdatePills();
  bcSetMsg(`${reason} Run reset — press Start run to try again.`);
  bcRenderGrid();
}

function bcPickRound(){
  const byTopic = bcAllTermsByTopic();
  const topicIds = Object.keys(byTopic).filter(id => byTopic[id].length >= 8);
  if(!topicIds.length) return null;

  const topicId = topicIds[Math.floor(Math.random()*topicIds.length)];
  const topicTerms = shuffle(byTopic[topicId]).slice(0,4);
  if(topicTerms.length < 4) return null;

  const others = Object.entries(byTopic)
    .filter(([id]) => id !== topicId)
    .flatMap(([,terms]) => terms)
    .filter(t => !topicTerms.includes(t));

  if(others.length < 4) return null;
  const distractors = shuffle(Array.from(new Set(others))).slice(0,4);
  const mixed = shuffle([...topicTerms, ...distractors]);
  return { topicId, topicTerms, mixed };
}

function bcStartRound(){
  const round = bcPickRound();
  if(!round){
    bcSetMsg("Not enough terms to build Beat the Clock rounds.");
    return;
  }

  BEAT_CLOCK.roundTopicId = round.topicId;
  BEAT_CLOCK.correctTerms = new Set(round.topicTerms);
  BEAT_CLOCK.terms = round.mixed;
  BEAT_CLOCK.selected = new Set();
  BEAT_CLOCK.timeLeft = 20;
  BEAT_CLOCK.active = true;

  const t = TOPICS.find(x=>x.id===round.topicId);
  const topicPill = document.getElementById("bcTopicPill");
  const prompt = document.getElementById("bcPrompt");
  const title = t ? t.title : round.topicId;
  if(topicPill) topicPill.textContent = `Topic: ${title}`;
  if(prompt) prompt.textContent = `Find the 4 matching terms: ${title}`;

  bcUpdatePills();
  bcSetMsg("Go! Pick 4 and lock them in before the timer ends.");
  bcRenderGrid();

  bcStopTimer();
  BEAT_CLOCK.timer = setInterval(()=>{
    BEAT_CLOCK.timeLeft--;
    bcUpdatePills();
    if(BEAT_CLOCK.timeLeft <= 0){
      bcFailRun("⏰ Time up!");
    }
  }, 1000);
}

function bcSubmit(){
  if(!BEAT_CLOCK.active) return;
  if(BEAT_CLOCK.selected.size !== 4){
    bcSetMsg("Select exactly 4 terms first.");
    return;
  }
  const ok = [...BEAT_CLOCK.selected].every(t => BEAT_CLOCK.correctTerms.has(t));
  if(!ok){
    bcFailRun("❌ Wrong set.");
    return;
  }

  bcStopTimer();
  BEAT_CLOCK.run += 1;
  if(BEAT_CLOCK.run > BEAT_CLOCK.best){
    BEAT_CLOCK.best = BEAT_CLOCK.run;
    localStorage.setItem("beat_clock_best_run", String(BEAT_CLOCK.best));
  }
  bcUpdatePills();
  bcSetMsg(`✅ Nice! Round ${BEAT_CLOCK.run} cleared. Next round...`);
  setTimeout(()=>{
    if(BEAT_CLOCK.run > 0) bcStartRound();
  }, 700);
}

(function initBeatClockGame(){
  const startBtn = document.getElementById("btnStartBeatClock");
  const submitBtn = document.getElementById("bcSubmitBtn");
  const clearBtn = document.getElementById("bcClearBtn");
  if(!startBtn || !submitBtn || !clearBtn) return;

  bcUpdatePills();
  bcRenderGrid();

  startBtn.addEventListener("click", ()=>{
    BEAT_CLOCK.run = 0;
    bcStartRound();
    bcUpdatePills();
  });

  submitBtn.addEventListener("click", bcSubmit);
  clearBtn.addEventListener("click", ()=>{
    if(!BEAT_CLOCK.active) return;
    BEAT_CLOCK.selected.clear();
    bcRenderGrid();
  });
})();

  
/* ==========================================================
   EMOJI BANK (fully populated starter as provided)
   ========================================================== */
const EMOJI_BANK = {
  t1: {
    terms: [
      { clue:"⛓️➡️🧑‍🌾📜💰", answer:"Emancipation Edict", why:"Ends serfdom by law; peasants still pay redemption." },
      { clue:"🗳️🏘️🛣️🏥", answer:"Zemstva", why:"Local councils handling services." },
      { clue:"⚖️👩‍⚖️👨‍⚖️👥", answer:"Judicial Reform", why:"Independent courts + jury trials." },
      { clue:"🪖👦➡️👨📘", answer:"Military Reform", why:"Conscription modernises army." },
      { clue:"🚨📜👮‍♂️🔒", answer:"Statute of State Security", why:"Emergency powers underpin repression." },
      { clue:"🌍🗣️✝️➡️🇷🇺", answer:"Russification", why:"Imposed Russian language/culture/Orthodoxy." },
      { clue:"🏭🚂📈💰", answer:"Industrialisation", why:"Rapid railway and heavy-industry growth under state guidance." }
    ],
    people: [
      { clue:"👑📉⚔️➡️📜🔧", answer:"Alexander II", why:"Crimea exposed weakness; reforms follow." },
      { clue:"👑🧱👮‍♂️📜", answer:"Alexander III", why:"Reaction + repression to protect autocracy." },
      { clue:"✝️📚🚫🗳️🚫", answer:"Pobedonostsev", why:"Anti-democratic conservative ideology." }
    ]
  },
  t2: {
    terms: [
      { clue:"📜🗳️✨(promise)", answer:"October Manifesto", why:"Promised liberties + Duma (limited later)." },
      { clue:"📜👑🔒", answer:"Fundamental Laws", why:"Reasserted Tsar’s powers." },
      { clue:"📜🕒➡️👑", answer:"Article 87", why:"Rule by decree when Duma not sitting." },
      { clue:"🩸⛪🚶‍♂️➡️🔥1905", answer:"Bloody Sunday", why:"Peaceful march shot by troops, triggering unrest." },
      { clue:"🚢💥⚔️🇯🇵", answer:"Russo-Japanese War", why:"Defeat weakened Tsarism and fueled opposition." },
      { clue:"🧑‍🌾➡️🏡📈", answer:"Stolypin's Land Reforms", why:"Sought a class of conservative, prosperous peasants." }
    ],
    people: [
      { clue:"👑🙅‍♂️🗳️➡️💥1917", answer:"Nicholas II", why:"Autocracy + war decisions drive collapse." },
      { clue:"🥕➕🪓", answer:"Stolypin", why:"Reform + repression strategy." },
      { clue:"⛪📜🙏➡️🩸", answer:"Georgy Gapon", why:"Led petitioners on Bloody Sunday." },
      { clue:"🔮👑🏛️😬", answer:"Rasputin", why:"Court influence damaged regime credibility." }
    ]
  },
  t3: {
    terms: [
      { clue:"🏭🍞➡️🪖(take)", answer:"War Communism", why:"Requisitioning + state control for war effort." },
      { clue:"💱🛒✅🏭🔒", answer:"NEP", why:"Mixed economy; commanding heights state." },
      { clue:"🕵️‍♂️➡️🔒⚖️", answer:"Cheka", why:"Political police enforcing rule." },
      { clue:"⚓❄️✊1921", answer:"Kronstadt Rising", why:"Sailor revolt pushed Bolsheviks toward NEP." },
      { clue:"📜🚫👥⚖️", answer:"Ban on Factions", why:"Outlawed organised dissent inside the party." },
      { clue:"🍞➡️🏘️🔫", answer:"Grain Requisitioning", why:"State seizure of peasant grain under War Communism." }
    ],
    people: [
      { clue:"🧠⚙️➡️(NEP)🧊", answer:"Lenin", why:"Pragmatism + coercion." },
      { clue:"🚂🪖📏", answer:"Trotsky", why:"Rail control + discipline." },
      { clue:"🕵️‍♂️⚔️🔒", answer:"Dzerzhinsky", why:"Ran the Cheka and Red Terror apparatus." },
      { clue:"📚🧑‍🏫➡️NEP🙂", answer:"Bukharin", why:"Supported NEP before losing to Stalin." }
    ]
  },
  t4: {
    terms: [
      { clue:"🌾➡️👥(collective)🔒", answer:"Collectivisation", why:"Control peasants + grain extraction." },
      { clue:"🧹🗂️🔫", answer:"Great Terror", why:"Mass purges consolidate dictatorship." },
      { clue:"⛓️🏕️🪓", answer:"Gulag", why:"Forced labour camp system." },
      { clue:"🧱🏭⚙️1️⃣", answer:"First Five-Year Plan", why:"Rapid industrial growth targets from 1928." }
    ],
    people: [
      { clue:"👨‍🦱⭐️🏛️🔒", answer:"Stalin", why:"Dictatorship through planning + terror." },
      { clue:"🕵️‍♂️📈1937", answer:"Yezhov", why:"NKVD chief at terror peak." }
    ]
  },
  t5: {
    terms: [
      { clue:"🗣️🕵️‍♂️❌1956", answer:"Secret Speech", why:"Denounced Stalin’s cult/terror." },
      { clue:"🌾🌾🌾➡️🌬️💥", answer:"Virgin Lands Scheme", why:"Early gains; long-term soil issues." },
      { clue:"🧩🏭➡️🗺️", answer:"Sovnarkhozy", why:"Regional councils decentralising planning." }
    ],
    people: [
      { clue:"👟🔧➡️(zigzag)", answer:"Khrushchev", why:"Reform + inconsistency; removed 1964." }
    ]
  },

};

const MATCH_PEOPLE_DEFAULTS = {
  t1: [
    { name:"Alexander II", role:"Tsar of Russia (1855–1881)", significance:"Launched major reforms including emancipation, zemstva and legal changes after defeat in the Crimean War." },
    { name:"Alexander III", role:"Tsar of Russia (1881–1894)", significance:"Reversed reform momentum with repression, Russification and emergency powers to preserve autocracy." },
    { name:"Konstantin Pobedonostsev", role:"Over-Procurator and chief conservative ideologue", significance:"Defended Orthodoxy, autocracy and nationalism and deeply influenced Alexander III and Nicholas II." },
    { name:"Dmitry Milyutin", role:"War Minister", significance:"Modernised the army through universal conscription and shorter service terms." },
    { name:"Sergei Witte", role:"Finance Minister", significance:"Drove industrialisation and railway growth to strengthen Russia’s economy and state power." },
    { name:"Mikhail Loris-Melikov", role:"Minister of the Interior", significance:"Proposed limited representative reform in 1881 before the reactionary turn halted change." }
  ],
  t2: [
    { name:"Nicholas II", role:"Last Tsar of Russia", significance:"Clung to autocracy and made key errors in war and reform, contributing to collapse in 1917." },
    { name:"Pyotr Stolypin", role:"Prime Minister (1906–1911)", significance:"Mixed harsh repression with agrarian reform in an attempt to stabilise tsarist rule." },
    { name:"Georgy Gapon", role:"Orthodox priest and workers’ organiser", significance:"Led the 1905 petition march on Bloody Sunday, helping trigger mass unrest." },
    { name:"Konstantin Pobedonostsev", role:"Conservative adviser and tutor", significance:"Promoted anti-parliamentary ideas that reinforced reaction under Nicholas II." },
    { name:"Grigori Rasputin", role:"Mystic with court influence", significance:"Damaged the monarchy’s credibility through influence over Alexandra and ministerial appointments." },
    { name:"Sergei Witte", role:"Statesman and reform advocate", significance:"Brokered the October Manifesto, conceding a Duma to calm revolutionary pressure." }
  ],
  t3: [
    { name:"Vladimir Lenin", role:"Bolshevik leader", significance:"Consolidated one-party rule through decrees, Civil War victory, terror and tactical NEP retreat." },
    { name:"Leon Trotsky", role:"People’s Commissar for War", significance:"Built the disciplined Red Army and was central to Bolshevik victory in the Civil War." },
    { name:"Felix Dzerzhinsky", role:"Head of the Cheka", significance:"Organised political repression and Red Terror to crush counter-revolutionary opposition." },
    { name:"Joseph Stalin", role:"General Secretary from 1922", significance:"Used party appointments and alliances to expand influence in the post-Lenin power struggle." },
    { name:"Nikolai Bukharin", role:"Senior Bolshevik theoretician", significance:"Supported continuation of NEP before later conflict with Stalin over economic direction." },
    { name:"Alexandra Kollontai", role:"Bolshevik revolutionary and women’s advocate", significance:"Represented radical social aims and criticised growing centralisation within the party." }
  ],
  t4: [
    { name:"Joseph Stalin", role:"Soviet leader", significance:"Directed wartime mobilisation and post-war reconstruction while preserving dictatorship and repression." },
    { name:"Georgy Zhukov", role:"Marshal of the Soviet Union", significance:"Key commander in major victories including Moscow, Stalingrad and Berlin." },
    { name:"Andrei Zhdanov", role:"Senior party ideologue", significance:"Imposed stricter cultural conformity after 1946 through Zhdanovshchina." },
    { name:"Nikita Khrushchev", role:"Soviet leader (1953–1964)", significance:"Advanced de-Stalinisation and selected reforms, but inconsistency and policy failures led to removal." },
    { name:"Lavrentiy Beria", role:"Security chief", significance:"Controlled coercive apparatus in late Stalin era before being removed after Stalin’s death." },
    { name:"Leonid Brezhnev", role:"Senior party figure", significance:"Helped organise Khrushchev’s 1964 ousting and represented the turn to stability and caution." }
  ]
};

(function ensureMatchPeopleInFactBank(){
  Object.entries(MATCH_PEOPLE_DEFAULTS).forEach(([topicId, list])=>{
    if(!FACT_BANK[topicId]) return;
    const existing = Array.isArray(FACT_BANK[topicId].people) ? FACT_BANK[topicId].people : [];
    const seen = new Set(existing.map(p=>String(p.name||"").toLowerCase()));
    const merged = existing.slice();
    list.forEach((p)=>{
      const k = String(p.name||"").toLowerCase();
      if(!k || seen.has(k)) return;
      seen.add(k);
      merged.push(p);
    });
    FACT_BANK[topicId].people = merged;
  });
})();

/* ==========================================================
   TOPIC 5 REMOVAL (MERGE INTO TOPIC 4)
   ========================================================== */
(function(){
  const T4 = "t4", T5 = "t5";
  const NEW_T4_TITLE = "4. Stalinist Dictatorship and reaction 1941-1964";
  function mergeBanks(bank){
    if(!bank || !bank[T5]) return;
    if(!bank[T4]){ bank[T4] = bank[T5]; delete bank[T5]; return; }
    const a = bank[T4], b = bank[T5];
    Object.keys(b).forEach((k)=>{
      if(k === "title") return;
      const bv = b[k], av = a[k];
      if(Array.isArray(bv)){
        a[k] = Array.isArray(av) ? av.concat(bv) : bv.slice();
      } else if(bv && typeof bv === "object"){
        a[k] = Object.assign({}, (av||{}), bv);
      } else if(typeof av === "undefined"){
        a[k] = bv;
      }
    });
    delete bank[T5];
  }
  mergeBanks(FACT_BANK);
  mergeBanks(TIMELINE_BANK);
  mergeBanks(CONNECTIONS_BANK);
  mergeBanks(EMOJI_BANK);
  if(FACT_BANK && FACT_BANK[T4]) FACT_BANK[T4].title = NEW_T4_TITLE;
})();

/* ==========================================================
   EXAM BANK (3 questions per topic — already true here)
   ========================================================== */
const EXAM_BANK = [
  {
      id:"e1", topicId:"t1",
      question:"‘Alexander II’s attempts at reform, in the years 1855 to 1881, were half-hearted and ineffective.’ Assess the validity of this view.",
      factors:["Emancipation (limits + aims)","Domestic reforms (zemstva/judicial/military)","Autocracy + repression + Poland/late reaction","Overall judgement (success vs limits)"],
      plan:[
        {title:"Intro (judgement)", body:"Define ‘half-hearted/ineffective’. Argue reforms were significant but designed to preserve autocracy; limits built in."},
        {title:"Factor 1: Emancipation 1861", body:"Aims (modernise, prevent unrest) vs limits (redemption, mir, land quality/size, nobles keep best land). Weigh change vs compromise."},
        {title:"Factor 2: Wider reforms", body:"Zemstva/judicial/military reforms modernised, but political freedom limited; central oversight remained."},
        {title:"Factor 3: Autocratic limits + backlash", body:"Poland 1863 → harder line; growth of opposition; repression and conservative turn show reform boundaries."},
        {title:"Conclusion", body:"Clear judgement: reforms not pointless, but constrained and failed to secure long-term stability."}
      ],
      help:[
        "Emancipation: redemption payments; mir control; nobles often kept best land; peasants dissatisfied.",
        "Zemstva (1864): services + local initiative but dominated/controlled.",
        "Judicial reform (1864): juries + independent courts (modern), but political controls remained.",
        "1874 military reform (Milyutin): improved state capacity and army effectiveness.",
        "Assassination 1881 ends reform era; reaction under Alexander III."
      ]
    },
  {
      id:"e6", topicId:"t1",
      question:"‘Alexander III’s policies in the years 1881 to 1894 strengthened autocracy but weakened the Russian Empire in the long term.’ Assess the validity of this view.",
      factors:["Repression + police state","Local government + Land Captains","Russification + minorities/Jews","Stability achieved vs opposition intensified"],
      plan:[
        {title:"Intro", body:"Define ‘strengthened autocracy’ vs ‘weakened the Empire’. Argue repression created short-term control but intensified long-term tensions."},
        {title:"Factor 1: Repression", body:"Statute of State Security; Okhrana growth; censorship/universities. Weigh short-term stability vs radicalisation."},
        {title:"Factor 2: Central control", body:"Land Captains and tighter local government; noble dominance; effects on peasantry and legitimacy."},
        {title:"Factor 3: Nationalities and Jews", body:"Russification and discriminatory policy; judge whether this built unity or fuelled resentment/instability."},
        {title:"Conclusion", body:"Judgement: control increased, but cohesion and consent weakened."}
      ],
      help:[
        "Statute of State Security (1881): emergency powers underpin long-term repression.",
        "Land Captains (1889): strengthened noble/state control over peasants.",
        "Russification: language/culture/Orthodoxy imposed across empire.",
        "May Laws (1882): restrictions on Jews; increased alienation."
      ]
    },
  {
      id:"e7", topicId:"t1",
      question:"How far did Alexander II’s reforms in the years 1855 to 1881 strengthen rather than weaken the Tsarist system?",
      factors:["Modernisation to preserve autocracy","Social impact of emancipation","Administrative/legal reforms","Opposition and unintended consequences"],
      plan:[
        {title:"Intro", body:"Argue reforms aimed to strengthen tsarism by modernising, but generated pressures and opposition that exposed weaknesses."},
        {title:"Factor 1: Strengthening through modernisation", body:"Crimean lessons; military/judicial reforms; more effective state capacity."},
        {title:"Factor 2: Emancipation – stabiliser or destabiliser?", body:"Reduced risk of revolt in theory; in practice dissatisfaction (land, payments, mir) fuels unrest."},
        {title:"Factor 3: Political consequences", body:"Raised expectations; growth of intelligentsia; repression and eventual assassination."},
        {title:"Conclusion", body:"Balanced judgement on whether stability/efficiency gains outweighed political costs."}
      ],
      help:[
        "Crimean War exposed weakness; reforms framed as ‘reconstruction’ while keeping autocracy intact.",
        "Judicial reform modernised law but did not create political rights.",
        "Reform era raised expectations; opposition radicalised over time."
      ]
    },
  {
      id:"e2", topicId:"t2",
      question:"‘The collapse of the Tsarist state in 1917 was due to the personal inadequacies of Tsar Nicholas II in the years after 1894.’ Assess the validity of this view.",
      factors:["Nicholas’ leadership + Duma settlement","Structural weaknesses of autocracy","WW1 as catalyst (timing)","Elite withdrawal + opposition"],
      plan:[
        {title:"Intro", body:"Nicholas mattered, but war + structural weaknesses were decisive for timing and scale."},
        {title:"Factor 1: Nicholas’ inadequacies", body:"Autocratic mindset; mishandled 1905; October Manifesto then Fundamental Laws; poor political skill."},
        {title:"Factor 2: Structural weaknesses", body:"Autocracy lacked flexibility; social tensions; rising expectations; limited constitutionalism."},
        {title:"Factor 3: WW1 turning point", body:"Defeats, supply crisis, inflation; 1915 Commander-in-Chief decision; government chaos and loss of legitimacy."},
        {title:"Conclusion", body:"Weigh: Nicholas worsened vulnerability; WW1 explains collapse in 1917."}
      ],
      help:[
        "1905: Bloody Sunday → October Manifesto; 1906 Fundamental Laws reassert Tsar’s power.",
        "Controls: dissolutions, 1907 franchise change, Article 87 decrees.",
        "WW1: shortages + inflation; 1915 Nicholas at front; elite confidence collapses."
      ]
    },
  {
      id:"e11", topicId:"t2",
      question:"‘The main reason for the survival of Tsarism after the 1905 Revolution was the weakness and division of the opposition.’ Assess the validity of this view.",
      factors:["Opposition division and aims","Regime concessions + coercion","Economic recovery and reform","Loyalty of army and elites"],
      plan:[
        {title:"Intro", body:"Argue opposition weakness mattered, but state coercion and managed concessions were more decisive in restoring control."},
        {title:"Factor 1: Opposition weaknesses", body:"Liberals vs radicals; inconsistent aims; how October Manifesto split groups."},
        {title:"Factor 2: Concessions and constitutional façade", body:"October Manifesto then Fundamental Laws; Duma manipulation; evaluate effectiveness."},
        {title:"Factor 3: Repression and force", body:"Use of troops, arrests; show how coercion restored order."},
        {title:"Conclusion", body:"Judgement: weigh opposition problems against the regime’s ability to combine concession and repression."}
      ],
      help:[
        "October Manifesto split opposition; many moderates satisfied while radicals continued.",
        "Fundamental Laws and electoral changes reduced Duma threat.",
        "Army loyalty and coercion crucial for restoring order."
      ]
    },
  {
      id:"e12", topicId:"t2",
      question:"To what extent did the First World War make the collapse of Tsarism in 1917 inevitable?",
      factors:["Pre-war weaknesses","War impact on economy/society","Political crisis and leadership","Timing vs inevitability"],
      plan:[
        {title:"Intro", body:"Argue war was the key catalyst for collapse in 1917, but it exploited long-term weaknesses rather than making collapse ‘inevitable’ from 1914."},
        {title:"Factor 1: Long-term weaknesses", body:"Explain existing strains: limited constitutionalism, social tensions, legitimacy issues after 1905."},
        {title:"Factor 2: War as accelerant", body:"Defeats, shortages, inflation, transport breakdown; link to urban unrest and loss of loyalty."},
        {title:"Factor 3: Leadership and elite withdrawal", body:"1915 Commander-in-Chief decision; government chaos; Progressive Bloc; elite confidence evaporates."},
        {title:"Conclusion", body:"Judgement on inevitability: war made collapse likely and rapid, but without war, tsarism might have limped on longer."}
      ],
      help:[
        "War hit supplies, inflation and morale; linked regime directly to failure.",
        "Progressive Bloc (1915) shows elite loss of confidence.",
        "Nicholas at the front (1915) worsened domestic governance."
      ]
    },
  {
      id:"e3", topicId:"t3",
      question:"‘Government under Lenin, in the years 1917 to 1924, was little different from government under Tsar Nicholas II in the years 1894 to 1905.’ Assess the validity of this view.",
      factors:["Similarity: coercion and repression","Difference: ideology + new structures","Civil War context","Extent of one-party rule"],
      plan:[
        {title:"Intro", body:"Methods can look similar (coercion), but aims/structures differ fundamentally."},
        {title:"Similarity", body:"Secret police (Okhrana/Cheka), censorship, repression, limited opposition tolerance."},
        {title:"Difference", body:"Class ideology + soviets in theory; one-party state; abolition of monarchy/estates."},
        {title:"Civil War", body:"Emergency context explains intensity (terror, requisitioning)."},
        {title:"Conclusion", body:"Coercive continuity in tools, but different political project and legitimacy claims."}
      ],
      help:[
        "Cheka 1917; Red Terror 1918; ban on factions 1921; one-party dominance.",
        "War Communism: requisitioning + state control (civil war supply).",
        "Judgement hinge: methods vs aims/structures."
      ]
    },
  {
      id:"e13", topicId:"t3",
      question:"‘The Bolsheviks maintained power in the years 1917 to 1924 mainly through coercion rather than popular support.’ Assess the validity of this view.",
      factors:["Early decrees and support","Cheka/terror as control","Civil War and War Communism","NEP and pragmatic legitimacy"],
      plan:[
        {title:"Intro", body:"Argue coercion was essential (especially during civil war), but early policies and later pragmatism also created a base of conditional support."},
        {title:"Factor 1: Support-building measures", body:"Land/peace promises; assess how far these generated genuine support vs temporary acquiescence."},
        {title:"Factor 2: Coercion and repression", body:"Cheka, Red Terror, suppression of opposition; evaluate centrality to survival."},
        {title:"Factor 3: War and economic policy", body:"War Communism’s role in victory but costs; NEP as retreat to stabilise rule."},
        {title:"Conclusion", body:"Judgement: coercion dominant in crisis; support mattered but was often conditional and managed."}
      ],
      help:[
        "Decree on Land (Oct 1917) helped secure rural acquiescence.",
        "Cheka and Red Terror enforced control; opposition suppressed (Constituent Assembly closed Jan 1918).",
        "War Communism helped win but caused unrest; NEP restored stability."
      ]
    },
  {
      id:"e14", topicId:"t3",
      question:"To what extent did the Civil War (1918–21) transform Bolshevik government by 1924?",
      factors:["Militarisation and centralisation","Terror and political policing","Economic controls","Long-term political legacy (one-party rule)"],
      plan:[
        {title:"Intro", body:"Argue the Civil War was transformative: it normalised coercion, centralisation and one-party rule, shaping the Soviet state by 1924."},
        {title:"Factor 1: Centralisation", body:"War demands: discipline, hierarchy, emergency decision-making; explain how this reshaped governance."},
        {title:"Factor 2: Terror apparatus", body:"Cheka and Red Terror; evaluate how war conditions entrenched political policing."},
        {title:"Factor 3: Economic legacy", body:"War Communism then NEP; show continuity of state direction and the precedent for intervention."},
        {title:"Conclusion", body:"Judgement on ‘transform’: war intensified trends and embedded methods that endured beyond 1921."}
      ],
      help:[
        "Civil War created emergency conditions that prioritised survival over pluralism.",
        "Cheka/terror became institutionalised as a tool of rule.",
        "1921: ban on factions signals enduring one-party discipline."
      ]
    },
  {
      id:"e4", topicId:"t4",
      question:"To what extent were purges and terror, in the years 1918 to 1941, a response to real threats to the Leninist and Stalinist regimes?",
      factors:["Real threats 1918–21","Stalin’s political consolidation","Social engineering & collectivisation","Terror beyond ‘threat’"],
      plan:[
        {title:"Intro", body:"Real threats existed early, but terror expanded into a proactive tool for control and transformation."},
        {title:"Leninist threats", body:"Civil War + foreign intervention made fear of enemies credible → Red Terror."},
        {title:"Stalin & power", body:"Rivals and institutional insecurity; show how ‘threat’ could be exaggerated."},
        {title:"Collectivisation", body:"Resistance framed as class enemies; terror used to force compliance."},
        {title:"Conclusion", body:"Threat explains origins; scale/targets show terror as governing strategy."}
      ],
      help:[
        "Civil War emergency shaped early coercion.",
        "Collectivisation resistance → repression.",
        "Great Terror expanded beyond genuine plots; fear enabled compliance."
      ]
    },
  {
      id:"e15", topicId:"t4",
      question:"‘Economic change under Stalin in the years 1928 to 1941 was achieved mainly through terror and coercion rather than planning and persuasion.’ Assess the validity of this view.",
      factors:["Planning (Five-Year Plans)","Coercion in industry","Collectivisation and violence","Propaganda and incentives"],
      plan:[
        {title:"Intro", body:"Argue coercion was central, but planning structures and mobilisation/propaganda also mattered in directing resources and behaviour."},
        {title:"Factor 1: Planning mechanisms", body:"Targets, priorities (heavy industry), central allocation; assess effectiveness and limits."},
        {title:"Factor 2: Coercion in industry", body:"Discipline, punishment, forced labour; evaluate role in meeting targets."},
        {title:"Factor 3: Collectivisation", body:"Violence/dekulakisation; famine; explain how coercion underpinned agricultural transformation."},
        {title:"Conclusion", body:"Judgement on ‘mainly’: coercion drove compliance, but planning set direction and scale."}
      ],
      help:[
        "Five-Year Plans prioritised heavy industry and state control over resources.",
        "Gulag labour and fear were part of enforcement.",
        "Collectivisation enforced by violence; famine highlights costs."
      ]
    },
  {
      id:"e16", topicId:"t4",
      question:"How far did propaganda and the cult of personality, in the years 1928 to 1953, sustain Stalin’s dictatorship?",
      factors:["Cult + legitimacy","Propaganda vs terror","Social policies and participation","War and post-war context"],
      plan:[
        {title:"Intro", body:"Argue propaganda helped normalise obedience and legitimacy, but terror and institutional control were more decisive—especially in the 1930s."},
        {title:"Factor 1: Cult and messaging", body:"Heroic image, ‘socialist construction’, show trials as theatre; assess impact on consent."},
        {title:"Factor 2: Limits of propaganda", body:"Fear, surveillance, purges; argue why coercion mattered more for compliance."},
        {title:"Factor 3: War and legitimacy", body:"Patriotic mobilisation and victory; explain how this strengthened regime authority post-1941."},
        {title:"Conclusion", body:"Judgement: propaganda sustained image and participation; terror ensured obedience when belief failed."}
      ],
      help:[
        "Show Trials performed ‘truth’ and signalled consequences of dissent.",
        "Great Terror created compliance through fear; propaganda reinforced narratives.",
        "WW2 victory strengthened legitimacy and Stalin’s standing."
      ]
    },
  {
      id:"e5", topicId: "t4",
      question:"‘Khrushchev’s reforms created more continuity than change in the USSR in the years 1953 to 1964.’ Assess the validity of this view.",
      factors:["Politics: de-Stalinisation vs one-party control","Economy: virgin lands/sovnarkhozy","Culture: thaw with limits","Reasons for removal"],
      plan:[
        {title:"Intro", body:"Real change in tone/terror; major continuity in party control and repression when challenged."},
        {title:"Politics", body:"Secret Speech + reduced terror; but one-party system stays; limits when dissent rises."},
        {title:"Economy", body:"Virgin Lands and decentralisation attempts; mixed results and disruption."},
        {title:"Culture", body:"Thaw broadened expression but boundaries enforced; continuity in control."},
        {title:"Conclusion", body:"Change mattered, but continuity explains constraints and removal in 1964."}
      ],
      help:[
        "1956 Secret Speech; de-Stalinisation.",
        "Virgin Lands: early gains then soil problems.",
        "Continuity: Party monopoly; limits to freedom; coercion still used."
      ]
    },
  {
      id:"e17", topicId: "t4",
      question:"‘The main reason Khrushchev was removed from power in 1964 was the failure of his economic reforms.’ Assess the validity of this view.",
      factors:["Economic ‘zig-zags’","Party/elite alienation","Foreign policy and prestige","Style of leadership"],
      plan:[
        {title:"Intro", body:"Economic problems were crucial, but removal also reflects elite politics: resentment at style, disruption, and loss of confidence."},
        {title:"Factor 1: Economic reforms", body:"Virgin Lands; sovnarkhozy; inconsistency; assess whether failures were decisive."},
        {title:"Factor 2: Elite alienation", body:"Cadre disruption, criticism of bureaucracy; explain why elites turned against him."},
        {title:"Factor 3: Other pressures", body:"Include at least one non-economic factor (e.g. foreign policy embarrassment or leadership style) and weigh it."},
        {title:"Conclusion", body:"Judgement: economic failures mattered most as they directly hit credibility, but removal required elite coalition."}
      ],
      help:[
        "Sovnarkhozy (1957): decentralisation created confusion/rivalry.",
        "Virgin Lands: short-term gains; long-term soil and planning problems.",
        "Removal in 1964: party coup signals elite resistance."
      ]
    },
  {
      id:"e18", topicId: "t4",
      question:"How far did de-Stalinisation improve Soviet society in the years 1953 to 1964?",
      factors:["Fear/terror reduction","Culture and ‘thaw’","Living standards and economy","Limits: coercion remains"],
      plan:[
        {title:"Intro", body:"Argue de-Stalinisation improved life for many (less terror, some cultural opening), but improvements were limited by continued one-party control and policy inconsistency."},
        {title:"Factor 1: Political/social climate", body:"Reduced terror and release/rehabilitation; explain significance for everyday life and conformity."},
        {title:"Factor 2: Cultural change", body:"Thaw and publication opportunities; then limits and clampdowns; weigh ‘real’ change."},
        {title:"Factor 3: Limits and coercion", body:"Novocherkassk 1962; Hungary 1956; show boundaries of reform."},
        {title:"Conclusion", body:"Judgement: meaningful change in tone and fear, but not in fundamentals of power and control."}
      ],
      help:[
        "Secret Speech (1956) launches de-Stalinisation and ‘Thaw’ (with limits).",
        "Novocherkassk (1962) shows coercion remained.",
        "Hungary (1956) crushed: reform had clear boundaries."
      ]
    }
];

/* ==========================================================
   STORAGE + STATE
   ========================================================== */
const STORAGE_KEY = "russia_revision_pastel_v1";

function baseState(){
  return {
    reviews:{},
    // stats: studied counter (focus backlog is computed from reviews)
    stats:{ studied:0 },
    quiz:{ attempted:0, correct:0, bestStreakAllTime:0 },
    weekly:{},
    topicLevels:{},
    daily:{},
    // Duolingo-style: consecutive days completing the Daily Challenge
    dailyStreak:{ count:0, best:0, lastDate:null },
    topicStats:{},
    userStats:{ lastActionType:null, lastActiveAt:0, sessionsToday:0 },
    analytics:{ daily:{} },
    // topics toggled off are excluded from flashcards/quizzes/daily challenge
    disabledTopics:{},
  };
}
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return baseState();
    const s = JSON.parse(raw);
    s.reviews ||= {};
    s.stats ||= { studied:0 };
    s.quiz ||= { attempted:0, correct:0, bestStreakAllTime:0 };
    s.weekly ||= {};
    s.topicLevels ||= {};
    s.daily ||= {};
    s.dailyStreak ||= { count:0, best:0, lastDate:null };
    s.topicStats ||= {};
    s.userStats ||= { lastActionType:null, lastActiveAt:0, sessionsToday:0 };
    s.analytics ||= { daily:{} };
    s.disabledTopics ||= {};
    return s;
  }catch{
    return baseState();
  }
}
var STATE = loadState();
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(STATE)); }


function isTopicEnabled(topicId){
  if(!STATE) STATE = loadState();
  STATE.disabledTopics ||= {};
  return !STATE.disabledTopics[topicId];
}
function enabledTopicIds(){
  const ids = TOPICS.map(t=>t.id).filter(id=>isTopicEnabled(id));
  return ids.length ? ids : TOPICS.map(t=>t.id);
}
const $ = (id)=>document.getElementById(id);

// Safe HTML escaping for dynamic template strings
function escapeHtml(v){
  return String(v)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/\"/g, "&quot;")
    .replace(/'/g, "&#39;");
}

/* ==========================================================
   DAILY CHALLENGE (purposeful + rotating)
   ========================================================== */
const DAILY_FLASH_GOAL = 12;
const DAILY_QUIZ_GOAL = 100;

let NEXT_QUIZ_FROM_DAILY_CHALLENGE = false;

function pad2(n){ return String(n).padStart(2,'0'); }
function todayKey(){
  const d = new Date();
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}
function keyToDate(k){
  // k = YYYY-MM-DD
  const [y,m,dd] = String(k).split('-').map(n=>parseInt(n,10));
  return new Date(y, (m||1)-1, dd||1);
}
function isSameDay(a,b){
  return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
}
function addDaysKey(k, delta){
  const d = keyToDate(k);
  d.setDate(d.getDate() + delta);
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}
function yesterdayKey(){
  return addDaysKey(todayKey(), -1);
}
function dayOfYear(d){
  const start = new Date(d.getFullYear(), 0, 0);
  const diff = d - start;
  return Math.floor(diff / 86400000);
}
function dailyIndex(){ return dayOfYear(new Date()); }
function getDailyTopicId(){
  // Deterministic rotation: topic depends on the day of year.
  // Exclude any topics toggled off by the student/teacher.
  const ids = enabledTopicIds();
  return ids[dailyIndex() % ids.length];
}
function getDailyExamId(topicId){
  const list = EXAM_BANK.filter(x=>x.topicId===topicId);
  if(!list.length) return null;
  return list[dailyIndex() % list.length].id;
}

function ensureDaily(){
  STATE.daily ||= {};
  const k = todayKey();
  const wantTopic = getDailyTopicId();
  if(!STATE.daily[k]){
    STATE.daily[k] = { topicId: wantTopic, flash:0, quizBest:0, planOpened:false, completed:false };
    saveState();
  }
  // If topic rotation logic changes (or bank changes), keep today aligned.
  if(STATE.daily[k].topicId !== wantTopic){
    STATE.daily[k].topicId = wantTopic;
    // don't wipe progress; just realign.
    saveState();
  }
  return STATE.daily[k];
}

function normalizeDailyStreak(){
  // Duolingo-style: streak remains “alive” if last completion was yesterday.
  STATE.dailyStreak ||= { count:0, best:0, lastDate:null };
  const last = STATE.dailyStreak.lastDate;
  if(!last){
    // Migration / safety: infer last completion from daily log if available
    try{
      const keys = Object.keys(STATE.daily||{}).sort();
      let inferred = null;
      for(let i=keys.length-1;i>=0;i--){
        const k = keys[i];
        if(STATE.daily[k]?.completed){ inferred = k; break; }
      }
      if(inferred){
        STATE.dailyStreak.lastDate = inferred;
        // Compute streak backwards (in case user has a run already)
        let count = 0;
        let cur = inferred;
        while(STATE.daily[cur]?.completed){
          count++;
          cur = addDaysKey(cur, -1);
        }
        STATE.dailyStreak.count = count;
        STATE.dailyStreak.best = Math.max(STATE.dailyStreak.best||0, count);
        saveState();
        return;
      }
    }catch(e){}
    STATE.dailyStreak.count = 0;
    STATE.dailyStreak.best = Math.max(STATE.dailyStreak.best||0, 0);
    saveState();
    return;
  }
  const t = todayKey();
  const y = yesterdayKey();
  if(last === t || last === y) return; // still valid
  // Missed at least one full day → streak breaks
  STATE.dailyStreak.count = 0;
  STATE.dailyStreak.best = Math.max(STATE.dailyStreak.best||0, 0);
  STATE.dailyStreak.lastDate = null;
  saveState();
}

function updateDailyStreakOnComplete(){
  STATE.dailyStreak ||= { count:0, best:0, lastDate:null };
  const t = todayKey();
  const last = STATE.dailyStreak.lastDate;
  if(last === t) return; // already counted today
  if(last === yesterdayKey()) STATE.dailyStreak.count = (STATE.dailyStreak.count||0) + 1;
  else STATE.dailyStreak.count = 1;
  STATE.dailyStreak.best = Math.max(STATE.dailyStreak.best||0, STATE.dailyStreak.count);
  STATE.dailyStreak.lastDate = t;
  saveState();
}

function updateDailyUI(){
  const d = ensureDaily();
  const topicTitle = (TOPICS.find(t=>t.id===d.topicId)||{}).title || d.topicId;

  const label = document.getElementById('dailyTopicLabel');
  if(label) label.textContent = topicTitle;

  const streakCard = document.getElementById('streakHeroCard');
  if(streakCard){
    const dailyTopicBackgrounds = {
      t1: "./topic1.png?v=1",
      t2: "./topic2.png?v=1",
      t3: "./section-bg.jpg?v=8",
      t4: "./section-bg.jpg?v=8"
    };
    const bg = dailyTopicBackgrounds[d.topicId];
    streakCard.style.setProperty('--dailyTopicBg', bg ? `url('${bg}')` : 'none');
  }

  const timePill = document.getElementById('dailyTimePill');
  if(timePill) timePill.textContent = `📅 ${todayKey()} • 10–15 mins`;

  const flashProg = document.getElementById('dmFlashProg');
  if(flashProg) flashProg.textContent = `${Math.min(d.flash, DAILY_FLASH_GOAL)}/${DAILY_FLASH_GOAL}`;

  const quizProg = document.getElementById('dmQuizProg');
  if(quizProg) quizProg.textContent = `${Math.min(100, d.quizBest)}% / ${DAILY_QUIZ_GOAL}%`;

  const planProg = document.getElementById('dmPlanProg');
  if(planProg) planProg.textContent = d.planOpened ? 'Yes' : 'No';

  const flashRow = document.getElementById('dmFlashRow');
  const quizRow  = document.getElementById('dmQuizRow');
  const planRow  = document.getElementById('dmPlanRow');
  const doneFlash = d.flash >= DAILY_FLASH_GOAL;
  const doneQuiz = d.quizBest >= DAILY_QUIZ_GOAL;
  const donePlan = !!d.planOpened;
  if(flashRow) flashRow.style.borderColor = doneFlash ? 'rgba(126,185,170,.55)' : 'rgba(0,0,0,.10)';
  if(quizRow)  quizRow.style.borderColor  = doneQuiz  ? 'rgba(126,185,170,.55)' : 'rgba(0,0,0,.10)';
  if(planRow)  planRow.style.borderColor  = donePlan  ? 'rgba(126,185,170,.55)' : 'rgba(0,0,0,.10)';

  const trophy = document.getElementById('streakCompleteBanner');
  if(trophy){
    if(d.completed) trophy.classList.remove('hidden');
    else trophy.classList.add('hidden');
  }
  try{ renderStreakHero(); }catch(e){}
}


function formatHMS(ms){
  const s = Math.max(0, Math.floor(ms/1000));
  const hh = Math.floor(s/3600);
  const mm = Math.floor((s%3600)/60);
  const ss = s%60;
  return `${pad2(hh)}:${pad2(mm)}:${pad2(ss)}`;
}
function msUntilReset(){
  const now = new Date();
  const end = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1, 0,0,0,0);
  return end - now;
}
function streakTier(count){
  if(count >= 30) return "🏆 Historian Mode (30)";
  if(count >= 14) return "🌟 Revolution Ready (14)";
  if(count >= 7)  return "✅ Moderniser (7)";
  if(count >= 3)  return "🌱 Reformer (3)";
  if(count >= 1)  return "🔥 Started (1)";
  return "Start today";
}
function nextMilestone(count){
  const targets = [3,7,14,30];
  for(const t of targets) if(count < t) return t;
  return 50;
}
let _streakTimer = null;
function renderStreakHero(){
  normalizeDailyStreak();
  const d = ensureDaily();
  const count = STATE.dailyStreak?.count || 0;
  const best  = STATE.dailyStreak?.best || 0;

  const big = $("streakBigNum"); if(big) big.textContent = String(count);
  const bestEl = $("streakBestNum"); if(bestEl) bestEl.textContent = String(best);
  // tier label removed from hero to reduce visual noise

  // Header streak pill
  try{ renderStreakSignal(); }catch(e){}

  // Status + checklist
  const doneToday = !!d.completed;
  const box = $("streakStatusBox");
  const icon = $("streakStatusIcon");
  const textEl = $("streakStatusText");
  const cd = $("streakCountdown");

  const doneFlash = d.flash >= DAILY_FLASH_GOAL;
  const doneQuiz  = d.quizBest >= DAILY_QUIZ_GOAL;
  const donePlan  = !!d.planOpened;

  const flashDot = $("chkFlashDot"); if(flashDot) flashDot.classList.toggle("done", doneFlash);
  const quizDot  = $("chkQuizDot");  if(quizDot)  quizDot.classList.toggle("done", doneQuiz);
  const planDot  = $("chkPlanDot");  if(planDot)  planDot.classList.toggle("done", donePlan);

  const flashVal = $("chkFlashVal"); if(flashVal) flashVal.textContent = `${Math.min(d.flash, DAILY_FLASH_GOAL)}/${DAILY_FLASH_GOAL}`;
  const quizVal  = $("chkQuizVal");  if(quizVal)  quizVal.textContent = `${Math.min(100, d.quizBest)}% / ${DAILY_QUIZ_GOAL}%`;
  const planVal  = $("chkPlanVal");  if(planVal)  planVal.textContent = donePlan ? "Started" : "Not started";

  if(box){
    box.classList.toggle("safe", doneToday);
    box.classList.toggle("risk", !doneToday);
  }
  if(icon) icon.textContent = doneToday ? "✅" : "⚠️";
  if(textEl){
    textEl.textContent = doneToday
      ? "Streak protected for today — keep momentum with your next step."
      : "Streak at risk — complete today’s Daily Challenge to protect it.";
  }
  if(cd) cd.textContent = formatHMS(msUntilReset());

  // Milestone progress
  const target = nextMilestone(count);
  const nextLabel = $("nextMilestoneLabel");
  if(nextLabel){
    const remaining = Math.max(0, target - count);
    nextLabel.textContent = remaining === 0
      ? `Unlocked: ${streakTier(count)}`
      : `Next unlock: ${streakTier(target)} — ${remaining} to go`;
  }
  const fill = $("milestoneBarFill");
  if(fill){
    const pct = Math.max(0, Math.min(1, count/target)) * 100;
    fill.style.width = `${pct}%`;
  }

  // Week strip (last 7 days ending today)
  const strip = $("weekStrip");
  if(strip){
    const today = todayKey();
    const days = [];
    for(let i=6;i>=0;i--){
      const k = addDaysKey(today, -i);
      const dt = keyToDate(k);
      const letter = ["S","M","T","W","T","F","S"][dt.getDay()];
      const completed = !!STATE.daily?.[k]?.completed;
      const missed = (k !== today) && !completed; // don't mark today as missed until it passes
      days.push({k, letter, completed, missed});
    }
    strip.innerHTML = days.map(dy=>{
      const cls = dy.completed ? "dayBlock done" : (dy.missed ? "dayBlock missed" : "dayBlock");
      const title = dy.completed ? `${dy.k}: Completed` : (dy.missed ? `${dy.k}: Missed` : `${dy.k}: Pending`);
      return `<div class="${cls}" title="${title}">${dy.letter}</div>`;
    }).join("");
  }


  // Completion banner + button behaviour
  const completeBanner = $("streakCompleteBanner");
  if(completeBanner){
    completeBanner.classList.toggle("hidden", !doneToday);
  }

  const btn = $("protectStreakBtn");
  if(btn){
    const cta = getChallengeCtaConfig(d);
    btn.classList.remove("hidden");
    btn.textContent = cta.label;
    btn.disabled = cta.disabled;
    btn.onclick = cta.onClick;
  }


  // Countdown tick
  clearInterval(_streakTimer);
  _streakTimer = setInterval(()=>{
    const el = $("streakCountdown");
    if(el) el.textContent = formatHMS(msUntilReset());
  }, 1000);
  updateBannerTitlePill();

}

function checkDailyComplete(){
  const d = ensureDaily();
  if(d.completed) return;
  if(d.flash >= DAILY_FLASH_GOAL && d.quizBest >= DAILY_QUIZ_GOAL && d.planOpened){
    d.completed = true;
    // Update Duolingo-style streak when a Daily Challenge is completed
    updateDailyStreakOnComplete();
    saveState();
    logEvent("daily_challenge_completed", { topicId: d.topicId });
    updateDailyUI();
    try{ computeKpis(); }catch(e){}
    closeQuizCompleteModal();
    showDailyChallengeCompleteModal(d.topicId);
    try{ confetti.fall(3200); }catch(e){}
    try{ confetti.burst(200); }catch(e){}
  }
}

function recordDailyFlashcard(topicId, cardId){
  const d = ensureDaily();
  if(topicId !== d.topicId) return;

  // Only count once per card per day (prevents spamming Reveal / marking)
  if(cardId){
    d.revealedCards = Array.isArray(d.revealedCards) ? d.revealedCards : [];
    if(d.revealedCards.includes(cardId)) return;
    d.revealedCards.push(cardId);
  }

  d.flash = (d.flash||0) + 1;
  saveState();
  updateDailyUI();
  checkDailyComplete();
}

function recordDailyQuiz(topicId, percent){
  const d = ensureDaily();
  if(topicId !== d.topicId) return;
  const p = Math.max(0, Math.min(100, Math.round(percent)));
  d.quizBest = Math.max(d.quizBest||0, p);
  const bucket = analyticsDayBucket(todayKey());
  bucket.quizAttempts = Number(bucket.quizAttempts || 0) + 1;
  bucket.quizTotal = Number(bucket.quizTotal || 0) + p;
  bucket.quizAvg = Math.round(bucket.quizTotal / Math.max(1, bucket.quizAttempts));
  saveState();
  updateDailyUI();
  checkDailyComplete();
}

function recordDailyPlanOpened(topicId){
  const d = ensureDaily();
  if(topicId !== d.topicId) return;
  const wasOpened = !!d.planOpened;
  d.planOpened = true;
  saveState();
  updateDailyUI();
  checkDailyComplete();
  if(!wasOpened) trackTaskCompleted("PLAN_25", topicId);
}

/* ==========================================================
   XP LEVELS + LEVEL-UP NOTIFICATIONS (Topic tiles)
   ========================================================== */
function getXpLevel(avgScore01to2){
  // avgScore is 0..2 based on weak/developing/secure distribution
  // Thresholds chosen to feel achievable but meaningful.
  if(avgScore01to2 >= 1.8) return { key:"master", label:"MASTER", rank:3, icon:"🏆" };
  if(avgScore01to2 >= 1.35) return { key:"secure", label:"SECURE", rank:2, icon:"✅" };
  if(avgScore01to2 >= 0.6) return { key:"developing", label:"DEVELOPING", rank:1, icon:"🌱" };
  return { key:"starting", label:"STARTING OUT", rank:0, icon:"🚦" };
}

let _bannerTimer = null;
function showLevelUpBanner(html){
  const el = document.getElementById("levelUpBanner");
  if(!el) return;
  el.innerHTML = html;
  el.classList.add("show");
  clearTimeout(_bannerTimer);
  _bannerTimer = setTimeout(()=>{ el.classList.remove("show"); }, 2400);
}

function celebrateLevelUp(topicTitle, levelObj){
  const reduceMotion = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;
  if(!reduceMotion && typeof confetti !== "undefined" && confetti?.burst){
    confetti.burst(160);
  }
  const safeTitle = escapeHtml(topicTitle);
  showLevelUpBanner(`
    <div>${levelObj.icon} Level up: <span style="text-transform:uppercase">${escapeHtml(levelObj.label)}</span></div>
    <div class="smallNote">${safeTitle}</div>
  `);
}

function startOfTodayTs(){
  const d = new Date();
  d.setHours(0,0,0,0);
  return d.getTime();
}
function addDaysTs(startTs, days){
  const d = new Date(startTs);
  d.setDate(d.getDate()+days);
  d.setHours(0,0,0,0);
  return d.getTime();
}
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function unique(arr){
  const seen=new Set(), out=[];
  for(const x of arr){
    const k=String(x).toLowerCase();
    if(seen.has(k)) continue;
    seen.add(k);
    out.push(x);
  }
  return out;
}
function debounce(fn, ms){
  let t;
  return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
}

/* ==========================================================
   ISO WEEK KEY (weekly badge)
   ========================================================== */
function getISOWeekKey(date = new Date()){
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  const year = d.getUTCFullYear();
  return `${year}-W${String(weekNo).padStart(2,"0")}`;
}
function getWeeklyBucket(){
  const key = getISOWeekKey(new Date());
  STATE.weekly[key] ||= { attempted:0, correct:0, bestStreak:0 };
  return { key, bucket: STATE.weekly[key] };
}
function weeklyPercent(){
  const { bucket } = getWeeklyBucket();
  if(bucket.attempted<=0) return 0;
  return Math.round((bucket.correct/bucket.attempted)*100);
}
function getWeeklyBadge(){
  const { bucket } = getWeeklyBucket();
  const enough = bucket.attempted >= 10;
  if(!enough) return { name:"—", icon:"🏅", note:"Do 10 quiz Qs this week to unlock." };
  const pct = weeklyPercent();
  if(pct>=90) return { name:"Diamond", icon:"💎", note:"90%+ this week." };
  if(pct>=80) return { name:"Gold", icon:"🥇", note:"80–89% this week." };
  if(pct>=65) return { name:"Silver", icon:"🥈", note:"65–79% this week." };
  return { name:"Bronze", icon:"🥉", note:"<65% this week — Focus then Mixed." };
}

/* ==========================================================
   CONFETTI (lightweight)
   ========================================================== */
const confetti = (() => {
  const canvas = document.getElementById("confettiCanvas");
  const ctx = canvas.getContext("2d");
  let W=0,H=0,pieces=[],running=false;

  function resize(){
    W = canvas.width = window.innerWidth * devicePixelRatio;
    H = canvas.height = window.innerHeight * devicePixelRatio;
    canvas.style.width = window.innerWidth + "px";
    canvas.style.height = window.innerHeight + "px";
  }
  window.addEventListener("resize", resize);

  function spawn(count=110){
    resize();
    const colors = [
      [110,144,202],[163,194,223],[126,185,170],[158,183,212],[183,142,161]
    ];
    pieces = Array.from({length:count}).map(()=> {
      const c = colors[Math.floor(Math.random()*colors.length)];
      return {
        x: Math.random()*W,
        y: -20*Math.random()*devicePixelRatio,
        r: (4+Math.random()*7)*devicePixelRatio,
        vx: (-2 + Math.random()*4)*devicePixelRatio,
        vy: (3 + Math.random()*6)*devicePixelRatio,
        rot: Math.random()*Math.PI,
        vr: (-0.2 + Math.random()*0.4),
        c,
        life: 110 + Math.random()*40
      };
    });
  }
  function tick(){
    if(!running) return;
    ctx.clearRect(0,0,W,H);
    pieces.forEach(p=>{
      p.x += p.vx;
      p.y += p.vy;
      p.rot += p.vr;
      p.vy += 0.03*devicePixelRatio;
      p.life--;

      ctx.save();
      ctx.translate(p.x,p.y);
      ctx.rotate(p.rot);
      ctx.fillStyle = `rgba(${p.c[0]},${p.c[1]},${p.c[2]},0.9)`;
      ctx.fillRect(-p.r/2, -p.r/2, p.r, p.r*0.6);
      ctx.restore();
    });
    pieces = pieces.filter(p=>p.life>0 && p.y < H+50*devicePixelRatio);
    if(pieces.length===0){ running=false; ctx.clearRect(0,0,W,H); return; }
    requestAnimationFrame(tick);
  }
  function burst(count=110){
    spawn(count);
    running=true;
    requestAnimationFrame(tick);
  }
  function fall(durationMs=2600){
    const count = Math.max(120, Math.floor(window.innerWidth / 7));
    burst(count);
    const interval = setInterval(()=>spawn(count), 420);
    setTimeout(()=>clearInterval(interval), Math.max(600, durationMs));
  }
  return { burst, fall };
})();

/* ==========================================================
   NAV RULE
   ========================================================== */
function setTab(tabId){
  document.querySelectorAll(".navBtn").forEach(b=>b.classList.toggle("active", b.dataset.tab===tabId));
  document.querySelectorAll(".tabpane").forEach(p=>p.classList.toggle("hidden", p.id!==tabId));

  // Reset viewport position whenever changing tabs
  window.scrollTo({ top: 0, left: 0, behavior: "auto" });

  // Games: default to hub list when entering the tab
  if(tabId==="games") gamesShowHub();

  if(tabId === "home"){
    renderHomeRecommendation();
  }
  if(tabId === "progress"){
    renderProgressReport();
  }
}
document.querySelectorAll(".navBtn").forEach(btn=>{
  btn.addEventListener("click", ()=>setTab(btn.dataset.tab));
});

const streakProgressBtn = $("streakProgressBtn");
if(streakProgressBtn){
  streakProgressBtn.addEventListener("click", ()=>setTab("progress"));
}

/* Games hub navigation */
function gamesShowHub(){
  const hub = $("gamesHub");
  const panes = ["gamesConnPane","gamesEmojiPane","gamesMatchPane","gamesTimelinePane","gamesBeatClockPane"];
  if(!hub) return;
  hub.classList.remove("hidden");
  panes.forEach(id => $(id) && $(id).classList.add("hidden"));
  if($("timelineTopicSelect")) tlPopulateSelect();
  window.scrollTo(0,0);
}
function openGamePane(paneId){
  const hub = $("gamesHub");
  const panes = ["gamesConnPane","gamesEmojiPane","gamesMatchPane","gamesTimelinePane","gamesBeatClockPane"];
  if(hub) hub.classList.add("hidden");
  panes.forEach(id => $(id) && $(id).classList.toggle("hidden", id!==paneId));
  window.scrollTo(0,0);
}
window.addEventListener("DOMContentLoaded", ()=>{
  const openConn = $("openConnBtn"), openEmoji = $("openEmojiBtn"), openMatch = $("openMatchBtn"), openTimeline = $("openTimelineBtn"), openBeatClock = $("openBeatClockBtn");
  const backConn = $("backFromConn"), backEmoji = $("backFromEmoji"), backMatch = $("backFromMatch"), backTimeline = $("backFromTimeline"), backBeatClock = $("backFromBeatClock");
  if(openConn) openConn.addEventListener("click", ()=>{ markGameSessionCompleted("connections", getDailyTopicId()); openGamePane("gamesConnPane"); });
  if(openEmoji) openEmoji.addEventListener("click", ()=>{ markGameSessionCompleted("emoji", $("emojiTopicSelect").value === "MIXED" ? getDailyTopicId() : $("emojiTopicSelect").value); openGamePane("gamesEmojiPane"); });
  if(openMatch) openMatch.addEventListener("click", ()=>{ markGameSessionCompleted("match", $("matchTopicSelect").value === "MIXED" ? getDailyTopicId() : $("matchTopicSelect").value); openGamePane("gamesMatchPane"); });
  if(openTimeline) openTimeline.addEventListener("click", ()=>{ markGameSessionCompleted("timeline", $("timelineTopicSelect")?.value || getDailyTopicId()); openGamePane("gamesTimelinePane"); });
  if(openBeatClock) openBeatClock.addEventListener("click", ()=>{ markGameSessionCompleted("beat_clock", getDailyTopicId()); openGamePane("gamesBeatClockPane"); });
  if(backConn) backConn.addEventListener("click", gamesShowHub);
  if(backEmoji) backEmoji.addEventListener("click", gamesShowHub);
  if(backMatch) backMatch.addEventListener("click", gamesShowHub);
  if(backTimeline) backTimeline.addEventListener("click", gamesShowHub);
  if(backBeatClock) backBeatClock.addEventListener("click", gamesShowHub);
  initTimelineGame();
});


/* ==========================================================
   Build knowledge cards (unchanged logic)
   ========================================================== */
function buildKnowledgeCards(){
  const out = [];
  let n = 1;
  const push = (topicId,q,a,tags=[]) => out.push({
    id:`c${String(n++).padStart(4,"0")}`,
    topicId, q, a, tags, kind:"knowledge"
  });
  const significanceQuestion = (subject, { preferArticle = false } = {}) => {
    const raw = (subject ?? "").toString().trim();
    if(!raw) return "what was significant about: it";
    return `what was significant about: ${raw}`;
  };

  for(const topicId of Object.keys(FACT_BANK)){
    const T = FACT_BANK[topicId];

    (T.core||[]).forEach(c => push(topicId, c.q, c.a, c.tags||[]));

(T.terms||[]).forEach(t=>{
  push(topicId, `Define: ${t.term}.`, t.meaning, [t.term,"definition"]);

  if (t.date && String(t.date).trim() !== "") {
    push(topicId, `Date check: ${t.term} — when?`, `${t.date}.`, [t.term,"date"]);
  }

  const sig = (t.significance ?? "").toString().trim();
  if(sig){
    push(topicId, significanceQuestion(t.term, { preferArticle:true }), sig, [t.term,"significance"]);
  }
});

    (T.people||[]).forEach(p=>{
      push(topicId, `Who was ${p.name}?`, p.role, [p.name,"people"]);
      const psig = (p.significance ?? "").toString().trim();
      if(psig){
        push(topicId, significanceQuestion(p.name), psig, [p.name,"significance"]);
      }
      // (Removed) "Link to ONE policy/event" cards removed per request
});

(T.events||[]).forEach(e=>{
  push(topicId, `What happened in: ${e.name}?`, e.what, [e.name,"event"]);

  if (e.date && String(e.date).trim() !== "") {
    push(topicId, `Date check: ${e.name} — when?`, `${e.date}.`, [e.name,"date"]);
  }

  push(topicId, significanceQuestion(e.name, { preferArticle:true }), e.whyMatters, [e.name,"significance"]);
  push(topicId, `Give two consequences of ${e.name}.`, `1) …  2) … (be specific)`, [e.name,"consequences"]);
});
  }
  return out;
}
const ALL_CARDS = buildKnowledgeCards();

/* ==========================================================
   Spaced repetition (unchanged)
   ========================================================== */
function nextIntervalDays(score, prevInterval){
  const base = [0, 1, 3, 7];
  if(prevInterval == null) return base[score];
  if(score === 0) return 0;
  if(score === 1) return Math.max(1, Math.round(prevInterval * 1.3));
  if(score === 2) return Math.max(2, Math.round(prevInterval * 2.0));
  return Math.max(4, Math.round(prevInterval * 3.0));
}
function getReview(cardId){ return STATE.reviews[cardId] || null; }
function setReview(cardId, review){ STATE.reviews[cardId] = Object.assign(STATE.reviews[cardId]||{}, review); saveState(); }

function cardConfidenceLevel(cardId){
  // 🔴 Weak / 🟡 Developing / 🟢 Secure
  // Based on: repeat Again/Hard + time since last success
  const r = getReview(cardId);
  if(!r) return 'weak';
  const score = typeof r.score === 'number' ? r.score : 0;
  // If the last outcome was Again/Hard, treat as weak until a successful recall
  if(score <= 1) return 'weak';

  const lastSuccessTs = r.lastSuccessTs || (score >= 2 ? r.lastTs : 0) || 0;
  if(!lastSuccessTs) return 'developing';

  const daysSince = (Date.now() - lastSuccessTs) / 86400000;
  if(daysSince > 21) return 'weak';
  if(daysSince > 10) return 'developing';
  return 'secure';
}


function topicConfidence(topicId){
  const cards = ALL_CARDS.filter(c=>c.topicId===topicId);
  if(!cards.length) return { level:'starting', avg:0, counts:{weak:0, developing:0, secure:0}, total:0 };
  const counts = {weak:0, developing:0, secure:0};
  for(const c of cards){
    const lvl = cardConfidenceLevel(c.id);
    counts[lvl] = (counts[lvl]||0)+1;
  }
  const total = cards.length;
  const avg = (counts.developing*1 + counts.secure*2) / total; // 0..2
  const lvl = getXpLevel(avg);
  return { level: lvl.key, levelObj:lvl, avg, counts, total };
}

function cardRetentionScore(cardId){
  const review = getReview(cardId);
  if(!review) return 0;
  const score = Math.max(0, Math.min(3, Number(review.score || 0)));
  return score / 3;
}

function cardSuccessfulRecalls(review){
  if(!review) return 0;
  if(Number.isFinite(review.successfulRecalls)){
    return Math.max(0, Math.floor(review.successfulRecalls));
  }
  return Number(review.score) >= 2 ? 1 : 0;
}

function topicRetentionSummary(topicId){
  const cards = ALL_CARDS.filter(c=>c.topicId===topicId);
  const stats = touchTopicStats(topicId);
  const previousRetention = Number.isFinite(Number(stats.previousRetention)) ? Number(stats.previousRetention) : 0;
  if(!cards.length){
    const retention = 0;
    const delta = retention - previousRetention;
    stats.previousRetention = retention;
    return { topicId, retention, previousRetention, delta, categoryLabel:"Building" };
  }

  let retentionTotal = 0;
  let cardsWithTwoPlusSuccesses = 0;

  for(const card of cards){
    const review = getReview(card.id);
    retentionTotal += cardRetentionScore(card.id);
    if(cardSuccessfulRecalls(review) >= 2) cardsWithTwoPlusSuccesses++;
  }

  const retention = Number((retentionTotal / cards.length).toFixed(2));
  const delta = Number((retention - previousRetention).toFixed(2));
  stats.previousRetention = retention;
  const twoPlusSuccessRate = cardsWithTwoPlusSuccesses / cards.length;

  let categoryLabel = "Building";
  if(retention >= 0.85){
    categoryLabel = twoPlusSuccessRate >= 0.6 ? "Mastery" : "Ambition";
  }else if(retention >= 0.65){
    categoryLabel = "Ambition";
  }else if(retention >= 0.4){
    categoryLabel = "Strong Foundations";
  }

  return { topicId, retention, previousRetention, delta, categoryLabel };
}

function retentionTrendMeta(delta){
  if(delta > 0.03){
    return {
      arrow:"↑",
      cls:"up",
      label:"Retention rising",
      reason:"Nice work — recall is improving because your recent study is sticking.",
      keyLabel:"improving recall"
    };
  }
  if(delta < -0.03){
    return {
      arrow:"↓",
      cls:"down",
      label:"Retention dropping",
      reason:"You haven’t studied this topic recently, so memory strength is fading. A quick review will boost it back up.",
      keyLabel:"fading recall"
    };
  }
  return {
    arrow:"→",
    cls:"flat",
    label:"Retention steady",
    reason:"Your recall is holding steady. Keep regular short reviews to move it upward.",
    keyLabel:"steady recall"
  };
}


function topicXpBreakdown(topicId){
  const stats = touchTopicStats(topicId);
  const flashTotal = Math.max(1, Number(stats.flashcardsTotal || 0));
  const flashDone = Math.max(0, Number(stats.flashcardsDone || 0));
  const flashXp = Math.max(0, Math.min(30, Math.round((flashDone / flashTotal) * 30)));
  const quizBest = Math.max(0, Math.min(100, Number(stats.quizBestPercent || 0)));
  const quizXp = Math.round(quizBest * 0.5);
  const planXp = stats.planStarted ? 20 : 0;
  const totalXp = Math.max(0, Math.min(100, flashXp + quizXp + planXp));
  const totalEarnedXp = Math.max(totalXp, Number(stats.totalEarnedXp || 0));
  const xpLevel = getTopicXpLevel(totalEarnedXp);

  const lastStudiedAt = Number(stats.lastStudiedAt || 0);
  const daysSince = lastStudiedAt ? Math.floor((Date.now() - lastStudiedAt) / 86400000) : null;

  let status = { label:"New", cls:"status-new" };
  if(totalXp >= 80) status = { label:"At target", cls:"status-target" };
  else if(totalXp >= 50) status = { label:"On track", cls:"status-track" };
  else if(totalXp > 0) status = { label:"Needs focus", cls:"status-focus" };

  return {
    topicId,
    flashXp,
    quizXp,
    planXp,
    totalXp,
    totalEarnedXp,
    xpLevel,
    quizBest,
    flashDone,
    flashTotal,
    planStarted:!!stats.planStarted,
    lastStudiedAt,
    daysSince,
    status
  };
}

function getTopicXpLevel(totalEarnedXp){
  const levelOrder = ["building", "strong foundations", "ambition", "mastery"];
  const safeXp = Math.max(0, Number(totalEarnedXp || 0));
  const tierIndex = Math.min(levelOrder.length - 1, Math.floor(safeXp / 100));
  const level = levelOrder[tierIndex];
  const progressInTier = tierIndex >= levelOrder.length - 1 ? 100 : (safeXp % 100);
  return { label: level, tierIndex, progressInTier };
}

function getUnifiedTopicLevel(progress){
  const safe = Math.max(0, Math.min(100, Math.round(Number(progress || 0))));
  if(safe >= 85) return { label:"mastery", tierIndex:3, progressInTier:safe };
  if(safe >= 65) return { label:"ambition", tierIndex:2, progressInTier:safe };
  if(safe >= 40) return { label:"strong foundations", tierIndex:1, progressInTier:safe };
  return { label:"building", tierIndex:0, progressInTier:safe };
}

function topicProgressModel(topicId){
  const xp = topicXpBreakdown(topicId);
  const retention = topicRetentionSummary(topicId);
  const retentionPercent = Math.max(0, Math.min(100, Math.round(Number(retention.retention || 0) * 100)));
  const blendedProgress = Math.max(0, Math.min(100, Math.round((xp.totalXp * 0.6) + (retentionPercent * 0.4))));
  const unifiedLevel = getUnifiedTopicLevel(blendedProgress);
  return { xp, retention, retentionPercent, blendedProgress, unifiedLevel };
}

function computeThisWeekMetrics(){
  const today = todayKey();
  const daily = STATE.analytics?.daily || {};
  const weekKeys = Array.from({length:7}, (_,i)=>addDaysKey(today, -i));

  const minutesWeek = Math.round(weekKeys.reduce((n,k)=> n + Number((daily[k]?.sessionDurations||[]).reduce((a,b)=>a+Number(b||0),0) || 0), 0) / 60000);
  const tasksWeek = weekKeys.reduce((n,k)=> n + Number(daily[k]?.dailyTasksCompleted || 0), 0);
  const quizEntriesWeek = weekKeys.map(k=>Number(daily[k]?.quizAvg || 0)).filter(v=>v>0);
  const quizAvgWeek = quizEntriesWeek.length ? Math.round(quizEntriesWeek.reduce((a,b)=>a+b,0) / quizEntriesWeek.length) : 0;
  const streak = Number(STATE.dailyStreak?.count || 0);
  const improvedTopics = weekKeys.reduce((set,k)=>{
    const improved = daily[k]?.topicsImproved || {};
    Object.keys(improved).forEach(tid=>set.add(tid));
    return set;
  }, new Set()).size;

  return { minutesWeek, tasksWeek, quizAvgWeek, streak, improvedTopics };
}

function renderProgressReport(){
  const topicIds = enabledTopicIds();
  const topicRows = topicIds.map(tid=>({
    topic: TOPICS.find(t=>t.id===tid),
    model: topicProgressModel(tid)
  }));
  const avgReadiness = topicRows.length ? Math.round(topicRows.reduce((n,row)=>n + row.model.blendedProgress,0) / topicRows.length) : 0;

  const readinessVal = $("overallReadinessVal");
  const readinessFill = $("overallReadinessFill");
  if(readinessVal) readinessVal.textContent = `${avgReadiness}%`;
  if(readinessFill) readinessFill.style.width = `${avgReadiness}%`;

  const { minutesWeek, tasksWeek, quizAvgWeek, streak, improvedTopics } = computeThisWeekMetrics();
  const weekMetricsEl = $("thisWeekMetrics");
  if(weekMetricsEl){
    const metrics = [
      ["Minutes this week", `${minutesWeek}m`],
      ["Tasks completed", String(tasksWeek)],
      ["Quiz average", `${quizAvgWeek}%`],
      ["Streak", `${streak} day${streak===1?"":"s"}`],
      ["Topics improved", String(improvedTopics)]
    ];
    weekMetricsEl.innerHTML = metrics.map(([label,val])=>`<div class="metricCard"><div class="metricLabel">${label}</div><div class="metricVal">${val}</div></div>`).join("");
  }

  const topicXpEl = $("topicXpList");
  if(topicXpEl){
    topicXpEl.innerHTML = topicRows.map(({topic,model})=>{
      const { xp, retention, unifiedLevel, blendedProgress } = model;
      const trend = retentionTrendMeta(retention.delta);
      const topicTitle = escapeHtml(topic?.title || xp.topicId);
      const dialogTitle = `${topicTitle} · ${escapeHtml(trend.label)}`;
      const daysText = xp.daysSince === null ? "No study session logged yet." : `Last studied ${xp.daysSince} day${xp.daysSince===1?"":"s"} ago.`;
      return `
      <div class="topicXpItem" role="button" tabindex="0" data-topic-open="1" data-topic-id="${xp.topicId}" aria-label="Open ${topicTitle} flashcards (full random cards)">
        <div class="topicXpTop">
          <div class="topicXpTitle">${topicTitle}</div>
          <div class="topicXpMeta">
            <span class="statusTag ${xp.status.cls}">${escapeHtml(unifiedLevel.label)}</span>
          </div>
        </div>
        <div class="topicXpSub"><span>${blendedProgress}/100 progress</span><button type="button" class="topicRetentionArrowBtn" title="${trend.label}" aria-label="${trend.label}: tap for explanation" data-topic-arrow="1" data-dialog-title="${dialogTitle}" data-dialog-body="${escapeHtml(trend.reason)}" data-dialog-meta="${escapeHtml(daysText)}"><span class="topicRetentionArrow ${trend.cls}" aria-hidden="true">${trend.arrow}</span></button></div>
        <div class="progressTrack" style="margin-top:6px"><div class="progressFill" style="width:${blendedProgress}%"></div></div>
      </div>
    `;
    }).join("");
  }

}

function openTopicArrowDialog(triggerBtn){
  if(!triggerBtn) return;
  const overlay = $("topicArrowDialog");
  const titleEl = $("topicArrowDialogTitle");
  const bodyEl = $("topicArrowDialogBody");
  const metaEl = $("topicArrowDialogMeta");
  if(!overlay || !titleEl || !bodyEl || !metaEl) return;

  titleEl.textContent = triggerBtn.dataset.dialogTitle || "Topic trend";
  bodyEl.textContent = triggerBtn.dataset.dialogBody || "Keep reviewing this topic to maintain progress.";
  metaEl.textContent = triggerBtn.dataset.dialogMeta || "";

  overlay.classList.remove("hidden");
}

function closeTopicArrowDialog(){
  const overlay = $("topicArrowDialog");
  if(!overlay) return;
  overlay.classList.add("hidden");
}

function initTopicArrowDialog(){
  const listEl = $("topicXpList");
  const overlay = $("topicArrowDialog");
  const closeBtn = $("topicArrowDialogClose");
  if(!listEl || !overlay || !closeBtn) return;

  listEl.addEventListener("click", (event)=>{
    const btn = event.target.closest("[data-topic-arrow='1']");
    if(btn){
      openTopicArrowDialog(btn);
      return;
    }

    const panel = event.target.closest("[data-topic-open='1']");
    if(!panel || !listEl.contains(panel)) return;
    const topicId = panel.dataset.topicId;
    if(topicId) openStudyForTopic(topicId, "all");
  });

  listEl.addEventListener("keydown", (event)=>{
    if(event.key !== "Enter" && event.key !== " ") return;
    const panel = event.target.closest("[data-topic-open='1']");
    if(!panel || !listEl.contains(panel)) return;
    event.preventDefault();
    const topicId = panel.dataset.topicId;
    if(topicId) openStudyForTopic(topicId, "all");
  });

  closeBtn.addEventListener("click", closeTopicArrowDialog);
  overlay.addEventListener("click", (event)=>{
    if(event.target === overlay) closeTopicArrowDialog();
  });
}

function renderTopicDashboard(){
  const el = document.getElementById('topicDash');
  if(!el) return;

  const topicIds = Object.keys(FACT_BANK);

  function tileTitleHTML(title){
    // Expect: "1. Something 1855-1894"
    const m = String(title).match(/^(\d+)\.\s*(.*)\s(\d{4}-\d{4})$/);
    if(m){
      return `
        <div class="tileTitlePanel">
          <div class="tileNum">${escapeHtml(m[1])}</div>
          <div class="tileMain">${escapeHtml(m[2])}</div>
          <div class="tileYears">${escapeHtml(m[3])}</div>
        </div>
      `;
    }
    return `<div class="tileTitlePanel"><div class="tileMain">${escapeHtml(title)}</div></div>`;
  }


  const topicBackgrounds = {
    t1: "./topic1.png?v=1",
    t2: "./topic2.png?v=1",
    t3: "./section-bg.jpg?v=8",
    t4: "./section-bg.jpg?v=8"
  };

  el.innerHTML = topicIds.map(tid=>{
    const t = FACT_BANK[tid];
    const conf = topicConfidence(tid);
    const model = topicProgressModel(tid);
    const xp = model.xp;
    const unifiedLevel = model.unifiedLevel;
    const blendedProgress = model.blendedProgress;

    const total = Math.max(1, conf.total || 0);
    const gRaw = (conf.counts.secure/total)*100;
    const yRaw = (conf.counts.developing/total)*100;

    // ensure the ring always closes cleanly
    let g = Math.round(gRaw);
    let y = Math.round(yRaw);
    if(g + y > 100){
      const over = (g + y) - 100;
      if(y >= over) y -= over; else g -= over;
    }
    const r = 100 - g - y;

    // Liquid fill: weight secure as 1, developing as 0.5 (0–100%)
    const fill = Math.max(0, Math.min(100, Math.round(((conf.counts.secure + (conf.counts.developing*0.5)) / total) * 100)));

    // Liquid colour shifts with progress (same traffic-light scheme)
    const liq = (blendedProgress >= 70) ? "var(--good)" : (blendedProgress >= 35) ? "var(--warn)" : "var(--bad)";

    const legacyLvl = conf.levelObj || getXpLevel(conf.avg||0);
    const lvl = {
      key: `xp-${unifiedLevel.tierIndex}`,
      label: unifiedLevel.label,
      rank: unifiedLevel.tierIndex,
      icon: legacyLvl.icon
    };
    const badgeText = unifiedLevel.label;
    const topicQuiz = Number(touchTopicStats(tid).quizBestPercent||0);
    const topicMastery = Math.max(blendedProgress, topicQuiz);

    // Level-up detection per topic (stored in localStorage)
    STATE.topicLevels ||= {};
    const prevRank = (typeof STATE.topicLevels[tid] === "number") ? STATE.topicLevels[tid] : null;
    if(prevRank === null){
      STATE.topicLevels[tid] = lvl.rank;
      saveState();
    }else if(lvl.rank > prevRank){
      STATE.topicLevels[tid] = lvl.rank;
      saveState();
      celebrateLevelUp(t.title, lvl);
    }

    const topicBg = topicBackgrounds[tid] || "section-bg.jpg";

    return `
      <button class="topicTile ${isTopicEnabled(tid) ? "" : "isDisabled"}" data-topic="${tid}" title="Open this topic" style="--topicTileBg:url('${topicBg}');">
        <div class="progressTank" style="--fill:${blendedProgress}%; --liq:${liq}; --topicBg:url('${topicBg}');">
          <div class="progressLiquid"></div>
          <div class="tankContent">
            ${tileTitleHTML(t.title)}
          </div>
        </div>
        <div class="topicPillRow">
          <div class="levelBadge level-${lvl.key}">${badgeText}</div>
          <div class="topicStatusDot ${topicMastery >= 80 ? "attarget" : topicMastery > 0 ? "inprogress" : "new"}" title="${topicMastery >= 80 ? "At target" : topicMastery > 0 ? "In progress" : "New"}"></div>
          <div class="topicToggleWrap topicTogglePill" title="Toggle this topic on/off">
            <label class="switch">
              <input type="checkbox" class="topicToggle" data-topic-toggle="${tid}" ${isTopicEnabled(tid) ? "checked" : ""} aria-label="Toggle topic ${tid}">
              <span class="slider"></span>
            </label>
          </div>
        </div>
      </button>
    `;
  }).join('');

  // click to jump topic into Study (Focus mode)
  el.querySelectorAll('[data-topic]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const tid = btn.getAttribute('data-topic');

      // switch to Study tabpane
      if(typeof setTab === "function") setTab("study");

      // set filters to this topic + focus mode
      const ts = document.getElementById("topicSelect");
      if(ts){ ts.value = tid; ts.dispatchEvent(new Event("change")); }

      const ms = document.getElementById("modeSelect");
      if(ms){ ms.value = "all"; ms.dispatchEvent(new Event("change")); }

      // refresh card list
      if(typeof loadNextCard === "function") loadNextCard();

      // bring the card into view
      const frame = document.getElementById("flashcardFrame");
      if(frame) frame.scrollIntoView({behavior:"smooth", block:"start"});
    });
  });

  // Topic toggles: on/off controls (exclude from flashcards/quizzes/daily challenge)
  // IMPORTANT: The whole tile is a <button>. The toggle sits inside it.
  // On some browsers, clicking the slider/label can bubble up and trigger the tile click.
  // So we stop propagation for the wrapper AND for pointer events (touch/mouse) in capture phase.
  el.querySelectorAll('.topicToggleWrap').forEach(wrap=>{
    const stop = (ev)=>{ ev.stopPropagation(); };
    // capture phase = safest (prevents the tile button click handler)
    ["pointerdown","mousedown","touchstart","click"].forEach(evt=>{
      wrap.addEventListener(evt, stop, true);
    });
  });

  el.querySelectorAll('[data-topic-toggle]').forEach(inp=>{
    // Keep these as a backstop (if the click lands on the input itself)
    inp.addEventListener('click', (ev)=>{ ev.stopPropagation(); }, true);

    inp.addEventListener('change', (ev)=>{
      ev.stopPropagation();
      const tid = inp.getAttribute('data-topic-toggle');
      STATE.disabledTopics ||= {};
      if(inp.checked){
        delete STATE.disabledTopics[tid];
      }else{
        STATE.disabledTopics[tid] = true;
      }
      saveState();

      // If the currently-selected study/quiz topic is now disabled, bounce to ALL/MIXED
      const ts = document.getElementById("topicSelect");
      if(ts && ts.value !== "ALL" && !isTopicEnabled(ts.value)) ts.value = "ALL";
      const ms = document.getElementById("mcqTopicSelect");
      if(ms && ms.value !== "MIXED" && !isTopicEnabled(ms.value)) ms.value = "MIXED";

      // Refresh UI + daily topic (if needed)
      try{ populateTopics(); }catch(e){}

      const syncIfMissing = (el, fallback)=>{
        if(!el) return;
        const values = new Set(Array.from(el.options||[]).map(o=>o.value));
        if(!values.has(el.value)) el.value = fallback;
      };
      syncIfMissing(document.getElementById("topicSelect"), "ALL");
      syncIfMissing(document.getElementById("mcqTopicSelect"), "MIXED");
      syncIfMissing(document.getElementById("matchTopicSelect"), "MIXED");
      syncIfMissing(document.getElementById("emojiTopicSelect"), "MIXED");
      syncIfMissing(document.getElementById("examTopicSelect"), "ALL");

      try{ if(typeof tlPopulateSelect === "function") tlPopulateSelect(); }catch(e){}
      try{ if(typeof refreshConnectionsTopicSelect === "function") refreshConnectionsTopicSelect(); }catch(e){}
      try{ renderTopicDashboard(); }catch(e){}
      try{ renderTopicTiles(); }catch(e){} // legacy tiles (if present)
      try{ renderExamSelect(); }catch(e){}
      try{ startMatchGame(); }catch(e){}
      try{ startEmojiRound(); }catch(e){}
      try{ updateDailyUI(); }catch(e){}
      try{ computeKpis(); }catch(e){}
    });
  });
}


/* ==========================================================
   Populate dropdowns + tiles
   ========================================================== */
function populateTopics(){
  const sel = $("topicSelect");
  const selQuiz = $("mcqTopicSelect");
  const selMatch = $("matchTopicSelect");
  const selEmoji = $("emojiTopicSelect");
  const selExamFilter = $("examTopicSelect");

  sel.innerHTML = "";
  selQuiz.innerHTML = "";
  selMatch.innerHTML = "";
  selEmoji.innerHTML = "";
  selExamFilter.innerHTML = "";

  const optAll = document.createElement("option");
  optAll.value = "ALL";
  optAll.textContent = "🌍 All topics (class order)";
  sel.appendChild(optAll);

  const addMixed = (selectEl)=>{
    const opt = document.createElement("option");
    opt.value = "MIXED";
    opt.textContent = "🎯 Mixed (all topics)";
    selectEl.appendChild(opt);
  };
  addMixed(selQuiz);
  addMixed(selMatch);
  addMixed(selEmoji);

  const exAll = document.createElement("option");
  exAll.value="ALL"; exAll.textContent="🌍 All topics";
  selExamFilter.appendChild(exAll);

  TOPICS.filter(t=>isTopicEnabled(t.id)).forEach(t=>{
    const o = document.createElement("option");
    o.value = t.id;
    o.textContent = t.title;
    sel.appendChild(o);

    const o2 = document.createElement("option");
    o2.value = t.id; o2.textContent = t.title;
    selQuiz.appendChild(o2);

    const o3 = document.createElement("option");
    o3.value = t.id; o3.textContent = t.title;
    selMatch.appendChild(o3);

    const o4 = document.createElement("option");
    o4.value = t.id; o4.textContent = t.title;
    selEmoji.appendChild(o4);

    const o5 = document.createElement("option");
    o5.value = t.id; o5.textContent = t.title;
    selExamFilter.appendChild(o5);
  });
}

function renderTopicTiles(){
  const box = $("topicTiles");
  box.innerHTML = "";
  TOPICS.forEach(t=>{
    const b = document.createElement("button");
    b.className = "btn";
    b.style.flex="1";
    b.style.minWidth="250px";
    b.innerHTML = `
  <div style="display:flex; justify-content:space-between; gap:12px; align-items:flex-start;">
    <div>
      📚 <b>${t.title}</b>
      <div class="note" style="margin-top:4px">
        Tap to jump into Focus for this topic
      </div>
      <div class="note" style="margin-top:6px">
        ${(()=>{ 
          const c = topicConfidence(t.id);
          const lab = c.level==='secure' ? '🟢 Secure' : (c.level==='developing' ? '🟡 Developing' : '🔴 Weak');
          return `${lab} · ${c.counts.secure} secure / ${c.counts.developing} developing / ${c.counts.weak} weak`;
        })()}
      </div>
    </div>
    <div class="chip">${topicConfidence(t.id).total}</div>
  </div>
`;
    b.addEventListener("click", ()=>{
      setTab("study");
      $("topicSelect").value = t.id;
      $("modeSelect").value = "all";
      $("orderSelect").value = "ordered";
      loadNextCard();
    });
    box.appendChild(b);
  });
}

/* ==========================================================
   KPIs + ring + badge + streak (tasteful)
   ========================================================== */
// ---------------------------
// Header microcopy upgrades
// ---------------------------
const HOOK_SESSION_KEY = "RU_headerHookSessions";
const HOOK_INDEX_KEY   = "RU_headerHookIndex";

function bumpHeaderSessions(){
  const n = Number(localStorage.getItem(HOOK_SESSION_KEY) || "0") + 1;
  localStorage.setItem(HOOK_SESSION_KEY, String(n));
  // Rotate hook every 3 sessions (keeps it fresh, not noisy)
  if(n % 3 === 1){
    const i = Number(localStorage.getItem(HOOK_INDEX_KEY) || "0") + 1;
    localStorage.setItem(HOOK_INDEX_KEY, String(i));
  }
  return n;
}

function computeProgressScore(){
  const attempted = STATE.quiz?.attempted || 0;
  const correct = STATE.quiz?.correct || 0;
  if(attempted <= 0) return 0;
  return Math.round((correct / attempted) * 100);
}

function computeFocusCount(){
  let n = 0;
  for(const c of ALL_CARDS){
    if(!isTopicEnabled(c.topicId)) continue;
    const r = getReview(c.id);
    if(r && Number(r.score) <= 1) n++;
  }
  return n;
}

function computeStatusLine(){
  const completed = STATE.stats?.studied || 0;
  return `Exam revision in progress · ${completed} cards completed`;
}

function pickHook(){
  const hooks = [
    "Most students revise 3–4 topics before quizzes",
    "Strong answers link repression + reform",
    "25-mark questions reward factor thinking",
    "Use precise evidence, then explain the significance",
    "If it feels easy, switch to weakest topics next",
  ];

  // Behaviour-based nudges
  const attempted = STATE.quiz?.attempted || 0;
  const focus = computeFocusCount();
  if(attempted === 0) hooks.unshift("Quick win: do 10 MCQs after 3 flashcards");
  if(focus >= 20) hooks.unshift("Next step: strengthen weakest topics");

  const idx = Number(localStorage.getItem(HOOK_INDEX_KEY) || "0");
  return hooks[Math.abs(idx) % hooks.length];
}

function updateHeaderCopy(){
  const statusEl = document.getElementById("statusLine");
  const hookEl   = document.getElementById("hookLine");
  if(statusEl) statusEl.textContent = computeStatusLine();
  if(hookEl) hookEl.textContent = pickHook();
}


function updateBannerTitlePill(){}


function weeklySignalSubtext(name){
  const n = String(name||"").toLowerCase();
  if(n.includes("diamond")) return "Top-tier engagement";
  if(n.includes("gold"))    return "Strong consistency";
  if(n.includes("silver"))  return "Good momentum";
  if(n.includes("bronze"))  return "Back on track";
  return "Keep momentum rolling";
}

function renderWeeklySignal(badge){
  const pill = document.getElementById("weeklyBadgePill");
  if(!pill) return;
  const top = `${badge.icon} ${badge.name} week`;
  const sub = weeklySignalSubtext(badge.name);
  pill.innerHTML = `<div class="pillTop">${top}</div><div class="pillSub">${sub}</div>`;
  updateBannerTitlePill();

}

function renderStreakSignal(){
  const btn = document.getElementById("streakPill");
  if(!btn) return;

  const count = STATE.dailyStreak?.count || 0;
  const last = STATE.dailyStreak?.lastDate;
  const t = todayKey();
  const y = yesterdayKey();

  let top = "Start today";
  let sub = "Don’t break the chain";

  if(last === t){
    top = "Active today";
    sub = "Don’t break the chain";
  }else if(last === y){
    top = "Keep it alive";
    sub = "";
  }else if(count > 0){
    top = "Restart today";
    sub = "Rebuild the chain";
  }

  btn.innerHTML = `<div class="pillTopRow"><span>${top}</span> <span class="streakBubble">${count}</span></div>${sub ? `<div class="pillSub">${sub}</div>` : ""}`;
  updateBannerTitlePill();

}


function computeKpis(){
  const weekMetrics = computeThisWeekMetrics();

  const minutesWeekEl = $("kpiMinutesWeek");
  if(minutesWeekEl) minutesWeekEl.textContent = `${weekMetrics.minutesWeek}m`;

  const tasksWeekEl = $("kpiTasksWeek");
  if(tasksWeekEl) tasksWeekEl.textContent = String(weekMetrics.tasksWeek);

  const quizWeekEl = $("kpiQuizWeek");
  if(quizWeekEl) quizWeekEl.textContent = `${weekMetrics.quizAvgWeek}%`;

  const badge = getWeeklyBadge();
  // Banner microcopy (status + rotating teacher whisper)
  try{ updateHeaderCopy(); }catch(e){}

  // Weekly signal pill (meaning, not stats)
  try{ renderWeeklySignal(badge); }catch(e){}

  // progress note card removed from home; keep microcopy in weekly signal + streak panel

  // Daily streak (Duolingo-style)
  normalizeDailyStreak();
  try{ renderStreakHero(); }catch(e){}
  try{ renderStreakSignal(); }catch(e){}
  // Update topic confidence dashboard
  try{ renderTopicDashboard(); }catch(e){}
  try{ renderProgressReport(); }catch(e){}
}
computeKpis();
updateDailyUI();
initTopicArrowDialog();

/* Home quick buttons (legacy IDs kept for safety) */

const LAST_STUDY_CONTEXT_KEY = "russia_revision_last_study_context_v1";
const EVENT_LOG_KEY = "russia_revision_event_log_v1";
const ONBOARDED_KEY = "onboarded";
const USER_GOAL_KEY = "userGoal";
const SESSION_MAGIC_SHOWN_KEY = "russia_revision_magic_shown_session_v1";

const RECO_WEIGHTS = {
  // Tunable ranking constants for deterministic recommendation engine.
  QUIZ_WEAKNESS_MULTIPLIER: 1.2,
  FLASH_REMAINING_MULTIPLIER: 2,
  PLAN_NOT_STARTED: 25,
  PLAN_STALE: 10,
  DUE_FOR_REVIEW_BONUS: 30,
  STUDIED_WITHIN_30_MIN_PENALTY: -40,
  STUDIED_TODAY_PENALTY: -10,
  MOMENTUM_FLASH_BONUS: 15,
  MOMENTUM_QUIZ_BONUS: 10,
  MOMENTUM_PLAN_PENALTY: -10,
  SAME_ACTION_TYPE_PENALTY: -8,
  PLAN_FREQUENCY_PENALTY: -12
};

let LAST_RECO_DEBUG = { recommendation:null, candidates:[] };
let APP_SESSION = { source:"app_open", startTs:Date.now(), tasksCompleted:0, active:true, gameSessions:{} };

function loadEventLog(){
  try{
    const raw = localStorage.getItem(EVENT_LOG_KEY);
    const list = raw ? JSON.parse(raw) : [];
    return Array.isArray(list) ? list : [];
  }catch(e){ return []; }
}
function saveEventLog(items){
  localStorage.setItem(EVENT_LOG_KEY, JSON.stringify(items.slice(-500)));
}
function analyticsDayBucket(day=todayKey()){
  STATE.analytics ||= { daily:{} };
  STATE.analytics.daily ||= {};
  STATE.analytics.daily[day] ||= {
    recoShown:0,
    recoClicked:0,
    dailyTasksCompleted:0,
    sessionDurations:[],
    sessionTaskCounts:[],
    tasksPerSession:0,
    nextTapRate:0,
    streakSavedToday:false
  };
  return STATE.analytics.daily[day];
}
function refreshDailyAggregates(day=todayKey()){
  const b = analyticsDayBucket(day);
  const sessions = Math.max(1, b.sessionTaskCounts.length);
  const totalTasks = b.sessionTaskCounts.reduce((n,v)=>n+Number(v||0),0);
  b.tasksPerSession = Number((totalTasks / sessions).toFixed(2));
  b.nextTapRate = b.recoShown ? Number((b.recoClicked / b.recoShown).toFixed(3)) : 0;
  b.streakSavedToday = !!STATE.daily?.[day]?.completed;
  saveState();
}
function logEvent(name, payload={}, ts=Date.now()){
  const list = loadEventLog();
  list.push({ name, payload, ts });
  saveEventLog(list);

  const b = analyticsDayBucket(todayKey());
  if(name === "home_reco_shown") b.recoShown += 1;
  if(name === "home_reco_clicked") b.recoClicked += 1;
  if(name === "task_completed") b.dailyTasksCompleted += 1;
  if(name === "daily_challenge_completed") b.streakSavedToday = true;
  if(name === "session_end"){
    b.sessionDurations.push(Number(payload.durationMs||0));
    b.sessionTaskCounts.push(Number(payload.tasksCompleted||0));
    b.sessionDurations = b.sessionDurations.slice(-20);
    b.sessionTaskCounts = b.sessionTaskCounts.slice(-20);
  }
  refreshDailyAggregates(todayKey());
}
function markActiveNow(){
  STATE.userStats ||= { lastActionType:null, lastActiveAt:0, sessionsToday:0 };
  STATE.userStats.lastActiveAt = Date.now();
  saveState();
}
function startSession(source="app_open"){
  const day = todayKey();
  const us = STATE.userStats ||= { lastActionType:null, lastActiveAt:0, sessionsToday:0 };
  if(us.sessionsDay !== day){
    us.sessionsDay = day;
    us.sessionsToday = 0;
  }
  us.sessionsToday = Number(us.sessionsToday||0) + 1;
  us.lastActiveAt = Date.now();
  APP_SESSION = { source, startTs:Date.now(), tasksCompleted:0, active:true, gameSessions:{} };
  localStorage.removeItem(SESSION_MAGIC_SHOWN_KEY);
  logEvent("session_start", { source });
  saveState();
}
function endSession(){
  if(!APP_SESSION?.active) return;
  APP_SESSION.active = false;
  const durationMs = Math.max(0, Date.now() - Number(APP_SESSION.startTs||Date.now()));
  logEvent("session_end", { durationMs, tasksCompleted: APP_SESSION.tasksCompleted||0 });
}
function trackTaskStarted(taskType, topicId){
  markActiveNow();
  STATE.userStats.lastActionType = taskType;
  saveState();
  logEvent("task_started", { taskType, topicId });
}
function touchTopicStats(topicId){
  STATE.topicStats ||= {};
  STATE.topicStats[topicId] ||= {
    quizAttempts:0,
    quizBestPercent:0,
    flashcardsDone:0,
    flashcardsTotal:0,
    totalEarnedXp:0,
    planStarted:false,
    lastStudiedAt:0,
    planLastSavedAt:0,
    failedCards:0,
    previousRetention:0
  };
  return STATE.topicStats[topicId];
}
function getMagicMomentMetric(topicId){
  const streak = Number(STATE.dailyStreak?.count || 0);
  if(streak > 0) return `Streak: ${streak} day${streak===1?"":"s"}`;

  const topic = topicId ? touchTopicStats(topicId) : null;
  if(topic){
    const quiz = Number(topic.quizBestPercent || 0);
    const flashDone = Number(topic.flashcardsDone || 0);
    const flashTotal = Math.max(1, Number(topic.flashcardsTotal || 0));
    const flashPct = Math.round((flashDone / flashTotal) * 100);
    const mastery = Math.max(quiz, flashPct);
    if(mastery > 0) return `Topic mastery: ${mastery}%`;
  }

  const today = analyticsDayBucket(todayKey());
  return `Tasks today: ${Math.max(1, Number(today.dailyTasksCompleted || 0))}`;
}

function showMagicMomentSheet(){
  const sheet = $("magicMomentSheet");
  if(sheet) sheet.classList.add("hidden");
}

function maybeShowMagicMoment(taskType){
  return true;
}

function markGameSessionCompleted(gameType, topicId){
  if(!APP_SESSION?.gameSessions) APP_SESSION.gameSessions = {};
  if(APP_SESSION.gameSessions[gameType]) return;
  APP_SESSION.gameSessions[gameType] = 1;
  const safeTopic = topicId && isTopicEnabled(topicId) ? topicId : (getDailyTopicId() || "t1");
  trackTaskCompleted("GAME", safeTopic, { scoreDelta:1, gameType });
}

function trackTaskCompleted(taskType, topicId, extra={}){
  markActiveNow();
  const ts = Date.now();
  const s = touchTopicStats(topicId);
  s.lastStudiedAt = ts;
  if(taskType === "QUIZ"){
    s.quizAttempts = Number(s.quizAttempts||0) + 1;
    const prevBest = Number(s.quizBestPercent||0);
    const nextBest = Math.max(prevBest, Number(extra.percent||0));
    s.quizBestPercent = nextBest;
    if(nextBest > prevBest){
      const b = analyticsDayBucket(todayKey());
      b.topicsImproved ||= {};
      b.topicsImproved[topicId] = true;
    }
  }
  if(taskType === "FLASHCARDS"){
    s.flashcardsDone = Math.max(Number(s.flashcardsDone||0), Number(extra.flashcardsDone||s.flashcardsDone||0));
    s.flashcardsTotal = Math.max(Number(s.flashcardsTotal||0), Number(extra.flashcardsTotal||0));
    s.failedCards = Number(extra.failedCards ?? s.failedCards ?? 0);
  }
  if(taskType === "PLAN_25"){
    s.planStarted = true;
    s.planLastSavedAt = ts;
  }
  const defaultXpByTask = { FLASHCARDS:10, QUIZ:10, PLAN_25:20, GAME:5 };
  const gainedXp = Number.isFinite(Number(extra.scoreDelta))
    ? Math.max(0, Number(extra.scoreDelta))
    : Number(defaultXpByTask[taskType] || 0);
  s.totalEarnedXp = Math.max(0, Number(s.totalEarnedXp || 0)) + gainedXp;
  STATE.userStats.lastActionType = taskType;
  saveState();
  APP_SESSION.tasksCompleted = Number(APP_SESSION.tasksCompleted||0) + 1;
  logEvent("task_completed", { taskType, topicId, scoreDelta: extra.scoreDelta, gameType: extra.gameType });
  renderHomeRecommendation();
  maybeShowMagicMoment(taskType);
}
function topicFlashcardStats(topicId){
  const pool = ALL_CARDS.filter(c=>c.topicId===topicId && isTopicEnabled(c.topicId));
  let weak = 0;
  pool.forEach(c=>{ if((getReview(c.id)?.score ?? 2) <= 1) weak++; });
  const daily = ensureDaily();
  const doneToday = (daily.topicId === topicId) ? Number(daily.flash||0) : 0;
  return {
    total: pool.length,
    done: doneToday,
    remaining: Math.max(0, pool.length - doneToday),
    failedCards: weak
  };
}
function topicQuizStats(topicId){
  const s = touchTopicStats(topicId);
  if(topicId === ensureDaily().topicId){
    s.quizBestPercent = Math.max(Number(s.quizBestPercent||0), Number(ensureDaily().quizBest||0));
  }
  return {
    quizAttempts: Number(s.quizAttempts||0),
    quizBestPercent: Number(s.quizBestPercent||0)
  };
}
function topicPlanStats(topicId){
  const s = touchTopicStats(topicId);
  if(topicId === ensureDaily().topicId && ensureDaily().planOpened) s.planStarted = true;
  return { planStarted: !!s.planStarted, planLastSavedAt: Number(s.planLastSavedAt||0) };
}
function dueForReview(topicId, now=Date.now()){
  const s = touchTopicStats(topicId);
  const last = Number(s.lastStudiedAt||0);
  const quizBestPercent = Number(s.quizBestPercent||0);
  if(!last) return true;
  const daysSince = (now - last) / 86400000;
  return (daysSince >= 2 && quizBestPercent < 80) || (daysSince >= 5 && quizBestPercent >= 80);
}
function candidateRoute(taskType, topicId){
  if(taskType === "FLASHCARDS") return `study?topic=${encodeURIComponent(topicId)}&mode=all`;
  if(taskType === "QUIZ") return `quiz?topic=${encodeURIComponent(topicId)}&count=10`;
  return `exam?topic=${encodeURIComponent(topicId)}`;
}
function buildCandidate(taskType, topicId){
  const flash = topicFlashcardStats(topicId);
  const quiz = topicQuizStats(topicId);
  const plan = topicPlanStats(topicId);
  const topic = touchTopicStats(topicId);
  return {
    taskType,
    topicId,
    route: candidateRoute(taskType, topicId),
    flashcardsRemaining: flash.remaining,
    flashcardsTotal: flash.total,
    flashcardsDone: flash.done,
    failedCards: flash.failedCards,
    quizAttempts: quiz.quizAttempts,
    quizBestPercent: quiz.quizBestPercent,
    planStarted: plan.planStarted,
    planLastSavedAt: plan.planLastSavedAt,
    lastStudiedAt: Number(topic.lastStudiedAt||0)
  };
}
function generateCandidates(now=Date.now()){
  const d = ensureDaily();
  const enabled = enabledTopicIds();
  const step = nextDailyAction(d);
  if(step){
    const map = { flash:"FLASHCARDS", quiz:"QUIZ", plan:"PLAN_25" };
    return [buildCandidate(map[step], d.topicId)];
  }

  const out = [];
  enabled.forEach(topicId=>{
    const quiz = topicQuizStats(topicId);
    const flash = topicFlashcardStats(topicId);
    const plan = topicPlanStats(topicId);

    if(quiz.quizAttempts === 0 || quiz.quizBestPercent < 80){
      out.push(buildCandidate("QUIZ", topicId));
    }
    if(flash.remaining > 0 || dueForReview(topicId, now)){
      out.push(buildCandidate("FLASHCARDS", topicId));
    }
    if(!plan.planStarted){
      out.push(buildCandidate("PLAN_25", topicId));
    }
  });
  return out;
}
function getWeakestTopicId(){
  const enabled = enabledTopicIds();
  let weakest = null;
  let weakestScore = Infinity;
  enabled.forEach(topicId=>{
    const c = buildCandidate("QUIZ", topicId);
    const score = Number(c.quizBestPercent||0) + Number(c.failedCards||0);
    if(score < weakestScore){ weakestScore = score; weakest = topicId; }
  });
  return weakest;
}
function scoreCandidate(candidate, now=Date.now(), weakestTopicId=getWeakestTopicId()){
  let score = 0;
  const why = [];

  if(candidate.taskType === "QUIZ") score += (100 - candidate.quizBestPercent) * RECO_WEIGHTS.QUIZ_WEAKNESS_MULTIPLIER;
  if(candidate.taskType === "FLASHCARDS") score += (candidate.flashcardsRemaining + candidate.failedCards) * RECO_WEIGHTS.FLASH_REMAINING_MULTIPLIER;
  if(candidate.taskType === "PLAN_25"){
    const stale = candidate.planStarted && ((now - Number(candidate.planLastSavedAt||0)) >= 7*86400000);
    score += !candidate.planStarted ? RECO_WEIGHTS.PLAN_NOT_STARTED : (stale ? RECO_WEIGHTS.PLAN_STALE : 0);
  }

  if(dueForReview(candidate.topicId, now)){ score += RECO_WEIGHTS.DUE_FOR_REVIEW_BONUS; why.push("due"); }

  const last = Number(candidate.lastStudiedAt||0);
  if(last && (now - last) <= 30*60*1000) score += RECO_WEIGHTS.STUDIED_WITHIN_30_MIN_PENALTY;
  if(last && isSameDay(new Date(last), new Date(now)) && candidate.topicId !== weakestTopicId){
    score += RECO_WEIGHTS.STUDIED_TODAY_PENALTY;
  }

  const lastActiveAt = Number(STATE.userStats?.lastActiveAt||0);
  const likelyDrop = Number(STATE.userStats?.sessionsToday||0) === 0 || (lastActiveAt && (now - lastActiveAt) > 24*60*60*1000);
  if(likelyDrop){
    if(candidate.taskType === "FLASHCARDS") score += RECO_WEIGHTS.MOMENTUM_FLASH_BONUS;
    if(candidate.taskType === "QUIZ") score += RECO_WEIGHTS.MOMENTUM_QUIZ_BONUS;
    if(candidate.taskType === "PLAN_25") score += RECO_WEIGHTS.MOMENTUM_PLAN_PENALTY;
  }

  if(STATE.userStats?.lastActionType === candidate.taskType){
    score += RECO_WEIGHTS.SAME_ACTION_TYPE_PENALTY;
  }
  if(candidate.taskType === "PLAN_25") score += RECO_WEIGHTS.PLAN_FREQUENCY_PENALTY;

  return { score, why };
}
function recommendationCopy(taskType, isChallenge){
  if(isChallenge){
    if(taskType === "FLASHCARDS") return { label:"Keep streak going: Flashcards", reason:"Finish today’s run to lock your streak." };
    if(taskType === "QUIZ") return { label:"Keep streak going: Topic Quiz", reason:"Finish today’s run to lock your streak." };
    return { label:"Keep streak going: 25-mark plan", reason:"Finish today’s run to lock your streak." };
  }
  if(taskType === "QUIZ") return { label:"Boost score: Topic Quiz", reason:"This topic is your lowest score right now." };
  if(taskType === "FLASHCARDS") return { label:"Continue:", reason:"This topic is due for a quick review." };
  return { label:"Exam skill: 25-mark plan", reason:"A short plan now keeps exam structure fresh." };
}
function getNextBestAction(now=Date.now()){
  const daily = ensureDaily();
  const candidates = generateCandidates(now);
  const step = nextDailyAction(daily);
  const isChallenge = !!step;

  let best = null;
  if(isChallenge){
    best = candidates[0] || null;
    if(best){
      const c = recommendationCopy(best.taskType, true);
      best = { ...best, label:c.label, reason:c.reason, score:9999, route: best.route };
    }
  }else{
    const weakestTopicId = getWeakestTopicId();
    const scored = candidates.map(c=>{
      const r = scoreCandidate(c, now, weakestTopicId);
      return { ...c, score:r.score, why:r.why };
    }).sort((a,b)=>b.score - a.score);

    const winner = scored[0] || null;
    if(winner){
      const c = recommendationCopy(winner.taskType, false);
      best = { ...winner, label:c.label, reason:c.reason };
    }
    LAST_RECO_DEBUG = { recommendation:best, candidates:scored.slice(0,5) };
  }

  if(!best) return { taskType:"FLASHCARDS", topicId:getDailyTopicId(), label:"Continue:", reason:"This topic is due for a quick review.", route:candidateRoute("FLASHCARDS", getDailyTopicId()) };
  LAST_RECO_DEBUG.recommendation = best;
  return best;
}

function compactTopicTitle(title){
  return String(title||"")
    .replace(/^\s*\d+\.\s*/, "")
    .replace(/\s+\d{4}[\-–]\d{4}\s*$/, "")
    .trim();
}
function navigateToRoute(route){
  const [tab, query] = String(route||"").split("?");
  const params = new URLSearchParams(query||"");
  const topicId = params.get("topic") || getDailyTopicId();
  if(tab === "study"){
    setTab("study");
    $("topicSelect").value = isTopicEnabled(topicId) ? topicId : "ALL";
    $("modeSelect").value = params.get("mode") || "all";
    $("orderSelect").value = "random";
    loadNextCard();
  }else if(tab === "quiz"){
    setTab("quiz");
    $("mcqTopicSelect").value = isTopicEnabled(topicId) ? topicId : "MIXED";
    $("mcqCount").value = params.get("count") || "10";
    startQuiz();
  }else if(tab === "exam"){
    setTab("exam");
    const filter = $("examTopicSelect");
    if(filter){ filter.value = topicId; filter.dispatchEvent(new Event("change")); }
    const exId = getDailyExamId(topicId);
    if(exId){ $("examSelect").value = exId; renderExamQuestion(); }
  }
}
function renderHomeRecommendation(){
  const reco = getNextBestAction(Date.now());
  logEvent("home_reco_shown", { taskType: reco.taskType, topicId: reco.topicId });
  renderDebugPanel();
}
function showNextUpSheet(){
  const sheet = $("nextUpSheet");
  if(sheet) sheet.classList.add("hidden");
}
function initOnboarding(){
  const overlay = $("onboardingOverlay");
  const step1 = $("onboardingStep1");
  const step2 = $("onboardingStep2");
  const nextBtn = $("onboardingNextBtn");
  const doneBtn = $("onboardingDoneBtn");
  if(!overlay || !step1 || !step2 || !nextBtn || !doneBtn) return;

  let selectedGoal = localStorage.getItem(USER_GOAL_KEY) || "";
  const syncGoals = ()=>{
    overlay.querySelectorAll(".goalBtn").forEach(btn=>{
      btn.classList.toggle("active", btn.dataset.goal === selectedGoal);
    });
  };

  nextBtn.onclick = ()=>{
    step1.classList.add("hidden");
    step2.classList.remove("hidden");
  };

  overlay.querySelectorAll(".goalBtn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      selectedGoal = btn.dataset.goal || "pass";
      syncGoals();
    });
  });

  doneBtn.onclick = ()=>{
    const goal = selectedGoal || "pass";
    localStorage.setItem(USER_GOAL_KEY, goal);
    localStorage.setItem(ONBOARDED_KEY, "1");
    overlay.classList.add("hidden");
  };

  syncGoals();
  if(localStorage.getItem(ONBOARDED_KEY) !== "1"){
    overlay.classList.remove("hidden");
  }
}

function renderDebugPanel(){
  const panel = $("debugPanel");
  if(!panel || panel.classList.contains("hidden")) return;
  const today = analyticsDayBucket(todayKey());
  $("debugReco").textContent = `Current: ${LAST_RECO_DEBUG.recommendation?.label || "—"}`;
  $("debugCandidates").textContent = (LAST_RECO_DEBUG.candidates||[]).map((c,i)=>`${i+1}. ${c.taskType} ${c.topicId} → ${c.score.toFixed(1)}`).join("\n") || "No candidates";
  $("debugMetrics").textContent = `tasks_per_session: ${today.tasksPerSession} • next_tap_rate: ${today.nextTapRate} • daily_tasks_completed: ${today.dailyTasksCompleted} • streak_saved_today: ${today.streakSavedToday}`;
}
function attachHomeDebugLongPress(){
  const title = document.querySelector(".banner-title-pill");
  if(!title) return;
  let timer = null;
  const start = ()=>{ timer = setTimeout(()=>{ $("debugPanel").classList.toggle("hidden"); renderDebugPanel(); }, 700); };
  const clear = ()=>{ if(timer){ clearTimeout(timer); timer = null; } };
  ["mousedown","touchstart","pointerdown"].forEach(evt=>title.addEventListener(evt, start));
  ["mouseup","mouseleave","touchend","touchcancel","pointerup"].forEach(evt=>title.addEventListener(evt, clear));
}

function rememberStudyContext(){
  try{
    const mode = $("modeSelect")?.value;
    const topicId = $("topicSelect")?.value;
    if(!mode || !topicId) return;
    localStorage.setItem(LAST_STUDY_CONTEXT_KEY, JSON.stringify({ mode, topicId }));
  }catch(e){}
}

function getLastStudyContext(){
  try{
    const raw = localStorage.getItem(LAST_STUDY_CONTEXT_KEY);
    if(!raw) return null;
    const parsed = JSON.parse(raw);
    if(!parsed || !["focus","all"].includes(parsed.mode)) return null;
    return parsed;
  }catch(e){ return null; }
}

function openStudyForTopic(topicId, mode="all"){
  const safeTopic = isTopicEnabled(topicId) ? topicId : getDailyTopicId();
  setTab("study");
  $("topicSelect").value = safeTopic;
  $("modeSelect").value = ["focus","all"].includes(mode) ? mode : "all";
  $("orderSelect").value = "random";
  loadNextCard();
  rememberStudyContext();
}

function nextDailyAction(d){
  if((d.flash||0) < DAILY_FLASH_GOAL) return "flash";
  if((d.quizBest||0) < DAILY_QUIZ_GOAL) return "quiz";
  if(!d.planOpened) return "plan";
  return null;
}

function challengeStepName(step){
  if(step === "flash") return "Flashcards";
  if(step === "quiz") return "Topic Quiz";
  if(step === "plan") return "25-mark plan";
  return "";
}

function getChallengeCtaConfig(d){
  const step = nextDailyAction(d);
  if(step){
    return {
      label: `Keep streak going: ${challengeStepName(step)}`,
      disabled: false,
      onClick: step === "flash"
        ? goDailyFocus
        : (step === "quiz" ? goDailyQuiz : goDailyExam)
    };
  }

  const reco = getNextBestAction(Date.now());
  const topic = TOPICS.find(t=>t.id===reco.topicId);
  const compactTitle = compactTopicTitle(topic?.title || "");
  const label = topic
    ? (String(reco.label).trim().endsWith(":") ? `${reco.label} ${compactTitle || topic.title}` : `${reco.label} • ${compactTitle || topic.title}`)
    : reco.label;

  return {
    label,
    disabled: false,
    onClick: ()=>{
      logEvent("home_reco_clicked", { taskType: reco.taskType, topicId: reco.topicId });
      trackTaskStarted(reco.taskType, reco.topicId);
      navigateToRoute(reco.route);
    }
  };
}

function goDailyFocus(){
  const d = ensureDaily();
  d.lastStep = "flash";
  saveState();
  trackTaskStarted("FLASHCARDS", d.topicId);
  openStudyForTopic(d.topicId, "all");
  startDailyFlashSession(d.topicId);
}
function goDailyQuiz(){
  const d = ensureDaily();
  d.lastStep = "quiz";
  saveState();
  trackTaskStarted("QUIZ", d.topicId);
  NEXT_QUIZ_FROM_DAILY_CHALLENGE = true;
  setTab("quiz");
  $("mcqTopicSelect").value = d.topicId;
  $("mcqCount").value = "10";
  startQuiz();
}
function goDailyExam(){
  const d = ensureDaily();
  d.lastStep = "plan";
  saveState();
  trackTaskStarted("PLAN_25", d.topicId);
  setTab("exam");
  const exFilter = $("examTopicSelect");
  if(exFilter){ exFilter.value = d.topicId; exFilter.dispatchEvent(new Event("change")); }
  const exId = getDailyExamId(d.topicId);
  if(exId){ $("examSelect").value = exId; renderExamQuestion(); }
}

{ const _b = document.getElementById('btnGoFocus'); if(_b) _b.addEventListener('click', goDailyFocus); }
{ const _b = document.getElementById('btnGoMixed'); if(_b) _b.addEventListener('click', goDailyQuiz); }
{ const _b = document.getElementById('btnGoExam'); if(_b) _b.addEventListener('click', goDailyExam); }

// Daily Challenge navigable checklist rows (these replace the removed top action buttons)
$("goDailyFlash").addEventListener("click", goDailyFocus);
$("goDailyQuiz").addEventListener("click", goDailyQuiz);
$("goDailyPlan").addEventListener("click", goDailyExam);

/* ==========================================================
   FLASHCARDS
   ========================================================== */
let CURRENT = { list:[], idx:0, card:null };

function pickDailyFlashcards(topicId, count=DAILY_FLASH_GOAL){
  const pool = ALL_CARDS.filter(c=>c.topicId===topicId && isTopicEnabled(c.topicId));
  return shuffle(pool).slice(0, Math.min(count, pool.length));
}

function startDailyFlashSession(topicId){
  CURRENT.dailySession = {
    active: true,
    topicId,
    cardIds: new Set(),
    complete: false
  };
  CURRENT.list = pickDailyFlashcards(topicId, DAILY_FLASH_GOAL);
  CURRENT.dailySession.cardIds = new Set(CURRENT.list.map(c=>c.id));
  CURRENT.idx = 0;
  CURRENT.card = CURRENT.list[0] || null;
  if(!CURRENT.card){
    CURRENT.dailySession.active = false;
    loadNextCard();
    return;
  }
  renderCard();
}

function checkDailyFlashSessionComplete(cardId){
  const session = CURRENT.dailySession;
  if(!session?.active || session.complete || !cardId) return;

  const d = ensureDaily();
  if(d.flashCelebrated) return;

  const revealed = new Set(Array.isArray(d.revealedCards) ? d.revealedCards : []);
  let done = 0;
  session.cardIds.forEach(id=>{ if(revealed.has(id)) done++; });

  const reachedGoal = (d.flash||0) >= DAILY_FLASH_GOAL;
  if(reachedGoal && done >= session.cardIds.size && session.cardIds.size > 0){
    session.complete = true;
    d.flashCelebrated = true;
    saveState();
    trackTaskCompleted("FLASHCARDS", session.topicId, {
      flashcardsDone: d.flash||0,
      flashcardsTotal: session.cardIds.size,
      failedCards: topicFlashcardStats(session.topicId).failedCards
    });
    try{ confetti.fall(2600); }catch(e){}
  }
}

const BUTTON_ICON_LABELS = {
  reveal: `<span class="btnIconLabel"><svg class="navIcon" viewBox="0 0 24 24" aria-hidden="true"><path d="M2 12s4-6 10-6 10 6 10 6-4 6-10 6-10-6-10-6z"></path><circle cx="12" cy="12" r="2.8"></circle></svg><span>Reveal answer</span></span>`,
  hide: `<span class="btnIconLabel"><svg class="navIcon" viewBox="0 0 24 24" aria-hidden="true"><path d="M3 3l18 18"></path><path d="M10.6 10.6a2 2 0 0 0 2.8 2.8"></path><path d="M9.9 5.2A10.8 10.8 0 0 1 12 5c6 0 10 7 10 7a19.7 19.7 0 0 1-4.1 4.8"></path><path d="M6.1 6.1A19.7 19.7 0 0 0 2 12s4 7 10 7c1.6 0 3-.4 4.3-1.1"></path></svg><span>Hide answer</span></span>`,
  startFlashcards: `<span class="btnIconLabel"><svg class="navIcon" viewBox="0 0 24 24" aria-hidden="true"><path d="m8 5 11 7-11 7z"></path></svg><span>Start flashcards</span></span>`,
  continueFlashcards: `<span class="btnIconLabel"><svg class="navIcon" viewBox="0 0 24 24" aria-hidden="true"><path d="m8 5 11 7-11 7z"></path></svg><span>Continue flashcards</span></span>`
};

let revealCooldownToken = 0;
function startRevealCooldown(ms=3000){
  const revealBtn = document.getElementById("btnRevealBand") || document.getElementById("btnReveal");
  const aBox = document.getElementById("aBox");
  if(!revealBtn) return;

  const token = ++revealCooldownToken;
  const end = Date.now() + ms;

  revealBtn.disabled = true;
  revealBtn.classList.add("isLocked");

  const tick = ()=>{
    if(token !== revealCooldownToken) return;
    const remaining = end - Date.now();
    if(remaining <= 0){
      revealBtn.disabled = false;
      revealBtn.classList.remove("isLocked");
      const isHidden = aBox ? aBox.classList.contains("hidden") : true;
      revealBtn.innerHTML = isHidden ? BUTTON_ICON_LABELS.reveal : BUTTON_ICON_LABELS.hide;
      return;
    }
    const secs = Math.ceil(remaining/1000);
    revealBtn.textContent = `Reveal in ${secs}s`;
    setTimeout(tick, 200);
  };
  tick();
}


function getTopicIndex(topicId){
  const idx = TOPICS.findIndex(t=>t.id===topicId);
  return idx < 0 ? 999 : idx;
}
function studyTopicLabel(topicId){
  if(topicId === "ALL") return "Mixed topics";
  return TOPICS.find(t=>t.id===topicId)?.title || "Mixed topics";
}
function updateStudyLaunchCta(){
  const topicSel = document.getElementById("topicSelect");
  const modeSel = document.getElementById("modeSelect");
  const orderSel = document.getElementById("orderSelect");
  const searchEl = document.getElementById("searchInput");
  const titleEl = document.getElementById("studyLaunchTitle");
  const hintEl = document.getElementById("studyLaunchHint");
  const statusEl = document.getElementById("studyLaunchStatus");
  const launchBtn = document.getElementById("studyLaunchBtn");

  if(!topicSel || !modeSel || !orderSel || !searchEl || !titleEl || !hintEl || !statusEl || !launchBtn) return;

  const hasCurrent = !!CURRENT.card;
  const topicLabel = studyTopicLabel(topicSel.value);
  const modeLabel = modeSel.value === "focus" ? "Focus" : "All cards";
  const searchActive = searchEl.value.trim().length > 0;

  titleEl.textContent = `Recommended: ${topicLabel}`;
  hintEl.textContent = searchActive
    ? `Search filter active. ${modeLabel} • ${orderSel.value === "random" ? "Random" : "In order"}.`
    : `Ready in ${modeLabel.toLowerCase()} mode • ${orderSel.value === "random" ? "Random" : "In order"}.`;
  statusEl.textContent = hasCurrent ? `Card ${CURRENT.idx+1}/${CURRENT.list.length || 0}` : "Ready";
  launchBtn.innerHTML = hasCurrent ? BUTTON_ICON_LABELS.continueFlashcards : BUTTON_ICON_LABELS.startFlashcards;
}
function getFilteredCards(){
  const topic = $("topicSelect").value;
  const mode = $("modeSelect").value;     // focus | all
  if(!["focus","all"].includes(mode)) $("modeSelect").value = "all";
  const order = $("orderSelect").value;   // ordered | random
  const q = $("searchInput").value.trim().toLowerCase();

  let list = ALL_CARDS.slice();

  // Exclude toggled-off topics
  list = list.filter(c=>isTopicEnabled(c.topicId));
  if(topic !== "ALL") list = list.filter(c=>c.topicId===topic);

  if(mode === "focus"){
    // Focus mode shows ONLY cards the student has flagged as needing focus (😐 or ☹️).
    // New users start with 0 focus cards; unseen cards are excluded.
    list = list.filter(c=>{
      const r = getReview(c.id);
      return !!r && Number(r.score) <= 1;
    });
  }

  if(q){
    list = list.filter(c => (c.q + " " + c.a + " " + (c.tags||[]).join(" ")).toLowerCase().includes(q));
  }

  if(order === "random"){
    list.sort(()=>Math.random()-0.5);
  }else{
    list.sort((a,b)=>{
      const ta = getTopicIndex(a.topicId);
      const tb = getTopicIndex(b.topicId);
      if(ta !== tb) return ta - tb;

      const ra = getReview(a.id);
      const rb = getReview(b.id);

      const aUnseen = !ra;
      const bUnseen = !rb;
      if(aUnseen !== bUnseen) return aUnseen ? -1 : 1;

      const da = ra?.dueTs ?? Number.MAX_SAFE_INTEGER;
      const db = rb?.dueTs ?? Number.MAX_SAFE_INTEGER;
      if(da !== db) return da - db;

      return a.id.localeCompare(b.id);
    });
  }
  return list;
}
function loadNextCard(){
  if(CURRENT.dailySession?.active){
    CURRENT.dailySession.active = false;
  }
  CURRENT.list = getFilteredCards();
  CURRENT.idx = 0;
  CURRENT.card = CURRENT.list[0] || null;

  if(!CURRENT.card){
    $("qText").textContent = "No cards match these filters. Try switching topic or clearing search.";
    $("aBox").classList.add("hidden");
    const rb = document.getElementById("btnRevealBand") || document.getElementById("btnReveal");
    if(rb) rb.innerHTML = BUTTON_ICON_LABELS.reveal;
    $("cardMeta").textContent = "🃏 Card 0/0";
    updateStudyLaunchCta();
    return;
  }
  renderCard();
  updateStudyLaunchCta();
}
function renderCard(){
  const c = CURRENT.card;
  $("qText").textContent = c.q;
  $("aText").textContent = c.a;
  $("aBox").classList.add("hidden");

  // Reset reveal button label whenever a new card is rendered
  const rb = document.getElementById("btnRevealBand") || document.getElementById("btnReveal");
  if(rb) rb.innerHTML = BUTTON_ICON_LABELS.reveal;


  // Disable reveal briefly to encourage retrieval effort
  startRevealCooldown(3000);

  const mode = $("modeSelect").value;
  const badge = CURRENT.dailySession?.active
    ? "🎯 DAILY 12"
    : (mode === "focus" ? "🎯 FOCUS" : "📚 STUDY");
  $("cardMeta").textContent = `🃏 ${CURRENT.idx+1}/${CURRENT.list.length} • ${badge}`;
  updateStudyLaunchCta();
}
function nextCard(){
  if(!CURRENT.list.length){ loadNextCard(); return; }
  CURRENT.idx = (CURRENT.idx + 1) % CURRENT.list.length;
  CURRENT.card = CURRENT.list[CURRENT.idx];
  renderCard();
}

$("topicSelect").addEventListener("change", ()=>{ rememberStudyContext(); loadNextCard(); updateStudyLaunchCta(); });
$("modeSelect").addEventListener("change", ()=>{ rememberStudyContext(); loadNextCard(); updateStudyLaunchCta(); });
$("orderSelect").addEventListener("change", ()=>{ rememberStudyContext(); loadNextCard(); updateStudyLaunchCta(); });
$("searchInput").addEventListener("input", debounce(()=>{ loadNextCard(); updateStudyLaunchCta(); }, 250));

const studyLaunchBtn = document.getElementById("studyLaunchBtn");
if(studyLaunchBtn){
  studyLaunchBtn.addEventListener("click", ()=>{
    if(!CURRENT.card) loadNextCard();
    const frame = document.getElementById("flashcardFrame");
    if(frame) frame.scrollIntoView({ behavior:"smooth", block:"center" });
    updateStudyLaunchCta();
  });
}

(function(){
  const revealBtn = document.getElementById("btnRevealBand") || document.getElementById("btnReveal");
  const aBox = document.getElementById("aBox");
  if(revealBtn && aBox){
    const syncLabel = ()=>{
      const isHidden = aBox.classList.contains("hidden");
      revealBtn.innerHTML = isHidden ? BUTTON_ICON_LABELS.reveal : BUTTON_ICON_LABELS.hide;
    };
    revealBtn.addEventListener("click", ()=>{
      // If no card is loaded yet, load one first.
      if(!CURRENT.card){ loadNextCard(); }
      if(!CURRENT.card) return;

      const wasHidden = aBox.classList.contains("hidden"); // hidden -> reveal counts
      aBox.classList.toggle("hidden");

      // Daily Challenge: ONLY count a flashcard when the student REVEALS the answer
      if(wasHidden && !aBox.classList.contains("hidden")){
        recordDailyFlashcard(CURRENT.card.topicId, CURRENT.card.id);
        checkDailyFlashSessionComplete(CURRENT.card.id);
      }
      syncLabel();
    });
    // Ensure correct label on load
    syncLabel();
  }
  // Skip button removed from UI (no binding needed).
})();
document.querySelectorAll('#study [data-score]').forEach(btn=>{
  btn.addEventListener("click", ()=>{
    if(!CURRENT.card) return;

    const score = Number(btn.dataset.score);
    const id = CURRENT.card.id;
    const todayTs = startOfTodayTs();
    const prev = getReview(id);

    const prevInterval = prev ? prev.intervalDays : null;
    const intervalDays = nextIntervalDays(score, prevInterval);
    const dueTs = addDaysTs(todayTs, intervalDays);

    setReview(id, {
      lastTs: todayTs,
      dueTs,
      intervalDays,
      score,
      // Preserve the most recent successful recall timestamp for traffic-lights/confidence
      lastSuccessTs: (score >= 2) ? todayTs : (prev?.lastSuccessTs || 0),
      successfulRecalls: (prev?.successfulRecalls || 0) + (score >= 2 ? 1 : 0),
      times: (prev?.times||0)+1
    });

    STATE.stats.studied = (STATE.stats.studied||0)+1;
    saveState();
    computeKpis();
    nextCard();
  });
});

/* ==========================================================
   QUIZ BANK (auto-generated, unchanged logic)
   ========================================================== */
function allTerms(){
  return Object.keys(FACT_BANK).flatMap(tid => (FACT_BANK[tid].terms||[]).map(x=>({...x, topicId:tid})));
}
function allPeople(){
  return Object.keys(FACT_BANK).flatMap(tid => (FACT_BANK[tid].people||[]).map(x=>({...x, topicId:tid})));
}
function allEvents(){
  return Object.keys(FACT_BANK).flatMap(tid => (FACT_BANK[tid].events||[]).map(x=>({...x, topicId:tid})));
}
function buildMcqBank(){
  const bank = [];
  const TERMS = allTerms();
  const PEOPLE = allPeople();
  const EVENTS = allEvents();

  const termDates = TERMS.filter(t=>t.date && String(t.date).trim()!=="").map(t=>String(t.date));
  const termMeans = TERMS.map(t=>String(t.meaning));
  const termSigs  = TERMS.map(t=>String(t.significance));
  const peopleRoles = PEOPLE.map(p=>String(p.role));
  const peopleSigs  = PEOPLE.map(p=>String(p.significance));
  const eventDates = EVENTS.filter(e=>e.date && String(e.date).trim()!=="").map(e=>String(e.date));
  const eventWhats  = EVENTS.map(e=>String(e.what));
  const eventWhy    = EVENTS.map(e=>String(e.whyMatters));

  function push(topicId,q,choices,answer,explain){
    bank.push({ topicId, q, choices, answer, explain });
  }

  TERMS.forEach(t=>{
    if (t.date && String(t.date).trim() !== "") {
  const wrongDates = shuffle(
    termDates.filter(d => d !== String(t.date))
  ).slice(0, 3);

  push(
    t.topicId,
    `When was: ${t.term}?`,
    shuffle([String(t.date), ...wrongDates]),
    String(t.date),
    `Correct: ${t.date}. Why it matters: ${t.significance}`
  );
}

    const wrongDefs = shuffle(termMeans.filter(m=>m!==String(t.meaning))).slice(0,3);
    push(t.topicId, `Which definition best matches: ${t.term}?`, shuffle([String(t.meaning), ...wrongDefs]), String(t.meaning),
      `Correct: ${t.meaning}`);

    const sigText = (t.significance ?? "").toString().trim();
    if(sigText){
      const wrongSigs = shuffle(termSigs.filter(s=>s!==sigText)).slice(0,3);
      push(t.topicId, `Which significance best fits: ${t.term}?`, shuffle([sigText, ...wrongSigs]), sigText,
        `Correct: ${sigText}`);

      const sigPrompt = sigText;
      const distractorTerms = shuffle(TERMS.filter(x=>x.term!==t.term).map(x=>x.term)).slice(0,3);
      push(t.topicId, `Which term matches this? “${sigPrompt}”`, shuffle([t.term, ...distractorTerms]), t.term,
        `Correct: ${t.term}${(t.date && String(t.date).trim()!=="") ? ` (${t.date})` : ""}.`);
    }
  });

  PEOPLE.forEach(p=>{
    const wrongRoles = shuffle(peopleRoles.filter(r=>r!==String(p.role))).slice(0,3);
    push(p.topicId, `Which role best matches: ${p.name}?`, shuffle([String(p.role), ...wrongRoles]), String(p.role),
      `Correct: ${p.role}.`);

    const psigText = (p.significance ?? "").toString().trim();
    if(psigText){
      const wrongSig = shuffle(peopleSigs.filter(s=>s!==psigText)).slice(0,3);
      push(p.topicId, `Which significance best fits: ${p.name}?`, shuffle([psigText, ...wrongSig]), psigText,
        `Correct: ${psigText}`);

      const desc = psigText;
      const distractors = shuffle(PEOPLE.filter(x=>x.name!==p.name).map(x=>x.name)).slice(0,3);
      push(p.topicId, `Who is described? “${desc}”`, shuffle([p.name, ...distractors]), p.name,
        `Correct: ${p.name} (${p.role}).`);
    }
  });

EVENTS.forEach(e=>{
 if (e.date && String(e.date).trim() !== "") {
  const wrongDates = shuffle(
    eventDates.filter(d => d !== String(e.date))
  ).slice(0, 3);

  push(
    e.topicId,
    `Date check: ${e.name} — when?`,
    shuffle([String(e.date), ...wrongDates]),
    String(e.date),
    `Correct: ${e.date}. Why it matters: ${e.whyMatters}`
  );
}

    const wrongWhat = shuffle(eventWhats.filter(w=>w!==String(e.what))).slice(0,3);
    push(e.topicId, `What happened in: ${e.name}?`, shuffle([String(e.what), ...wrongWhat]), String(e.what),
      `Correct: ${e.what}`);

    const whyPrompt = String(e.whyMatters);
    const distractorEvents = shuffle(EVENTS.filter(x=>x.name!==e.name).map(x=>x.name)).slice(0,3);
    push(
      e.topicId,
      `Which event matches this impact? “${whyPrompt}”`,
      shuffle([e.name, ...distractorEvents]),
      e.name,
      `Correct: ${e.name}${(e.date && String(e.date).trim()!=="") ? ` (${e.date})` : ""}.`
    );
  });

  return bank;
}
const MCQ_BANK = [...MCQ_BANK_MANUAL];

function getQuizPool(topicId){
  const enabled = (x)=>isTopicEnabled(x.topicId);
  if(topicId === "MIXED") return MCQ_BANK.filter(enabled);
  // If a topic is toggled off, it should yield an empty quiz pool
  if(!isTopicEnabled(topicId)) return [];
  return MCQ_BANK.filter(x=>x.topicId===topicId).filter(enabled);
}

/* QUIZ state + streaks */
let QUIZ = { list:[], idx:0, score:0, locked:false, streak:0, best:0, errorBank:[], mode:"standard", topicId:"MIXED", fromDailyChallenge:false };

function inferChoiceType(answer){
  const a = String(answer||"").trim();
  if(/^\d{4}$/.test(a)) return "year";
  if(/^[A-Z][a-z]+(?:\s[A-Z][a-z]+){0,2}$/.test(a)) return "person";
  if(a.split(" ").length >= 4) return "statement";
  return "term";
}

function buildExamisedQuestion(q){
  const type = inferChoiceType(q.answer);
  const pool = MCQ_BANK
    .map(x=>x.answer)
    .filter(a=>a !== q.answer && inferChoiceType(a) === type);
  const harderDistractors = shuffle(unique(pool)).slice(0, 3);
  const fallback = q.choices.filter(c=>c !== q.answer);
  const distractors = harderDistractors.length === 3 ? harderDistractors : shuffle(unique([...harderDistractors, ...fallback])).slice(0,3);
  return {
    ...q,
    q: q.q.endsWith("?") ? q.q : `${q.q}?`,
    choices: shuffle([q.answer, ...distractors])
  };
}

function updateQuizMasteryUi(){
  const runPercent = QUIZ.list.length ? Math.round((QUIZ.score / QUIZ.list.length) * 100) : 0;
  $("quizMasteryLabel").textContent = `Progress: ${runPercent}%`;
  $("quizMasteryFill").style.width = `${Math.min(100, runPercent)}%`;
}

function renderQuizReview(){
  const box = $("quizReviewBox");
  const list = $("quizReviewList");
  if(!box || !list) return;

  if(!QUIZ.errorBank.length){
    list.innerHTML = `<div class="note">No misses to review yet.</div>`;
  }else{
    list.innerHTML = QUIZ.errorBank.map(item=>`
      <div class="reviewItem">
        <div class="reviewQ">${escapeHtml(item.q)}</div>
        <div class="reviewMeta">Your answer: ${escapeHtml(item.picked)} · Correct: ${escapeHtml(item.answer)}</div>
        <div class="note" style="margin-top:6px">${escapeHtml(item.explain)}</div>
      </div>
    `).join("");
  }
  box.classList.remove("hidden");
}

function closeQuizResultModal(){
  $("quizResultOverlay")?.classList.add("hidden");
}

function closeQuizCompleteModal(){
  $("quizCompleteOverlay")?.classList.add("hidden");
}

function closeDailyChallengeCompleteModal(){
  $("dailyChallengeCompleteOverlay")?.classList.add("hidden");
}

function showDailyChallengeCompleteModal(topicId){
  const overlay = $("dailyChallengeCompleteOverlay");
  if(!overlay) return;

  const focusCount = computeFocusCount();
  const focusBtn = $("btnDailyCompleteFocus");
  const explain = $("dailyCompleteExplain");
  const topicTitle = TOPICS.find(t=>t.id===topicId)?.title || "this topic";

  if(focusBtn){
    const hasFocus = focusCount > 0;
    focusBtn.disabled = !hasFocus;
    focusBtn.classList.toggle("hidden", !hasFocus);
  }
  if(explain){
    explain.textContent = focusCount > 0
      ? `You have ${focusCount} focus ${focusCount === 1 ? "card" : "cards"} ready to review.`
      : `No focus cards yet for ${topicTitle}. You can return home and choose your next task.`;
  }

  overlay.classList.remove("hidden");
}

function showQuizCompleteModal(){
  const overlay = $("quizCompleteOverlay");
  if(!overlay) return;

  const percent = QUIZ.list.length ? Math.round((QUIZ.score / QUIZ.list.length) * 100) : 0;
  const perfect = percent === 100;
  const misses = QUIZ.errorBank.length;
  const d = ensureDaily();
  const fromDailyChallenge = !!(QUIZ.fromDailyChallenge && QUIZ.topicId === d.topicId);

  const title = $("quizCompleteTitle");
  const status = $("quizCompleteStatus");
  const explainNode = $("quizCompleteExplain");
  const fixBtn = $("btnQuizCompleteFix");
  const flashBtn = $("btnQuizCompleteFlashcards");

  if(title) title.textContent = perfect ? "🎉 Perfect score!" : (fromDailyChallenge ? "Daily Challenge quiz check" : "Quiz complete");
  if(status){
    status.classList.toggle("good", perfect);
    status.classList.toggle("bad", !perfect);
    if(perfect){
      status.textContent = "You scored 100%. Great time to move on to the next activity.";
    }else if(fromDailyChallenge){
      status.textContent = `Daily Challenge requires 100%. You scored ${percent}% — use Fix to correct ${misses} ${misses === 1 ? "answer" : "answers"}.`;
    }else{
      status.textContent = `You scored ${percent}%. Review ${misses} incorrect ${misses === 1 ? "answer" : "answers"} with Fix.`;
    }
  }

  if(explainNode){
    if(perfect){
      explainNode.textContent = "Suggestion: continue to flashcards for the next activity.";
    }else if(fromDailyChallenge){
      explainNode.textContent = "To complete the quiz part of today’s Daily Challenge, choose Fix and correct every incorrect answer.";
    }else{
      explainNode.textContent = "Choose Fix to go over your incorrect answers and improve your score.";
    }
  }

  if(fixBtn) fixBtn.classList.toggle("hidden", perfect || misses === 0);
  if(flashBtn) flashBtn.classList.toggle("hidden", !perfect);

  overlay.classList.remove("hidden");
}

function showQuizResultModal({ correct, picked, answer, explain }){
  const overlay = $("quizResultOverlay");
  if(!overlay) return;
  const title = $("quizResultTitle");
  const status = $("quizResultStatus");
  const explainNode = $("quizResultExplain");
  if(title) title.innerHTML = correct
    ? '<span class="inlineIconLabel"><svg class="navIcon" viewBox="0 0 24 24" aria-hidden="true"><path d="m5 13 4 4L19 7"></path></svg><span>Correct</span></span>'
    : '<span class="inlineIconLabel"><svg class="navIcon" viewBox="0 0 24 24" aria-hidden="true"><path d="m7 7 10 10"></path><path d="m17 7-10 10"></path></svg><span>Incorrect</span></span>';
  if(status){
    status.classList.toggle("good", correct);
    status.classList.toggle("bad", !correct);
    status.textContent = correct
      ? "Great answer"
      : `You chose “${picked}”. Correct answer: “${answer}”.`;
  }
  if(explainNode) explainNode.textContent = explain;
  overlay.classList.remove("hidden");
}

function startRandomQuiz(){
  NEXT_QUIZ_FROM_DAILY_CHALLENGE = false;
  const topics = enabledTopicIds();
  const chosen = topics.length ? topics[Math.floor(Math.random() * topics.length)] : "MIXED";
  const topicSelect = $("mcqTopicSelect");
  if(topicSelect) topicSelect.value = chosen;
  startQuiz(false);
}

function startQuiz(useErrorBank=false){
  closeQuizCompleteModal();
  const topicId = $("mcqTopicSelect").value;
  const count = Number($("mcqCount").value);
  const mode = $("quizModeSelect")?.value || "standard";
  if(topicId !== "MIXED") trackTaskStarted("QUIZ", topicId);

  const pool = useErrorBank ? QUIZ.errorBank.map(x=>x.sourceQ) : getQuizPool(topicId);
  let list = shuffle(pool).slice(0, Math.min(count, pool.length));
  if(mode === "exam") list = list.map(buildExamisedQuestion);

  QUIZ.list = list;
  QUIZ.idx = 0;
  QUIZ.score = 0;
  QUIZ.locked = false;
  QUIZ.streak = 0;
  QUIZ.best = 0;
  QUIZ.topicId = topicId;
  QUIZ.mode = mode;
  QUIZ.fromDailyChallenge = !!(NEXT_QUIZ_FROM_DAILY_CHALLENGE || (useErrorBank && QUIZ.fromDailyChallenge));
  NEXT_QUIZ_FROM_DAILY_CHALLENGE = false;
  if(!useErrorBank) QUIZ.errorBank = [];

  $("quizReviewBox").classList.add("hidden");
  $("btnFixIt").classList.toggle("hidden", QUIZ.errorBank.length === 0);

  $("quizEmpty").classList.add("hidden");
  $("quizBox").classList.remove("hidden");
  $("btnStartRandomQuiz").classList.add("hidden");
  $("btnRandomQuizMini").classList.remove("hidden");
  $("quizExplainer").textContent = mode === "exam" ? "Exam mode: one answer only." : "Tap your answer.";
  closeQuizResultModal();
  updateQuizMasteryUi();

  if(!QUIZ.list.length){
    $("quizQ").textContent = "No questions available for this selection.";
    $("quizChoices").innerHTML = "";
    $("btnRandomQuizMini").classList.add("hidden");
    $("btnStartRandomQuiz").classList.remove("hidden");
    return;
  }
  renderQuizQ();
}

$("btnStartQuiz").addEventListener("click", ()=>startQuiz(false));
$("btnStartRandomQuiz").addEventListener("click", startRandomQuiz);
$("btnRandomQuizMini").addEventListener("click", startRandomQuiz);
$("btnFixIt").addEventListener("click", ()=>startQuiz(true));
$("btnReviewMisses").addEventListener("click", renderQuizReview);
$("btnQuizModalNext").addEventListener("click", ()=>{
  closeQuizResultModal();
  $("btnNextQ").click();
});

$("btnQuizCompleteClose")?.addEventListener("click", closeQuizCompleteModal);
$("btnQuizCompleteHome")?.addEventListener("click", ()=>{
  closeQuizCompleteModal();
  setTab("home");
});
$("btnQuizCompleteFix")?.addEventListener("click", ()=>{
  closeQuizCompleteModal();
  startQuiz(true);
});
$("btnQuizCompleteFlashcards")?.addEventListener("click", ()=>{
  closeQuizCompleteModal();
  setTab("study");
});

$("btnDailyCompleteHome")?.addEventListener("click", ()=>{
  closeDailyChallengeCompleteModal();
  setTab("home");
});

$("btnDailyCompleteFocus")?.addEventListener("click", ()=>{
  closeDailyChallengeCompleteModal();
  const d = ensureDaily();
  openStudyForTopic(d.topicId, "focus");
});

$("btnNextQ").addEventListener("click", ()=>{
  if(!QUIZ.list.length) return;
  QUIZ.idx++;
  QUIZ.locked=false;

  if(QUIZ.idx >= QUIZ.list.length){
    const action = (QUIZ.fromDailyChallenge && QUIZ.errorBank.length)
      ? "Daily Challenge quiz needs 100%: use Fix-it to correct misses."
      : (QUIZ.errorBank.length ? "Use Fix-it to retry misses." : "No misses. Keep the pace.");
    $("quizQ").textContent = `Finished. Final score: ${QUIZ.score}/${QUIZ.list.length}`;
    $("quizChoices").innerHTML = "";
    $("quizMeta").textContent = "Done";
    $("quizExplainer").textContent = `${action} Progress ${computeProgressScore()}% · Weekly ${weeklyPercent()}%`;

    const percent = QUIZ.list.length ? Math.round((QUIZ.score / QUIZ.list.length) * 100) : 0;
    recordDailyQuiz(QUIZ.topicId, percent);
    if(QUIZ.topicId && QUIZ.topicId !== "MIXED") trackTaskCompleted("QUIZ", QUIZ.topicId, { percent });

    $("btnFixIt").classList.toggle("hidden", QUIZ.errorBank.length === 0);
    updateQuizMasteryUi();
    confetti.burst(140);
    computeKpis();
    showQuizCompleteModal();
    return;
  }
  $("quizExplainer").textContent = QUIZ.mode === "exam" ? "Exam mode: one answer only." : "Tap your answer.";
  renderQuizQ();
});

function renderQuizQ(){
  const q = QUIZ.list[QUIZ.idx];
  $("quizMeta").textContent = `Q ${QUIZ.idx+1}/${QUIZ.list.length}`;
  $("quizQ").textContent = q.q;
  $("quizChoices").innerHTML = "";

  q.choices.forEach(choice=>{
    const b = document.createElement("button");
    b.className = "choiceBtn";
    b.textContent = choice;
    b.title = choice;
    b.setAttribute("aria-label", choice);

    b.addEventListener("click", ()=>{
      if(QUIZ.locked) return;
      QUIZ.locked = true;

      STATE.quiz.attempted = (STATE.quiz.attempted||0) + 1;

      const { bucket } = getWeeklyBucket();
      bucket.attempted += 1;

      const correct = (choice === q.answer);
      if(correct){
        QUIZ.score++;
        STATE.quiz.correct = (STATE.quiz.correct||0) + 1;
        bucket.correct += 1;

        QUIZ.streak++;
        QUIZ.best = Math.max(QUIZ.best, QUIZ.streak);
        bucket.bestStreak = Math.max(bucket.bestStreak||0, QUIZ.best);
        STATE.quiz.bestStreakAllTime = Math.max(STATE.quiz.bestStreakAllTime||0, QUIZ.best);

        b.classList.add("correct");

        if(QUIZ.streak > 0 && QUIZ.streak % 5 === 0){
          confetti.burst(90);
        }
      }else{
        QUIZ.streak = 0;
        b.classList.add("wrong");
        QUIZ.errorBank.push({ q:q.q, picked:choice, answer:q.answer, explain:q.explain, sourceQ:q });
      }

      $("btnFixIt").classList.toggle("hidden", QUIZ.errorBank.length === 0);

      saveState();

      showQuizResultModal({
        correct,
        picked: choice,
        answer: q.answer,
        explain: q.explain
      });

      $("quizExplainer").textContent = `Error bank: ${QUIZ.errorBank.length} · Progress ${computeProgressScore()}% · Weekly ${weeklyPercent()}%`;
      updateQuizMasteryUi();
      computeKpis();
    });

    $("quizChoices").appendChild(b);
  });
}

/* ==========================================================
   EMOJI GAME
   ========================================================== */
let EMOJI = { score:0, attempted:0, current:null, choices:[], streak:0, best:0 };

function getEmojiPool(topicId, mode){
  const build = (tid)=>{
    if(!isTopicEnabled(tid)) return [];
    const pack = EMOJI_BANK[tid];
    if(!pack) return [];
    if(mode === "terms") return (pack.terms||[]).map(x=>({...x, type:"term"}));
    if(mode === "people") return (pack.people||[]).map(x=>({...x, type:"people"}));
    return [
      ...(pack.terms||[]).map(x=>({...x, type:"term"})),
      ...(pack.people||[]).map(x=>({...x, type:"people"}))
    ];
  };

  if(topicId === "MIXED") return enabledTopicIds().flatMap(tid=>build(tid));
  return build(topicId);
}

function allAnswerOptions(mode){
  const allowed = new Set(enabledTopicIds());
  const terms = Object.keys(FACT_BANK).filter(tid=>allowed.has(tid)).flatMap(tid => (FACT_BANK[tid].terms||[]).map(x=>x.term));
  const people = Object.keys(FACT_BANK).filter(tid=>allowed.has(tid)).flatMap(tid => (FACT_BANK[tid].people||[]).map(x=>x.name));
  if(mode === "terms") return unique(terms);
  if(mode === "people") return unique(people);
  return unique([...terms, ...people]);
}

function startEmojiRound(){
  const topicId = $("emojiTopicSelect").value;
  const mode = $("emojiMode").value;

  const pool = getEmojiPool(topicId, mode);
  if(pool.length < 4){
    $("emojiClue").textContent = "⚠️ Not enough emoji prompts yet for this selection.";
    $("emojiChoices").innerHTML = `<div class="note">Add more clues in EMOJI_BANK for this topic/mode.</div>`;
    return;
  }

  const prompt = pool[Math.floor(Math.random()*pool.length)];
  const optionsUniverse = allAnswerOptions(mode);

  const distractors = shuffle(optionsUniverse.filter(x=>x !== prompt.answer)).slice(0,3);
  const choices = shuffle([prompt.answer, ...distractors]);

  EMOJI.current = prompt;
  EMOJI.choices = choices;

  $("emojiClue").textContent = prompt.clue;
  renderEmojiChoices();
}

function renderEmojiChoices(){
  const box = $("emojiChoices");
  box.innerHTML = "";
  $("emojiMeta").textContent = `${EMOJI.score} correct • ${EMOJI.attempted} attempted`;
  $("emojiStreakPill").textContent = `🔥 Streak: ${EMOJI.streak}`;
  $("emojiBestStreakPill").textContent = `🏆 Best: ${EMOJI.best}`;

  EMOJI.choices.forEach(ch=>{
    const b = document.createElement("button");
    b.className = "choiceBtn";
    b.textContent = ch;

    b.addEventListener("click", ()=>{
      if(!EMOJI.current) return;
      EMOJI.attempted++;

      const correct = (ch === EMOJI.current.answer);
      if(correct){
        EMOJI.score++;
        EMOJI.streak++;
        EMOJI.best = Math.max(EMOJI.best, EMOJI.streak);

        b.classList.add("correct");
        $("emojiHelp").textContent = `✅ ${EMOJI.current.why}`;

        if(EMOJI.streak > 0 && EMOJI.streak % 7 === 0){
          confetti.burst(105);
        }

        setTimeout(()=>startEmojiRound(), 650);
      }else{
        EMOJI.streak = 0;
        b.classList.add("wrong");
        $("emojiHelp").textContent = "❌ Not quite — think conceptually (not literal emojis).";
      }

      $("emojiMeta").textContent = `${EMOJI.score} correct • ${EMOJI.attempted} attempted`;
      $("emojiStreakPill").textContent = `🔥 Streak: ${EMOJI.streak}`;
      $("emojiBestStreakPill").textContent = `🏆 Best: ${EMOJI.best}`;
    });

    box.appendChild(b);
  });
}

$("btnStartEmoji").addEventListener("click", ()=>{
  EMOJI.score = 0; EMOJI.attempted = 0; EMOJI.streak = 0; EMOJI.best = 0;
  $("emojiHelp").textContent = "Pick the best answer from 4.";
  startEmojiRound();
});
$("emojiTopicSelect").addEventListener("change", startEmojiRound);
$("emojiMode").addEventListener("change", startEmojiRound);

/* ==========================================================
   MATCHING GAME
   ========================================================== */
function dedupeByName(people){
  const seen = new Set();
  const out = [];
  for(const p of people){
    const k = String(p.name||"").toLowerCase();
    if(!k || seen.has(k)) continue;
    seen.add(k);
    out.push(p);
  }
  return out;
}
let MATCH = {
  pairs: [],
  names: [],
  descs: [],
  selectedNameId: null,
  selectedDescId: null,
  correct: 0,
  total: 0,
  locked: new Set(),
  streak: 0,
  best: 0
};

function buildPeoplePool(topicId){
  const allowed = new Set(enabledTopicIds());
  const allP = Object.keys(FACT_BANK)
    .filter(tid=>allowed.has(tid))
    .flatMap(tid => (FACT_BANK[tid].people||[]).map(p=>({...p, topicId: tid})));
  if(topicId === "MIXED") return dedupeByName(allP);
  if(!allowed.has(topicId)) return [];

  const topicPeople = (FACT_BANK[topicId]?.people || []).map(p=>({...p, topicId}));
  const decoys = shuffle(allP.filter(p=>p.topicId!==topicId)).slice(0, 6);
  return dedupeByName([...topicPeople, ...decoys]);
}
function makeTrickyDescription(p){
  const role = p.role.replace(/\s+/g," ").trim();
  const sig = p.significance.replace(/\s+/g," ").trim();
  const safeSig = sig.replaceAll(p.name, "this figure");
  return `${role}. ${safeSig}`;
}
function startMatchGame(){
  const topicId = $("matchTopicSelect").value;
  const pairsWanted = Number($("matchDifficulty").value);

  const pool = buildPeoplePool(topicId);
  const chosen = shuffle(pool).slice(0, Math.min(pairsWanted, pool.length));

  const pairs = chosen.map((p, i)=>({
    key:`p${i}`,
    name: p.name,
    desc: makeTrickyDescription(p)
  }));

  MATCH = {
    pairs,
    names: shuffle(pairs.map(x=>({ id:`n_${x.key}`, key:x.key, text:x.name }))),
    descs: shuffle(pairs.map(x=>({ id:`d_${x.key}`, key:x.key, text:x.desc }))),
    selectedNameId: null,
    selectedDescId: null,
    correct: 0,
    total: pairs.length,
    locked: new Set(),
    streak: 0,
    best: 0
  };

  renderMatch();
}
function renderMatch(){
  $("matchNames").innerHTML = "";
  $("matchDescs").innerHTML = "";
  $("matchMeta").textContent = `Pairs: ${MATCH.total} • Correct: ${MATCH.correct}`;
  $("matchStreakPill").textContent = `🔥 Streak: ${MATCH.streak}`;
  $("matchBestStreakPill").textContent = `🏆 Best: ${MATCH.best}`;

  const pickedName = MATCH.names.find(x=>x.id===MATCH.selectedNameId);
  const pickedDesc = MATCH.descs.find(x=>x.id===MATCH.selectedDescId);
  const selNameEl = $("matchSelectedName");
  const selDescEl = $("matchSelectedDesc");
  selNameEl.textContent = pickedName ? pickedName.text : "None selected yet.";
  selDescEl.textContent = pickedDesc ? pickedDesc.text : "None selected yet.";
  selNameEl.classList.toggle("empty", !pickedName);
  selDescEl.classList.toggle("empty", !pickedDesc);

  MATCH.names.forEach(item=>{
    const b = document.createElement("button");
    b.className = "matchItem";
    b.textContent = item.text;

    if(MATCH.locked.has(item.key)) b.classList.add("correct");
    if(MATCH.selectedNameId === item.id) b.classList.add("selected");

    b.addEventListener("click", ()=>{
      if(MATCH.locked.has(item.key)) return;
      MATCH.selectedNameId = (MATCH.selectedNameId === item.id) ? null : item.id;
      attemptMatch();
      renderMatch();
    });

    $("matchNames").appendChild(b);
  });

  MATCH.descs.forEach(item=>{
    const b = document.createElement("button");
    b.className = "matchItem";
    b.textContent = item.text;

    if(MATCH.locked.has(item.key)) b.classList.add("correct");
    if(MATCH.selectedDescId === item.id) b.classList.add("selected");

    b.addEventListener("click", ()=>{
      if(MATCH.locked.has(item.key)) return;
      MATCH.selectedDescId = (MATCH.selectedDescId === item.id) ? null : item.id;
      attemptMatch();
      renderMatch();
    });

    $("matchDescs").appendChild(b);
  });
}
function attemptMatch(){
  if(!MATCH.selectedNameId || !MATCH.selectedDescId) return;

  const nameItem = MATCH.names.find(x=>x.id===MATCH.selectedNameId);
  const descItem = MATCH.descs.find(x=>x.id===MATCH.selectedDescId);
  if(!nameItem || !descItem) return;

  const correct = (nameItem.key === descItem.key);

  if(correct){
    MATCH.locked.add(nameItem.key);
    MATCH.correct++;
    MATCH.streak++;
    MATCH.best = Math.max(MATCH.best, MATCH.streak);

    $("matchHelp").textContent = "✅ Correct! Keep going.";

    if(MATCH.streak > 0 && MATCH.streak % 4 === 0){
      confetti.burst(80);
    }
  }else{
    MATCH.streak = 0;
    $("matchHelp").textContent = "❌ Not a match — look for the precise clue in the wording.";
  }

  MATCH.selectedNameId = null;
  MATCH.selectedDescId = null;

  if(MATCH.correct >= MATCH.total){
    $("matchHelp").textContent = "🏆 Completed! New game to reshuffle.";
    confetti.burst(160);
  }
}
$("btnStartMatch").addEventListener("click", startMatchGame);

/* ==========================================================
   EXAM TAB UI (enforce 3 per topic)
   ========================================================== */
function validateExamBank(){
  // ensures 3 per topicId (t1..t4)
  const counts = {};
  EXAM_BANK.forEach(q => counts[q.topicId] = (counts[q.topicId]||0)+1);
  for(const t of TOPICS){
    if((counts[t.id]||0) !== 3){
      console.warn("EXAM_BANK topic not equal to 3:", t.id, counts[t.id]);
    }
  }
}
validateExamBank();

function renderExamSelect(){
  const filter = $("examTopicSelect").value;
  $("examSelect").innerHTML = "";

  const list = EXAM_BANK.filter(q=>isTopicEnabled(q.topicId)).filter(q=>filter==="ALL" ? true : q.topicId===filter);

  list.forEach(q=>{
    const o=document.createElement("option");
    o.value=q.id;
    o.textContent = q.question.length>95 ? q.question.slice(0,95)+"…" : q.question;
    $("examSelect").appendChild(o);
  });

  if(list.length){
    $("examSelect").value=list[0].id;
    renderExamQuestion();
  }else{
    $("examQText").textContent="No questions here yet. Try another topic.";
    $("examPlan").innerHTML="";
    $("examHelpBody").innerHTML="";
  }
}

function renderExamQuestion(){
  const id = $("examSelect").value;
  const q = EXAM_BANK.find(x=>x.id===id);
  if(!q) return;

  $("examQText").textContent = q.question;
  const topicTitle = (TOPICS.find(t=>t.id===q.topicId)||{}).title || "—";
  $("examTag").textContent = `Topic: ${topicTitle} • Suggested factors: ${q.factors.length}`;

  const plan = $("examPlan");
  plan.innerHTML="";
  q.plan.forEach((p,i)=>{
    const div=document.createElement("div");
    div.style.border="1px solid var(--line)";
    div.style.borderRadius="16px";
    div.style.padding="12px";
    div.style.background="#fff";
    div.style.marginBottom="10px";
    div.innerHTML = `<b>${i+1}. ${p.title}</b><div class="note" style="margin-top:6px;color:var(--muted)">${p.body}</div>`;
    plan.appendChild(div);
  });

  $("examHelpBody").innerHTML =
    `<ul style="margin:0 0 0 18px">${q.help.map(x=>`<li>${x}</li>`).join("")}</ul>`;
  $("examHelp").open = false;

  // Daily challenge: opening the relevant plan counts
  recordDailyPlanOpened(q.topicId);
}
$("examTopicSelect").addEventListener("change", renderExamSelect);
$("examSelect").addEventListener("change", renderExamQuestion);

/* ==========================================================
   EXPORT / IMPORT / RESET
   ========================================================== */
$("btnExport").addEventListener("click", ()=>{ $("dataBox").value = JSON.stringify(STATE); });

$("btnImport").addEventListener("click", ()=>{
  const raw = $("dataBox").value.trim();
  if(!raw) return alert("Drop JSON into the box first.");
  try{
    const obj = JSON.parse(raw);
    if(!obj || typeof obj !== "object") throw new Error("Invalid data");
    STATE = obj;
    saveState();
    computeKpis();
    alert("Import complete.");
  }catch(e){
    alert("Import failed — JSON format is invalid.");
  }
});

$("btnReset").addEventListener("click", ()=>{
  const ok = confirm("Reset all progress on this device?");
  if(!ok) return;
  STATE = baseState();
  saveState();
  computeKpis();
  alert("Progress reset done.");
});

/* ==========================================================
   INIT
   ========================================================== */
function init(){
  populateTopics();
  startSession("app_open");
  attachHomeDebugLongPress();
  initOnboarding();
  try{ bumpHeaderSessions(); }catch(e){}
  updateDailyUI();
  // sensible defaults
  $("topicSelect").value = "ALL";
  $("modeSelect").value = "all";
  $("orderSelect").value = "ordered";
  $("mcqTopicSelect").value = "MIXED";
  $("emojiTopicSelect").value = "MIXED";
  $("matchTopicSelect").value = "MIXED";
  $("examTopicSelect").value = "ALL";

  renderExamSelect();
  updateStudyLaunchCta();
  computeKpis();

  // pre-load games
  startMatchGame();
  startEmojiRound();

  // start on Home
  setTab("home");
  renderHomeRecommendation();

  document.addEventListener("visibilitychange", ()=>{
    if(document.visibilityState === "hidden") endSession();
    if(document.visibilityState === "visible") startSession("tab_switch");
  });
  window.addEventListener("beforeunload", endSession);
}

function hideSplashScreen(){
  const splash = $("splashScreen");
  if(!splash) return;
  splash.classList.add("fadeOut");
  const done = ()=>splash.remove();
  splash.addEventListener("transitionend", done, { once:true });
  setTimeout(done, 900);
}

function startAppWithSplash(){
  const splashMinMs = 2600;
  const startAt = performance.now();
  init();
  const elapsed = performance.now() - startAt;
  const wait = Math.max(0, splashMinMs - elapsed);
  window.setTimeout(hideSplashScreen, wait);
}

startAppWithSplash();
</script>

<!-- Optional: PWA service worker registration (keeps mobile/PWA assets up to date) -->
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", async () => {
      try{
        const reg = await navigator.serviceWorker.register("./service-worker.js?v9", { scope: "./" });
        // Ask the browser to check for an updated SW file
        if (reg && reg.update) reg.update();

        // If an updated SW is waiting, activate it and reload so new assets (e.g. header-bg.jpg) appear
        if (reg.waiting) {
          reg.waiting.postMessage({ type: "SKIP_WAITING" });
        }
        reg.addEventListener("updatefound", () => {
          const sw = reg.installing;
          if (!sw) return;
          sw.addEventListener("statechange", () => {
            if (sw.state === "installed" && navigator.serviceWorker.controller) {
              sw.postMessage({ type: "SKIP_WAITING" });
            }
          });
        });

        navigator.serviceWorker.addEventListener("controllerchange", () => {
          window.location.reload();
        });
      }catch(e){
        console.warn("Service worker registration failed", e);
      }
    });
  }
</script>
</body>
</html>
